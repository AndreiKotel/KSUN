unit UnitPrint;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, DB, DBTables, Wwquery,ComObj,Excel97,Math, OleServer, ExcelXP,
  ppDB, Wwdatsrc, ppDBPipe, ppComm, ppRelatv, ppProd, ppClass, ppReport,
  ppPrnabl, ppCtrls, ppBands, ppCache, ppDBBDE, ppVar,ppTypes, ppStrtch,
  ppSubRpt, ppParameter, StdCtrls, ppModule, raCodMod, ppMemo;

type
  TFormPrint = class(TForm)
    QPr: TwwQuery;
    QPrKol: TFloatField;
    QPrNDS: TFloatField;
    QPrName: TStringField;
    QPrPrice: TFloatField;
    PRNS: TwwQuery;
    PRNSID: TIntegerField;
    PRNSCar: TStringField;
    PRNSDT: TDateField;
    PRNSDateN: TDateField;
    PRNSGod: TIntegerField;
    PRNSKBS: TStringField;
    PRNSMes: TIntegerField;
    PRNSNK: TIntegerField;
    PRNSNnak: TIntegerField;
    PRNSOperac: TIntegerField;
    PRNSPDK: TIntegerField;
    PRNSPodr: TIntegerField;
    PRNSPrN: TIntegerField;
    PRNSSK: TIntegerField;
    PRNSSTara: TFloatField;
    PRNSSTov: TFloatField;
    PRNSTM: TTimeField;
    PRNSTpKod: TIntegerField;
    PRNSTpLicens: TStringField;
    PRNSTpName: TStringField;
    PRNSTpOklp: TStringField;
    PRNSTpPod: TIntegerField;
    PRNSTpPr: TIntegerField;
    PRNSTpUNN: TIntegerField;
    PRNSTrKod: TIntegerField;
    PRNSVodKod: TIntegerField;
    PRNSVodName: TStringField;
    PRNSqN: TStringField;
    QPrID: TIntegerField;
    QPrDT: TDateField;
    QPrDat: TDateField;
    QPrFasovka: TFloatField;
    QPrIDdoc: TIntegerField;
    QPrNK: TIntegerField;
    QPrNad: TFloatField;
    QPrNnt: TIntegerField;
    QPrNntName: TStringField;
    QPrPriceR: TFloatField;
    QPrSkid: TFloatField;
    QPrSummaR: TFloatField;
    QPrTM: TTimeField;
    QPrID_1: TIntegerField;
    QPrAdd4School: TFloatField;
    QPrAddBase: TFloatField;
    QPrAddBuyer: TFloatField;
    QPrAddSuppl: TFloatField;
    QPrAxc: TStringField;
    QPrBottle: TIntegerField;
    QPrCalcPrice: TFloatField;
    QPrCena: TFloatField;
    QPrCenaOpt: TFloatField;
    QPrDNakl: TDateField;
    QPrDOSNNT: TIntegerField;
    QPrDT_1: TDateField;
    QPrDop: TStringField;
    QPrGrRasc: TIntegerField;
    QPrKodEI: TIntegerField;
    QPrKodEIName: TStringField;
    QPrKodGr: TIntegerField;
    QPrKodGrName: TStringField;
    QPrKodPGr: TIntegerField;
    QPrKodPGrName: TStringField;
    QPrKodVid: TIntegerField;
    QPrKodVidName: TStringField;
    QPrKoef: TFloatField;
    QPrNK_1: TIntegerField;
    QPrNal: TFloatField;
    QPrNameSupl: TStringField;
    QPrNnt_1: TIntegerField;
    QPrNntOsn: TIntegerField;
    QPrPr1: TIntegerField;
    QPrPr2: TIntegerField;
    QPrPriceOptSale: TFloatField;
    QPrRaz1: TIntegerField;
    QPrRaz1Name: TStringField;
    QPrRaz2: TIntegerField;
    QPrRaz2Name: TStringField;
    QPrSK: TIntegerField;
    QPrSkid_1: TFloatField;
    QPrSuplR: TIntegerField;
    QPrTM_1: TTimeField;
    QPrTekOst: TFloatField;
    QPrTnakl: TIntegerField;
    QPrTrans: TFloatField;
    prov: TwwQuery;
    provID: TIntegerField;
    provBSD: TStringField;
    provBSDA: TIntegerField;
    provBSK: TStringField;
    provBSKA: TIntegerField;
    provNS: TIntegerField;
    provS: TFloatField;
    PRNZ: TwwQuery;
    PRNZID: TIntegerField;
    PRNZCdalOtp: TStringField;
    PRNZCelPriobr: TStringField;
    PRNZDokTov: TStringField;
    PRNZDovData: TDateField;
    PRNZDovNom: TStringField;
    PRNZDovVyd: TStringField;
    PRNZNK: TIntegerField;
    PRNZOsnOtp: TStringField;
    PRNZOtpProizv: TStringField;
    PRNZOtpRazr: TStringField;
    PRNZOwnCar: TIntegerField;
    PRNZOwnCarName: TStringField;
    PRNZPrinPol: TStringField;
    PRNZPunktPogr: TStringField;
    PRNZPunktRazgr: TStringField;
    PRNZPutList: TStringField;
    PRNZUslPost: TStringField;
    PRNZVCar: TStringField;
    PRNZVCode: TIntegerField;
    PRNZVName: TStringField;
    PRNZVidPerev: TStringField;
    PRNZDT: TDateField;
    PRNZTM: TTimeField;
    qrBankAccount: TwwQuery;
    qrBankAccountRS: TStringField;
    qrBankAccountAdressB: TStringField;
    qrBankAccountNameB: TStringField;
    qrBankAccountMFOB: TIntegerField;
    Addition: TppReport;
    dPrint: TwwDataSource;
    qPrint: TwwQuery;
    qPrintID: TIntegerField;
    qPrintAddOpt: TFloatField;
    qPrintAddTorg: TFloatField;
    qPrintEI: TStringField;
    qPrintNDS: TFloatField;
    qPrintNNT: TIntegerField;
    qPrintNS: TIntegerField;
    qPrintName: TStringField;
    qPrintPrice: TFloatField;
    qPrintPricewNDS: TFloatField;
    qPrintPricewTax: TFloatField;
    qPrintPricewTrans: TFloatField;
    qPrintPricewoNDS: TFloatField;
    qPrintQnt: TFloatField;
    qPrintSumNDS: TFloatField;
    qPrintSumTotal: TFloatField;
    qPrintSumTrans: TFloatField;
    qPrintSumwNDS: TFloatField;
    qPrintTax: TFloatField;
    qPrintTrans: TFloatField;
    ppHeaderBand1: TppHeaderBand;
    ppDetailBand1: TppDetailBand;
    ppFooterBand1: TppFooterBand;
    ppLabel4: TppLabel;
    ppTitleBand1: TppTitleBand;
    ppBDEPipeline1: TppBDEPipeline;
    ppDBText1: TppDBText;
    ppDBText2: TppDBText;
    ppDBText3: TppDBText;
    ppDBText4: TppDBText;
    ppDBText7: TppDBText;
    ppDBText8: TppDBText;
    ppDBText9: TppDBText;
    ppDBText10: TppDBText;
    ppDBText11: TppDBText;
    ppDBText12: TppDBText;
    ppDBText13: TppDBText;
    ppDBText14: TppDBText;
    ppDBText15: TppDBText;
    ppDBText16: TppDBText;
    ppLabel2: TppLabel;
    ppLabel3: TppLabel;
    ppLabel5: TppLabel;
    ppLabel6: TppLabel;
    ppLabel7: TppLabel;
    ppLabel8: TppLabel;
    ppLabel9: TppLabel;
    ppSummaryBand1: TppSummaryBand;
    ppLabel10: TppLabel;
    ppLabel11: TppLabel;
    ppLabel12: TppLabel;
    ppLabel13: TppLabel;
    ppLabel14: TppLabel;
    ppLabel15: TppLabel;
    ppLabel16: TppLabel;
    ppLabel17: TppLabel;
    qPrintSumTax: TFloatField;
    ppSystemVariable1: TppSystemVariable;
    ppSystemVariable2: TppSystemVariable;
    ppLine1: TppLine;
    ppLine2: TppLine;
    ppLine3: TppLine;
    ppLine4: TppLine;
    ppLine5: TppLine;
    ppLine6: TppLine;
    ppLine7: TppLine;
    ppLine8: TppLine;
    ppLine9: TppLine;
    ppLine10: TppLine;
    ppLine11: TppLine;
    ppLine12: TppLine;
    ppLine13: TppLine;
    ppLine14: TppLine;
    ppLine16: TppLine;
    ppLine17: TppLine;
    ppLine18: TppLine;
    ppLine19: TppLine;
    qPrintSkid: TFloatField;
    qPrintSumBegin: TFloatField;
    qPrintSumSkid: TFloatField;
    PRNZustomer: TBooleanField;
    ppReport1: TppReport;
    ppHeaderBand2: TppHeaderBand;
    ppDetailBand2: TppDetailBand;
    ppFooterBand2: TppFooterBand;
    ppBDEPipeline2: TppBDEPipeline;
    ppDBText21: TppDBText;
    ppDBText22: TppDBText;
    ppDBText23: TppDBText;
    ppDBText24: TppDBText;
    ppDBText25: TppDBText;
    ppDBText26: TppDBText;
    ppDBText30: TppDBText;
    ppDBText31: TppDBText;
    ppDBText32: TppDBText;
    ppDBText33: TppDBText;
    ppDBText34: TppDBText;
    ppSummaryBand2: TppSummaryBand;
    ppLabel29: TppLabel;
    ppDBCalc9: TppDBCalc;
    ppDBCalc11: TppDBCalc;
    ppDBCalc12: TppDBCalc;
    ppDBCalc13: TppDBCalc;
    qPrintDop: TStringField;
    ppLine15: TppLine;
    ppLine20: TppLine;
    ppLine21: TppLine;
    ppLine22: TppLine;
    ppLabel26: TppLabel;
    ppLabel28: TppLabel;
    ppLabel27: TppLabel;
    ppLabel30: TppLabel;
    ppLabel31: TppLabel;
    ppLabel32: TppLabel;
    ppLine23: TppLine;
    ppLabel33: TppLabel;
    ppLabel34: TppLabel;
    ppLabel35: TppLabel;
    ppLine24: TppLine;
    ppLine25: TppLine;
    ppLabel36: TppLabel;
    ppLabel37: TppLabel;
    ppLabel38: TppLabel;
    ppLine26: TppLine;
    ppLabel39: TppLabel;
    ppLabel40: TppLabel;
    ppLine27: TppLine;
    ppLabel41: TppLabel;
    ppLabel42: TppLabel;
    ppLine28: TppLine;
    ppLabel43: TppLabel;
    ppLabel44: TppLabel;
    ppLine29: TppLine;
    ppLabel45: TppLabel;
    ppLabel46: TppLabel;
    ppLabel47: TppLabel;
    ppLabel48: TppLabel;
    ppLine30: TppLine;
    ppLine31: TppLine;
    ppLine32: TppLine;
    ppLabel49: TppLabel;
    ppSystemVariable3: TppSystemVariable;
    ppSystemVariable4: TppSystemVariable;
    ppLabel50: TppLabel;
    ppLine33: TppLine;
    ppLabel51: TppLabel;
    qPrintKodGr: TIntegerField;
    qPrintKodPGr: TIntegerField;
    qPrintVid: TIntegerField;
    ppLabel18: TppLabel;
    ppDBCalc1: TppDBCalc;
    ppDBCalc2: TppDBCalc;
    ppDBCalc3: TppDBCalc;
    ppDBCalc4: TppDBCalc;
    ppLabel1: TppLabel;
    ppLabel19: TppLabel;
    qPrintAxc: TStringField;
    ppLabel20: TppLabel;
    PRNZPereadr: TStringField;
    ppLabel21: TppLabel;
    ppLabel22: TppLabel;
    ppLabel23: TppLabel;
    ppLabel24: TppLabel;
    ppLabel25: TppLabel;
    ppLabel52: TppLabel;
    ppLabel53: TppLabel;
    ppLabel54: TppLabel;
    ppLabel55: TppLabel;
    ppLabel56: TppLabel;
    ppLabel57: TppLabel;
    SumTara: TwwQuery;
    SumTaraQnt: TFloatField;
    SumTaraNDS: TFloatField;
    SumTarawNDS: TFloatField;
    SumTaraTotal: TFloatField;
    ppLine34: TppLine;
    ppLine35: TppLine;
    ppLabel58: TppLabel;
    ppLabel59: TppLabel;
    ppLabel60: TppLabel;
    ppLabel61: TppLabel;
    ppLabel62: TppLabel;
    ppLabel63: TppLabel;
    ppLabel64: TppLabel;
    ppLabel65: TppLabel;
    ppLabel66: TppLabel;
    ppLabel67: TppLabel;
    ppLabel68: TppLabel;
    ppLabel69: TppLabel;
    ppLabel70: TppLabel;
    ppLabel71: TppLabel;
    qPrintCenaOpt: TFloatField;
    qPrintSumOpt: TFloatField;
    qPrintSumwoNDS: TFloatField;
    ppReport2: TppReport;
    ppHeaderBand3: TppHeaderBand;
    ppDetailBand3: TppDetailBand;
    ppFooterBand3: TppFooterBand;
    ppLabel72: TppLabel;
    ppLabel73: TppLabel;
    ppLabel74: TppLabel;
    ppLabel75: TppLabel;
    ppDBText5: TppDBText;
    ppDBText6: TppDBText;
    ppDBText17: TppDBText;
    ppDBText18: TppDBText;
    ppDBText19: TppDBText;
    ppDBText20: TppDBText;
    ppDBText27: TppDBText;
    ppDBText28: TppDBText;
    ppDBText29: TppDBText;
    ppDBText35: TppDBText;
    ppDBText37: TppDBText;
    ppDBText38: TppDBText;
    ppDBText39: TppDBText;
    ppDBText40: TppDBText;
    ppLine36: TppLine;
    ppLabel76: TppLabel;
    ppLabel77: TppLabel;
    ppLabel78: TppLabel;
    ppLabel79: TppLabel;
    ppLabel80: TppLabel;
    ppLabel81: TppLabel;
    ppLabel82: TppLabel;
    ppLabel83: TppLabel;
    ppLabel84: TppLabel;
    ppLabel85: TppLabel;
    ppLabel87: TppLabel;
    ppLabel88: TppLabel;
    ppLine37: TppLine;
    ppLine38: TppLine;
    ppLine39: TppLine;
    ppLine40: TppLine;
    ppLine41: TppLine;
    ppLine42: TppLine;
    ppLine43: TppLine;
    ppLine44: TppLine;
    ppLine45: TppLine;
    ppLine46: TppLine;
    ppLine47: TppLine;
    ppLine49: TppLine;
    ppLine50: TppLine;
    ppLabel89: TppLabel;
    ppSummaryBand3: TppSummaryBand;
    ppSystemVariable5: TppSystemVariable;
    ppSystemVariable6: TppSystemVariable;
    ppLine51: TppLine;
    ppLine52: TppLine;
    ppLine53: TppLine;
    ppLine54: TppLine;
    ppLine55: TppLine;
    ppLabel90: TppLabel;
    ppDBCalc5: TppDBCalc;
    ppDBCalc6: TppDBCalc;
    ppDBCalc7: TppDBCalc;
    ppDBCalc8: TppDBCalc;
    ppLabel91: TppLabel;
    ppLine56: TppLine;
    ppLabel92: TppLabel;
    ppLabel93: TppLabel;
    ppLabel94: TppLabel;
    ppLabel95: TppLabel;
    ppLabel96: TppLabel;
    ppLabel97: TppLabel;
    ppDBText42: TppDBText;
    ppDBText43: TppDBText;
    ppLabel99: TppLabel;
    ppDBCalc10: TppDBCalc;
    ppReport3: TppReport;
    ppHeaderBand4: TppHeaderBand;
    ppLabel86: TppLabel;
    ppLabel98: TppLabel;
    ppLabel100: TppLabel;
    ppLabel101: TppLabel;
    ppLabel102: TppLabel;
    ppLabel103: TppLabel;
    ppLabel104: TppLabel;
    ppLabel105: TppLabel;
    ppLabel106: TppLabel;
    ppLabel108: TppLabel;
    ppLabel109: TppLabel;
    ppLabel110: TppLabel;
    ppLabel111: TppLabel;
    ppLine48: TppLine;
    ppLine57: TppLine;
    ppLine58: TppLine;
    ppLine59: TppLine;
    ppLine60: TppLine;
    ppLine61: TppLine;
    ppLine63: TppLine;
    ppLine64: TppLine;
    ppLine65: TppLine;
    ppLine66: TppLine;
    ppLine69: TppLine;
    ppLine70: TppLine;
    ppLine71: TppLine;
    ppLine72: TppLine;
    ppDetailBand4: TppDetailBand;
    ppDBText36: TppDBText;
    ppDBText44: TppDBText;
    ppDBText45: TppDBText;
    ppDBText46: TppDBText;
    ppDBText48: TppDBText;
    ppDBText49: TppDBText;
    ppDBText50: TppDBText;
    ppDBText51: TppDBText;
    ppDBText54: TppDBText;
    ppDBText55: TppDBText;
    ppDBText56: TppDBText;
    ppLine74: TppLine;
    ppDBText57: TppDBText;
    ppLabel115: TppLabel;
    ppDBText58: TppDBText;
    ppDBText59: TppDBText;
    ppFooterBand4: TppFooterBand;
    ppSystemVariable7: TppSystemVariable;
    ppSystemVariable8: TppSystemVariable;
    ppSummaryBand4: TppSummaryBand;
    ppLabel116: TppLabel;
    ppDBCalc14: TppDBCalc;
    ppDBCalc15: TppDBCalc;
    ppDBCalc16: TppDBCalc;
    ppDBCalc17: TppDBCalc;
    ppLabel117: TppLabel;
    ppLine75: TppLine;
    ppLabel118: TppLabel;
    ppLabel119: TppLabel;
    ppLabel120: TppLabel;
    ppLabel121: TppLabel;
    ppLabel122: TppLabel;
    ppLabel123: TppLabel;
    ppDBCalc18: TppDBCalc;
    ppDBText47: TppDBText;
    ppDBText52: TppDBText;
    ppLabel107: TppLabel;
    ppLine62: TppLine;
    ppDBText53: TppDBText;
    wwQuery2: TwwQuery;
    ppDBText60: TppDBText;
    ppLabel112: TppLabel;
    qPrintTPNakl: TStringField;
    ppLabel113: TppLabel;
    ppLine67: TppLine;
    ppLabel114: TppLabel;
    ppLine68: TppLine;
    ppLabel124: TppLabel;
    ppLine73: TppLine;
    ppLabel125: TppLabel;
    ppLine76: TppLine;
    ppLabel126: TppLabel;
    ppLine77: TppLine;
    ppLabel127: TppLabel;
    ppLine78: TppLine;
    ppLabel128: TppLabel;
    ppLine79: TppLine;
    ppLabel129: TppLabel;
    ppLine80: TppLine;
    ppDBCalc19: TppDBCalc;
    SourceProv: TwwDataSource;
    ppBDEPipeline3: TppBDEPipeline;
    ppSubReport1: TppSubReport;
    ppChildReport1: TppChildReport;
    ppDetailBand5: TppDetailBand;
    ppDBText41: TppDBText;
    ppDBText61: TppDBText;
    ppDBText62: TppDBText;
    ppDBText63: TppDBText;
    ppDBText64: TppDBText;
    ppLabel130: TppLabel;
    ppReport4: TppReport;
    ppHeaderBand5: TppHeaderBand;
    ppLabel131: TppLabel;
    ppLabel132: TppLabel;
    ppLabel133: TppLabel;
    ppLabel134: TppLabel;
    ppLabel135: TppLabel;
    ppLabel136: TppLabel;
    ppLabel137: TppLabel;
    ppLabel138: TppLabel;
    ppLabel139: TppLabel;
    ppLabel140: TppLabel;
    ppLabel141: TppLabel;
    ppLabel142: TppLabel;
    ppLabel143: TppLabel;
    ppLabel144: TppLabel;
    ppLabel145: TppLabel;
    ppLabel146: TppLabel;
    ppLine81: TppLine;
    ppLine82: TppLine;
    ppLine83: TppLine;
    ppLine84: TppLine;
    ppLine85: TppLine;
    ppLine86: TppLine;
    ppLine87: TppLine;
    ppLine88: TppLine;
    ppLine89: TppLine;
    ppLine90: TppLine;
    ppLine91: TppLine;
    ppLine92: TppLine;
    ppLine93: TppLine;
    ppLabel147: TppLabel;
    ppLine94: TppLine;
    ppLine95: TppLine;
    ppLine96: TppLine;
    ppLine97: TppLine;
    ppLine98: TppLine;
    ppDetailBand6: TppDetailBand;
    ppDBText65: TppDBText;
    ppDBText66: TppDBText;
    ppDBText67: TppDBText;
    ppDBText68: TppDBText;
    ppDBText69: TppDBText;
    ppDBText70: TppDBText;
    ppDBText71: TppDBText;
    ppDBText72: TppDBText;
    ppDBText73: TppDBText;
    ppDBText74: TppDBText;
    ppDBText75: TppDBText;
    ppDBText76: TppDBText;
    ppDBText77: TppDBText;
    ppDBText78: TppDBText;
    ppLine99: TppLine;
    ppLabel148: TppLabel;
    ppDBText79: TppDBText;
    ppDBText80: TppDBText;
    ppDBText81: TppDBText;
    ppDBText82: TppDBText;
    ppLabel149: TppLabel;
    ppFooterBand5: TppFooterBand;
    ppSystemVariable9: TppSystemVariable;
    ppSystemVariable10: TppSystemVariable;
    ppSummaryBand5: TppSummaryBand;
    ppLabel150: TppLabel;
    ppDBCalc20: TppDBCalc;
    ppDBCalc21: TppDBCalc;
    ppDBCalc22: TppDBCalc;
    ppDBCalc23: TppDBCalc;
    ppLabel151: TppLabel;
    ppLine100: TppLine;
    ppLabel152: TppLabel;
    ppLabel153: TppLabel;
    ppLabel154: TppLabel;
    ppLabel155: TppLabel;
    ppLabel156: TppLabel;
    ppLabel157: TppLabel;
    ppDBCalc24: TppDBCalc;
    ppLabel158: TppLabel;
    ppLine101: TppLine;
    ppLabel159: TppLabel;
    ppLine102: TppLine;
    ppLabel160: TppLabel;
    ppLine103: TppLine;
    ppLabel161: TppLabel;
    ppLine104: TppLine;
    ppLabel162: TppLabel;
    ppLine105: TppLine;
    ppLabel163: TppLabel;
    ppLine106: TppLine;
    ppLabel164: TppLabel;
    ppLine107: TppLine;
    ppLabel165: TppLabel;
    ppLine108: TppLine;
    ppDBCalc25: TppDBCalc;
    ppSubReport2: TppSubReport;
    ppChildReport2: TppChildReport;
    ppDetailBand7: TppDetailBand;
    ppDBText83: TppDBText;
    ppDBText84: TppDBText;
    ppDBText85: TppDBText;
    ppDBText86: TppDBText;
    ppDBText87: TppDBText;
    ppLabel166: TppLabel;
    ppLabel167: TppLabel;
    ppSubReport3: TppSubReport;
    ppChildReport3: TppChildReport;
    ppDetailBand8: TppDetailBand;
    ppDBText88: TppDBText;
    ppDBText89: TppDBText;
    ppDBText90: TppDBText;
    ppDBText91: TppDBText;
    ppDBText92: TppDBText;
    wwQuery2STov: TFloatField;
    wwQuery2STara: TFloatField;
    wwQuery2STov2: TFloatField;
    wwQuery2STara2: TFloatField;
    ppLabel168: TppLabel;
    ppLine109: TppLine;
    ppDBText93: TppDBText;
    qPrintFas: TStringField;
    ppReport5: TppReport;
    ppHeaderBand6: TppHeaderBand;
    ppLabel169: TppLabel;
    ppLabel170: TppLabel;
    ppLabel171: TppLabel;
    ppLabel172: TppLabel;
    ppLabel173: TppLabel;
    ppLabel174: TppLabel;
    ppLabel175: TppLabel;
    ppLabel176: TppLabel;
    ppLabel177: TppLabel;
    ppLabel178: TppLabel;
    ppLabel179: TppLabel;
    ppLabel180: TppLabel;
    ppLabel181: TppLabel;
    ppLine110: TppLine;
    ppLine111: TppLine;
    ppLine112: TppLine;
    ppLine113: TppLine;
    ppLine114: TppLine;
    ppLine115: TppLine;
    ppLine116: TppLine;
    ppLine117: TppLine;
    ppLine118: TppLine;
    ppLine119: TppLine;
    ppLine120: TppLine;
    ppLine121: TppLine;
    ppLine122: TppLine;
    ppLine123: TppLine;
    ppLabel182: TppLabel;
    ppLine124: TppLine;
    ppDetailBand9: TppDetailBand;
    ppDBText94: TppDBText;
    ppDBText95: TppDBText;
    ppDBText96: TppDBText;
    ppDBText97: TppDBText;
    ppDBText98: TppDBText;
    ppDBText99: TppDBText;
    ppDBText100: TppDBText;
    ppDBText101: TppDBText;
    ppDBText102: TppDBText;
    ppDBText103: TppDBText;
    ppLine125: TppLine;
    ppDBText104: TppDBText;
    ppLabel183: TppLabel;
    ppDBText105: TppDBText;
    ppDBText106: TppDBText;
    ppDBText107: TppDBText;
    ppDBText108: TppDBText;
    ppDBText109: TppDBText;
    ppFooterBand6: TppFooterBand;
    ppSystemVariable11: TppSystemVariable;
    ppSystemVariable12: TppSystemVariable;
    ppSummaryBand6: TppSummaryBand;
    ppLabel184: TppLabel;
    ppDBCalc26: TppDBCalc;
    ppDBCalc27: TppDBCalc;
    ppDBCalc28: TppDBCalc;
    ppDBCalc29: TppDBCalc;
    ppLabel185: TppLabel;
    ppLine126: TppLine;
    ppLabel186: TppLabel;
    ppLabel187: TppLabel;
    ppLabel188: TppLabel;
    ppLabel189: TppLabel;
    ppLabel190: TppLabel;
    ppLabel191: TppLabel;
    ppDBCalc30: TppDBCalc;
    ppLabel192: TppLabel;
    ppSubReport4: TppSubReport;
    ppChildReport4: TppChildReport;
    ppDetailBand10: TppDetailBand;
    ppDBText110: TppDBText;
    ppDBText111: TppDBText;
    ppDBText112: TppDBText;
    ppDBText113: TppDBText;
    ppDBText114: TppDBText;
    ppLabel193: TppLabel;
    ppLine127: TppLine;
    ppLabel194: TppLabel;
    ppLine128: TppLine;
    ppDBText115: TppDBText;
    ppDBText116: TppDBText;
    ppDBCalc31: TppDBCalc;
    ppReport6: TppReport;
    ppHeaderBand7: TppHeaderBand;
    ppLabel195: TppLabel;
    ppLabel196: TppLabel;
    ppLabel197: TppLabel;
    ppLabel198: TppLabel;
    ppLabel199: TppLabel;
    ppLabel200: TppLabel;
    ppLabel201: TppLabel;
    ppLabel202: TppLabel;
    ppLine129: TppLine;
    ppLine130: TppLine;
    ppLine131: TppLine;
    ppLine132: TppLine;
    ppLine133: TppLine;
    ppLine142: TppLine;
    ppLine143: TppLine;
    ppLine144: TppLine;
    ppLabel212: TppLabel;
    ppLine147: TppLine;
    ppDetailBand11: TppDetailBand;
    ppDBText117: TppDBText;
    ppDBText118: TppDBText;
    ppDBText119: TppDBText;
    ppDBText128: TppDBText;
    ppDBText129: TppDBText;
    ppDBText130: TppDBText;
    ppLine148: TppLine;
    ppLabel213: TppLabel;
    ppDBText131: TppDBText;
    ppDBText132: TppDBText;
    ppDBText134: TppDBText;
    ppLabel214: TppLabel;
    ppDBText135: TppDBText;
    ppFooterBand7: TppFooterBand;
    ppSystemVariable13: TppSystemVariable;
    ppSystemVariable14: TppSystemVariable;
    ppSummaryBand7: TppSummaryBand;
    ppLabel215: TppLabel;
    ppDBCalc32: TppDBCalc;
    ppLabel216: TppLabel;
    ppLine149: TppLine;
    ppLabel217: TppLabel;
    ppLabel218: TppLabel;
    ppLabel219: TppLabel;
    ppLabel220: TppLabel;
    ppLabel221: TppLabel;
    ppLabel222: TppLabel;
    ppDBCalc36: TppDBCalc;
    ppLabel223: TppLabel;
    ppLine150: TppLine;
    ppLabel224: TppLabel;
    ppLine151: TppLine;
    ppLabel225: TppLabel;
    ppLine152: TppLine;
    ppLabel226: TppLabel;
    ppLine153: TppLine;
    ppLabel227: TppLabel;
    ppLine154: TppLine;
    ppLabel228: TppLabel;
    ppLine155: TppLine;
    ppLabel229: TppLabel;
    ppLine156: TppLine;
    ppLabel230: TppLabel;
    ppLine157: TppLine;
    ppDBCalc37: TppDBCalc;
    ppSubReport5: TppSubReport;
    ppChildReport5: TppChildReport;
    ppDetailBand12: TppDetailBand;
    ppDBText136: TppDBText;
    ppDBText137: TppDBText;
    ppDBText138: TppDBText;
    ppDBText139: TppDBText;
    ppDBText140: TppDBText;
    ppLabel231: TppLabel;
    ppDBText120: TppDBText;
    ppLine134: TppLine;
    ppParameterList1: TppParameterList;
    qPrintMassaGruza: TFloatField;
    qPrintSumrwNDS: TFloatField;
    qPrintSumNDS10: TIntegerField;
    qPrintSumNDS20: TIntegerField;
    qPrintSumbNDS10: TIntegerField;
    qPrintSumbNDS20: TIntegerField;
    qPrintTaraNDS: TIntegerField;
    qPrintTarabNDS: TIntegerField;
    qPrintNac: TFloatField;
    qPrintNormOthod: TFloatField;
    qPrintSymNOthod: TFloatField;
    qPrintAddSuppl: TFloatField;
    Memo1: TMemo;
    qPrintGrMest: TFloatField;
ppReport7: TppReport;
    ppHeaderBand8: TppHeaderBand;
    ppLabel203: TppLabel;
    ppLabel204: TppLabel;
    ppLabel205: TppLabel;
    ppLabel206: TppLabel;
    ppLabel207: TppLabel;
    ppLabel208: TppLabel;
    ppLabel209: TppLabel;
    ppLabel210: TppLabel;
    ppLabel211: TppLabel;
    ppLabel232: TppLabel;
    ppLabel233: TppLabel;
    ppLabel234: TppLabel;
    ppLabel235: TppLabel;
    ppLine135: TppLine;
    ppLine136: TppLine;
    ppLine137: TppLine;
    ppLine138: TppLine;
    ppLine139: TppLine;
    ppLine140: TppLine;
    ppLine141: TppLine;
    ppLabel236: TppLabel;
    ppLine145: TppLine;
    ppLine146: TppLine;
    ppLine158: TppLine;
    ppLine159: TppLine;
    ppLabel237: TppLabel;
    ppLine160: TppLine;
    ppLine161: TppLine;
    ppLine162: TppLine;
    ppLine163: TppLine;
    ppLine164: TppLine;
    ppLine165: TppLine;
    ppDetailBand13: TppDetailBand;
    ppDBText121: TppDBText;
    ppDBText122: TppDBText;
    ppDBText123: TppDBText;
    ppDBText124: TppDBText;
    ppDBText125: TppDBText;
    ppDBText126: TppDBText;
    ppDBText127: TppDBText;
    ppDBText133: TppDBText;
    ppDBText141: TppDBText;
    ppDBText142: TppDBText;
    ppDBText143: TppDBText;
    ppLine166: TppLine;
    ppLabel238: TppLabel;
    ppDBText144: TppDBText;
    ppDBText145: TppDBText;
    ppDBText146: TppDBText;
    ppLabel239: TppLabel;
    ppDBText147: TppDBText;
    ppFooterBand8: TppFooterBand;
    ppSystemVariable15: TppSystemVariable;
    ppSystemVariable16: TppSystemVariable;
    ppSummaryBand8: TppSummaryBand;
    ppLabel240: TppLabel;
    ppDBCalc33: TppDBCalc;
    ppDBCalc34: TppDBCalc;
    ppDBCalc35: TppDBCalc;
    ppDBCalc38: TppDBCalc;
    ppLabel241: TppLabel;
    ppLine167: TppLine;
    ppLabel242: TppLabel;
    ppLabel243: TppLabel;
    ppLabel244: TppLabel;
    ppLabel245: TppLabel;
    ppLabel246: TppLabel;
    ppLabel247: TppLabel;
    ppDBCalc39: TppDBCalc;
    ppLabel248: TppLabel;
    ppLine168: TppLine;
    ppLabel249: TppLabel;
    ppLine169: TppLine;
    ppLabel250: TppLabel;
    ppLine170: TppLine;
    ppLabel251: TppLabel;
    ppLine171: TppLine;
    ppLabel252: TppLabel;
    ppLine172: TppLine;
    ppLabel253: TppLabel;
    ppLine173: TppLine;
    ppLabel254: TppLabel;
    ppLine174: TppLine;
    ppLabel255: TppLabel;
    ppLine175: TppLine;
    ppDBCalc40: TppDBCalc;
    ppSubReport6: TppSubReport;
    ppChildReport6: TppChildReport;
    ppDetailBand14: TppDetailBand;
    ppDBText148: TppDBText;
    ppDBText149: TppDBText;
    ppDBText150: TppDBText;
    ppDBText151: TppDBText;
    ppDBText152: TppDBText;
    ppLabel256: TppLabel;
    ppParameterList2: TppParameterList;
    ppDBCalc41: TppDBCalc;
    provST: TFloatField;
    qPrintGGR: TStringField;
    qPrintVY: TStringField;
    QPrVidNad: TIntegerField;
    QPrFas: TFloatField;
    qPrintSumNDSO: TFloatField;
    QPrPriceSr: TFloatField;
    ProtocolCen: TppReport;
    ppParameterList3: TppParameterList;
    ppHeaderBand9: TppHeaderBand;
    ppLabel257: TppLabel;
    ppLabel258: TppLabel;
    ppLabel259: TppLabel;
    ppLabel260: TppLabel;
    ppLabel261: TppLabel;
    ppLabel263: TppLabel;
    ppLabel265: TppLabel;
    ppLabel266: TppLabel;
    ppLabel268: TppLabel;
    ppLabel269: TppLabel;
    ppLine176: TppLine;
    ppLine177: TppLine;
    ppLine178: TppLine;
    ppLine179: TppLine;
    ppLine180: TppLine;
    ppLine182: TppLine;
    ppLine183: TppLine;
    ppLine184: TppLine;
    ppLine185: TppLine;
    ppLine186: TppLine;
    ppLine187: TppLine;
    ppLine188: TppLine;
    ppLine189: TppLine;
    ppLabel270: TppLabel;
    ppLine190: TppLine;
    ppLine192: TppLine;
    ppDetailBand15: TppDetailBand;
    ppDBText153: TppDBText;
    ppDBText154: TppDBText;
    ppDBText156: TppDBText;
    ppDBText158: TppDBText;
    ppDBText159: TppDBText;
    ppDBText160: TppDBText;
    ppLine193: TppLine;
    ppDBText162: TppDBText;
    ppDBText166: TppDBText;
    ppDBText167: TppDBText;
    ppDBText170: TppDBText;
    ppFooterBand9: TppFooterBand;
    ppSystemVariable17: TppSystemVariable;
    ppSystemVariable18: TppSystemVariable;
    ppLabel262: TppLabel;
    ppLabel264: TppLabel;
    ppLabel267: TppLabel;
    ppLabel271: TppLabel;
    qPrintKach: TStringField;
    qPrintSumsNDS: TFloatField;
    ReestrCen: TppReport;
    ppParameterList4: TppParameterList;
    ppHeaderBand10: TppHeaderBand;
    ppLabel274: TppLabel;
    ppLabel275: TppLabel;
    ppLabel276: TppLabel;
    ppLabel278: TppLabel;
    ppLabel279: TppLabel;
    ppLabel280: TppLabel;
    ppLabel281: TppLabel;
    ppLabel283: TppLabel;
    ppLabel284: TppLabel;
    ppLabel285: TppLabel;
    ppLabel286: TppLabel;
    ppLabel287: TppLabel;
    ppLine181: TppLine;
    ppLine191: TppLine;
    ppLine194: TppLine;
    ppLine196: TppLine;
    ppLine197: TppLine;
    ppLine200: TppLine;
    ppLine201: TppLine;
    ppLine202: TppLine;
    ppLine203: TppLine;
    ppLine204: TppLine;
    ppLine205: TppLine;
    ppLine206: TppLine;
    ppLine207: TppLine;
    ppLine208: TppLine;
    ppLine210: TppLine;
    ppDetailBand16: TppDetailBand;
    ppDBText155: TppDBText;
    ppDBText157: TppDBText;
    ppDBText161: TppDBText;
    ppDBText163: TppDBText;
    ppDBText164: TppDBText;
    ppDBText165: TppDBText;
    ppDBText168: TppDBText;
    ppDBText169: TppDBText;
    ppDBText171: TppDBText;
    ppDBText172: TppDBText;
    ppDBText173: TppDBText;
    ppDBText174: TppDBText;
    ppDBText175: TppDBText;
    ppLine211: TppLine;
    ppFooterBand10: TppFooterBand;
    ppSystemVariable19: TppSystemVariable;
    ppSystemVariable20: TppSystemVariable;
    ppLabel272: TppLabel;
    ppLine195: TppLine;
    ppLabel273: TppLabel;
    ppLabel277: TppLabel;
    ppTitleBand2: TppTitleBand;
    ppLabel282: TppLabel;
    ppLabel288: TppLabel;
    ppLabel289: TppLabel;
    qPrintSumTorg: TFloatField;
    qPrintPriceBottle: TFloatField;
    ppDBText176: TppDBText;
    ppDBText177: TppDBText;
    ppLine198: TppLine;
    ppLine199: TppLine;
    ppSummaryBand9: TppSummaryBand;
    ppLabel290: TppLabel;
    ppSummaryBand10: TppSummaryBand;
    ppLabel291: TppLabel;
    ppLabel292: TppLabel;
    ppLabel293: TppLabel;
    ppLabel294: TppLabel;
    ppLabel295: TppLabel;
    ppLabel296: TppLabel;
    ppLabel297: TppLabel;
    ppLabel298: TppLabel;
    ppDBCalc42: TppDBCalc;
    ppDBCalc43: TppDBCalc;
    ppDBCalc44: TppDBCalc;
    ppDBCalc45: TppDBCalc;
    ppDBCalc46: TppDBCalc;
    QPrSkidV: TFloatField;
    ppLine209: TppLine;
    ppLabel299: TppLabel;
    ppDBText178: TppDBText;
    ppDBCalc47: TppDBCalc;
    Eda: TppReport;
    ppParameterList5: TppParameterList;
    ppHeaderBand11: TppHeaderBand;
    ppLabel300: TppLabel;
    ppLabel301: TppLabel;
    ppLabel302: TppLabel;
    ppLabel303: TppLabel;
    ppLabel304: TppLabel;
    ppLabel305: TppLabel;
    ppLabel306: TppLabel;
    ppLabel307: TppLabel;
    ppLabel308: TppLabel;
    ppLabel309: TppLabel;
    ppLabel310: TppLabel;
    ppLabel312: TppLabel;
    ppLine212: TppLine;
    ppLine213: TppLine;
    ppLine214: TppLine;
    ppLine215: TppLine;
    ppLine216: TppLine;
    ppLine217: TppLine;
    ppLine218: TppLine;
    ppLine219: TppLine;
    ppLine220: TppLine;
    ppLine222: TppLine;
    ppLine223: TppLine;
    ppLine224: TppLine;
    ppLine225: TppLine;
    ppLabel313: TppLabel;
    ppLine226: TppLine;
    ppLabel314: TppLabel;
    ppLine227: TppLine;
    ppLabel315: TppLabel;
    ppLine228: TppLine;
    ppDetailBand17: TppDetailBand;
    ppDBText179: TppDBText;
    ppDBText180: TppDBText;
    ppDBText181: TppDBText;
    ppDBText184: TppDBText;
    ppDBText185: TppDBText;
    ppDBText186: TppDBText;
    ppDBText187: TppDBText;
    ppLine229: TppLine;
    ppDBText192: TppDBText;
    ppFooterBand11: TppFooterBand;
    ppSystemVariable21: TppSystemVariable;
    ppSystemVariable22: TppSystemVariable;
    ppSummaryBand11: TppSummaryBand;
    ppLabel317: TppLabel;
    ppLabel318: TppLabel;
    ppLine230: TppLine;
    ppLabel325: TppLabel;
    ppDBText183: TppDBText;
    ppDBText189: TppDBText;
    ppDBText190: TppDBText;
    ppDBText191: TppDBText;
    ppDBText182: TppDBText;
    qPrintEd: TIntegerField;
    ppGroup1: TppGroup;
    ppGroupHeaderBand1: TppGroupHeaderBand;
    ppGroupFooterBand1: TppGroupFooterBand;
    ppLabel311: TppLabel;
    ppDBCalc48: TppDBCalc;
    ppDBCalc49: TppDBCalc;
    ppDBCalc50: TppDBCalc;
    ppDBCalc51: TppDBCalc;
    ppDBCalc52: TppDBCalc;
    ppSubReport7: TppSubReport;
    ppChildReport7: TppChildReport;
    ppDetailBand18: TppDetailBand;
    ppDBText188: TppDBText;
    ppDBText193: TppDBText;
    ppDBText194: TppDBText;
    ppDBText195: TppDBText;
    ppDBText196: TppDBText;
    ppHeaderBand12: TppHeaderBand;
    ppLabel316: TppLabel;
    ppLabel324: TppLabel;
    ppLabel326: TppLabel;
    ppLine221: TppLine;
    ppLine231: TppLine;
    ppLine232: TppLine;
    ppLine233: TppLine;
    ppLine234: TppLine;
    ppLine235: TppLine;
    ppLabel327: TppLabel;
    ppDBCalc53: TppDBCalc;
    ppDBCalc54: TppDBCalc;
    ppDBCalc55: TppDBCalc;
    ppDBCalc56: TppDBCalc;
    ppDBCalc57: TppDBCalc;
    ppGroup2: TppGroup;
    ppGroupHeaderBand2: TppGroupHeaderBand;
    ppGroupFooterBand2: TppGroupFooterBand;
    ppDBText197: TppDBText;
    ppLabel319: TppLabel;
    ppDBCalc58: TppDBCalc;
    ppDBCalc59: TppDBCalc;
    ppDBCalc60: TppDBCalc;
    ppDBCalc61: TppDBCalc;
    ppDBCalc62: TppDBCalc;
    ppDBCalc63: TppDBCalc;
    ppLabel320: TppLabel;
    ppReport8: TppReport;
    ppParameterList6: TppParameterList;
    ppTitleBand3: TppTitleBand;
    ppLabel321: TppLabel;
    ppLabel322: TppLabel;
    ppLabel323: TppLabel;
    ppHeaderBand13: TppHeaderBand;
    ppLabel328: TppLabel;
    ppLabel329: TppLabel;
    ppLabel330: TppLabel;
    ppLabel331: TppLabel;
    ppLabel332: TppLabel;
    ppLabel333: TppLabel;
    ppLabel336: TppLabel;
    ppLabel337: TppLabel;
    ppLabel338: TppLabel;
    ppLabel339: TppLabel;
    ppLine236: TppLine;
    ppLine237: TppLine;
    ppLine238: TppLine;
    ppLine239: TppLine;
    ppLine240: TppLine;
    ppLine242: TppLine;
    ppLine243: TppLine;
    ppLine244: TppLine;
    ppLine245: TppLine;
    ppLine246: TppLine;
    ppLine247: TppLine;
    ppLine248: TppLine;
    ppLine249: TppLine;
    ppLine250: TppLine;
    ppLine254: TppLine;
    ppLabel343: TppLabel;
    ppDetailBand19: TppDetailBand;
    ppDBText198: TppDBText;
    ppDBText200: TppDBText;
    ppDBText201: TppDBText;
    ppDBText204: TppDBText;
    ppDBText205: TppDBText;
    ppDBText206: TppDBText;
    ppDBText207: TppDBText;
    ppDBText208: TppDBText;
    ppDBText209: TppDBText;
    ppDBText210: TppDBText;
    ppLine255: TppLine;
    ppDBText213: TppDBText;
    ppFooterBand12: TppFooterBand;
    ppSystemVariable23: TppSystemVariable;
    ppSystemVariable24: TppSystemVariable;
    ppSummaryBand12: TppSummaryBand;
    ppLabel344: TppLabel;
    ppLabel345: TppLabel;
    ppDBCalc64: TppDBCalc;
    ppDBCalc66: TppDBCalc;
    ppDBCalc67: TppDBCalc;
    ppDBCalc69: TppDBCalc;
    ppGroup3: TppGroup;
    ppGroupHeaderBand3: TppGroupHeaderBand;
    ppDBText214: TppDBText;
    ppLabel346: TppLabel;
    ppGroupFooterBand3: TppGroupFooterBand;
    ppDBCalc70: TppDBCalc;
    ppDBCalc72: TppDBCalc;
    ppDBCalc73: TppDBCalc;
    ppDBCalc75: TppDBCalc;
    ppLabel347: TppLabel;
    ppDBText199: TppDBText;
    ppLabel334: TppLabel;
    ppDBText202: TppDBText;
    ppLabel335: TppLabel;
    ppLine241: TppLine;
    ppDBCalc65: TppDBCalc;
    ppDBCalc68: TppDBCalc;
    PRNSSkidNakl: TFloatField;
    qPrintPriceFN: TFloatField;
    ppReport9: TppReport;
    ppParameterList7: TppParameterList;
    ppHeaderBand14: TppHeaderBand;
    ppLine251: TppLine;
    ppLine252: TppLine;
    ppLine253: TppLine;
    ppLine256: TppLine;
    ppLabel340: TppLabel;
    ppLabel341: TppLabel;
    ppLabel342: TppLabel;
    ppLabel348: TppLabel;
    ppLabel349: TppLabel;
    ppLine257: TppLine;
    ppLabel350: TppLabel;
    ppLabel351: TppLabel;
    ppLabel352: TppLabel;
    ppLine258: TppLine;
    ppLine259: TppLine;
    ppLabel353: TppLabel;
    ppLabel354: TppLabel;
    ppLabel355: TppLabel;
    ppLine260: TppLine;
    ppLabel356: TppLabel;
    ppLabel357: TppLabel;
    ppLine261: TppLine;
    ppLabel358: TppLabel;
    ppLabel359: TppLabel;
    ppLine262: TppLine;
    ppLabel360: TppLabel;
    ppLabel361: TppLabel;
    ppLine263: TppLine;
    ppLabel362: TppLabel;
    ppLabel363: TppLabel;
    ppLabel364: TppLabel;
    ppLabel365: TppLabel;
    ppLine264: TppLine;
    ppLine265: TppLine;
    ppLine266: TppLine;
    ppLabel366: TppLabel;
    ppLabel367: TppLabel;
    ppDetailBand20: TppDetailBand;
    ppDBText203: TppDBText;
    ppDBText211: TppDBText;
    ppDBText212: TppDBText;
    ppDBText215: TppDBText;
    ppDBText216: TppDBText;
    ppDBText217: TppDBText;
    ppDBText218: TppDBText;
    ppDBText219: TppDBText;
    ppDBText220: TppDBText;
    ppDBText221: TppDBText;
    ppDBText222: TppDBText;
    ppLabel368: TppLabel;
    ppLine267: TppLine;
    ppFooterBand13: TppFooterBand;
    ppSystemVariable25: TppSystemVariable;
    ppSystemVariable26: TppSystemVariable;
    ppLabel369: TppLabel;
    ppSummaryBand13: TppSummaryBand;
    ppLabel370: TppLabel;
    ppDBCalc71: TppDBCalc;
    ppDBCalc74: TppDBCalc;
    ppDBCalc76: TppDBCalc;
    ppDBCalc77: TppDBCalc;
    ppLine268: TppLine;
    ppLabel371: TppLabel;
    ppGroup5: TppGroup;
    ppGroupHeaderBand5: TppGroupHeaderBand;
    ppGroupFooterBand5: TppGroupFooterBand;
    ppDBText223: TppDBText;
    ppDBCalc78: TppDBCalc;
    ppDBCalc79: TppDBCalc;
    ppDBCalc80: TppDBCalc;
    ppDBCalc81: TppDBCalc;
    ppLabel372: TppLabel;
    ppDBText224: TppDBText;
    QPrYbil: TFloatField;
    QPrSocialnost: TIntegerField;
    PRNZPogruzkaIsp: TStringField;
    PRNZPogruzkaPrib: TStringField;
    PRNZPogruzkaSpos: TStringField;
    PRNZPogruzkaYbit: TStringField;
    PRNZRazgrIsp: TStringField;
    PRNZRazgrPrib: TStringField;
    PRNZRazgrSpos: TStringField;
    PRNZRazgrYbit: TStringField;
    PRNSPricep: TStringField;
    ppReestrCen: TppReport;
    ppParameterList8: TppParameterList;
    ppTitleBand4: TppTitleBand;
    ppLabel373: TppLabel;
    ppDBText233: TppDBText;
    ppDBText234: TppDBText;
    ppHeaderBand15: TppHeaderBand;
    ppLabel376: TppLabel;
    ppLabel377: TppLabel;
    ppLabel378: TppLabel;
    ppLabel379: TppLabel;
    ppLabel381: TppLabel;
    ppLabel382: TppLabel;
    ppLabel384: TppLabel;
    ppLabel386: TppLabel;
    ppLine269: TppLine;
    ppLine270: TppLine;
    ppLine271: TppLine;
    ppLine273: TppLine;
    ppLine275: TppLine;
    ppLine276: TppLine;
    ppLine277: TppLine;
    ppLine279: TppLine;
    ppLine280: TppLine;
    ppLine281: TppLine;
    ppLine282: TppLine;
    ppLine284: TppLine;
    ppLabel380: TppLabel;
    ppLabel383: TppLabel;
    ppLine272: TppLine;
    ppDetailBand21: TppDetailBand;
    ppDBText225: TppDBText;
    ppDBText228: TppDBText;
    ppDBText229: TppDBText;
    ppDBText232: TppDBText;
    ppDBText236: TppDBText;
    ppDBText237: TppDBText;
    ppLine288: TppLine;
    ppDBText226: TppDBText;
    ppDBText227: TppDBText;
    ppDBText230: TppDBText;
    ppDBText231: TppDBText;
    ppFooterBand14: TppFooterBand;
    ppSystemVariable27: TppSystemVariable;
    ppSystemVariable28: TppSystemVariable;
    ppSummaryBand14: TppSummaryBand;
    ppLabel392: TppLabel;
    ppLabel393: TppLabel;
    ppLabel374: TppLabel;
    ppLine274: TppLine;
    ppLabel375: TppLabel;
    ppDBText235: TppDBText;
    ppDBCalc82: TppDBCalc;
    PRNSTransp: TFloatField;
    PRNSTpAdres: TMemoField;
    LimitKarta: TppReport;
    ppHeaderBand16: TppHeaderBand;
    ppDetailBand22: TppDetailBand;
    ppFooterBand15: TppFooterBand;
    ppTitleBand5: TppTitleBand;
    ppLabel385: TppLabel;
    ppLabel387: TppLabel;
    ppLabel388: TppLabel;
    ppLabel389: TppLabel;
    ppLabel390: TppLabel;
    ppLabel391: TppLabel;
    ppLabel394: TppLabel;
    ppLabel395: TppLabel;
    ppLabel396: TppLabel;
    ppDBText238: TppDBText;
    qPrintCar: TStringField;
    qPrintData: TDateField;
    qPrintNnak: TIntegerField;
    qPrintVoditel: TStringField;
    ppLine278: TppLine;
    ppLine283: TppLine;
    ppLabel397: TppLabel;
    ppLine285: TppLine;
    ppLine286: TppLine;
    ppLabel398: TppLabel;
    ppLine287: TppLine;
    ppLabel399: TppLabel;
    ppLine289: TppLine;
    ppLine290: TppLine;
    ppLabel400: TppLabel;
    ppLine291: TppLine;
    ppLabel401: TppLabel;
    ppLine292: TppLine;
    ppLabel402: TppLabel;
    ppLine293: TppLine;
    ppLabel403: TppLabel;
    ppLine294: TppLine;
    ppLabel404: TppLabel;
    ppLabel405: TppLabel;
    ppLabel406: TppLabel;
    ppLine295: TppLine;
    ppLine296: TppLine;
    ppVariable1: TppVariable;
    raCodeModule1: TraCodeModule;
    ppDBText239: TppDBText;
    ppDBText240: TppDBText;
    ppDBText241: TppDBText;
    ppDBText243: TppDBText;
    ppDBText244: TppDBText;
    ppDBText245: TppDBText;
    ppSystemVariable29: TppSystemVariable;
    ppSystemVariable30: TppSystemVariable;
    ppSummaryBand15: TppSummaryBand;
    ppLabel407: TppLabel;
    ppDBCalc83: TppDBCalc;
    ppLabel408: TppLabel;
    ppLabel409: TppLabel;
    ppLabel410: TppLabel;
    ppLabel411: TppLabel;
    ppParameterList9: TppParameterList;
    ppLine297: TppLine;
    ppDBMemo1: TppDBMemo;
    ppLine298: TppLine;
    ppLabel412: TppLabel;
    ppDBText242: TppDBText;
    qPrintMassaGruzaB: TFloatField;
    PRNZPogruzkaProstoi: TStringField;
    PRNZRazgrProstoi: TStringField;
    PRNZTotalPackages: TIntegerField;
    QPrVes: TFloatField;
    qPrintDop1: TStringField;
    QPrPriceOpt: TFloatField;
    PRNZPreisk: TStringField;
    PRNZProt: TStringField;
    PRNZYK: TStringField;
    QPrNadT: TFloatField;
    procedure Rash2;
    procedure Rash1;
    procedure Rash_VC;
    procedure Rash_new;
    procedure Rash_tarabaz;
    procedure Rash_gal;
    procedure Rash_lopo;
    procedure Rash_lopobaz;
    procedure Rash_lopobaz2;
    procedure Rash_veg;
    procedure Rash_stol_baz;
    procedure Rash_stol_opt;
    procedure Rash_stol_baz2;
    procedure Rash_stol_bazopt;
    procedure Rash_stolbazPril;
    procedure Rash_veg_svoi;
    procedure Rash_lopoPril;
    procedure Rash_lopo_1;
    procedure Rash_lopo1;
    procedure Rash_lopo2;
    procedure Rash_lopo3;
    procedure Rash_lopo4;
    procedure Rash_lopo5;
    procedure Rash_stol;
    procedure Rash_stol2;
    procedure Rash_stol2Pril;
    procedure Rash_stol2Okr;
    procedure Rash_stol3;
    procedure Rash_stol4;
    procedure Enter;
    procedure Prich1;
    procedure PrichProiz;
    procedure Prich2;
    procedure Prich3cr;
    procedure Prich3;
    procedure Prich4;
    procedure Prich4Ivac;
    procedure Prich5;
    procedure Prich6;
    procedure Prich7;
    procedure Prich8;
    procedure PrichStol1;
    procedure PrichStol2;
    procedure PrichStol2cena;
    procedure PrichStol3;
    procedure PrichStol4;
    procedure Rash3;
    procedure Rash_new_2;
    procedure Rash_new_kobrin;
    procedure rash_Kobrin;
    procedure Rash_TN;
    procedure ppDetailBand1BeforeGenerate(Sender: TObject);
    procedure ppTitleBand1BeforeGenerate(Sender: TObject);
    procedure RashKyl;
    procedure Rash11;
    procedure Zagl;
    procedure ZaglN;
    procedure ZaglPr;
    procedure Podv;
    procedure ppDetailBand2BeforePrint(Sender: TObject);
    procedure ppDBCalc12Print(Sender: TObject);
    procedure ppDBCalc11Print(Sender: TObject);
    procedure ppDBCalc9Print(Sender: TObject);
    procedure ppDBCalc13Print(Sender: TObject);
    procedure ppLabel49GetText(Sender: TObject; var Text: String);
    procedure ppSummaryBand1BeforeGenerate(Sender: TObject);
    procedure ppHeaderBand2BeforeGenerate(Sender: TObject);
    procedure Rash_TTN_olsh;
    procedure Rash_iv21;
    procedure Prih_KSS;
    procedure Rash_One;
    procedure Rash_TN_Two;
    procedure Rash_One_2;
    procedure Rash_One_3;
    procedure Rash_album;
    procedure Rash_Vnu;
    procedure Rash_TTN_ruzh;
    procedure Rash_Vnytr;
    procedure ppHeaderBand3BeforeGenerate(Sender: TObject);
    procedure ppHeaderBand300BeforeGenerate(Sender: TObject);
    procedure ppDetailBand3BeforeGenerate(Sender: TObject);
    procedure ppDetailBand300BeforeGenerate(Sender: TObject);
    procedure ppDetailBand13BeforeGenerate(Sender: TObject);
    procedure ppSummaryBand3BeforeGenerate(Sender: TObject);
    procedure ppSummaryBand300BeforeGenerate(Sender: TObject);
    procedure RashNewKyl;
    procedure RashNewKyl1;
    procedure Rash_pruzh21;
    procedure ppDetailBand4BeforeGenerate(Sender: TObject);
    procedure ppSummaryBand4BeforeGenerate(Sender: TObject);
    procedure Rash_TN_toplivo;
    procedure Rash_album_2;
    procedure ppDetailBand6BeforeGenerate(Sender: TObject);
    procedure ppSummaryBand5BeforeGenerate(Sender: TObject);
    procedure ppHeaderBand5BeforeGenerate(Sender: TObject);
    procedure ppSummaryBand7BeforeGenerate(Sender: TObject);
    procedure ppDetailBand9BeforeGenerate(Sender: TObject);
    procedure ppHeaderBand8BeforeGenerate(Sender: TObject);
    procedure ppHeaderBand9BeforeGenerate(Sender: TObject);
    procedure Rash_gzk21;
    procedure Rash_TTN_brgzk;
    procedure Rash_proiz_ch;
    procedure Rash_proiz_sv;
    procedure Rash_proiz_sv_s;
    procedure Rash_proiz_sv_c;
    procedure Rash_ivac;
    procedure Rash_Domach;
    procedure Rash_Lotos;
    procedure Rash_KKP10_chujie;
    procedure Rash_KKP10_FN;
    procedure Rash_KKP20_FN;
    procedure Rash_KKP10_cena0;
    procedure Rash_KKP20_svoi;
    procedure Rash_KKP20_svoi_skid;
    procedure Rash_PinRin10;
    procedure Rash_PinRin11;
    procedure Rash_PinRin11Pril;
    procedure Rash_PinRin20;
    procedure Rash_PinRin21;
    procedure Rash_PinRin20_TN;
    procedure Rash_PinRin21_TN;
    procedure Rash_TN_VSr;
    procedure Rash_SrNad;
    procedure Rash_EDA;
    procedure Rash_GZK2;
    procedure Rash_GZK22;
    procedure Rash_Rozn20;
    procedure Rash_Rozn21;
    procedure Rash_Rozn21Pril;
    procedure Rash_Rozn22;
    procedure Rash_Rozn23;
    procedure Rash_Rozn24;
    procedure Rash_Rozn20TN;
    procedure Rash_Gor;
    procedure Rash_Opt;
    procedure Rash_BrRinTN;
    procedure Rash_BaseOpt;
    procedure Rash_OptBer;
    procedure Rash_BaseOptPril;
    procedure Rash_Obsch;
    procedure Rash_Obdrog;
    procedure Rash_Mag;
    procedure Rash_Alko;
    procedure Rash_AktSpis1;
    procedure Rash_AktSpis2;
    procedure Rash_Brrpo;
    procedure Rash_Brrpo1;
    procedure Rash_ivacbaza;
    procedure Rash_ivacbaza2;
    //procedure Rash_stol_baz;
    procedure Rash_ivacbazaPril;
    procedure Rash_lynrpo;
    procedure Rash_kolos;
    procedure Rash_kolosRozn;
    procedure Rash_kolosOpt;
    procedure ppHeaderBand4BeforeGenerate(Sender: TObject);
    procedure ppGroupHeaderBand1AfterGenerate(Sender: TObject);
    procedure ppHeaderBand11BeforeGenerate(Sender: TObject);
    procedure ppSummaryBand11BeforeGenerate(Sender: TObject);
    procedure ppGroupHeaderBand3BeforeGenerate(Sender: TObject);
    procedure ppDetailBand20BeforePrint(Sender: TObject);
    procedure ppDBCalc71Print(Sender: TObject);
    procedure ppDBCalc74Print(Sender: TObject);
    procedure ppDBCalc76Print(Sender: TObject);
    procedure ppDBCalc77Print(Sender: TObject);
    procedure ppDBCalc78Print(Sender: TObject);
    procedure ppDBCalc79Print(Sender: TObject);
    procedure ppDBCalc80Print(Sender: TObject);
    procedure ppDBCalc81Print(Sender: TObject);
    procedure ppGroupHeaderBand2BeforeGenerate(Sender: TObject);
    procedure ppDetailBand22BeforeGenerate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormPrint: TFormPrint;
  XL: variant;
  n,n2:string;
  i,idprn:integer;
  SumTara, SumTovar, SumTotal, SumNDS, Sum: real;

const
  SQLStringPodr = 'SELECT RS, adressb, nameb, mfob FROM SU.RSPodr, su.banks where su.rsPodr.code=:c and mfob=kodbanka';
  SQLStringTp = 'SELECT RS, adressb, nameb, mfob FROM SU.RSTP, su.banks where su.rsTP.code=:c and mfob=kodbanka';

implementation
 uses UnitData,UnitDataSpr,UnitMain,UnitFTXPRN ,Util, UnitFormProgress, UnitThread,
  DateUtils, UnitFTXPRNAll, UnitKachYdo, ky, UnitDanAkt, Alex;
{$R *.dfm}
var kolnakl:Byte; //Количество экземпляров накладных ,выдавыемых на печать
    FormPr:Boolean; //Выводить ли проводки на печать.
//Увеличиваем на еденицу строковую переменную
Function Incn(n:String):String;
begin
  Result:=IntToStr(StrToInt(n)+1);
end;

procedure TFormPrint.Rash_VC;
var osh, nstr:String;
    ns,kolt,vniz,start,i,nst:Integer;
    orgpl:Boolean; //Плательщик головная организация
    kodpl,oper:Integer;  //Её код
    s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11:String;
    itogkolt,itogstoim,itognds,itogsnds,itogbinds,itogmassa,snds10,snds20:Double;
Begin
 if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
 if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.P2:=SK;
 FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeVC(P1)');
 osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
 if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
 ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
 qPrint.Close;
 qPrint.Prepare;
 qPrint.ParamByName('ns').Value:=ns;
 qPrint.Open;
 qPrint.First;
 kolt:=qPrint.RecordCount;
 XL.WorkBooks.Add(ProgDir+'Nakl_VC');
 //XL.visible:=true;

 //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;

  XL.WorkBooks[1].Sheets[4].Activate;
  //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['M2']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['R2']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['W2']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['W2']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 XL.Range['f29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты

 XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['G1']:=PRNZOsnOtp.AsString;
 XL.Range['I1']:=PRNSDateN.AsString;
 XL.Range['A5']:=AnsiUpperCase(PRNSTpName.Value);
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 //XL.Range['B42']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['J42']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   XL.WorkBooks[1].Sheets[4].Activate;
   if PRNZustomer.Value then
    begin
     XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['M25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['J42']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.WorkBooks[1].Sheets[4].Activate;
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;

  XL.WorkBooks[1].Sheets[4].Activate;
  XL.Range['G31']:='№';
  XL.Range['Q31']:=PRNZPunktPogr.AsString;
  XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;

 //start:=39;
 //nst:=-1;
 nst:=14;
 itogkolt:=0;itogstoim:=0;itognds:=0;itogsnds:=0;itogbinds:=0;
 itogmassa:=0;snds10:=0;snds20:=0;
 for i:=1 to kolt do
 begin
  XL.WorkBooks[1].Sheets[1].Activate;
  inc(nst);
  nstr:=IntToStr(nst);
  XL.Range['A'+nstr]:=i;
  XL.Range['B'+nstr]:=qPrintName.AsString;
  XL.Rows[nstr].Autofit;
  XL.WorkBooks[1].Sheets[2].Activate;
  XL.Rows[IntToStr(nst-1)].Autofit;
  XL.Rows[IntToStr(nst+35)].Autofit;
  XL.WorkBooks[1].Sheets[4].Activate;
  XL.Rows[IntToStr(nst+23)].Autofit;
  XL.WorkBooks[1].Sheets[5].Activate;
  XL.Rows[IntToStr(nst+22)].Autofit;
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Range['D'+nstr]:=qPrintEI.AsString;
  XL.Range['E'+nstr]:=FloatToStr(qPrintQnt.Value);
  itogkolt:=itogkolt+qPrintQnt.Value;
  XL.Range['F'+nstr]:=FloatToStr(qPrintPrice.Value);
  XL.Range['G'+nstr]:=FloatToStr(qPrintAddOpt.Value);
  XL.Range['I'+nstr]:=FloatToStr(qPrintPricewNDS.Value);
  XL.Range['J'+nstr]:=FloatToStr(qPrintSumwNDS.Value);
  itogstoim:=itogstoim+qPrintSumwNDS.Value;
  XL.Range['K'+nstr]:=FloatToStr(qPrintNDS.Value);
  XL.Range['L'+nstr]:=FloatToStr(qPrintSumwoNDS.Value);
  itognds:=itognds+qPrintSumwoNDS.Value;
  XL.Range['M'+nstr]:=FloatToStr(qPrintSumTotal.Value);
  itogsnds:=itogsnds+qPrintSumTotal.Value;
  XL.WorkBooks[1].Sheets[4].Activate;
  XL.Range['AA'+IntToStr(nst+23)]:=qPrintMassaGruza.AsString;
  itogmassa:=itogmassa+qPrintMassaGruza.Value;
  //XL.Range['AC'+IntToStr(nst+23)]:='Надб.'+qPrintAddOpt.AsString+'%. Отпускная цена '+qPrintPrice.AsString;
  qPrint.Next;
 end;
 {inc(nst);
 nstr:=IntToStr(nst);
 XL.WorkBooks[1].Sheets[1].Activate;
 XL.Rows[nstr+':'+IntToStr(27)].RowHeight:=0;
 XL.WorkBooks[1].Sheets[2].Activate;
 XL.Rows[nstr+':'+IntToStr(27)].RowHeight:=0;  }

 ///ИТОГО
 XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['J'+IntToStr(28)]:=itogstoim;
 XL.Range['L'+IntToStr(28)]:=itognds;
 XL.Range['M'+IntToStr(28)]:=itogsnds;
 XL.Range['A'+IntToStr(31)]:=UtilForm.SumNumToFull(itogsnds);
 XL.Range['A'+IntToStr(33)]:=UtilForm.SumNumToFull(itognds);

 XL.WorkBooks[1].Sheets[4].Activate;
 XL.Range['K'+IntToStr(51)]:=itogkolt;
 XL.Range['O'+IntToStr(51)]:=itogstoim;
 XL.Range['S'+IntToStr(51)]:=itognds;
 XL.Range['V'+IntToStr(51)]:=itogsnds;
 XL.Range['AA'+IntToStr(51)]:=itogmassa;
 osh:='';
 if itogmassa>0 then
 begin
   s1:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(itogmassa),',',1));
   if UtilForm.P(FloatToStr(itogmassa),',',2)<>'' then
     itogmassa:=StrToFloat(UtilForm.P(FloatToStr(itogmassa),',',2))*100
   else    itogmassa:=0;
   s2:=UtilForm.MoneyToText(FloatToStr(itogmassa));
   s3:=s1+'кг. '+s2+'гр.';
   XL.Range['G'+IntToStr(58)]:=s3;
 end;
 XL.Range['AB'+IntToStr(58)]:=UtilForm.MoneyToText(FloatToStr(itogkolt));
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');

 if PRNSPrN.Value=0 then
 begin
   FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
   FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
   if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
   Data.KPRN.Close;
   Data.KPRN.Prepare;
   Data.KPRN.Open;
 end;
 XL.visible:=true;
end;



procedure TFormPrint.Rash1;
var
  i:integer;
begin
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ТТН-1_К.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['ПодУНН']:=inttostr(DataSpr.QuerySPDUNN.Value);
  XL.Range['ПодОКЮЛП']:=DataSpr.QuerySPDOklp.Value;
  XL.Range['ПодЛицензия']:=DataSpr.QuerySPDLicens.Value;
  XL.Range['Грузоотправитель']:=DataSpr.QuerySPDName.Value+', '+DataSpr.QuerySPDAdres.Value+'; и т.д.';
  XL.Range['ПунктПогрузки']:=DataSpr.QuerySPDAdres.Value;
  if UnitFTXPRN.Table then
   begin
   XL.Range['ТПУНН']:=inttostr(Data.TableFTXPRNTpUNN.Value);
   XL.Range['ТПОКЮЛП']:=Data.TableFTXPRNTpOklp.Value;
   XL.Range['ТПЛицензия']:=Data.TableFTXPRNTpLicens.Value;
   XL.Range['Номер']:=Data.TableFTXPRNNnak.Value;
   XL.Range['Дата']:=Data.TableFTXPRNDateN.Value;
   XL.Range['Автомобиль']:=Data.TableFTXPRNCar.Value;
   XL.Range['Водитель']:=Data.TableFTXPRNVodName.Value;
   XL.Range['ВидПеревозки']:='Авто';
   XL.Range['Грузополучатель']:=Data.TableFTXPRNTpName.Value+', '+Data.TableFTXPRNTpAdres.Value+'; и т.д.';
   XL.Range['КодГрузополучатель']:=Data.TableFTXPRNTpKod.Value;
   XL.Range['ОснованиеОтпуска']:='Согласно документу';
   XL.Range['ЦельПриобретения']:='Для розничной торговли';
   XL.Range['ПунктРазгрузки']:=Data.TableFTXPRNTpAdres.Value;
   end
  else
   begin
   XL.Range['ТПУНН']:=inttostr(PRNSTpUNN.Value);
   XL.Range['ТПОКЮЛП']:=PRNSTpOklp.Value;
   XL.Range['ТПЛицензия']:=PRNSTpLicens.Value;
   XL.Range['Номер']:=PRNSNnak.Value;
   XL.Range['Дата']:=PRNSDateN.Value;
   XL.Range['Автомобиль']:=PRNSCar.Value;
   XL.Range['Водитель']:=PRNSVodName.Value;
   XL.Range['ВидПеревозки']:='Авто';
   XL.Range['КодЗаказчик']:=PRNSTrKod.Value;
   XL.Range['Грузополучатель']:=PRNSTpName.Value+', '+PRNSTpAdres.Value+'; и т.д.';
   XL.Range['КодГрузополучатель']:=PRNSTpKod.Value;
   XL.Range['ОснованиеОтпуска']:='Согласно документу';
   XL.Range['ЦельПриобретения']:='Для розничной торговли';
   XL.Range['ПунктРазгрузки']:=PRNSTpAdres.Value;
   end;
  QPr.First;
  for i:=1 to QPr.RecordCount do begin
    n:=inttostr(i+32);
    XL.Range['C'+n]:=QPrName.Value;
    XL.Range['H'+n]:=QPrKol.Value;
    XL.Range['I'+n]:=QPrPrice.Value;
    //XL.Range['P'+n]:=QPrONad.Value;
    //XL.Range['Q'+n]:=QPrKol.Value*(QPrPrice.Value*(1+QPrONad.Value));
    XL.Range['X'+n]:=QPrNDS.Value/100;
    XL.Range['Y'+n]:=QPrKol.Value*(QPrPrice.Value*QPrNDS.Value);
    //XL.Range['Z'+n]:=QPrKol.Value*(QPrPrice.Value*(1+QPrONad.Value+QPrNDS.Value));
    QPr.Next;
  end;

  QPr.Close;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);
 XL.WorkBooks[1].Sheets[2].Protect(2040478);
end;

procedure TFormPrint.Rash2;
var
  i, NumRecOn1stPage: integer;
  num:integer;
  n,n2,str,s1,s2: string;
  SinglePageTable:boolean; {флаг, указывающий, что таблица вхлазит на одну страницу qq}
begin


  SinglePageTable:=true;
//  n:=Util.UtilForm.MoneyToText('5362354');
  XL.WorkBooks.Add(ProgDir+'ТТН.xls');
  XL.DisplayAlerts:=false;
  XL.EnableEvents:=false;
  XL.WorkBooks[1].Sheets[1].Activate;

  //
  XL.Range['J7']:=inttostr(DataSpr.QuerySPDUNN.Value);
  XL.Range['J9']:=DataSpr.QuerySPDOklp.Value;
  XL.Range['J11']:=DataSpr.QuerySPDLicens.Value;

  XL.Range['K21']:=PRNSNnak.Value;
  XL.Range['Q21']:=PRNSDateN.Value;
  XL.Range['M21']:=PRNSOperac.Value;

  XL.Range['F24']:=DataSpr.QuerySPDName.Value+', '+DataSpr.QuerySPDAdres.Value+'; и т.д.';
  XL.Range['E30']:=DataSpr.QuerySPDAdres.Value;
  XL.Range['H23']:=PRNZOwnCarName.Value;
  //XL.Range['C28']:=PRNZustomer.Value;
  XL.Range['R22']:=PRNZPutList.Value;
  if UnitFTXPRN.Table then
   begin
   XL.Range['M7']:=inttostr(Data.TableFTXPRNTpUNN.Value);
   XL.Range['M9']:=Data.TableFTXPRNTpOklp.Value;
   XL.Range['M11']:=Data.TableFTXPRNTpLicens.Value;
//   XL.Range['Номер']:=Data.TableFTXPRNNnak.Value;
//   XL.Range['Дата']:=Data.TableFTXPRNDateN.Value;
   XL.Range['D22']:=Data.TableFTXPRNCar.Value;
   XL.Range['M23']:=Data.TableFTXPRNVodName.Value;
   XL.Range['W23']:='Авто';
   XL.Range['F26']:=Data.TableFTXPRNTpName.Value+', '+Data.TableFTXPRNTpAdres.Value+'; и т.д.';
//   XL.Range['КодГрузополучатель']:=Data.TableFTXPRNTpKod.Value;
   XL.Range['G32']:='Согласно документу';
   XL.Range['O32']:='Для розничной торговли';
   XL.Range['N30']:=Data.TableFTXPRNTpAdres.Value;
   end
  else begin
    XL.Range['M7']:=inttostr(PRNSTpUNN.Value);
    XL.Range['M9']:=PRNSTpOklp.Value;
    XL.Range['M11']:=PRNSTpLicens.Value;
//   XL.Range['Номер']:=PRNSNnak.Value;
//   XL.Range['Дата']:=PRNSDateN.Value;
    XL.Range['D22']:=PRNSCar.Value;
    XL.Range['M23']:=PRNSVodName.Value;
    XL.Range['W23']:='Авто';
//   XL.Range['КодЗаказчик']:=PRNSTrKod.Value;
    XL.Range['F26']:=PRNSTpName.Value+', '+PRNSTpAdres.Value+'; и т.д.';
//   XL.Range['КодГрузополучатель']:=PRNSTpKod.Value;
    XL.Range['G32']:='Согласно документу';
    XL.Range['O32']:='Для розничной торговли';
    XL.Range['N30']:=PRNSTpAdres.Value;
  end;

  qrBankAccount.Close;
  qrBankAccount.SQL.Text:=SQLStringPodr;
  qrBankAccount.Prepare;
  qrBankAccount.ParamByName('c').Value:=PodrG;
  qrBankAccount.Open;
  XL.Range['B25']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;
  XL.Range['V25']:=qrBankAccountMFOB.Value;
  if PRNZustomer.Value=True
    // если заказчик = "наша" организация
    then begin
      XL.Range['B29']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;
      XL.Range['V29']:=qrBankAccountMFOB.Value;
      XL.Range['R7']:=inttostr(DataSpr.QuerySPDUNN.Value);
      XL.Range['R9']:=DataSpr.QuerySPDOklp.Value;
      XL.Range['R11']:=DataSpr.QuerySPDLicens.Value;
    end;

  if PRNSTpPr.Value=1
  then begin
  // если торговый партнер - сторонняя организация.
    qrBankAccount.Close;
    qrBankAccount.SQL.Text:=SQLStringTp;
    qrBankAccount.Prepare;
    qrBankAccount.ParamByName('c').Value:=PRNSTpKod.Value;
    qrBankAccount.Open;
    XL.Range['B27']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;
    XL.Range['V27']:=qrBankAccountMFOB.Value;
    if PRNZustomer.Value=False
    // если заказчик = торг. партнер
      then begin
        XL.Range['B29']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;;
        XL.Range['V29']:=qrBankAccountMFOB.Value;
        if UnitFTXPRN.Table
        then begin
          XL.Range['R7']:=inttostr(Data.TableFTXPRNTpUNN.Value);
          XL.Range['R9']:=Data.TableFTXPRNTpOklp.Value;
          XL.Range['R11']:=Data.TableFTXPRNTpLicens.Value;
        end
        else begin
          XL.Range['R7']:=inttostr(PRNSTpUNN.Value);
          XL.Range['R9']:=PRNSTpOklp.Value;
          XL.Range['R11']:=PRNSTpLicens.Value;
        end;
      end;
  end
  else begin
  // если торговый партнер - своя организация.

    XL.Range['B27']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;
    XL.Range['V27']:=qrBankAccountMFOB.Value;
    XL.Range['M7']:=inttostr(DataSpr.QuerySPDUNN.Value);
    XL.Range['M9']:=DataSpr.QuerySPDOklp.Value;
    XL.Range['M11']:=DataSpr.QuerySPDLicens.Value;
  end;


  QPr.First;
  num:=34;
  NumRecOn1stPage:=0;
  for i:=1 to QPr.RecordCount do begin
    inc(NumRecOn1stPage);
    n:=inttostr(num);
    n2:=inttostr(num+1);
    XL.Range['A'+n+':B'+n].Merge;
    XL.Range['A'+n]:=QPrNnt.Value;
    XL.Range['C'+n+':H'+n].Merge;
    XL.Range['C'+n]:=QPrName.Value;
    XL.Range['I'+n]:=QPrKodEIName.Value;
    if QprFasovka.Value<>0 then XL.Range['J'+n]:=floattostr(QprFasovka.Value)+'x'+Floattostr(QPrFas.Value)
      else XL.Range['J'+n]:='';
    XL.Range['K'+n]:=QPrKol.Value;
    XL.Range['L'+n+':M'+n].Merge;
    XL.Range['L'+n]:=QPrPrice.Value;
    XL.Range['N'+n]:=QPrAddBase.Value/100;
    XL.Range['O'+n]:=QPrAddBuyer.Value/100;
//    XL.Range['P'+n]:=QPrPrice.Value*(1+QPrAddBase.Value/100+QPrAddBuyer.Value/100);
    //XL.Range['P'+n]:=QPrONad.Value;
    //XL.Range['Q'+n]:=QPrKol.Value*(QPrPrice.Value*(1+QPrONad.Value));
    XL.Range['Q'+n+':R'+n].Merge;
    XL.Range['Q'+n]:=QPrNDS.Value/100;
//    XL.Range['S'+n]:=QPrKol.Value*(QPrPrice.Value*QPrNDS.Value/100);
//    XL.Range['T'+n]:=QPrPrice.Value*(1+QPrAddBase.Value/100+QPrAddBuyer.Value/100)*(1+QPrNDS.Value/100);
//    XL.Range['U'+n]:=QPrKol.Value*QPrPrice.Value*(1+QPrAddBase.Value/100+QPrAddBuyer.Value/100)*(1+QPrNDS.Value/100);
    XL.Range['V'+n]:=QPrNal.Value/100;
//    XL.Range['W'+n]:=QPrPrice.Value*(1+QPrAddBase.Value/100+QPrAddBuyer.Value/100)*(1+QPrNDS.Value/100)*(1+QPrNal.Value/100);
//    XL.Range['X'+n]:=QPrKol.Value*QPrPrice.Value*(1+QPrAddBase.Value/100+QPrAddBuyer.Value/100)*(1+QPrNDS.Value/100)*(1+QPrNal.Value/100);
    if Length(QPrDop.Value)>175
    then begin
      Utilform.SplitString(QPrDop.Value,175,s1,s2);
      XL.Range['C'+n2+':X'+n2].Merge;
      XL.Range['C'+n2]:=s1;
      n2:=inttostr(strtoint(n2)+1);
      inc(num);
      XL.Range['C'+n2+':X'+n2].Merge;
      XL.Range['C'+n2]:=s2;
    end
    else begin
      XL.Range['C'+n2+':X'+n2].Merge;
      XL.Range['C'+n2].HorizontalAlignment:=2;
      XL.Range['C'+n2]:=QPrDop.Value;
    end;
    //XL.Range['Z'+n]:=QPrKol.Value*(QPrPrice.Value*(1+QPrONad.Value+QPrNDS.Value));
    inc(num,2);
    if num>90 then SinglePageTable:=false;
    if not SinglePageTable then break;
    QPr.Next;
  end;

  XL.WorkBooks[1].Sheets[1].Protect('2040478');
  if not SinglePageTable then XL.WorkBooks[1].Sheets[2].Activate
    else XL.WorkBooks[1].Sheets[3].Activate;
  str:=XL.Range['H6'];
  //str:=FloatToStr(Round(StrToFloat(str)));
  XL.Range['I6']:=Util.UtilForm.MoneyToText(str);
  str:=XL.Range['H7'];
  //str:=FloatToStr(Round(StrToFloat(str)));
  XL.Range['I7']:=Util.UtilForm.MoneyToText(str);
  XL.Range['I11']:=PRNZCdalOtp.Value;
  XL.Range['W9']:=PRNZDokTov.Value;
  XL.Range['T10']:=PRNZOtpProizv.Value;
  XL.Range['T12']:=PRNZPrinPol.Value;
  XL.Range['P9']:=PRNZDovNom.Value;
  XL.Range['R9']:=PRNZDovData.Value;
  XL.Range['I10']:=PRNZOtpRazr.Value;
  XL.Range['I12']:=PRNZVName.Value;

  if not SinglePageTable
  then begin
    num:=27;
    for i:=NumRecOn1stPage to QPr.RecordCount do begin
      n:=inttostr(num);
      n2:=inttostr(num+1);
      XL.Range['A'+n+':B'+n].Merge;
      XL.Range['A'+n]:=QPrNnt.Value;
      XL.Range['C'+n+':H'+n].Merge;
      XL.Range['C'+n]:=QPrName.Value;
      XL.Range['I'+n]:=QPrKodEIName.Value;
      if QprFasovka.Value<>0
      then XL.Range['J'+n]:=floattostr(QprFasovka.Value)+'x'+Floattostr(QPrFas.Value)
        else XL.Range['J'+n]:='';
      XL.Range['K'+n]:=QPrKol.Value;
      XL.Range['L'+n+':M'+n].Merge;
      XL.Range['L'+n]:=QPrPrice.Value;
      XL.Range['N'+n]:=QPrAddBase.Value/100;
      XL.Range['O'+n]:=QPrAddBuyer.Value/100;
      XL.Range['Q'+n+':R'+n].Merge;
      XL.Range['Q'+n]:=QPrNDS.Value/100;
      XL.Range['V'+n]:=QPrNal.Value/100;
      if Length(QPrDop.Value)>175
      then begin
        Utilform.SplitString(QPrDop.Value,175,s1,s2);
        XL.Range['C'+n2+':X'+n2].Merge;
        XL.Range['C'+n2]:=s1;
        n2:=inttostr(strtoint(n2)+1);
        inc(num);
        XL.Range['C'+n2+':X'+n2].Merge;
        XL.Range['C'+n2]:=s2;
      end
      else begin
        XL.Range['C'+n2+':X'+n2].Merge;
        XL.Range['C'+n2].HorizontalAlignment:=2;
        XL.Range['C'+n2]:=QPrDop.Value;
      end;
      inc(num,2);
      if num>100 then SinglePageTable:=false;
      if not SinglePageTable then break;
      QPr.Next;
    end;
  end;

  QPr.Close;
  XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
  if PRNSPrN.Value<>0 then XL.visible:=true
  else begin
    XL.WorkBooks[1].Sheets[1].PrintOut;
    if SinglePageTable then XL.WorkBooks[1].Sheets[3].PrintOut else XL.WorkBooks[1].Sheets[2].PrintOut;
    FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
    FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
    if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
    Data.KPRN.Close;
    Data.KPRN.Prepare;
    Data.KPRN.Open;
  end;

end;

// печать расходных накладных для внутреннего перемещения
procedure TFormPrint.Rash_Vnu;
var
  i: integer;
  ns,nr,nrt:integer;
  nrs:string;
  ii:string;
  kol,sym:double;
  Rng, WSh:variant;
begin
  XL.WorkBooks.Add(ProgDir+'VnNakl.xls');
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeShv(P1,P3)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  XL.WorkBooks[1].Sheets[1].Activate;

  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['B7']:=FormMain.Vism2.P5+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель

  if PRNSTpPr.Value=1
  then begin
    XL.Range['B9']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value// Грузополучатель реквизиты
    //Заказчик(плательщик)
  end
  else begin
   XL.Range['B9']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
  end;

  nrt:=19;
  kol:=0;
  sym:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt-1);
    //Rng := WSh.Rows[Row+1];

    //XL.Range['A'+nrs,'A'+nrs].Insert(3);
    //XL.Rows[nrt].Insert(3);
 {   XL.ActiveSheet.Rows[inttostr(nrt)].Insert;
    XL.Range[XL.Cells[nrs,1],XL.Cells[nrs,3]].Select;
    Xl.Selection.MergeCells:=true;      }
    XL.Range['A'+nrs]:=inttostr(nr)+'. '+qPrintName.Value;
    XL.Range['A'+nrs].Font.Bold:=true;
    XL.Range['D'+nrs]:=qPrintEI.Value;
    XL.Range['F'+nrs]:=qPrintNNT.Value;
    XL.Range['H'+nrs]:=qPrintQnt.Value;
    kol:=kol+qPrintQnt.Value;;
    XL.Range['J'+nrs]:=qPrintQnt.Value;
    XL.Range['K'+nrs]:=qPrintPrice.Value;
    XL.Range['L'+nrs]:=qPrintSumBegin.Value;
    sym:=sym+qPrintSumBegin.Value;

    XL.ActiveSheet.Rows[inttostr(nrt)].Insert;
    XL.Range[XL.Cells[nrs,1],XL.Cells[nrs,3]].Select;
    Xl.Selection.MergeCells:=true;

    //XL.Selection.EntireRow.Insert;
    //XL.Selection.Insert(Shift := xlDown);
    //XL.Range['A'+nrs,'A'+nrs].Insert(3);
    qPrint.Next;
    //XL.Rows[strtoint(nrs)+1].Insert;
    //XL.Selection.Insert(Shift := xlDown);
    //XL.Range['A'+nrs,'A'+nrs].Insert(3);
    //XL.Selection.EntireRow.Insert;
  end;
   XL.ActiveSheet.Rows[inttostr(nrt)].Delete;
   XL.Range['H'+inttostr(nrt)]:=kol;
   XL.Range['J'+inttostr(nrt)]:=kol;
   XL.Range['L'+inttostr(nrt)]:=sym;
  {for nr:=nrt to 55 do XL.Rows[nr].RowHeight:=0;}
  //ii:=XL.Range['J56'];
  XL.Range['C'+inttostr(nrt+1)]:=Util.UtilForm.MoneyToText(floattostr(kol)); {ii}
  XL.Range['A'+inttostr(nrt+3)]:=Util.UtilForm.MoneyToText(floattostr(sym));  {XL.Range['L56']}

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый лист',mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,1);
     FormMain.VisM1.P9:=Data.TableFTXPRNTIDdoc.Value;
     if not FormFTXPRN.OperationIsIncome then FormMain.VisM1.Execute('s P8=##class(KSU.FTXPRN).Printed(P9)');
     if FormMain.VisM1.P8<>'' then ShowMessage(FormMain.VisM1.P8);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;


end;


// печать рахходных накладных для Ивацевичи-ЛОТОС с приложением
procedure TFormPrint.Rash3;
var
  ns:integer;
  printtime:string;

begin
  printtime:='время печати '+DateTimeToStr(Date)+' '+TimeToStr(Time);
  XL.WorkBooks.Add(ProgDir+'ТТН_ivatz.xls');

  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeIvatz(P1,P3)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if PRNSPrN.Value<>0 then Addition.DeviceType:='Screen' else Addition.DeviceType:='Printer';
  Addition.Print;

  // заполняем приложение

  XL.WorkBooks[1].Sheets[1].Activate;

  qrBankAccount.Close;
  qrBankAccount.SQL.Text:=SQLStringPodr;
  qrBankAccount.Prepare;
  qrBankAccount.ParamByName('c').Value:=PodrG;
  qrBankAccount.Open;
  XL.Range['E19']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;// Грузоотправитель
  XL.Range['AE18']:=qrBankAccountMFOB.Value;// код банка грузоотправителя

  XL.Range['P5']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  XL.Range['P6']:=DataSpr.QuerySPDOklp.Value;// ОКЮЛП            | Грузоотправителя
  XL.Range['P7']:=DataSpr.QuerySPDLicens.Value;// лицензия         |

  if PRNSTpPr.Value=1
  then begin
    qrBankAccount.Close;
    qrBankAccount.SQL.Text:=SQLStringTp;
    qrBankAccount.Prepare;
    qrBankAccount.ParamByName('c').Value:=PRNSTpKod.Value;
    qrBankAccount.Open;

    XL.Range['E21']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;// Грузополучатель реквизиты
    XL.Range['AE20']:=qrBankAccountMFOB.Value;// Код банка грузополучателя

    if UnitFTXPRN.Table
    then begin
      XL.Range['Y5']:=inttostr(Data.TableFTXPRNTpUNN.Value);// УНН        |
      XL.Range['Y6']:=Data.TableFTXPRNTpOklp.Value;// ОКЮЛП     | Грузополучателя
      XL.Range['Y7']:=Data.TableFTXPRNTpLicens.Value;// лицензия  |
    end
    else begin
      XL.Range['Y5']:=inttostr(PRNSTpUNN.Value);
      XL.Range['Y6']:=PRNSTpOklp.Value;
      XL.Range['Y7']:=PRNSTpLicens.Value;
    end

  end
  else begin
    XL.Range['E21']:='=E19';// Грузополучатель реквизиты
    XL.Range['AE20']:='=AE18';// Код банка грузополучателя

    XL.Range['Y5']:=inttostr(DataSpr.QuerySPDUNN.Value);
    XL.Range['Y6']:=DataSpr.QuerySPDOklp.Value;
    XL.Range['Y7']:=DataSpr.QuerySPDLicens.Value;

  end;

  if PRNZustomer.Value=True
  then begin // если заказчик=грузоотправитель
    XL.Range['AA5']:='=P5';// УНН             |
    XL.Range['AA6']:='=P6';// ОКЮЛП          | Заказчика
    XL.Range['AA7']:='=P7';// лицензия       |

    XL.Range['F17']:='=E19';// Реквизиты заказчика
    XL.Range['AE16']:='=AE18';// Код банка заказчика

  end
  else begin  // заказчик=грузополучатель
    XL.Range['AA5']:='=Y5';// УНН             |
    XL.Range['AA6']:='=Y6';// ОКЮЛП          | Заказчика
    XL.Range['AA7']:='=Y7';// лицензия       |

    XL.Range['F17']:='=E21';// Реквизиты заказчика
    XL.Range['AE16']:='=AE20';// Код банка заказчика

  end;

  XL.Range['E13']:=PRNZVCar.Value;// автомобиль
  XL.Range['Z13']:=PRNZPutList.Value;// № путевого листа
  XL.Range['F15']:=PRNZOwnCarName.Value;// владелец транспорта
  XL.Range['V15']:=PRNZVName.Value;// водитель
  XL.Range['AA15']:='Авто';// вид перевозки
  XL.Range['E23']:='Согласно документу';// Основание отпуска
  XL.Range['Z23']:='Для розничной торговли';// Цель приобретения
  XL.Range['E25']:=PRNZPunktPogr.Value;// Пункт погрузки
  XL.Range['U25']:=PRNZPunktRazgr.Value;// Пункт разгрузки
  XL.Range['AC25']:='';// № маршрута
  XL.Range['E27']:='';// переадресовка
  XL.Range['Z27']:='';// прицеп
  XL.Range['AC27']:='';// Гараж
  XL.Range['P11']:=PRNSDateN.Value;// Дата

  XL.Range['D32:AG32'].Merge;
  XL.Range['D32']:='Товар согласно приложения '+inttostr(Addition.AbsolutePageCount)+' листов';

  XL.Range['Q36']:=Sum;
  XL.Range['Y36']:=SumNDS;
  XL.Range['Z36']:=SumTotal;

  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  XL.WorkBooks[1].Sheets[2].Activate;


  XL.Range['E3']:=Util.UtilForm.MoneyToText(FloatToStr(SumNDS));// сумма НДС прописью
  XL.Range['G5']:=Util.UtilForm.MoneyToText(FloatToStr(SumTotal));// Всего отпущено на сумму с НДС прописью
  XL.Range['J7']:='';// оттиск
  XL.Range['мест']:='';// количество мест прописью
  XL.Range['масса']:='';// груз массой брутто
  XL.Range['F11']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['G13']:=PRNZVName.Value;// принял водитель
  XL.Range['F18']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['J20']:='';// оттиск
  XL.Range['M20']:='';// количество мест прописью
  XL.Range['F22']:='';// груз массой брутто
  XL.Range['G24']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F26']:=PRNZVName.Value;// принял водитель
  XL.Range['F32']:=PRNZDovNom.Value;// № доверенности
  XL.Range['I32']:=PRNZDovData.AsString;// дата доверенности
  XL.Range['M32']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['F34']:='';// груз получил


  XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[1].Activate;
  if PRNSPrN.Value<>0 then XL.visible:=true
  else begin
    //XL.WorkBooks[1].Sheets[1].PrintOut;
    //XL.WorkBooks[1].Sheets[2].PrintOut;
    FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
    FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
    if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
    Data.KPRN.Close;
    Data.KPRN.Prepare;
    Data.KPRN.Open;
  end;
end;

procedure TFormPrint.Rash_new_kobrin;
var
  ns,nn,kodpl,oper:Integer;
  nr,nrt,nrstart:integer;
  intNDS,intSumNDS,intSkid:real;
  nrs:string;
  str:string;
  orgpl: boolean;
  tara:double;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;

  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1, P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeTNKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_new_kobrin.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  intNDS:=0;
  intSumNDS:=0;
  intSkid:=0;
  nrt:=nrstart;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt-1);
    XL.Range['B'+nrs]:=inttostr(nr)+'. '+qPrintName.Value;
    XL.Range['B'+nrs].Font.Bold:=true;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewNDS.Value;
    XL.Range['O'+nrs]:=qPrintSumwNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    intNDS:=intNDS+qPrintSumNDS.Value;
    intSumNDS:=intSumNDS+qPrintSumTotal.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.Value;
    XL.Range['AF'+nrs]:=qPrintAddTorg.Value;
    XL.Range['AH'+nrs]:=qPrintSumBegin.Value;
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt-1);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt-1);
      XL.Range['B'+nrs+':AH'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumTotal.value,-2);
    qPrint.Next;
  end;
  if tara=0 then XL.Rows[80].RowHeight:=0
    else XL.Range['V80']:=tara;
  // скрываем лишние строки
  for nrt:=nrt to 78 do XL.Rows[nrt].RowHeight:=0;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

   //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['I25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;

  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AB31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  //intNDS:=XL.Range['S79'];
  //intSumNDS:=XL.Range['V79'];
  XL.Range['S79']:=intNDS;
  XL.Range['V79']:=intSumNDS;

// ----------------------------------------
// транспортные данные
  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(floattostr(intNDS));//
  XL.Range['F2']:=str;
  str:=Util.UtilForm.MoneyToText(floattostr(intSumNDS));//
  XL.Range['H4']:=str;
  str:=Util.UtilForm.MoneyToText(floattostr(intSkid));
  XL.Range['F6']:=str;
  str:=Util.UtilForm.MoneyToText(floattostr(intSumNDS-intSkid));
  XL.Range['F8']:=str;

  XL.Range['AB10']:='';// количество мест прописью
  XL.Range['G12']:='';// груз массой брутто
  XL.Range['H14']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA12']:=PRNSVodName.Value;// принял водитель
  XL.Range['F12']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y14']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE14']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z16']:='';// груз получил
end;

procedure TFormPrint.rash_Kobrin;
var
  ns:integer;
  printtime,n,n_dop:string;
  i,num:integer;
  // суммы :
  Sum1stPrice: real;
  SumSellPrice: real;
  SumDiscount: real;
  SumNDS: real;
  SumTotal: real;
  SumQnt: real;
  str:string;
begin
  Sum1stPrice:=0;
  SumSellPrice:=0;
  SumDiscount:=0;
  SumNDS:=0;
  SumTotal:=0;
  SumQnt:=0;

  // расход на свои магазины для кобрина кондитерский цех по типам операций 21,22, 23
  printtime:='время печати '+DateTimeToStr(Date)+' '+TimeToStr(Time);
  XL.WorkBooks.Add(ProgDir+'ТТН_kobrin.xls');
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1, P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  XL.WorkBooks[1].Sheets[1].Activate;

  XL.Range['K2']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  XL.Range['K3']:=DataSpr.QuerySPDOklp.Value;// ОКЮЛП            | Грузоотправителя
  XL.Range['K4']:=DataSpr.QuerySPDLicens.Value;// лицензия         |

  // шапка
  XL.Range['G11']:=DataSpr.QuerySPDName.Value+', '+DataSpr.QuerySPDAdres.Value;
  XL.Range['G13']:=PRNSTpName.Value+', '+PRNSTpAdres.Value;

  qrBankAccount.Close;
  qrBankAccount.SQL.Text:=SQLStringPodr;
  qrBankAccount.Prepare;
  qrBankAccount.ParamByName('c').Value:=PodrG;
  qrBankAccount.Open;
  XL.Range['G12']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;// Грузоотправитель
  XL.Range['AP12']:=qrBankAccountMFOB.Value;// код банка грузоотправителя

  if PRNSTpPr.Value=1    // торговый партнер - "чужой"
  then begin
    qrBankAccount.Close;
    qrBankAccount.SQL.Text:=SQLStringTp;
    qrBankAccount.Prepare;
    qrBankAccount.ParamByName('c').Value:=PRNSTpKod.Value;
    qrBankAccount.Open;

    XL.Range['G14']:=qrBankAccountRS.Value+' '+qrBankAccountNameB.Value+' '+qrBankAccountAdressB.Value;// Грузополучатель реквизиты
    XL.Range['AP14']:=qrBankAccountMFOB.Value;// Код банка грузополучателя

    if UnitFTXPRN.Table
    then begin
      XL.Range['W2']:=inttostr(Data.TableFTXPRNTpUNN.Value);// УНН        |
      XL.Range['W3']:=Data.TableFTXPRNTpOklp.Value;// ОКЮЛП     | Грузополучателя
      XL.Range['W4']:=Data.TableFTXPRNTpLicens.Value;// лицензия  |
    end
    else begin
      XL.Range['W2']:=inttostr(PRNSTpUNN.Value);
      XL.Range['W3']:=PRNSTpOklp.Value;
      XL.Range['W4']:=PRNSTpLicens.Value;
    end

  end
  else begin
    XL.Range['G14']:='=E19';// Грузополучатель реквизиты
    XL.Range['AP14']:='=AE18';// Код банка грузополучателя

    XL.Range['W2']:=inttostr(DataSpr.QuerySPDUNN.Value);
    XL.Range['W3']:=DataSpr.QuerySPDOklp.Value;
    XL.Range['W4']:=DataSpr.QuerySPDLicens.Value;
  end;

  if PRNZustomer.Value=True
  then begin // если заказчик=грузоотправитель
    XL.Range['AD2']:='=K2';// УНН             |
    XL.Range['AD3']:='=K3';// ОКЮЛП          | Заказчика
    XL.Range['AD4']:='=K4';// лицензия       |

    XL.Range['G15']:='=G11';
    XL.Range['G16']:='=G12';// Реквизиты заказчика
    XL.Range['AP16']:='=AP12';// Код банка заказчика
  end
  else begin  // заказчик=грузополучатель
    XL.Range['AD2']:='=W2';// УНН             |
    XL.Range['AD3']:='=W3';// ОКЮЛП          | Заказчика
    XL.Range['AD4']:='=W4';// лицензия       |

    XL.Range['G15']:='=G13';
    XL.Range['G16']:='=G14';// Реквизиты заказчика
    XL.Range['AP16']:='=AP14';// Код банка заказчика
  end;




  XL.Range['G9']:=PRNZVCar.Value;// автомобиль
  XL.Range['AP9']:=PRNZPutList.Value;// № путевого листа
  XL.Range['G10']:=PRNZOwnCarName.Value;// владелец транспорта
  XL.Range['AH10']:=PRNZVName.Value;// водитель
  XL.Range['AU10']:='Авто';// вид перевозки
  XL.Range['G19']:='Согласно документу';// Основание отпуска
  XL.Range['Y19']:='Для розничной торговли';// Цель приобретения
  XL.Range['G17']:=PRNZPunktPogr.Value;// Пункт погрузки
  XL.Range['X17']:=PRNZPunktRazgr.Value;// Пункт разгрузки
  XL.Range['AS17']:='';// № маршрута
  XL.Range['G18']:='';// переадресовка
  XL.Range['X18']:='';// прицеп
  XL.Range['AQ18']:='';// Гараж
  XL.Range['A8']:=PRNSDateN.Value;// Дата

  // данные
  qPrint.First;
  num:=22;
  for i:=1 to qPrint.RecordCount do
  begin
    n:=inttostr(num);
    n_dop:=inttostr(num+1);

//    XL.Range['A'+n+':E'+n].Merge;
    XL.Range['A'+n]:=qPrintNNT.Value;
//    XL.Range['A'+n]:=n;

//    XL.Range['F'+n+':J'+n].Merge;
    XL.Range['F'+n]:=qPrintName.Value;
//    XL.Range['F'+n]:=n;

//    XL.Range['K'+n+':M'+n].Merge;
    XL.Range['K'+n]:=qPrintEI.Value;
//    XL.Range['K'+n]:=n;

//    XL.Range['Q'+n+':S'+n].Merge;
    XL.Range['Q'+n]:=qPrintQnt.Value;
//    XL.Range['Q'+n]:=n;
    SumQnt:=SumQnt+qPrintQnt.Value;

//    XL.Range['T'+n+':V'+n].Merge;
    XL.Range['T'+n]:=qPrintPrice.Value;
//    XL.Range['T'+n]:=n;

//    XL.Range['W'+n+':Y'+n].Merge;
    XL.Range['W'+n]:=qPrintSumBegin.Value;
//    XL.Range['W'+n]:=n;
    Sum1stPrice:=Sum1stPrice+qPrintSumBegin.Value;

//    XL.Range['Z'+n+':AB'+n].Merge;
    XL.Range['Z'+n]:=qPrintAddTorg.Value;
//    XL.Range['Z'+n]:=n;

//    XL.Range['AC'+n+':AE'+n].Merge;
    XL.Range['AC'+n]:=qPrintPricewoNDS.Value;
//    XL.Range['AC'+n]:=n;

//    XL.Range['AF'+n+':AH'+n].Merge;
    XL.Range['AF'+n]:=qPrintSumwNDS.Value;
//    XL.Range['AF'+n]:=n;
    SumSellPrice:=SumSellPrice+qPrintSumwNDS.Value;

//    XL.Range['AI'+n+':AK'+n].Merge;
    XL.Range['AI'+n]:=qPrintSkid.Value;
//    XL.Range['AI'+n]:=n;

//    XL.Range['AL'+n+':AN'+n].Merge;
    XL.Range['AL'+n]:=qPrintSumSkid.Value;
//    XL.Range['AL'+n]:=n;
    SumDiscount:=SumDiscount+qPrintSumSkid.Value;

//    XL.Range['AO'+n+':AQ'+n].Merge;
    XL.Range['AO'+n]:=qPrintNDS.Value;
//    XL.Range['AO'+n]:=n;

//    XL.Range['AR'+n+':AT'+n].Merge;
    XL.Range['AR'+n]:=qPrintSumNDS.Value;
//    XL.Range['AR'+n]:=n;
    SumNDS:=SumNDS+qPrintSumNDS.Value;

//    XL.Range['AU'+n+':AW'+n].Merge;
    XL.Range['AU'+n]:=qPrintSumTotal.Value;
//    XL.Range['AU'+n]:=n;
    SumTotal:=SumTotal+qPrintSumTotal.Value;

//    XL.Range['B'+n_dop+':AW'+n_dop].Merge;
    XL.Range['B'+n_dop]:=qPrintDop.Value;
//    XL.Range['B'+n_dop]:=n;

    inc(num,2);
    qPrint.Next;
  end;
  n:=inttostr(num);
  XL.Range['A'+n+':J'+n].Merge;
  XL.Range['A'+n]:='ИТОГО';
  XL.Range['W'+n+':Y'+n].Merge;
  XL.Range['W'+n]:=Sum1stPrice;
  XL.Range['AF'+n+':AH'+n].Merge;
  XL.Range['AF'+n]:=SumSellPrice;
  XL.Range['AL'+n+':AN'+n].Merge;
  XL.Range['AL'+n]:=SumDiscount;
  XL.Range['AR'+n+':AT'+n].Merge;
  XL.Range['AR'+n]:=SumNDS;
  XL.Range['AU'+n+':AW'+n].Merge;
  XL.Range['AU'+n]:=SumTotal;

  XL.WorkBooks[1].Sheets[2].Activate;
  str:='Товар получил  __________________ по доверенности №'+PRNZDovNom.Value+' от '+PRNZDovData.AsString+', выданной '+PRNZDovVyd.Value;
  XL.Range['F1']:=SumQnt;
  XL.Range['A6']:=str;
  XL.Range['F2']:=SumTotal;
  XL.Range['F3']:=SumNDS;
  XL.Range['F4']:=SumDiscount;
//  XL.Range['H3']:=Util.UtilForm.MoneyToText(FloatToStr(SumNDS));// сумма НДС прописью
//  XL.Range['H2']:=Util.UtilForm.MoneyToText(FloatToStr(SumTotal));// Всего отпущено на сумму с НДС прописью

  XL.Range['E11']:=Util.UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNDS,-2)));// сумма НДС прописью
  XL.Range['G13']:=Util.UtilForm.MoneyToText(FloatToStr(SumTotal));// Всего отпущено на сумму с НДС прописью
  XL.Range['F18']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['G21']:=PRNZVName.Value;// принял водитель
  XL.Range['F26']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['G32']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F34']:=PRNZVName.Value;// принял водитель
  XL.Range['F40']:=PRNZDovNom.Value;// № доверенности
  XL.Range['I40']:=PRNZDovData.AsString;// дата доверенности
  XL.Range['M40']:=PRNZDovVyd.Value;// выдана доверенность

  XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[1].Activate;

  if PRNSPrN.Value<>0 then XL.visible:=true
  else begin
    XL.WorkBooks[1].Sheets[1].PrintOut;
    XL.WorkBooks[1].Sheets[2].PrintOut;
    FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
    FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
    if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
    Data.KPRN.Close;
    Data.KPRN.Prepare;
    Data.KPRN.Open;
  end;

{  FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
  FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
  if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
  Data.KPRN.Close;
  Data.KPRN.Prepare;
  Data.KPRN.Open;

  XL.visible:=true;}
end;

Function PrivNKorSK:Integer;
begin
  FormMain.VisM1.P1:=0;
  FormMain.VisM1.Execute('s P1=^KSU.Option("FormFTXPRN","PrivNKorSK")');
  if FormMain.VisM1.P1=1 then
  Result:=SK
  else Result:=NomK;
end;

procedure TFormPrint.Enter;
var namef:String;
begin
{  if UnitFTXPRN.Table then
    idprn:=Data.TableFTXPRNID.Value
  else begin
    idprn:=Data.KPRNID.Value;}
    Data.KPRN.Locate('ID',idnakl,[]);
    idprn:=idnakl;
    Data.KPRN.Locate('ID',idnakl,[]) ;
    PRNS.Close;
    PRNS.Prepare;
    PRNS.ParamByName('idprn').Value:=idprn;
    PRNS.Open;
 // end;
  QPr.Close;
  QPr.Prepare;
  QPr.ParamByName('Doc').Value:=idprn;
  QPr.Open;

  DataSpr.QuerySPD.Close;
  DataSpr.QuerySPD.Params[0].AsInteger:=PodrG;
  DataSpr.QuerySPD.Open;

  PRNZ.Close;
  PRNZ.Prepare;
  PRNZ.ParamByName('nk').Value:=PrivNKorSK;
  PRNZ.Open;
  // Обьект EXCEL
  XL:=CreateOleObject('Excel.Application');
  // Чтоб не задавал вопрос о сохранении документа
  XL.DisplayAlerts := false;
  if FormFTXPRN.OperationIsIncome then FormMain.VisM1.P2:=1
  else                                 FormMain.VisM1.P2:=2;
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P3:=FormFTXPRN.wwDBGrid2.GetFieldValue(2);
  FormMain.VisM1.Execute('s P4=##Class(KSU.FTXPRN).FilePrint(P1,P2,P3),P5=+$P(P4,":",2),P6=+$P(P4,":",3),P4=$P(P4,":",1)');
  namef:=FormMain.VisM1.P4 ;
  kolnakl:=FormMain.VisM1.P5;
  if FormFTXPRNAll.Edit1.Text<>'' then
  if FormFTXPRNAll.Edit1.Text<>FormMain.VisM1.P5 then
    kolnakl:=StrToInt(FormFTXPRNAll.Edit1.Text);
  if FormMain.VisM1.P6='1' then FormPr:=True
  else                          FormPr:=False;
  if kolnakl=0 then kolnakl:=4;
  //if FileExists(namef+'.xls')
  //then begin
    if namef='VC' then Rash_VC;
    if namef='ТТН-1_К' then Rash1;
    if namef='ПН-1' then Prich1;
    if namef='ПНпроиз' then PrichProiz;
    if namef='ПН-2' then Prich2;
    if namef='ПН-3ср' then Prich3cr;
    if namef='ПН-3' then Prich3;
    if namef='ПН-4' then Prich4;
    if namef='ПН-4Ivac' then Prich4Ivac;
    if namef='ПН-5' then Prich5;
    if namef='ПН-6' then Prich6;
    if namef='ПК-1' then Prich7; // Приемная квитанция ПК-1(вторичное сырье)
    if namef='ПН-4БШ' then Prich8;
    if namef='ПН-Stol1' then PrichStol1;
    if namef='ПН-Stol2' then PrichStol2;
    if namef='ПН-Stol2cena' then PrichStol2cena;
    if namef='ПН-Stol3' then PrichStol3;
    if namef='ПН-Stol4' then PrichStol4;
    if namef='ТТН' then Rash2;
    if namef='ТТН_ivatz' then Rash3;
    if namef='ТТН_kobrin' then rash_kobrin;
    if namef='ТТН_1'then RashKyl;
    if namef='ТТН_11'then Rash11;
    if namef='ТТН_new' then Rash_new;
    if namef='ТТН_gal' then Rash_gal;
    if namef='ТТН_lopo' then Rash_lopo;
    if namef='ТТН_lopobaz' then Rash_lopobaz;
    if namef='ТТН_lopobaz2' then Rash_lopobaz2;
    if namef='ТТН_veg_svoi' then Rash_veg_svoi;
    if namef='ТТН_veg' then Rash_veg;
    if namef='ТТН_lopo_1' then Rash_lopo_1;
    if namef='ТТН_lopo1' then Rash_lopo1;
    if namef='ТТН_stol' then Rash_stol;
    if namef='ТТН_stol2' then Rash_stol2;
    if namef='ТТН_stol2Okr' then Rash_stol2Okr;
    if namef='ТТН_stol3' then Rash_stol3;
    if namef='ТТН_stol4' then Rash_stol4;
    if namef='ТТН_lopo2' then Rash_lopo2;
    if namef='ТТН_tarabaz' then Rash_tarabaz;
    if namef='ТТН_lopo3' then Rash_lopo3;
    if namef='ТТН_lopo4' then Rash_lopo4;
    if namef='ТТН_lopo5' then Rash_lopo5;
    if namef='ТТН_new_2' then Rash_new_2;
    if namef='ТН_kobrin' then Rash_TN; // ТН для кобрина для склада сырья
    if namef='ТТН_new_kobrin' then Rash_new_kobrin; // ТТН для кобрина
    if namef='ТТН_olsh' then Rash_TTN_olsh; // ТТН для Ольшан и ивацевич в продажной ценой
    if namef='ТТН_iv21' then Rash_iv21; // ТТН для ивацевичей для отпуска на сторону (возврат) с оптовой ценой
    if namef='ПН_КСС' then Prih_KSS; // приходная накладная для кобрин. склад сырья
    if namef='ТТН_One' then Rash_One; // ТТН с автоматическим переносом подвала на вторую сторону, если не вмещается все на 1 страницу
    if namef='TH_VSr' then  Rash_TN_VSr ; //ТН внутренняя цена средняя
    if namef='ТН_two' then Rash_TN_Two;   // ТН с дополнительными полями и продажной ценой в графе цена
    if namef='ТТН_One_2' then Rash_One_2; // ТТН как в Rash_One, только с ценой, округленной до рубля
    if namef='ТТН_One_3' then Rash_One_3; // ТТН как в Rash_One, только с первой ценой, округленной до рубля
    if namef='ТТН_album' then Rash_album; // альбомная
    if namef='VnNakl' then Rash_Vnu; // внутренняя накладная
    if namef='ТТН_ruzh' then Rash_TTN_ruzh; // ТТН для Ружан
    if namef='ТТН_new_kond' then RashNewKyl; // расход для кулинарного на новой накладной
    if namef='ТТН_new_kond1' then RashNewKyl1; // расход для кулинарного на новой накладной, печать без приложения
    if namef='ТТН_pruzh21' then Rash_pruzh21; // расход на сторонние организации для Пружан ТЦ
    if namef='ТН_toplivo' then Rash_TN_toplivo; // расход ТН для топлива (Лунинец Автокомбинат)
    if namef='ТТН_album_2' then Rash_album_2; // альбомная с приложением
    if namef='ТТН_gzk21' then Rash_gzk21; // расход для ГорЗаготКонторы (как ТТН_pruzh21, только с розничной ценой)
    if namef='ТТН_brgzk' then Rash_TTN_brgzk; // расход для Брест ГорЗаготКонторы (как ТТН_razh; но в приложении только первая цена,кол-во, сумма)
    if namef='ТТН_gzk2' then Rash_GZK2; //расход для Брест ГорЗаготКонторы
    if namef='ТТН_gzk22' then Rash_GZK22; //тоже что и ТТН_gzk2, но округление до 10 рублей
    if namef='ТТН_proiz_ch' then Rash_proiz_ch; // расход для кондитерских, на сторону
    if namef='ТТН_proiz_sv' then Rash_proiz_sv; // расход для кондитерских, своим
    if namef='ТТН_proiz_sv_s' then Rash_proiz_sv_s; // расход для кондитерских, своим, есть табличка с НДС 10%, и 20%
    if namef='ТТН_proiz_sv_c' then Rash_proiz_sv_c; // расход для кондитерских, на сторону, есть табличка с НДС 10%, и 20%
    if namef='ТН_ivac' then Rash_ivac; // товарная накладная для Ивацевики ККП, на основе ТТН_proiz_sv_s
    if namef='ТТН_dmch' then Rash_Domach; // накладная, расход, для Домачево
    if namef='ТТН_Lotos' then Rash_Lotos; // накладная, расход, для Лотоса Ивацевичи
    if namef='ТТН_KKP10' then Rash_KKP10_chujie; // расход для ККП, чужим
    if namef='ТТН_KKP10_FN' then Rash_KKP10_FN;
    if namef='ТТН_KKP20_FN' then Rash_KKP20_FN;
    if namef='ТТН_KKP10_cena0' then Rash_KKP10_cena0; // расход для ККП с нулевой ценой
    if namef='ТТН_KKP20' then Rash_KKP20_svoi; // расход для ККП, своим
    if namef='ТТН_KKP20_skid' then Rash_KKP20_svoi_skid; // расход для ККП, своим
    if namef='ТТН_PINRIN10' then Rash_PinRin10; // расход чужим для Пинского рынка
    if namef='ТТН_PINRIN11' then Rash_PinRin11; // расход чужим для Пинского рынка
    if namef='ТТН_PINRIN20' then Rash_PinRin20; // расход своим для Пинского рынка
    if namef='ТТН_PINRIN21' then Rash_PinRin21; // расход своим для Пинского рынка,ТТН_PINRIN20 но без нормы отходов
    if namef='ТН_PINRIN20' then Rash_PinRin20_TN; // ТН расход своим для Пинского рынка
    if namef='ТН_PINRIN21' then Rash_PinRin21_TN; // ТН расход своим для Пинского рынка,ТН_PINRIN20 но без нормы отходов
    if namef='TTH_SrNad' then Rash_SrNad;   //расход по средней цене с надбавкой для сторонних
    if namef='ТТН_EDA' then Rash_EDA;   //расход для ресторанов, кафе (деление по трапезам)
    if namef='ТТН_rozn20' then Rash_Rozn20;  // расход с розничного склада в магазин
    if namef='ТТН_rozn21' then Rash_Rozn21;  // расход розница отличается от Rash_Rozn20 методом в Studio
    if namef='ТТН_rozn22' then Rash_Rozn22;  // расход розница отличается от Rash_Rozn20 методом в Delphi
    if namef='ТТН_rozn23' then Rash_Rozn23;  // тоже самое, что и ТТН_rozn20, но без скидки
    if namef='ТТН_rozn24' then Rash_Rozn24;  // возврат товара, тоже что и ТТН_lopo4, + розничная цена
    if namef='ТН_rozn20' then Rash_Rozn20TN;  // расход с розничного склада в магазин
    if namef='ТТН_gor' then Rash_Gor; // расход для розничного склада
    if namef='ТТН_opt' then Rash_Opt; // расход
    if namef='ТН_brrin' then Rash_BrRinTN; //оличие от ТН_rozn20 методом в Studio
    if namef='ТТН_basopt' then Rash_BaseOpt; // расход
    if namef='ТТН_optber' then Rash_OptBer; // и это расход
    if namef='ТТН_obsch' then Rash_Obsch; // расход на общепит
    if namef='ТТН_obdrog' then Rash_Obdrog; // расход на общепит
    if namef='ТТН_mag' then Rash_Mag; // расход с магазина потребителю
    if namef='ТТН_alko' then Rash_Alko; // расход с производства алкоголя (Беловежские вина)
    if namef='ТН_vnytr' then Rash_Vnytr; // Внутренне перемещение по учетной цене + НДС
    if namef='akt_spis1' then Rash_AktSpis1; // Акт на списание 1 (broken.xls, лист2)
    if namef='akt_spis2' then Rash_AktSpis2; // Акт на списание 2 (broken.xls, лист3)
    if namef='ТТН_ivacbaza' then Rash_ivacbaza;   // расход ивацевичи база, оптторг
    if namef='ТТН_ivacbaza2' then Rash_ivacbaza2;
    if namef='ТТН_stol_baz' then Rash_stol_baz;
    if namef='ТТН_stol_opt' then Rash_stol_opt;
    if namef='ТТН_stol_baz2' then Rash_stol_baz2;
    if namef='ТТН_stol_bazopt' then Rash_stol_bazopt;
    if namef='ТТН_brrpo' then Rash_brrpo;   // расход ивацевичи база, оптторг
    if namef='ТТН_brrpo1' then Rash_brrpo1;
    if namef='ТТН_lynrpo' then Rash_lynrpo;   // расход Лунинец райпо
    if namef='ТТН_lynrpobnds' then Rash_lynrpo;   // расход Лунинец райпо без НДС
    if namef='ТТН_kolos' then Rash_kolos;
    if namef='ТТН_kolosRozn' then Rash_kolosRozn;
    if namef='ТТН_kolosOpt' then Rash_kolosOpt;
  //end;
  //else raise Exception.Create('Нет описания для накладной');
  QPr.Close;
  if not UnitFTXPRN.Table then
  PRNS.Close;
  DataSpr.QuerySPD.Close;
  SumTara.Close;qPrint.Close;qrBankAccount.Close;PRNZ.Close;
  prov.Close;
{  try
    XL.Quit;
  except
  end;}
 end;

procedure TFormPrint.Rash_AktSpis1;
var osh,nrs,s,s1,ytv,pred,chl1,chl2,chl3:String;
    i,ns,j:Integer;
    sum:Double;
Begin
  osh:='';
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakeVnytr(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  XL.WorkBooks.Add(ProgDir+'broken.xls');
  XL.WorkBooks[1].Sheets[2].Activate;
  FormDanAkt.Enter();
  FormMain.VisM1.P1:=NomK;
  FormMain.VisM1.Execute('s P2=$G(^Nastr(P1,"Ytv")),P3=$G(^Nastr(P1,"PredKom"))');
  FormMain.VisM1.Execute('s P4=$G(^Nastr(P1,"ChlKom1")),P5=$G(^Nastr(P1,"ChlKom2")),P6=$G(^Nastr(P1,"ChlKom3"))');
  ytv:=FormMain.VisM1.P2;
  pred:=FormMain.VisM1.P3;
  chl1:=FormMain.VisM1.P4;
  chl2:=FormMain.VisM1.P5;
  chl3:=FormMain.VisM1.P6;
  XL.Range['T2']:=UtilForm.P(ytv,':',2);
  XL.Range['Q4']:=UtilForm.P(ytv,':',1);
  XL.Range['Q6']:=PRNSDateN.AsString;
  XL.Range['N7']:=PRNSNnak.AsString;
  FormMain.VisM2.P1:=Mes;
  FormMain.VisM2.Execute('s P2=$$Mes1^AA(P1)');
  XL.Range['J9']:='ЗА '+FormMain.VisM2.P2+' '+IntToStr(God)+'г.';
  s:=XL.Range['AB2'];
  s:=s+' '+UtilForm.P(chl1,':',1)+' '+UtilForm.P(chl1,':',2)+', ';
  s:=s+' '+UtilForm.P(chl2,':',1)+' '+UtilForm.P(chl2,':',2)+', ';
  s:=s+' '+UtilForm.P(chl3,':',1)+' '+UtilForm.P(chl3,':',2)+', ';
  s1:=XL.Range['AB3'];
  s:=s+s1;
  XL.Range['A11']:=s;
  XL.Rows[11].Autofit;
  s:=XL.Range['AB4'];
  XL.Range['A13']:=s;
  XL.Rows[13].Autofit;
  sum:=0;
  j:=17;
  for i:=1 to qPrint.RecordCount do
  begin
    XL.Range['A'+IntToStr(17+i)]:=IntToStr(i);
    XL.Range['B'+IntToStr(17+i)]:=qPrintNNT.AsString;
    XL.Range['D'+IntToStr(17+i)]:=qPrintName.AsString;
    XL.Range['Q'+IntToStr(17+i)]:=qPrintEI.AsString;
    XL.Range['S'+IntToStr(17+i)]:=qPrintQnt.AsString;
    XL.Range['U'+IntToStr(17+i)]:=qPrintPrice.AsString;
    XL.Range['X'+IntToStr(17+i)]:=qPrintSumBegin.AsString;
     sum:=sum+qPrintSumBegin.Value;
    XL.Rows[17+i].Autofit;
    XL.Range['A'+IntToStr(17+i)+':'+'AD'+IntToStr(17+i)].Select;
    XL.Selection.Copy;
    XL.Range['A'+IntToStr(17+i+1)].Select;
    XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                              SkipBlanks:=False, Transpose:=False);
    XL.CutCopyMode:=False;
    XL.Range['A'+IntToStr(17+i+1)].Characters().Font.FontStyle:='';
    qPrint.Next;
  end;
  XL.Range['A17:X'+IntToStr(17+i)].Select;
  XL.Selection.Borders.LineStyle:=xlContinuous;
  XL.Range['B'+IntToStr(17+i)]:='ИТОГО';
  XL.Range['B'+IntToStr(17+i)].Characters.Font.FontStyle:='полужирный';
  XL.Range['X'+IntToStr(17+i)]:=sum;
  XL.Range['X'+IntToStr(17+i)].Characters.Font.FontStyle:='полужирный';
  i:=17+i;
  XL.Range['B'+IntToStr(i+2)]:='Итого: '+UtilForm.SumNumToFull(sum);
  if (UtilForm.P(pred,':',1)<>'')or(UtilForm.P(pred,':',2)<>'') then
  begin
    XL.Range['A'+IntToStr(i+4)]:='Председатель комиссии:';
    XL.Range['A'+IntToStr(i+4)].Characters.Font.FontStyle:='полужирный';
    XL.Range['A'+IntToStr(i+5)]:=UtilForm.P(pred,':',1);
    XL.Range['L'+IntToStr(i+5)+':O'+IntToStr(i+5)].Select;
    XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
    XL.Range['P'+IntToStr(i+5)]:=UtilForm.P(pred,':',2);
    i:=i+2;
  end;
  XL.Range['A'+IntToStr(i+4)]:='Комиссия:';
  XL.Range['A'+IntToStr(i+4)].Characters.Font.FontStyle:='полужирный';
  XL.Range['A'+IntToStr(i+5)]:=UtilForm.P(chl1,':',1);
  XL.Range['L'+IntToStr(i+5)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  XL.Range['P'+IntToStr(i+5)]:=UtilForm.P(chl1,':',2);
  XL.Range['A'+IntToStr(i+6)]:=UtilForm.P(chl2,':',1);
  XL.Range['L'+IntToStr(i+6)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  XL.Range['P'+IntToStr(i+6)]:=UtilForm.P(chl2,':',2);
  XL.Range['A'+IntToStr(i+7)]:=UtilForm.P(chl3,':',1);
  XL.Range['L'+IntToStr(i+7)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  XL.Range['P'+IntToStr(i+7)]:=UtilForm.P(chl3,':',2);
  XL.Range['A'+IntToStr(i+8)]:='Материально-ответственное лицо';
  XL.Range['L'+IntToStr(i+8)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  FormMain.VisM2.P1:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SMOL(P1)),":",1)');
  XL.Range['P'+IntToStr(i+8)]:=FormMain.VisM2.P2;
  XL.WorkBooks[1].Sheets[2].PageSetup.PrintArea:= '$A$1:$Z$'+IntToStr(i+8);
  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
  XL.Visible:=true;

End;

procedure TFormPrint.Rash_AktSpis2;
var osh,nrs,s,s1,ytv,pred,chl1,chl2,chl3:String;
    i,ns,j:Integer;
    sum:Double;
Begin
  osh:='';
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakeVnytr(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  XL.WorkBooks.Add(ProgDir+'broken.xls');
  XL.WorkBooks[1].Sheets[3].Activate;
  //XL.Visible:=true;
  FormDanAkt.Enter();
  FormMain.VisM1.P1:=NomK;
  FormMain.VisM1.Execute('s P2=$G(^Nastr(P1,"Ytv")),P3=$G(^Nastr(P1,"PredKom"))');
  FormMain.VisM1.Execute('s P4=$G(^Nastr(P1,"ChlKom1")),P5=$G(^Nastr(P1,"ChlKom2")),P6=$G(^Nastr(P1,"ChlKom3"))');
  ytv:=FormMain.VisM1.P2;
  pred:=FormMain.VisM1.P3;
  chl1:=FormMain.VisM1.P4;
  chl2:=FormMain.VisM1.P5;
  chl3:=FormMain.VisM1.P6;
  XL.Range['T2']:=UtilForm.P(ytv,':',2);
  XL.Range['Q4']:=UtilForm.P(ytv,':',1);
  XL.Range['Q6']:=PRNSDateN.AsString;
  XL.Range['N7']:=PRNSNnak.AsString;
  FormMain.VisM2.P1:=Mes;
  FormMain.VisM2.Execute('s P2=$$Mes1^AA(P1)');
  XL.Range['J9']:='ЗА '+FormMain.VisM2.P2+' '+IntToStr(God)+'г.';
  s:=XL.Range['AB2'];
  s:=s+' '+UtilForm.P(chl1,':',1)+' '+UtilForm.P(chl1,':',2)+', ';
  s:=s+' '+UtilForm.P(chl2,':',1)+' '+UtilForm.P(chl2,':',2)+', ';
  s:=s+' '+UtilForm.P(chl3,':',1)+' '+UtilForm.P(chl3,':',2)+', ';
  s1:=XL.Range['AB3'];
  s:=s+s1;
  XL.Range['A11']:=s;
  XL.Rows[11].Autofit;
  s:=XL.Range['AB4'];
  XL.Range['A13']:=s;
  XL.Rows[13].Autofit;
  sum:=0;
  j:=17;
  for i:=1 to qPrint.RecordCount do
  begin
    XL.Range['A'+IntToStr(17+i)]:=IntToStr(i);
    XL.Range['B'+IntToStr(17+i)]:=qPrintNNT.AsString;
    XL.Range['D'+IntToStr(17+i)]:=qPrintName.AsString;
    XL.Range['Q'+IntToStr(17+i)]:=qPrintEI.AsString;
    XL.Range['S'+IntToStr(17+i)]:=qPrintQnt.AsString;
    XL.Range['U'+IntToStr(17+i)]:=qPrintPrice.AsString;
    XL.Range['X'+IntToStr(17+i)]:=qPrintSumBegin.AsString;
    XL.Range['Z'+IntToStr(17+i)]:=qPrintData.AsString;
     sum:=sum+qPrintSumBegin.Value;
    XL.Rows[17+i].Autofit;
    XL.Range['A'+IntToStr(17+i)+':'+'AD'+IntToStr(17+i)].Select;
    XL.Selection.Copy;
    XL.Range['A'+IntToStr(17+i+1)].Select;
    XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                              SkipBlanks:=False, Transpose:=False);
    XL.CutCopyMode:=False;
    XL.Range['A'+IntToStr(17+i+1)].Characters().Font.FontStyle:='';
    qPrint.Next;
  end;
  XL.Range['A17:Z'+IntToStr(17+i)].Select;
  XL.Selection.Borders.LineStyle:=xlContinuous;
  XL.Range['B'+IntToStr(17+i)]:='ИТОГО';
  XL.Range['B'+IntToStr(17+i)].Characters.Font.FontStyle:='полужирный';
  XL.Range['X'+IntToStr(17+i)]:=sum;
  XL.Range['X'+IntToStr(17+i)].Characters.Font.FontStyle:='полужирный';
  i:=17+i;
  XL.Range['B'+IntToStr(i+2)]:='Итого: '+UtilForm.SumNumToFull(sum);
  if (UtilForm.P(pred,':',1)<>'')or(UtilForm.P(pred,':',2)<>'') then
  begin
    XL.Range['A'+IntToStr(i+4)]:='Председатель комиссии:';
    XL.Range['A'+IntToStr(i+4)].Characters.Font.FontStyle:='полужирный';
    XL.Range['A'+IntToStr(i+5)]:=UtilForm.P(pred,':',1);
    XL.Range['L'+IntToStr(i+5)+':O'+IntToStr(i+5)].Select;
    XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
    XL.Range['P'+IntToStr(i+5)]:=UtilForm.P(pred,':',2);
    i:=i+2;
  end;
  XL.Range['A'+IntToStr(i+4)]:='Комиссия:';
  XL.Range['A'+IntToStr(i+4)].Characters.Font.FontStyle:='полужирный';
  XL.Range['A'+IntToStr(i+5)]:=UtilForm.P(chl1,':',1);
  XL.Range['L'+IntToStr(i+5)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  XL.Range['P'+IntToStr(i+5)]:=UtilForm.P(chl1,':',2);
  XL.Range['A'+IntToStr(i+6)]:=UtilForm.P(chl2,':',1);
  XL.Range['L'+IntToStr(i+6)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  XL.Range['P'+IntToStr(i+6)]:=UtilForm.P(chl2,':',2);
  XL.Range['A'+IntToStr(i+7)]:=UtilForm.P(chl3,':',1);
  XL.Range['L'+IntToStr(i+7)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  XL.Range['P'+IntToStr(i+7)]:=UtilForm.P(chl3,':',2);
  XL.Range['A'+IntToStr(i+8)]:='Материально-ответственное лицо';
  XL.Range['L'+IntToStr(i+8)+':O'+IntToStr(i+5)].Select;
  XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
  FormMain.VisM2.P1:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SMOL(P1)),":",1)');
  XL.Range['P'+IntToStr(i+8)]:=FormMain.VisM2.P2;
  XL.WorkBooks[1].Sheets[3].PageSetup.PrintArea:= '$A$1:$Z$'+IntToStr(i+8);
  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
  XL.Visible:=true;

End;

procedure TFormPrint.Rash_Vnytr;
var osh,nrs,provki,provka:String;
    ns,kolt,nrt,pril,i,j:Integer;
    itogtara,itogkolt,itogstoim,itognds,itogstoimnds,stov:Double;
Begin
  osh:='';
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТН_vnytr.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;
  pril:=0;
  if kolt>62 then 
  begin
    XL.WorkBooks[1].Sheets[2].Activate;
    pril:=1;
  end;

   //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  //Грузополучатель
  if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
  //Заказчик(плательщик)
  if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
    if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end;
  {else // заказчик=грузополучатель
    if not PRNSTpUNN.IsNull then
      XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);   }
  XL.Range['B20']:='Накладная №'+PRNSNnak.AsString+', от '+PRNSDateN.AsString;// Дата}
  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  if PrintMOLNakl then
    XL.Range['F21']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5
  else
    XL.Range['F21']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3;
  //Грузополучатель реквизиты
  if PRNSTpPr.Value=1 then
    XL.Range['F23']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString
  else XL.Range['F23']:=AnsiUpperCase(PRNSTpName.Value);
  XL.Range['G25']:=PRNZOsnOtp.AsString;
  XL.Range['Q25']:=PRNZPunktPogr.AsString;
  XL.Range['AB25']:=PRNZPunktRazgr.AsString;

  if pril=0 then
  begin
    nrt:=30;
    XL.WorkBooks[1].Sheets[1].Activate;
  end
  else
  begin
    nrt:=8;
    XL.WorkBooks[1].Sheets[3].Activate;
  end;
  itogtara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;
  ///XL.Visible:=true;
  for i:=1 to kolt do
  begin
    nrt:=nrt+1;
    XL.Range['B'+IntToStr(nrt)]:=qPrintName.AsString;
    XL.Range['M'+IntToStr(nrt)]:=qPrintEI.AsString;
    XL.Range['O'+IntToStr(nrt)]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['Q'+IntToStr(nrt)]:=qPrintPrice.AsString;
    XL.Range['T'+IntToStr(nrt)]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['W'+IntToStr(nrt)]:=qPrintNDS.AsString;
    XL.Range['X'+IntToStr(nrt)]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['Z'+IntToStr(nrt)]:=qPrintSumTotal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
     if qPrintKodGr.Value=99 then
       itogtara:=itogtara+qPrintSumTotal.Value;
    nrt:=nrt+1;
    if qPrintDop.AsString='' then
      XL.Rows[nrt].RowHeight:=0
    else
    begin
      XL.Range['B'+IntToStr(nrt)]:=qPrintDop.AsString;
      XL.Rows[nrt].Autofit;
    end;
  if pril=1 then
  if i<>kolt then
  begin
    XL.Range['B'+IntToStr(nrt-1)+':'+'AJ'+IntToStr(nrt)].Select;
    XL.Selection.Copy;
    XL.Range['B'+IntToStr(nrt+1)].Select;
    XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
    XL.CutCopyMode:=False;
    ///XL.Range['B'+IntToStr(nrt+1)].Characters().Font.FontStyle:='';
  end
  else
  begin
    XL.Range['B'+IntToStr(nrt-1)+':'+'AJ'+IntToStr(nrt-1)].Select;
    XL.Selection.Copy;
    XL.Range['B'+IntToStr(nrt+1)].Select;
    XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
    XL.CutCopyMode:=False;
    XL.Range['B'+IntToStr(nrt+1)+':'+'AJ'+IntToStr(nrt+1)].Select;
    XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
    XL.Selection.Borders[xlEdgeRight].LineStyle:=1;
    XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
    XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   end;
    qPrint.Next;
  end;
  /// ПЕЧАТЬ ИТОГОВ
  nrt:=nrt+1;
  if pril=0 then
  begin
    XL.Range[IntToStr(nrt)+':154'].Select;
    XL.Selection.RowHeight:=0;
    nrt:=155;
    XL.Range['O'+IntToStr(nrt)]:=itogkolt;
    XL.Range['T'+IntToStr(nrt)]:=itogstoim;
    XL.Range['X'+IntToStr(nrt)]:=itognds;
    XL.Range['Z'+IntToStr(nrt)]:=itogstoimnds;
    XL.Range['Z'+IntToStr(nrt+1)]:=itogtara;
  end
  else
  begin
    XL.Range['B'+IntToStr(nrt)]:='Итого';
    XL.Range['B'+IntToStr(nrt)].HorizontalAlignment:=xlRight;
    XL.WorkBooks[1].Sheets[3].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(nrt);
    XL.Range['O'+IntToStr(nrt)]:=itogkolt;
    XL.Range['T'+IntToStr(nrt)]:=itogstoim;
    XL.Range['X'+IntToStr(nrt)]:=itognds;
    XL.Range['Z'+IntToStr(nrt)]:=itogstoimnds;
    XL.WorkBooks[1].Sheets[2].Activate;
    nrt:=32;
    XL.Range['O'+IntToStr(nrt)]:=itogkolt;
    XL.Range['T'+IntToStr(nrt)]:=itogstoim;
    XL.Range['X'+IntToStr(nrt)]:=itognds;
    XL.Range['Z'+IntToStr(nrt)]:=itogstoimnds;
    XL.Range['Z'+IntToStr(nrt+1)]:=itogtara;
    i:=XL.WorkBooks[1].Sheets[3].HPageBreaks.Count;
    XL.Range['B31']:='Товар согласно приложения на '+IntToStr(i+1)+ ' листах'
  end;
  XL.Range['F'+IntToStr(nrt+13)]:='/ '+FloatToStr(itognds)+' / '+UtilForm.SumNumToFull(itognds);
  XL.Range['H'+IntToStr(nrt+15)]:='/ '+FloatToStr(itogstoimnds)+' / '+UtilForm.SumNumToFull(itogstoimnds);
  XL.Range['F'+IntToStr(nrt+17)]:=PRNZOtpRazr.AsString; // Отпуск разрешил
  XL.Range['H'+IntToStr(nrt+19)]:=PRNZCdalOtp.AsString; // Сдал грузоотправитель
  XL.Range['H'+IntToStr(nrt+21)]:=PRNSVodName.AsString; // Принял водитель
  XL.Range['Y'+IntToStr(nrt+21)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;
  XL.Range['AE'+IntToStr(nrt+21)]:=PRNZDovVyd.AsString;
  XL.Range['H'+IntToStr(nrt+23)]:=PRNZPrinPol.AsString; // Принял грузополучательж
  XL.Range['I'+IntToStr(nrt+25)]:=PRNZDokTov.AsString; // Переданы документы

  /// ПРОВОДКИ
  provka:='';
  provki:='';
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P2:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2)),'+
                         ' P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(nrt+6)]:='Дебет';
     XL.Range['H'+InttoStr(nrt+6)]:='Кредит';
     XL.Range['I'+InttoStr(nrt+6)]:='Сумма';
     if  UtilForm.P(provki,'!',6)<>'' then
     begin
       XL.Range['R'+InttoStr(nrt+6)]:='Дебет';
       XL.Range['V'+InttoStr(nrt+6)]:='Кредит';
       XL.Range['Z'+InttoStr(nrt+6)]:='Сумма';
     end;
   end;
///   i:=97;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=5 then
     begin
       XL.Range['D'+IntToStr(nrt+6+j)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(nrt+6+j)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(nrt+6+j)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(nrt+6+j)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(nrt+6+j)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end
     else
     begin
       XL.Range['R'+IntToStr(nrt+1+j)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(nrt+1+j)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(nrt+1+j)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(nrt+1+j)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(nrt+1+j)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
   End
   else
   begin
    XL.Rows[IntToStr(nrt+6)+':'+IntToStr(nrt+11)].RowHeight:=0;
   end;

 if pril=0 then
 if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0 then
 begin
 i:=0;
 i:=XL.WorkBooks[1].Sheets[1].HPageBreaks[1].Location.Row;
 if (168<=i)and(i<=180) then
   XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A168'])
 else if (161<i)and(i<=168) then
        XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A61'])
      else if (157<i)and(i<=161) then
             XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A157'])
           else if (153<i)and(i<=157) then
                  XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A153'])
                 else if (i mod 2)=0 then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A'+IntToStr(i-1)]);
 end;
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
   if pril=0 then
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if (XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0) then
      if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes)
        then XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
    end
   else
   if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if (MessageDlg('Вставить листы для печати приложения' ,mtConfirmation,[mbYes,mbNo],0)=mrYes)
        then XL.WorkBooks[1].Sheets[3].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
    end
  end;
end;

procedure TFormPrint.Rash_Alko;
var osh,nrs:String;
    ns,kolt,nrt:Integer;
    orgpl:Boolean; //Плательщик головная организация
    kodpl:Integer;  //Её код
    itogkolt,itogstoim,itognds,itogstoimnds,itogtara,itogskid:Double;
Begin
  osh:='';
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_alko.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
  end
  else
  begin
    orgpl:=False;
    kodpl:=PRNSTpKod.Value;
  end;
  //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['P4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  //Грузополучатель
  if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
  //Заказчик(плательщик)
  if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
    if not DataSpr.QuerySPDUNN.IsNull then
      XL.Range['Z4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
  else
  begin  // заказчик=грузополучатель
    if not PRNSTpUNN.IsNull then
      XL.Range['Z4']:=inttostr(PRNSTpUNN.Value);
  end;
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  XL.Range['B11']:='Накладная № '+inttostr(nn)+', от '+PRNSDateN.AsString;// Дата
  ///XL.Range['V20']:='Отпущено со склада '+IntToStr(KMOLG);
  //Транспорт
  XL.Range['E12']:=PRNSCar.Value;
  XL.Range['P12']:=PRNSPricep.AsString;
  XL.Range['AE12']:=PRNZPutList.Value;
  XL.Range['G14']:=PRNZOwnCarName.Value;
  XL.Range['Z14']:=PRNSVodName.Value;
  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F18']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3+', '+AnsiUpperCase(FormMain.Vism2.P5);// Грузоотправитель
  if PRNSTpPr.Value=1 then
  begin
    XL.Range['F20']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
    //Заказчик(плательщик)
    if PRNZustomer.Value then
      XL.Range['I16']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3
    else
    begin
      if orgpl then
      begin
        FormMain.Vism2.P1:=kodpl;
        FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
        XL.Range['I16']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
      else
        XL.Range['I16']:='=F20';
    end
  end
  else
  begin
    FormMain.VisM2.P8:=PRNSTpKod.Value;
    FormMain.VisM2.Execute('s P6=$P($G(^SMOL(P8)),":",10)');
    FormMain.VisM2.P7:='';
    if FormMain.VisM2.P6<>'' then
      FormMain.VisM2.Execute('if $D(^SU.STPD(P6)) {s P7=$LG(^SU.STPD(P6),4),P9=$LG(^SU.STPD(P6),6)}');
    if FormMain.VisM2.P7='' then
      XL.Range['F20']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value // Грузополучатель реквизиты
    else XL.Range['F20']:=FormMain.VisM2.P7+', '+FormMain.VisM2.P9+', '+AnsiUpperCase(PRNSTpName.Value);
      XL.Range['I16']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
  XL.Range['G22']:=PRNZOsnOtp.Value;
  XL.Range['Q22']:=PRNZPunktPogr.Value;
  XL.Range['AB22']:=PRNZPunktRazgr.Value;
  // переадресовка
  XL.Range['F24']:=PRNZPereadr.Value;

  ///Visible:=true;
  nrt:=29;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogtara:=0;itogskid:=0;
  for i:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(i)+'. '+qPrintName.AsString;
    XL.Range['N'+nrs]:=qPrintEI.AsString;
    XL.Range['P'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['R'+nrs]:=qPrintPrice.AsString;
    XL.Range['T'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['W'+nrs]:=qPrintNDS.AsString;
    XL.Range['X'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['AA'+nrs]:=qPrintSumToTal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumToTal.Value;
     if qPrintKodGr.Value=99 then
       itogtara:=itogtara+qPrintSumToTal.Value;
    if qPrintKodGr.Value<>99 then XL.Range['AJ'+nrs]:=qPrintSkid.AsString;
    XL.Range['AL'+nrs]:=qPrintSumSkid.AsString;
      itogskid:=itogskid+qPrintSumSkid.Value;
    if qPrintKodGr.Value<>99 then XL.Range['AN'+nrs]:=qPrintPricewTax.AsString;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>'' then
    begin
      osh:=qPrintDop.AsString;
      XL.Range['B'+nrs]:=qPrintDop.AsString+'ВУ '+qPrintVY.AsString+'ГГР '+qPrintGGR.AsString;
      XL.Rows[nrs].Autofit;
    end
    else XL.Rows[nrs].RowHeight:=0;
    //XL.Range['B'+IntToStr(53+i)]:=qPrintName.AsString;
    //osh:=Copy(qPrintVY.AsString,3,Length(qPrintVY.AsString));
    //XL.Range['K'+IntToStr(53+i)]:='ВУ '+osh+'ГГР '+qPrintGGR.AsString;
    //XL.Range['AA'+IntToStr(53+i)]:=qPrintAxc.AsString;
    qPrint.Next;
  end;
  inc(nrt);
  nrs:=inttostr(nrt);
  XL.Rows[nrs+':45'].RowHeight:=0;
  //XL.Rows[IntToStr(53+i)+':61'].RowHeight:=0;
    ///ИТОГО
  XL.Range['P46']:=FloatToStr(itogkolt);
  XL.Range['T46']:=FloatToStr(itogstoim);
  XL.Range['X46']:=FloatToStr(itognds);
  XL.Range['AA46']:=FloatToStr(itogstoimnds);
  if itogtara<>0 then
    XL.Range['AA47']:=FloatToStr(itogtara)
  else XL.Rows['47'].RowHeight:=0;
  XL.Range['AL46']:=FloatToStr(itogskid); 

  XL.Range['F63']:=UtilForm.SumNumToFull(itognds);
  XL.Range['H65']:=UtilForm.SumNumToFull(itogstoimnds);
  XL.Range['F69']:=PRNZOtpRazr.AsString;// отпуск разрешил
  XL.Range['H71']:=PRNZCdalOtp.AsString;// сдал отправитель
  XL.Range['AE69']:=PRNSVodName.AsString;// принял водитель
  XL.Range['AB71']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AJ71']:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['AE73']:=PRNZPrinPol.AsString;// груз получил

  /// Дополнительные сведения
  XL.Range['C53']:=PRNZPreisk.AsString;
  XL.Range['C55']:=PRNZProt.AsString;
  XL.Range['C57']:=PRNZYK.AsString;

  /// ПОГРУЗОЧНО-РАЗГРУЗОЧНЫЕ ОПЕРАЦИИ
  XL.Range['C82']:=PRNZPogruzkaIsp.AsString;
  XL.Range['I82']:=PRNZPogruzkaSpos.AsString;
  XL.Range['P82']:=PRNZPogruzkaPrib.AsString;
  XL.Range['R82']:=PRNZPogruzkaYbit.AsString;
  XL.Range['C83']:=PRNZRazgrIsp.AsString;
  XL.Range['I83']:=PRNZRazgrSpos.AsString;
  XL.Range['P83']:=PRNZRazgrPrib.AsString;
  XL.Range['R83']:=PRNZRazgrYbit.AsString;
  XL.Range['H102']:=PRNZDokTov.AsString;

  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
    XL.visible:=true
  else
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=PRNSID.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
    end;
End;

procedure TFormPrint.Rash_Mag;
var osh,nstr,sname,sdop,provki,provka,nrs:String;
    kolt,i,ns,kodpl,oper,nrstart,nrt,raznprint,j:Integer;
    orgpl: boolean;
    itogkolt,itogstoim,itognds,itogstoimnds,stov:Double;
Begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeMag(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.SQL.Strings[2]:='order by KodGr';
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;

  XL.WorkBooks.Add(ProgDir+'ТТН_KKP10.xls');
  XL.WorkBooks[1].Sheets[3].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
  end
  else
  begin
    orgpl:=False;
    kodpl:=PRNSTpKod.Value;
  end;
  //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  //Грузополучатель
  if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
  //Заказчик(плательщик)
  if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
     if not DataSpr.QuerySPDUNN.IsNull then
       XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
  else
  begin  // заказчик=грузополучатель
     if not PRNSTpUNN.IsNull then
       XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
  XL.Range['B20']:='Накладная №'+inttostr(nn)+', от '+PRNSDateN.AsString;// Дата
  //Транспорт
  XL.Range['E21']:=PRNSCar.AsString;
  XL.Range['AE21']:=PRNZPutList.AsString;
  XL.Range['G23']:=PRNZOwnCarName.AsString;
  XL.Range['Z23']:=PRNSVodName.AsString;
  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
  if PRNSTpPr.Value=1 then
  begin
    XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
    //Заказчик(плательщик)
    if PRNZustomer.Value then
      XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3
    else
    begin
      if orgpl then
      begin
        FormMain.Vism2.P1:=kodpl;
        FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
        XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
      else
       XL.Range['I25']:='=F29';
    end
  end
  else
  begin
    XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
    XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
  XL.Range['G31']:=PRNZOsnOtp.AsString;
  XL.Range['Q31']:=PRNZPunktPogr.AsString;
  XL.Range['AB31']:=PRNZPunktRazgr.AsString;
  // переадресовка
  XL.Range['F33']:=PRNZPereadr.AsString;

  nrstart:=39;
  nrt:=nrstart-1;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;
  //XL.Visible:=true;
  for i:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(i)+'. '+qPrintName.AsString;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumToTal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumToTal.Value;
    FormMain.VisM1.P1:=SK;
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormFTXPRN",P1,"Primech")),P3=+$P(P2,":",1)');
    if FormMain.VisM1.P3='1' then
      XL.Range['AC'+nrs]:='Торговая надбавка '+qPrintAddTorg.AsString+'%';
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>'' then
    begin
      osh:=qPrintDop.AsString;
      XL.Range['B'+nrs]:=qPrintDop.AsString+qPrintKach.AsString+qPrintVY.AsString+qPrintGGR.AsString; //qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
      XL.Rows[nrs].Autofit;
    end
    else XL.Rows[nrs].RowHeight:=0;
    qPrint.Next;
  end;
  inc(nrt);
  nrs:=inttostr(nrt);
  XL.Rows[nrs+':132'].RowHeight:=0;
    ///ИТОГО
  XL.Range['K133']:=FloatToStr(itogkolt);
  XL.Range['O133']:=FloatToStr(itogstoim);
  XL.Range['S133']:=FloatToStr(itognds);
  XL.Range['V133']:=FloatToStr(itogstoimnds);
  XL.Rows['134'].RowHeight:=0;

  XL.Range['F146']:=UtilForm.SumNumToFull(itognds);
  XL.Range['H148']:=UtilForm.SumNumToFull(itogstoimnds);
  XL.Range['H154']:=PRNZCdalOtp.AsString;// сдал отправитель
  XL.Range['AA152']:=PRNSVodName.AsString;// принял водитель
  XL.Range['F152']:=PRNZOtpRazr.AsString;// отпуск разрешил
  XL.Range['Y154']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE154']:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['Z156']:=PRNZPrinPol.AsString;// груз получил

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   raznprint:=FormMain.VisM1.P5;
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   nrt:=139;
   nrs:=inttostr(nrt);
   if provki<>'' then
   begin
     XL.Range['D'+nrs]:='Дебет';
     XL.Range['H'+nrs]:='Кредит';
     XL.Range['I'+nrs]:='Сумма';
     if  UtilForm.P(provki,'!',6)<>'' then
     begin
       XL.Range['R'+nrs]:='Дебет';
       XL.Range['V'+nrs]:='Кредит';
       XL.Range['Z'+nrs]:='Сумма';
     end;
   end;
   i:=1;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=5 then
     begin
       XL.Range['D'+IntToStr(i+nrt)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+nrt)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+nrt)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+nrt)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+nrt)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end
     else
     begin
       XL.Range['R'+IntToStr(i+nrt-5)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+nrt-5)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+nrt-5)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+nrt-5)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+nrt-5)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
   End
   else XL.Rows['137:145'].RowHeight:=0;

  if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
  begin
    i:=0;
    i:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
    if (133<=i)and(i<=139) then
      XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
    else if (139<i)and(i<=146) then
           XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
         else if (146<i)and(i<=160) then
                XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
              else if (160<i)and(i<=168) then
                     XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                   else if (168<i)and(i<=175) then
                          XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                        else if (175<i)and(i<=186) then
                               XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                             else if (i mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(i-1)]);
  end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else
  begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if (XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0)and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
    end;  
  end;

End;

/// Метод печати для общепита
procedure TFormPrint.Rash_Obsch;
var osh,nstr,sname,sdop,provki,provka:String;
    ns,kolt,i,j,namdop,nn:Integer;
    itogstov,itogstara,itognac,itogsnac,itognad,itognds,itogtrans:Double;
    itogstovr,itogstarar,itogkolt:Double;
begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeObschepit(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.SQL.Strings[2]:='order by KodGr';
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  XL.WorkBooks.Add(ProgDir+'ТТН_obschepit.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  ///XL.Visible:=true;
  kolt:=qPrint.RecordCount;
  ZaglN;
  itogstov:=0;itogstara:=0;itognac:=0;itogsnac:=0;itognad:=0;
  itognds:=0;itogtrans:=0;itogstovr:=0;itogstarar:=0;itogkolt:=0;
  i:=0;j:=0;provki:='';provka:='';
  nstr:='38';
  for i:=1  to kolt do
  begin
    nstr:=Incn(nstr);
    XL.Range['B'+nstr]:=qPrintNNT.AsString;
    sname:='';sdop:='';
    Memo1.Text:=qPrintName.Value+' '+qPrintDop.Value;
    sname:=Memo1.Lines.Strings[0];
    if Length(qPrintName.AsString)<=Length(sname) then
    begin
      sname:=qPrintName.AsString;
      sdop:=qPrintDop.AsString;
      namdop:=1;
    end
    else
    begin
      for j:=1 to Memo1.Lines.Count-1 do
        sdop:=sdop+Memo1.Lines.Strings[j];
      namdop:=0;
    end;
    XL.Range['C'+nstr]:=sname;
    XL.Range['I'+nstr]:=qPrintEI.AsString;
    if qPrintFas.AsString='' then
      XL.Range['K'+nstr]:=qPrintQnt.AsString
    else XL.Range['K'+nstr]:=qPrintFas.AsString+'='+qPrintQnt.AsString;
    itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nstr]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nstr]:=qPrintSumwoNDS.AsString;
    itogsnac:=itogsnac+qPrintSumwoNDS.Value;
    XL.Range['R'+nstr]:=qPrintNDS.AsString;
    XL.Range['S'+nstr]:=qPrintSumNDS.AsString;
    itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nstr]:=qPrintSumwoNDS.AsString;
    XL.Range['AC'+nstr]:=qPrintPricewNDS.AsString;
    if qPrintKodGr.Value<>99 then
      itogstov:=itogstov+qPrintSumwNDS.Value
    else itogstara:=itogstara+qPrintSumwNDS.Value;
    XL.Range['AE'+nstr]:=qPrintPrice.AsString;
    if qPrintKodGr.Value<>99 then
      itogstovr:=itogstovr+qPrintSumBegin.Value
    else itogstarar:=itogstarar+qPrintSumBegin.Value;
    XL.Range['AH'+nstr]:=qPrintAddTorg.AsString;
    itognad:=itognad+qPrintSumTorg.Value;
    XL.Range['AJ'+nstr]:=qPrintNac.AsString;
    itogtrans:=itogtrans+qPrintSumTrans.Value;
    if sdop<>'' then
    begin
      nstr:=Incn(nstr);
      XL.Range['B'+nstr]:=sdop;
      if namdop=0 then
      begin
        XL.Range['B'+nstr].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(sname) ).Font.FontStyle:='полужирный';
        XL.Rows[nstr].Autofit;
      end;
    end
    else
    begin
      nstr:=Incn(nstr);
      XL.Rows[nstr].RowHeight:=0;
    end;
    qPrint.Next;
  end;
  nstr:=Incn(nstr);
  XL.Rows[nstr+':148'].Select;
  XL.Selection.RowHeight:=0;
  /// ИТОГИ
  XL.Range['K149']:=itogkolt;
  XL.Range['O149']:=itogsnac;
  XL.Range['S149']:=itognds;
  XL.Range['V149']:=itogsnac;

  XL.Range['F152']:=itogstov;
  XL.Range['F153']:=itogstara;
  XL.Range['F154']:=itogstov+itogstara;
  XL.Range['F156']:=itogsnac-itogstovr-itogstarar;
  XL.Range['F157']:=itogsnac;
  XL.Range['O152']:=itognad;
  XL.Range['O153']:=itognds;
  XL.Range['O154']:=itogtrans;
  XL.Range['O155']:=itogstovr;
  XL.Range['O156']:=itogstarar;
  XL.Range['O157']:=itogstovr+itogstarar;
  XL.Range['F159']:=UtilForm.SumNumToFull(itognds);
  XL.Range['G161']:=UtilForm.SumNumToFull(itogsnac);

  XL.Range['F165']:=PRNZOtpRazr.AsString;// отпуск разрешил
  XL.Range['G167']:=PRNZCdalOtp.AsString;// сдал отправитель
  XL.Range['AA165']:=PRNSVodName.AsString;// принял водитель
  XL.Range['X167']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE167']:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['Z169']:=PRNZPrinPol.AsString;// груз получил

  /// ПРОВОДКИ
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P2:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))'+
    ',P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
  if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
  else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
       else FormMain.VisM1.P5:=0;
  if (FormMain.VisM1.P5>0) then
  Begin
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.P2:=PRNSID.Value;
    FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
    osh:=FormMain.VisM1.P4;
    if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
    else  provki:=FormMain.VisM1.P3;
    i:=1;
    j:=1;
    provka:=UtilForm.P(provki,'!',j);
    while provka<>'' do
    begin
      if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
      then
      begin
        XL.Range['R'+IntToStr(152+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['U'+IntToStr(152+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        itogstov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        itogstov:=itogstov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(152+i)]:=FloatToStr(itogstov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(152+i)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(152+i)]:=FloatToStr(itogstov)+'/'+UtilForm.P(provka,':',6);
        i:=i+1;
      end;
      j:=j+1;
      provka:=UtilForm.P(provki,'!',j);
    end;

    /// Зеркальные проводки
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.Execute('s P2=+$LG(^KSU.SOD(P1),7)');
    if FormMain.VisM1.P2<>'0'
    then
    begin
      FormMain.VisM1.P1:=FormMain.VisM1.P2;
      FormMain.VisM1.P3:=PRNSID.Value;
      FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P3), P4=$P(P3,";",1)');
      osh:=FormMain.VisM1.P4;
      if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
      else  provki:=FormMain.VisM1.P3;
      i:=1;
      j:=1;
      provka:=UtilForm.P(provki,'!',j);
      while provka<>'' do
      begin
        if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
        then begin
          XL.Range['AC'+IntToStr(152+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
          XL.Range['AF'+IntToStr(152+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
          itogstov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
          itogstov:=itogstov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
          if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(152+i)]:=FloatToStr(itogstov)
          else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(152+i)]:=UtilForm.P(provka,':',6)
               else XL.Range['AI'+IntToStr(152+i)]:=FloatToStr(itogstov)+'/'+UtilForm.P(provka,':',6);
          i:=i+1;
        end;
        j:=j+1;
        provka:=UtilForm.P(provki,'!',j);
      end;
    end;
  End;

  if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0 then
  begin
    i:=0;
    i:=XL.WorkBooks[1].Sheets[1].HPageBreaks[1].Location.Row;
    if (187<=i)and(i<=199) then
    XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A188'])
    else if (180<=i)and(i<187) then
         XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A180'])
         else if (173<=i)and(i<180) then
              XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A173'])
              else if (159<=i)and(i<173) then
                   XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A159'])
                   else if (152<=i)and(i<159) then
                        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A152'])
                        else if (147<=i)and(i<152) then
                             XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A147'])
                             else if (i mod 2)=0 then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A'+IntToStr(i-1)]);
  end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
 else
 begin
   nn:=PRNSNnak.Value;
   if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
   begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
     if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0 then
        if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
          XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
     FormMain.VisM1.P1:=PRNSID.Value; /// Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
   end;
 end;
end;

/// Метод печати для общепита
procedure TFormPrint.Rash_Obdrog;
var osh,nstr,sname,sdop,provki,provka,s1,s2,s3:String;
    ns,kolt,i,j,namdop,nn:Integer;
    itogstov,itogstara,itognac,itogsnac,itognad,itognds,itogtrans:Double;
    itogstovr,itogstarar,itogkolt,itogstorg,itogmassa:Double;
begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeObdrog(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then
     raise Exception.Create(osh)
  else ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.SQL.Strings[2]:='order by KodGr';
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  XL.WorkBooks.Add(ProgDir+'ТТН_obschepit.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  ///XL.Visible:=true;
  kolt:=qPrint.RecordCount;
  ZaglN;
  itogstov:=0;itogstara:=0;itognac:=0;itogsnac:=0;itognad:=0;
  itognds:=0;itogtrans:=0;itogstovr:=0;itogstarar:=0;itogkolt:=0;itogstorg:=0;
  i:=0;j:=0;provki:='';provka:='';
  nstr:='38';
  for i:=1  to kolt do
  begin
    nstr:=Incn(nstr);
    XL.Range['B'+nstr]:=qPrintNNT.AsString;
    sname:='';sdop:='';
    Memo1.Text:=qPrintName.Value+' '+qPrintDop.Value;
    sname:=Memo1.Lines.Strings[0];
    if Length(qPrintName.AsString)<=Length(sname) then
    begin
      sname:=qPrintName.AsString;
      sdop:=qPrintDop.AsString;
      namdop:=1;
    end
    else
    begin
      for j:=1 to Memo1.Lines.Count-1 do
        sdop:=sdop+Memo1.Lines.Strings[j];
      namdop:=0;
    end;
    XL.Range['C'+nstr]:=sname;
    XL.Range['I'+nstr]:=qPrintEI.AsString;
    if qPrintFas.AsString='' then
      XL.Range['K'+nstr]:=qPrintQnt.AsString
    else XL.Range['K'+nstr]:=qPrintFas.AsString+'='+qPrintQnt.AsString;
    itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nstr]:=qPrintPrice.AsString;
    XL.Range['O'+nstr]:=qPrintSumwoNDS.AsString;
    itogsnac:=itogsnac+qPrintSumTotal.Value;
     itogstorg:=itogstorg+qPrintSumwoNDS.Value;
    XL.Range['R'+nstr]:=qPrintNDS.AsString;
    XL.Range['S'+nstr]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nstr]:=qPrintSumTotal.AsString;
    XL.Range['AA'+nstr]:=qPrintMassaGruza.AsString;
     itogmassa:=itogmassa+qPrintMassaGruza.Value;
    XL.Range['AC'+nstr]:=qPrintPricewNDS.AsString;
    if qPrintKodGr.Value<>99 then
      itogstov:=itogstov+qPrintSumwNDS.Value
    else itogstara:=itogstara+qPrintSumwNDS.Value;
    XL.Range['AE'+nstr]:=qPrintPricewoNDS.AsString;
    if qPrintKodGr.Value<>99 then
      itogstovr:=itogstovr+qPrintSumTotal.Value
    else itogstarar:=itogstarar+qPrintSumTotal.Value;
    XL.Range['AH'+nstr]:=qPrintAddTorg.AsString;
    itognad:=itognad+qPrintSumTorg.Value;
    XL.Range['AJ'+nstr]:=qPrintNac.AsString;
    itogtrans:=itogtrans+qPrintSumTrans.Value;
    if sdop<>'' then
    begin
      nstr:=Incn(nstr);
      XL.Range['B'+nstr]:=sdop;
      if namdop=0 then
      begin
        XL.Range['B'+nstr].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(sname) ).Font.FontStyle:='полужирный';
        XL.Rows[nstr].Autofit;
      end;
    end
    else
    begin
      nstr:=Incn(nstr);
      XL.Rows[nstr].RowHeight:=0;
    end;
    qPrint.Next;
  end;
  nstr:=Incn(nstr);
  XL.Rows[nstr+':148'].Select;
  XL.Selection.RowHeight:=0;
  /// ИТОГИ
  XL.Range['K149']:=itogkolt;
  XL.Range['O149']:=itogstorg;
  XL.Range['S149']:=itognds;
  XL.Range['V149']:=itogsnac;
  XL.Range['AA149']:=itogmassa;

  XL.Range['F152']:=itogstov;
  XL.Range['F153']:=itogstara;
  XL.Range['F154']:=itogstov+itogstara;
  XL.Range['F156']:=itogsnac-itogstovr-itogstarar;
  XL.Range['F157']:=itogsnac;
  XL.Range['O152']:=itognad;
  XL.Range['O153']:=itognds;
  XL.Range['O154']:=itogtrans;
  XL.Range['O155']:=itogstovr;
  XL.Range['O156']:=itogstarar;
  XL.Range['O157']:=itogstovr+itogstarar;
  XL.Range['F159']:=UtilForm.SumNumToFull(itognds);
  XL.Range['G161']:=UtilForm.SumNumToFull(itogsnac);

  if itogmassa>0 then
 begin
   s1:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(itogmassa),',',1));
   if UtilForm.P(FloatToStr(itogmassa),',',2)<>'' then
     itogmassa:=StrToFloat(UtilForm.P(FloatToStr(itogmassa),',',2))*10
   else    itogmassa:=0;
   s2:=UtilForm.MoneyToText(FloatToStr(itogmassa));
   s3:=s1+'кг. '+s2+'гр.';
   XL.Range['G163']:=s3;
 end;

  XL.Range['F165']:=PRNZOtpRazr.AsString;// отпуск разрешил
  XL.Range['G167']:=PRNZCdalOtp.AsString;// сдал отправитель
  XL.Range['AA165']:=PRNSVodName.AsString;// принял водитель
  XL.Range['X167']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE167']:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['Z169']:=PRNZPrinPol.AsString;// груз получил

  /// ПРОВОДКИ
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P2:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))'+
    ',P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
  if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
  else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
       else FormMain.VisM1.P5:=0;
  if (FormMain.VisM1.P5>0) then
  Begin
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.P2:=PRNSID.Value;
    FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
    osh:=FormMain.VisM1.P4;
    if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
    else  provki:=FormMain.VisM1.P3;
    i:=1;
    j:=1;
    provka:=UtilForm.P(provki,'!',j);
    while provka<>'' do
    begin
      if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
      then
      begin
        XL.Range['R'+IntToStr(152+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['U'+IntToStr(152+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        itogstov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        itogstov:=itogstov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(152+i)]:=FloatToStr(itogstov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(152+i)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(152+i)]:=FloatToStr(itogstov)+'/'+UtilForm.P(provka,':',6);
        i:=i+1;
      end;
      j:=j+1;
      provka:=UtilForm.P(provki,'!',j);
    end;

    /// Зеркальные проводки
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.Execute('s P2=+$LG(^KSU.SOD(P1),7)');
    if FormMain.VisM1.P2<>'0'
    then
    begin
      FormMain.VisM1.P1:=FormMain.VisM1.P2;
      FormMain.VisM1.P3:=PRNSID.Value;
      FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P3), P4=$P(P3,";",1)');
      osh:=FormMain.VisM1.P4;
      if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
      else  provki:=FormMain.VisM1.P3;
      i:=1;
      j:=1;
      provka:=UtilForm.P(provki,'!',j);
      while provka<>'' do
      begin
        if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
        then begin
          XL.Range['AC'+IntToStr(152+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
          XL.Range['AF'+IntToStr(152+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
          itogstov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
          itogstov:=itogstov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
          if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(152+i)]:=FloatToStr(itogstov)
          else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(152+i)]:=UtilForm.P(provka,':',6)
               else XL.Range['AI'+IntToStr(152+i)]:=FloatToStr(itogstov)+'/'+UtilForm.P(provka,':',6);
          i:=i+1;
        end;
        j:=j+1;
        provka:=UtilForm.P(provki,'!',j);
      end;
    end;
  End;

  if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0 then
  begin
    i:=0;
    i:=XL.WorkBooks[1].Sheets[1].HPageBreaks[1].Location.Row;
    if (187<=i)and(i<=199) then
    XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A188'])
    else if (180<=i)and(i<187) then
         XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A180'])
         else if (173<=i)and(i<180) then
              XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A173'])
              else if (159<=i)and(i<173) then
                   XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A159'])
                   else if (152<=i)and(i<159) then
                        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A152'])
                        else if (147<=i)and(i<152) then
                             XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A147'])
                             else if (i mod 2)=0 then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A'+IntToStr(i-1)]);
  end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
 else
 begin
   nn:=PRNSNnak.Value;
   if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
   begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
     if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0 then
        if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
          XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
     FormMain.VisM1.P1:=PRNSID.Value; /// Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
   end;
 end;
end;

/// отличие этого метода от BaseOpt только в том,
/// что печать производится на приложении
/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_BaseOpt
/// они одинаковы и наоборот
procedure TFormPrint.Rash_BaseOptPril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sndsf:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin

koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_lopo1.xls');
XL.WorkBooks[1].Sheets[2].Activate;
///XL.visible:=true;
 XL.Range['B39']:='Товар согласно приложения';
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладгой № '+nn;
 ny:=5;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cenatr);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown].RowHeight:=0;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
      j:=0;
      FormMain.VisM1.P1:=SK;
      FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormFTXPRN",P1,"Primech"),""),P3=+$P(P2,":",1)');
      j:=FormMain.VisM1.P3;
      if j=2 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
      XL.Range['AG'+n]:=SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
    end
   else
    begin
     {rown:=InttoStr(ny+1);
     XL.Rows[rown].RowHeight:=0;}
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['AG'+n]:=SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then sndsf:=sndsf+qPrintSumNDS.Value;
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2);
   if qPrintSkid.Value>0 then
     skida:=skida+SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,-2);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   if i<>koln then
   begin
     XL.Range['B'+IntToStr(ny-2)+':'+'AJ'+IntToStr(ny)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(ny+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(ny+2)].Characters().Font.FontStyle:='';
   end
   else
   begin
     XL.Range['B'+IntToStr(ny-2)+':'+'AJ'+IntToStr(ny-2)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(ny+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(ny+1)+':'+'AJ'+IntToStr(ny+1)].Select;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Selection.Borders[xlEdgeRight].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   end;
   qPrint.Next;
  end;
  //Печать итогов
  vy:=ny;
  XL.Range['C'+IntToStr(vy+1)]:='ИТОГО:';
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(vy+1);
  XL.WorkBooks[1].Sheets[2].Activate;
  vy:=39;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);

  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  if skida>0 then
  begin
   XL.Range['B'+IntToStr(vy+9)+':E'+IntToStr(vy+9)].Merge;
   XL.Range['B'+IntToStr(vy+9)].HorizontalAlignment:=xlLeft;
   XL.Range['B'+IntToStr(vy+9)+':E'+IntToStr(vy+9)].Select;
   XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   XL.Range['B'+IntToStr(vy+9)]:='Сумма скидки';
   XL.Range['F'+IntToStr(vy+9)+':H'+IntToStr(vy+9)].Merge;
   XL.Range['F'+IntToStr(vy+9)].HorizontalAlignment:=xlCenter;
   XL.Range['F'+IntToStr(vy+9)+':H'+IntToStr(vy+9)].Select;
   XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(skida,-2));
  end;

  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds-sndsf,-2));

  XL.Range['I'+IntToStr(vy+6)]:='НДС тов. по фикс. ценам';
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sndsf,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;

    /// Зеркальные проводки
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.Execute('s P2=+$LG(^KSU.SOD(P1),7)');
    if FormMain.VisM1.P2<>'0'
    then
    begin
      FormMain.VisM1.P1:=FormMain.VisM1.P2;
      FormMain.VisM1.P3:=PRNSID.Value;
      FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P3), P4=$P(P3,";",1)');
      osh:=FormMain.VisM1.P4;
      if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
      else  provki:=FormMain.VisM1.P3;
      i:=6;
      j:=1;
      provka:=UtilForm.P(provki,'!',j);
      while provka<>'' do
      begin
       if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
       then begin
        XL.Range['AC'+IntToStr(vy+i-1)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['AF'+IntToStr(vy+i-1)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-1)]:=FloatToStr(stov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-1)]:=UtilForm.P(provka,':',6)
             else XL.Range['AI'+IntToStr(vy+i-1)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
      i:=i+1;
     end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
    end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  sumtov:=SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds-sndsf,-2)-SimpleRoundTo(skida,-2);
  XL.Range['B'+IntToStr(vy+9)]:='Всего к оплате:';
  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumtov);
  XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(sumtov)+' / '+UtilForm.SumNumToFull(sumtov);
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистый листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_OptBer;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs,oper:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sndsf:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeOptBer(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;sndsf:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_BaseOptPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo1.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
 XL.Range['K20']:='Накладная №'+nn+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cenatr);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
      XL.Range['AG'+n]:=SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
    end
   else
    begin
     {rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;}
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['AG'+n]:=SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then sndsf:=sndsf+qPrintSumNDS.Value;
   snds:=snds+qPrintSumNDS.Value;
   if qPrintSkid.Value>0 then
     skida:=skida+SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,-2);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  if skida>0 then
  begin
   XL.Range['B'+IntToStr(vy+9)+':E'+IntToStr(vy+9)].Merge;
   XL.Range['B'+IntToStr(vy+9)].HorizontalAlignment:=xlLeft;
   XL.Range['B'+IntToStr(vy+9)+':E'+IntToStr(vy+9)].Select;
   XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   XL.Range['B'+IntToStr(vy+9)]:='Сумма скидки';
   XL.Range['F'+IntToStr(vy+9)+':H'+IntToStr(vy+9)].Merge;
   XL.Range['F'+IntToStr(vy+9)].HorizontalAlignment:=xlCenter;
   XL.Range['F'+IntToStr(vy+9)+':H'+IntToStr(vy+9)].Select;
   XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(skida,-2));
  end;

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds-sndsf,-2));

  XL.Range['I'+IntToStr(vy+6)]:='НДС тов. по фикс. ценам';
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sndsf,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;

    /// Зеркальные проводки
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.Execute('s P2=+$LG(^KSU.SOD(P1),7)');
    if FormMain.VisM1.P2<>'0'
    then
    begin
      FormMain.VisM1.P1:=FormMain.VisM1.P2;
      FormMain.VisM1.P3:=PRNSID.Value;
      FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P3), P4=$P(P3,";",1)');
      osh:=FormMain.VisM1.P4;
      if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
      else  provki:=FormMain.VisM1.P3;
      i:=6;
      j:=1;
      provka:=UtilForm.P(provki,'!',j);
      while provka<>'' do
      begin
       if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
       then begin
        if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
        else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
             else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
      i:=i+1;
     end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;

    end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  sumtov:=SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds-sndsf,-2);
  XL.Range['B'+IntToStr(vy+10)]:='Всего к оплате:    '+FloatToStr(sumtov);
  XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(sumtov)+' / '+UtilForm.SumNumToFull(sumtov);
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_BaseOptPril
/// они одинаковы и наоборот
procedure TFormPrint.Rash_BaseOpt;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sndsf:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeBaseOpt(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;sndsf:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_BaseOptPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo1.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cenatr);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   j:=0;
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormFTXPRN",P1,"Primech"),""),P3=+$P(P2,":",1)');
   j:=FormMain.VisM1.P3;

   if (j=2)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if j=2 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
      XL.Range['AG'+n]:=SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
    end
   else
    begin
     {rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;}
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['AG'+n]:=SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then sndsf:=sndsf+qPrintSumNDS.Value;
   snds:=snds+qPrintSumNDS.Value;
   if qPrintSkid.Value>0 then
     skida:=skida+SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,-2);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  if skida>0 then
  begin
   XL.Range['B'+IntToStr(vy+9)+':E'+IntToStr(vy+9)].Merge;
   XL.Range['B'+IntToStr(vy+9)].HorizontalAlignment:=xlLeft;
   XL.Range['B'+IntToStr(vy+9)+':E'+IntToStr(vy+9)].Select;
   XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   XL.Range['B'+IntToStr(vy+9)]:='Сумма скидки';
   XL.Range['F'+IntToStr(vy+9)+':H'+IntToStr(vy+9)].Merge;
   XL.Range['F'+IntToStr(vy+9)].HorizontalAlignment:=xlCenter;
   XL.Range['F'+IntToStr(vy+9)+':H'+IntToStr(vy+9)].Select;
   XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(skida,-2));
  end;
  {XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1; }

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds-sndsf,-2));

  XL.Range['I'+IntToStr(vy+6)]:='НДС тов. по фикс. ценам';
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sndsf,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;

    /// Зеркальные проводки
    FormMain.VisM1.P1:=PRNSOperac.Value;
    FormMain.VisM1.Execute('s P2=+$LG(^KSU.SOD(P1),7)');
    if FormMain.VisM1.P2<>'0'
    then
    begin
      FormMain.VisM1.P1:=FormMain.VisM1.P2;
      FormMain.VisM1.P3:=PRNSID.Value;
      FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P3), P4=$P(P3,";",1)');
      osh:=FormMain.VisM1.P4;
      if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
      else  provki:=FormMain.VisM1.P3;
      i:=6;
      j:=1;
      provka:=UtilForm.P(provki,'!',j);
      while provka<>'' do
      begin
       if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
       then begin
        if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
        else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
             else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
      i:=i+1;
     end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;

    end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  sumtov:=SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds-sndsf,-2)-SimpleRoundTo(skida,-2);
  XL.Range['B'+IntToStr(vy+9)]:='Всего к оплате:';
  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumtov);
  XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(sumtov)+' / '+UtilForm.SumNumToFull(sumtov);
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_BrRinTN;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeBrRin(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТН_rozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+SimpleRoundTo(cena*(1+(qPrintAddOpt.Value/100))*qnt,-2)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+SimpleRoundTo(cena*(1+(qPrintAddOpt.Value/100))*qnt,-2)
   else  sumtov:=sumtov+SimpleRoundTo(cena*(1+(qPrintAddOpt.Value/100))*qnt,-2);
   if nadabs=0 then
    begin
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end;
        if nado<>0 then
          begin
            sumnado:=sumnado+(cenatr*qnt*nado/100);
            sndsb:=sndsb+(cenatr*(1+nad/100)*(1+qPrintNDS.Value/100)*qnt)
          end;
     end
   else begin
          if nad<>0 then
          begin
            sumnad:=sumnad+(nad*qnt);
            sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
          end;
          if nado<>0 then
          begin
            sumnado:=sumnado+(nado*qnt);
            sndsb:=sndsb+((cenatr+nado)*(1+qPrintNDS.Value/100)*qnt)
          end;
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
   else                         sumroztov:=sumroztov+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 FormMain.VisM1.P1:=SK;  //  PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P6=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P6<>0 then FormMain.VisM1.P1:=FormMain.VisM1.P6;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             //XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_Opt;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka,str1:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,tara:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeOpt(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP10.xls');
  {if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;}

  vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;

  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    str:=qPrintName.Value+' '+qPrintDop.Value;
    Memo1.Width:=290;
    Memo1.Text:=str;
    str1:=Memo1.Lines.Strings[0];
    str:=Copy(str,Length(str1),Length(str));
    if Length(str1)>=Length(qPrintName.AsString) then
    begin
      str1:=qPrintName.AsString+' ';
      str:=qPrintDop.AsString;
    end;
    Memo1.Width:=193;
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+str1;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
//    XL.Range['Y'+nrs]:=qPrintFas.AsString; // кол-во грузовых мест
//    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
//     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if str<>''
    then begin
           XL.Range['B'+nrs]:=str;
           if (1+Length(qPrintName.AsString)-Length(str1))>0 then
              XL.Range['B'+nrs].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

  FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(96+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(96+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(96+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',6)<>'' then
     begin
       XL.Range['R'+InttoStr(96+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(96+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(96+vniz)]:='Сумма';
     end;
   end;
   i:=97;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=5 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
   End;
  {if (kolt<>1)and(kolt<>25)and(kolt<>47) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
  end;}

  inc(nrt);
  nrs:=IntToStr(nrt);
  XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
// XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
// str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
// str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
// XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else
  begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if (XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0) then
        if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
          XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
    end;
  end;
     Memo1.Width:=193;
End;

procedure TFormPrint.Rash_Gor;
var osh,n,str,str1:String;
    ns,koln,i,nst,j:Integer;
    qnt,itogkol,itogstoim,itogstoimnds,itogsumnds,itogsumndsskl,itogsumskl:Double;
    itogtov,itogsteklo,itogtara,itogroztov,itogroztara,itognds10,itognds20:Double;
    itogsumnad,itogsumnadskl,stov:Double;
    orgpl:Boolean; //Плательщик головная организация
    kodpl,viborttn:Integer;  //Её код
    provki,provka:String;    
Begin
 osh:='';
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh1(P1,P3)');
 osh:=FormMain.VisM1.P2;
 if osh<>'' then
   raise Exception.Create(osh)
 else ns:=FormMain.VisM1.P3;

 viborttn:=0;
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormFTXPRN",P1,"Primech")),P3=+$P(P2,":",1)');
 viborttn:=FormMain.VisM1.P3;
 if viborttn=2 then XL.WorkBooks.Add(ProgDir+'ТТН_Gor1.xls')
 else XL.WorkBooks.Add(ProgDir+'ТТН_Gor.xls');
 XL.WorkBooks[1].Sheets[1].Activate;
 //XL.Visible:=true;

 // ШАПКА
 //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;
  //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  //Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);
  //Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  XL.Range['K17']:='Накладная № '+inttostr(nn)+', от '+PRNSDateN.AsString;// Дата
  XL.Range['V17']:='Отпущено со склада '+IntToStr(KMOLG);
  //XL.Range['B20']:=PRNSDateN.Value;// Дата}

  //Транспорт
  XL.Range['E18']:=PRNSCar.Value;
  XL.Range['AE18']:=PRNZPutList.Value;
  XL.Range['G20']:=PRNZOwnCarName.Value;
  XL.Range['Z20']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F24']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3+', '+AnsiUpperCase(FormMain.Vism2.P5);// Грузоотправитель
  XL.Range['F24'].Characters.Font.FontStyle:='полужирный';
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F26']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['I22']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['I22']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['I22']:='=F26';
     end;
    end
   end
  else
   begin
   XL.Range['F26']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I22']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G28']:=PRNZOsnOtp.Value;
//  XL.Range['Z20']:=PRNZCelPriobr.Value;
  XL.Range['Q28']:=PRNZPunktPogr.Value;
  XL.Range['AD28']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F30']:=PRNZPereadr.Value;


 qPrint.Close;
 qPrint.Prepare;
 qPrint.SQL.Strings[2]:='order by KodGr';
 qPrint.ParamByName('ns').Value:=ns;
 qPrint.Open;
 qPrint.First;
 itogkol:=0;itogstoim:=0;itogstoimnds:=0;itogsumnds:=0;itogsumndsskl:=0;itogsumskl:=0;
 itogtov:=0;itogsteklo:=0;itogtara:=0;itogroztov:=0;itogroztara:=0;
 itognds10:=0;itognds20:=0;itogsumnad:=0;itogsumnadskl:=0;stov:=0;
 koln:=qPrint.RecordCount;
 nst:=36;
 for i:=1 to koln do
 begin
   n:=IntToStr(nst);
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.AsString+' '+qPrintDop.AsString;
   Memo1.Width:=250;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   {if Length(str1)<Length(qPrintName.AsString) then
   begin
     str:=Copy(str,Length(str1),Length(str));
   end
   else begin
          str1:=qPrintName.AsString+' ';
          str:=qPrintDop.AsString;
        end;}
   Memo1.Width:=193;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   XL.Range['K'+n]:=FloatToStr(qPrintQnt.Value);
    qnt:=qPrintQnt.Value;
    itogkol:=itogkol+qnt;
   XL.Range['M'+n]:=qPrintPricewNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
    itogstoim:=itogstoim+SimpleRoundTo(qPrintSumTotal.Value,-2);
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   begin
     XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
     itogsumnds:=itogsumnds+SimpleRoundTo(qPrintSumNDS.Value,-2);
   end;
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
    itogstoimnds:=itogstoimnds+SimpleRoundTo(qPrintSumTotal.Value,-2);
   //XL.Range['Y'+n]:=qPrintGrMest.AsString;
   //XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   XL.Range['AC'+n]:=FloatToStr(SimpleRoundTo(qPrintPrice.Value,-2));
   XL.Range['AE'+n]:=qPrintGGR.Asstring;
   XL.Range['AF'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDSO.Value,-2));
    itogsumndsskl:=itogsumndsskl+SimpleRoundTo(qPrintSumNDSO.Value,-2);
   XL.Range['AH'+n]:=FloatToStr(SimpleRoundTo(qPrintPricewTax.Value,-2));
   XL.Range['AI'+n]:=FloatToStr(SimpleRoundTo(qPrintSumsNDS.Value,-2));
    itogsumskl:=itogsumskl+SimpleRoundTo(qPrintSumsNDS.Value,-2);
   XL.Range['AJ'+n]:=qPrintAddTorg.Asstring;

   if str<>'' then
    begin
     nst:=nst+1;
     n:=InttoStr(nst);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     XL.Rows[nst].Autofit;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     n:=InttoStr(nst+1);
     XL.Rows[n+':'+n].RowHeight:=0;
    end;
   if viborttn=2 then
   begin
     nst:=nst+1;
     n:=InttoStr(nst);
     if qPrintTrans.Value<>0 then
       XL.Range['C'+n]:='Транспортные расходы: '+qPrintTrans.AsString
     else XL.Rows[n+':'+n].RowHeight:=0;
   end;  
   /// ИТОГИ
   if (qPrintKodGr.Value<>93)and(qPrintKodGr.Value<>99) then
     itogtov:=itogtov+SimpleRoundTo(qPrintSumBegin.Value,-2)
   else if (qPrintKodGr.Value=93) then
          itogsteklo:=itogsteklo+SimpleRoundTo(qPrintSumBegin.Value,-2)
        else if (qPrintKodGr.Value=99) then
               itogtara:=itogtara+SimpleRoundTo(qPrintSumBegin.Value,-2);
   if (qPrintKodGr.Value<>99) then
     itogroztov:=itogroztov+SimpleRoundTo(qPrintSumTotal.Value,-2)
   else if (qPrintKodGr.Value=99) then
          itogroztara:=itogroztara+SimpleRoundTo(qPrintSumTotal.Value,-2);
   if qPrintNDS.Value=10 then itognds10:=itognds10+SimpleRoundTo(qPrintSumNDS.Value,-2);
   nst:=nst+1;
   qPrint.Next;
 end;
 XL.Rows[IntToStr(nst)+':163'].RowHeight:=0;
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).nadtorg(P1)');
 itogsumnadskl:=FormMain.VisM1.P2;
 FormMain.VisM1.Execute('s P3=##Class(KSU.Provodki).nadbase(P1)');
 itogsumnad:=FormMain.VisM1.P3;

 XL.Range['K164']:=FloatToStr(itogkol);
 XL.Range['O164']:=FloatToStr(itogstoim);
 XL.Range['S164']:=FloatToStr(itogsumnds);
 XL.Range['V164']:=FloatToStr(itogstoimnds);
 XL.Range['AF164']:=FloatToStr(itogsumndsskl);
 XL.Range['AI164']:=FloatToStr(itogsumskl);

 XL.Range['F168']:=FloatToStr(itogtov);
 XL.Range['F169']:=FloatToStr(itogsteklo);
 XL.Range['F170']:=FloatToStr(itogtov+itogsteklo);
 XL.Range['F171']:=FloatToStr(itogtara);
 XL.Range['F172']:=FloatToStr(itogtov+itogsteklo+itogtara);
 XL.Range['O168']:=FloatToStr(itogsumnadskl);
 XL.Range['O169']:=FloatToStr(itogsumnad);
 XL.Range['O170']:=FloatToStr(itognds10);
 XL.Range['O171']:=FloatToStr(itogsumnds-itognds10);
 XL.Range['O172']:=FloatToStr(itogroztov);
 XL.Range['O173']:=FloatToStr(itogroztara);
 XL.Range['O174']:=FloatToStr(itogroztov+itogroztara);

 XL.Range['F176']:=UtilForm.SumNumToFull(itogsumnds);
 XL.Range['H178']:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F180']:=UtilForm.SumNumToFull(itogstoimnds);

 XL.Range['Y186']:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE186']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F184']:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H186']:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z188']:=PRNZPrinPol.AsString;// принял грузополучатель
 XL.Range['H217']:=PRNZDokTov.AsString;// с товаром переданы документы

 /// ПРОВОДКИ
 FormMain.VisM1.P1:=SK;  //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(i+168)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(i+168)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(i+168)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(i+168)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(i+168)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      XL.Range['AC'+IntToStr(i+162)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(i+162)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(i+162)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(i+162)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(i+162)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  if (koln>9)and(koln<17) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A200']);
  if (koln>=17)and(koln<22) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A192']);
  if (koln>=22)and(koln<27) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A176']);
  if (koln>=27)and(koln<=34) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A166']);


  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0 then
      if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
          XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
 Memo1.Width:=193;

 //XL.Visible:=true;

End;

procedure TFormPrint.Rash_Rozn24;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,trans:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO4(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_rozn1.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPricewoNDS.Value;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   nad:=qPrintAddSuppl.Value; //qPrintAddOpt.Value+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=FloatToStr(nad);
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   FormMain.VisM1.P1:=qPrintNNT.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
   XL.Range['AI'+n]:=FormMain.VisM1.P2;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       if qPrintAddOpt.Value>0 then
         XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo((qPrintSumwoNDS.Value*qPrintSkid.Value/100),-2);
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   if FormMain.VisM1.P2=0 then
        if nad<>0 then
        begin
          sumnad:=sumnad+(cena*qnt*nad/100);
          sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        end
   else if nad<>0 then
        begin
          sumnad:=sumnad+((cena+nad)*qnt);
          sndsb:=sndsb+((cena+nad)*qPrintNDS.Value/100*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo((sumtov+sumstk),-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo((sumtov+sumstk+sumtara),-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo((sumroztov+sumroztara),-2));
  XL.Range['R'+IntToStr(vy+4)]:='';
  XL.Range['U'+IntToStr(vy+4)]:='';
  XL.Range['X'+IntToStr(vy+4)]:='';
  XL.Range['AC'+IntToStr(vy+4)]:='';
  XL.Range['AF'+IntToStr(vy+4)]:='';
  XL.Range['AI'+IntToStr(vy+4)]:='';
 //Печать для возврата
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;  
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;
{
  XL.Range['R'+IntToStr(vy+5)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+6)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+7)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+8)]:='427/11';
  XL.Range['R'+IntToStr(vy+9)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+10)]:='441/11';
  XL.Range['U'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+6)]:='183/33';
  XL.Range['U'+IntToStr(vy+7)]:='183/11';
  XL.Range['U'+IntToStr(vy+8)]:='601/'+PRNSTpKod.AsString;
  XL.Range['U'+IntToStr(vy+9)]:='423/11';
  XL.Range['U'+IntToStr(vy+10)]:='411/'+IntToStr(SK);

  FormMain.VisM1.P1:=PRNSID.AsString;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltara(P1),P3=##Class(KSU.Provodki).ccklsteklo(P1),'+
  'P4=##Class(KSU.Provodki).cckltovfix(P1),P5=##Class(KSU.Provodki).cckltov(P1),'+
  'P6=##Class(KSU.Provodki).nadbase(P1),P7=##Class(KSU.Provodki).nadpostskl(P1),'+
  'P8=##Class(KSU.Provodki).ndscckltov10(P1),P9=##Class(KSU.Provodki).ndscckltov20(P1)');
  sumtara:=FormMain.VisM1.P2; sumsteklo:=FormMain.VisM1.P3; sumfix:=FormMain.VisM1.P4;
  sumtov:=FormMain.VisM1.P5;sumbase:=FormMain.VisM1.P6;sumpost:=FormMain.VisM1.P7;
  sumnds10:=FormMain.VisM1.P8; sumnds20:=FormMain.VisM1.P9;
  FormMain.VisM1.P2:=0;  FormMain.VisM1.P3:=0;  FormMain.VisM1.P4:=0;
  FormMain.VisM1.P5:=0;  FormMain.VisM1.P6:=0;  FormMain.VisM1.P7:=0;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).skidskl(P1),P3=##Class(KSU.Provodki).ndsccklskids(P1),'+
  'P4=##Class(KSU.Provodki).ndsskids(P1),P5=##Class(KSU.Provodki).ndsskidtv(P1),'+
  'P6=##Class(KSU.Provodki).ndscckltara(P1),P7=##Class(KSU.Provodki).trans(P1)');
  skidtv:=FormMain.VisM1.P2;skids:=FormMain.VisM1.P3;
  ndsskids:=FormMain.VisM1.P4;ndsskidtv:=FormMain.VisM1.P5;
  ndstara:=FormMain.VisM1.P6; trans:=FormMain.VisM1.P7;
  tov:=sumtov+sumpost+sumbase+sumnds10+sumnds20+ndstara-skid;

  XL.RAnge['X'+IntToStr(vy+5)]:=FloatToStr(tov+sumtara);
  XL.RAnge['X'+IntToStr(vy+6)]:=FloatToStr(sumnds10);
  XL.RAnge['X'+IntToStr(vy+7)]:=FloatToStr(sumnds20);
  XL.RAnge['X'+IntToStr(vy+8)]:=FloatToStr(skidtv);
  XL.RAnge['X'+IntToStr(vy+9)]:=FloatToStr(sumpost);
  XL.RAnge['X'+IntToStr(vy+10)]:=FloatToStr(trans);
}
  {  XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
  XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad);
  if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
  else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
}  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo((sumtov+sumtara+sumstk+snds-skida),-2)); //+sumnad
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_Rozn20;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
 /// Печать лимитной карточки
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P3:=':'+PRNSOperac.AsString+':';
 FormMain.VisM1.P4:=PRNSID.Value;
 FormMain.VisM1.Execute('s P2=":"_$G(^KSU.Option("FormFTXPRN",P1,"LimitKarta"),"")_":" '+
                        ' if P2[P3 {s P5=1,P6=##Class(KSU.tNaklPrint).PrePrint(P4),P7=$P(P6,":",1),P8=$P(P6,":",2)} '+
                        ' else {s P5=0}');
 if FormMain.VisM1.P5=1 then
 begin
   ns:=StrToInt(FormMain.VisM1.P7);
   osh:='';
   osh:=FormMain.VisM1.P8;
   if osh<>'' then
     raise Exception.Create('Ошибка формирования лимитной карточки '+osh);
   qPrint.Close;
   qPrint.Prepare;
   qPrint.ParamByName('ns').Value:=ns;
   qPrint.Open;
   FormMain.VisM2.P1:=PodrG;
   FormMain.VisM2.Execute('s P2=$P(^SPD(P1),":",1)');
   ppLabel385.Text:=FormMain.VisM2.P2;
   FormMain.VisM2.P2:=Mes;
   FormMain.VisM2.Execute('s P4=$$Mes1^AA(P2)');
   ppLabel390.Text:=FormMain.VisM2.P4;
   ppLabel394.Text:=IntToStr(God);
   LimitKarta.DeviceType:=dtScreen;
   LimitKarta.Print;
 end;
 /// Печать накладной
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;skidtv:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_rozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   if qPrintSkid.Value<>0 then
     skidtv:=skidtv+(qPrintSumTotal.Value*qPrintSkid.Value/100);
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else begin
          if nad<>0 then
          begin
            sumnad:=sumnad+(nad*qnt);
            sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
          end;
          if nado<>0 then
          begin
            sumnado:=sumnado+(nado*qnt);
            sndsb:=sndsb+((cenatr+nado)*(1+qPrintNDS.Value/100)*qnt)
          end;
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
   else                         sumroztov:=sumroztov+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(skidtv,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 {FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;}

  FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

 // Используется только торговая надбавка и НДС
/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_Rozn21Pril
/// они одинаковы и наоборот
procedure TFormPrint.Rash_Rozn21;
var osh,str,str1,rown,nn,s1,s2,s3:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado,massagr:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
 /// Печать лимитной карточки
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P3:=':'+PRNSOperac.AsString+':';
 FormMain.VisM1.P4:=PRNSID.Value;
 FormMain.VisM1.Execute('s P2=":"_$G(^KSU.Option("FormFTXPRN",P1,"LimitKarta"),"")_":" '+
                        ' if P2[P3 {s P5=1,P6=##Class(KSU.tNaklPrint).PrePrint(P4),P7=$P(P6,":",1),P8=$P(P6,":",2)} '+
                        ' else {s P5=0}');
 if FormMain.VisM1.P5=1 then
 begin
   ns:=StrToInt(FormMain.VisM1.P7);
   osh:='';
   osh:=FormMain.VisM1.P8;
   if osh<>'' then
     raise Exception.Create('Ошибка формирования лимитной карточки '+osh);
   qPrint.Close;
   qPrint.Prepare;
   qPrint.ParamByName('ns').Value:=ns;
   qPrint.Open;
   FormMain.VisM2.P1:=PodrG;
   FormMain.VisM2.Execute('s P2=$P(^SPD(P1),":",1)');
   ppLabel385.Text:=FormMain.VisM2.P2;
   FormMain.VisM2.P2:=Mes;
   FormMain.VisM2.Execute('s P4=$$Mes1^AA(P2)');
   ppLabel390.Text:=FormMain.VisM2.P4;
   ppLabel394.Text:=IntToStr(God);
   LimitKarta.DeviceType:=dtScreen;
   LimitKarta.Print;
 end;
 /// Печать накладной
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh1(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;skidtv:=0;
koln:=qPrint.RecordCount;
if koln>38 then   
begin
 Rash_Rozn21Pril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_rozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   if qPrintSkid.Value<>0 then
     skidtv:=skidtv+(qPrintSumTotal.Value*qPrintSkid.Value/100);
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else begin
          if nad<>0 then
          begin
            sumnad:=sumnad+(nad*qnt);
            sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
          end;
          if nado<>0 then
          begin
            sumnado:=sumnado+(nado*qnt);
            sndsb:=sndsb+((cenatr+nado)*(1+qPrintNDS.Value/100)*qnt)
          end;
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
   else                         sumroztov:=sumroztov+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(massagr);
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(skidtv,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 {FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;}


FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;


  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2)); //23^10
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

   if massagr>0 then
 begin
   s1:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(massagr),',',1));
   if UtilForm.P(FloatToStr(massagr),',',2)<>'' then
     massagr:=StrToFloat(UtilForm.P(FloatToStr(massagr),',',2))*10
   else    massagr:=0;
   s2:=UtilForm.MoneyToText(FloatToStr(massagr));
   s3:=s1+'кг. '+s2+'гр.';
   XL.Range['G'+IntToStr(vy+15)]:=s3;
 end;

  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

// Используется только торговая надбавка и НДС
/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_Rozn21
/// они одинаковы и наоборот
procedure TFormPrint.Rash_Rozn21Pril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
 /// Печать накладной
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh1(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;skidtv:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_rozn.xls');
XL.WorkBooks[1].Sheets[2].Activate;
///XL.visible:=true;
 XL.Range['B39']:='Товар согласно приложения';
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладгой № '+nn;
ny:=5;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   if qPrintSkid.Value<>0 then
     skidtv:=skidtv+(qPrintSumTotal.Value*qPrintSkid.Value/100);
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     ny:=ny+1;
     XL.Rows[IntToStr(ny)].RowHeight:=0;
     {rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;}
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          {rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;}
          ny:=ny+1;
          XL.Rows[IntToStr(ny)].RowHeight:=0;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else begin
          if nad<>0 then
          begin
            sumnad:=sumnad+(nad*qnt);
            sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
          end;
          if nado<>0 then
          begin
            sumnado:=sumnado+(nado*qnt);
            sndsb:=sndsb+((cenatr+nado)*(1+qPrintNDS.Value/100)*qnt)
          end;
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
   else                         sumroztov:=sumroztov+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2);
   if i<>koln then
   begin
     XL.Range['B'+IntToStr(ny-2)+':'+'AJ'+IntToStr(ny)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(ny+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(ny+2)].Characters().Font.FontStyle:='';
   end
   else
   begin
     XL.Range['B'+IntToStr(ny-2)+':'+'AJ'+IntToStr(ny-2)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(ny+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(ny+1)+':'+'AJ'+IntToStr(ny+1)].Select;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Selection.Borders[xlEdgeRight].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   end;
   XL.Range['B'+IntToStr(ny+1)+':'+'AJ'+IntToStr(ny+1)].Borders[xlEdgeTop].LineStyle:=1;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
   vy:=ny;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(vy+1);

 //Печать ТТН
 XL.WorkBooks[1].Sheets[2].Activate;
 vy:=39;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);

  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(skidtv,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистый листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_Rozn22;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;skidtv:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_rozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   if qPrintSkid.Value<>0 then
     skidtv:=skidtv+(qPrintSumTotal.Value*qPrintSkid.Value/100);
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   sumnado:=SimpleRoundTo(qPrintSumTotal.Value,-2)*qPrintNDS.Value/(100+qPrintNDS.Value);
   sumnad:=sumnad+SimpleRoundTo(SimpleRoundTo(qPrintSumTotal.Value,-2)-SimpleRoundTo(sumnado,-2)-(qPrintPrice.Value*qnt),-2);
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
   else                         sumroztov:=sumroztov+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(skidtv,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara-skidtv-sumnad,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara-skidtv-sumnad,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_Rozn23;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;skidtv:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_rozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   //if qPrintSkid.Value<>0 then
    // skidtv:=skidtv+(qPrintSumTotal.Value*qPrintSkid.Value/100);
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else begin
          if nad<>0 then
          begin
            sumnad:=sumnad+(nad*qnt);
            sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
          end;
          if nado<>0 then
          begin
            sumnado:=sumnado+(nado*qnt);
            sndsb:=sndsb+((cenatr+nado)*(1+qPrintNDS.Value/100)*qnt)
          end;
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2)
   else                         sumroztov:=sumroztov+SimpleRoundTo(qPrintPricewNDS.Value*qnt,-2);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));        ///zzzzzzzzzzzzzzzzzz               
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(skidtv,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P3<>'' then
    FormMain.VisM1.P1:=FormMain.VisM1.P3;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara-skidtv,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_Rozn20TN;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,nado,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,sumnado:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumnac,sumsnac:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
osh:=FormMain.VisM1.P2;
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(FormMain.VisM1.P3);
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;nado:=0;sumnado:=0;
sumnac:=0;sumsnac:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТН_rozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString;
   end;
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   if qPrintFas.AsString<>'' then
        XL.Range['K'+n]:=qPrintFas.AsString+'='+FloatToStr(qnt)
   else XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddTorg.Value;  //qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AH'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=qPrintAddOpt.AsString;
   nado:=qPrintAddOpt.Value;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
    sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
    sumsnac:=sumsnac+qPrintSumrwNDS.Value;
   if (qPrintTrans.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
     XL.Range['O'+n]:=qPrintSumTrans.AsString;
     XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
     if qPrintNac.Value>0 then
     begin
       XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
       '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
       {sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
       sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
     end
    end
   else if qPrintNac.Value>0 then
        begin
          ny:=ny+1;
          n:=IntToStr(ny);
          XL.Range['AD'+n]:='Наценка:'+qPrintNac.AsString+
          '%  Цена:'+qPrintVY.AsString+'  Сумма:'+qPrintSumrwNDS.AsString;
         { sumnac:=sumnac+(qPrintSumrwNDS.Value-SimpleRoundTo(qPrintSumTotal.Value,-2));
          sumsnac:=sumsnac+qPrintSumrwNDS.Value; }
        end
        else
        begin
          rown:=InttoStr(ny+1);
          XL.Rows[rown+':'+rown].Select;
          XL.Selection.Delete;
          vy:=vy-1;
        end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintSumwNDS.Value*qPrintSkid.Value/100,-2);
   //sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumTotal.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else begin
          if nad<>0 then
          begin
            sumnad:=sumnad+(nad*qnt);
            sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
          end;
          if nado<>0 then
          begin
            sumnado:=sumnado+(nado*qnt);
            sndsb:=sndsb+((cenatr+nado)*(1+qPrintNDS.Value/100)*qnt)
          end;
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['I'+IntToStr(vy+3)]:='Надбавка оптовая';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sumnado,-2));
  XL.Range['L'+IntToStr(vy+4)]:='торговая';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  if PRNSSkidNakl.Value>0 then
  begin
    XL.Range['F'+IntToStr(vy+9)]:=PRNSSkidNakl.AsString+' %';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(SimpleRoundTo((sumroztov*PRNSSkidNakl.Value/100),-2));
    sumroztov:=sumroztov-(sumroztov*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(snds*PRNSSkidNakl.Value/100,-2));
    snds:=snds-(snds*PRNSSkidNakl.Value/100);
    XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  end
  else if sumnac>0 then
  begin
    XL.Range['B'+IntToStr(vy+9)]:='Сумма наценки';
    XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(sumnac);
    XL.Range['B'+IntToStr(vy+10)]:='Сумма с наценкой';
    XL.Range['F'+IntToStr(vy+10)]:=FloatToStr(sumsnac);
  end;

  //Печать проводок
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  if sumnac=0 then
    XL.Range['H'+IntToStr(vy+13)]:='/ '+FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2))+' /'+UtilForm.SumNumToFull(SimpleRoundTo(sumroztov+sumroztara,-2))
  else XL.Range['H'+IntToStr(vy+13)]:= '/ '+FloatToStr(sumsnac)+' /'+UtilForm.SumNumToFull(sumsnac);
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(sumnado,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  if PRNSPrN.Value<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             //XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_GZK2;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,str1,osh:string;
  orgpl: boolean;
  intskid,TransR:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itoggruz,itogmest,tara:Double;
Begin
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  //реестр цен
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
  if FormMain.VisM1.P2='1' then
  begin
   FormMain.VisM1.P1:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeGZK(P1)');
   osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
   if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
   ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
   qPrint.Close;
   qPrint.Prepare;
   qPrint.ParamByName('ns').Value:=ns;
   qPrint.Open;
   qPrint.First;


  ppLabel323.Caption:=PRNSTpName.AsString;
  ppLabel322.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
  ppReport8.DeviceType:=dtScreen;
  ppReport8.Print;
 end;

  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeGZK(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;

  {ppLabel289.Caption:=PRNSTpName.AsString;
  ppLabel288.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
  ReestrCen.DeviceType:=dtScreen;
  ReestrCen.Print;}

  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv_ch.xls');
  {if kolt<=5 then begin vniz:=-44; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=26 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=52 then begin vniz:=50; XL.WorkBooks[1].Sheets[3].Activate; end;
  }
  XL.WorkBooks[1].Sheets[4].Activate;
  XL.Application.EnableEvents:=false;
  vniz:=50;
 /// nrstart:=39;

  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['P21']:=PRNSPricep.AsString;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 //XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itoggruz:=0;
  itogmest:=0;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    str:=qPrintName.Value+' '+qPrintDop.Value;
    Memo1.Width:=302;
    Memo1.Text:=str;
    str1:=Memo1.Lines.Strings[0];
    str:=Copy(str,Length(str1),Length(str));
    Memo1.Width:=193;
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+str1; ///qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumwoNDS.AsString;
     itogstoim:=itogstoim+qPrintSumwoNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.AsString;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;
    itoggruz:=itoggruz+qPrintMassaGruza.Value;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
    FormMain.VisM1.P1:=SK;
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormFTXPRN",P1,"Primech")),P3=+$P(P2,":",1)');
    if qPrintTax.Value=1 then
      if FormMain.VisM1.P3='0' then
        XL.Range['AC'+nrs]:='Первая цена '+qPrintPrice.AsString;
    if FormMain.VisM1.P3='1' then
      XL.Range['AC'+nrs]:='Торговая надбавка '+qPrintAddTorg.AsString+'%';
    {XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TransR:=TransR+qPrintTrans.Value;  }
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

  if (kolt<>5)and(kolt<>26)and(kolt<>52) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;

 ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(93+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 XL.Range['Y'+nrs]:=PRNZTotalPackages.AsString;
 nrs:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(105+vniz)]:=str;
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C'+IntToStr(120+vniz)]:=PRNZPogruzkaIsp.AsString;
 XL.Range['H'+IntToStr(120+vniz)]:=PRNZPogruzkaSpos.AsString;
 XL.Range['K'+IntToStr(120+vniz)]:=PRNZPogruzkaPrib.AsString;
 XL.Range['M'+IntToStr(120+vniz)]:=PRNZPogruzkaYbit.AsString;
 XL.Range['C'+IntToStr(121+vniz)]:=PRNZRazgrIsp.AsString;
 XL.Range['H'+IntToStr(121+vniz)]:=PRNZRazgrSpos.AsString;
 XL.Range['K'+IntToStr(121+vniz)]:=PRNZRazgrPrib.AsString;
 XL.Range['M'+IntToStr(121+vniz)]:=PRNZRazgrYbit.AsString;
 XL.Range['AB'+IntToStr(105+vniz)]:=Util.UtilForm.MoneyToText(PRNZTotalPackages.AsString);
 //XL.Range['Y'+nrs]:=PRNZTotalPackages.AsString;
  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

  if XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0 then
  begin
    i:=0;
    i:=XL.WorkBooks[1].Sheets[4].HPageBreaks[1].Location.Row;
    if (180<=i)and(i<=190) then
    XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A179'])
    else if (173<=i)and(i<179) then
         XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A172'])
         else if (165<=i)and(i<172) then
              XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A165'])
              else if (147<=i)and(i<165) then
                   XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A147'])
                   else if (141<=i)and(i<147) then
                        XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A141'])
                        else if (i mod 2)=0 then XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A'+IntToStr(i-1)]);
  end;

  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
  XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
    XL.visible:=true
  else
  begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
     XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
     if XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0 then
       if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
         XL.WorkBooks[1].Sheets[4].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      FormMain.VisM1.P1:=PRNSID.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end; 
  end;
  Memo1.Width:=193;
 {if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=5 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end
      else if kolt<=26 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=52 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end;
      if (kolt>5) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=52 then begin XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;  }

End;

procedure TFormPrint.Rash_GZK22;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid,TransR:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itoggruz,itogmest,tara:Double;
Begin
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  //реестр цен
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeGZK(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;

  ppLabel323.Caption:=PRNSTpName.AsString;
  ppLabel322.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
  ppReport8.DeviceType:=dtScreen;
  ppReport8.Print;

  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeGZK(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;

  {ppLabel289.Caption:=PRNSTpName.AsString;
  ppLabel288.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
  ReestrCen.DeviceType:=dtScreen;
  ReestrCen.Print;}

  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv_ch.xls');
  if kolt<=5 then begin vniz:=-44; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=26 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=52 then begin vniz:=50; XL.WorkBooks[1].Sheets[3].Activate; end;
  XL.Application.EnableEvents:=false;
  nrstart:=39;

  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['P21']:=PRNSPricep.AsString;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itoggruz:=0;
  itogmest:=0;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
        XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumwoNDS.AsString;
     itogstoim:=itogstoim+qPrintSumwoNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=FloatToStr(SimpleRoundTo(qPrintSumTotal.Value,-2));
     itogstoimnds:=itogstoimnds+SimpleRoundTo(qPrintSumTotal.Value,-2);
    if qPrintTax.Value=1 then
      XL.Range['AC'+nrs]:='Первая цена '+qPrintPrice.AsString;
    {XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TransR:=TransR+qPrintTrans.Value;  }
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

  if (kolt<>5)and(kolt<>26)and(kolt<>52) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;

 ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(93+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
{ str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(105+vniz)]:=str;         }
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил


 XL.Range['C'+IntToStr(120+vniz)]:=PRNZPogruzkaIsp.AsString;
 XL.Range['H'+IntToStr(120+vniz)]:=PRNZPogruzkaSpos.AsString;
 XL.Range['K'+IntToStr(120+vniz)]:=PRNZPogruzkaPrib.AsString;
 XL.Range['M'+IntToStr(120+vniz)]:=PRNZPogruzkaYbit.AsString;
 XL.Range['C'+IntToStr(121+vniz)]:=PRNZRazgrIsp.AsString;
 XL.Range['H'+IntToStr(121+vniz)]:=PRNZRazgrSpos.AsString;
 XL.Range['K'+IntToStr(121+vniz)]:=PRNZRazgrPrib.AsString;
 XL.Range['M'+IntToStr(121+vniz)]:=PRNZRazgrYbit.AsString;
  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=5 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end
      else if kolt<=26 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=52 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end;
      if (kolt>5) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=52 then begin XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
End;

procedure TFormPrint.Rash_EDA;
var
  ns,nn,kodpl,nrt,oper,kollist:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,padlist,osh,str1,idlist:string;
  orgpl: boolean;
  intskid:real;
Begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakeEDA(P1),P3=$P(P2,":",1),P4=$P(P2,":",2)');
  ns:=FormMain.VisM1.P3;
  osh:=FormMain.VisM1.P4;
  if osh<>'' then
    raise Exception.Create(osh); 
  i:=3;
  while UtilForm.P(FormMain.VisM1.P2,':',i)<>'' do
  begin
    idlist:=idlist+UtilForm.P(FormMain.VisM1.P2,':',i)+':';
    i:=i+1;
  end;
  if osh<>'' then
    raise Exception.Create(osh);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.SQL.Strings[2]:='Order by Ed,KodGr,KodPgr,Vid';
  qPrint.Open;
  if FormPr Then
   begin
    FormMain.Vism1.P1:=idprn;
    FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
    //Если при формировании ошибки ,то выводим ошибку
    //если нет то выводим проводки
    osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
    if osh<>'' then
    begin
     MessageDlg(osh,mtError,[mbok],0);
    end
    else
    begin
     ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
     prov.Close;
     prov.Prepare;
     prov.ParamByName('ns').Value:=ns;
     prov.Open;
     ppLabel325.Visible:=True;
    end;
   end
  else
   begin
    ppLabel325.Visible:=False;
   end;
  if PRNSPrN.Value<>0 then
   begin
    Eda.DeviceType:=dtScreen;
    Eda.Print;
   end
   else
   begin
    i:=1;
    while UtilForm.P(idlist,':',i)<>'' do
    begin
      FormMain.VisM1.P1:=UtilForm.P(idlist,':',i);
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      i:=i+1;
    end;
    Data.KPRN.Close;
    Data.KPRN.Prepare;
    Data.KPRN.Open;
    Eda.PrinterSetup.Copies:=kolnakl;
    Eda.DeviceType:=dtPrinter;
    Eda.Print;
   end;
  {qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.SQL.Strings[2]:='Order by KodGr,KodPgr,Vid';
  qPrint.Open;}

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');
// заголовок
  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);
//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='№ '+Data.KPRNNnak.AsString+' от '+inttostr(DayOf(PRNSDateN.AsDateTime))+' '+masmesR[MonthOfTheYear(PRNSDateN.AsDateTime)]+' '+inttostr(YearOf(PRNSDateN.AsDateTime));// Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  str1:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  if PrintMOLNakl then str1:=IntToStr(KMOLG)+' '+AnsiUpperCase(FormMain.Vism2.P5)+', '+str1;
  XL.Range['F27']:=str1;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  kollist:=Eda.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  //XL.Range['K41']:=ppDBCalc19.Value;
  XL.Range['O41']:=ppDBCalc48.Value;
  XL.Range['S41']:=ppDBCalc49.Value;
  XL.Range['V41']:=ppDBCalc50.Value;
  XL.Range['F44']:=Util.UtilForm.SumNumToFull(ppDBCalc49.Value);
  XL.Range['H46']:=Util.UtilForm.SumNumToFull(ppDBCalc50.Value);
  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил

  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.SQL.Strings[2]:='Order by KodGr,KodPgr,Vid';
  qPrint.Open;

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     {FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);}
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

End;
procedure TFormPrint.Rash_PinRin20_TN;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stovm,itogmest,tara:Double;
  sumothod,itogsumpost:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТН2_СВОИМ.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 XL.Range['B19']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F20']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
 XL.Range['G24']:=PRNZOsnOtp.AsString;

  nrstart:=31;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itogmest:=0;sumothod:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumwoNDS.AsString;
     itogstoim:=itogstoim+qPrintSumwoNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.AsString;
    XL.Range['AD'+nrs]:=qPrintSumBegin.AsString;
     itogsumpost:=itogsumpost+qPrintSumBegin.Value;
    XL.Range['AF'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AH'+nrs]:=qPrintNormOthod.AsString;
    XL.Range['AJ'+nrs]:=qPrintSymNOthod.AsString;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;
  XL.Range[nrs+':70'].Select;
  XL.Selection.RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 XL.Range['K71']:=FloatToStr(itogkolt);
 XL.Range['O71']:=FloatToStr(itogstoim);
 XL.Range['S71']:=FloatToStr(itognds);
 XL.Range['V71']:=FloatToStr(itogstoimnds);
 XL.Range['Y71']:=itogmest;
 XL.Range['AA71']:=FloatToStr(itoggruz);
 XL.Range['AD71']:=FloatToStr(itogsumpost);

 XL.Range['F74']:=UtilForm.SumNumToFull(itognds);
 XL.Range['G76']:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['G86']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['F78']:=UtilForm.SumNumToFull(tara);// отпуск разрешил
 XL.Range['F84']:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['F90']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['S90']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['H92']:=PRNZPrinPol.AsString;// груз получил
 XL.Range['F82']:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['H88']:=PRNSVodName.AsString;// принял к доставке


 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
      begin
       XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
       FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
       if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
       Data.KPRN.Close;
       Data.KPRN.Prepare;
       Data.KPRN.Open;
      end
     end;

End;

procedure TFormPrint.Rash_PinRin21_TN;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stovm,itogmest,tara:Double;
  sumothod,itogsumpost:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТН2_СВОИМ1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 XL.Range['B19']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F20']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
 XL.Range['G24']:=PRNZOsnOtp.AsString;

  nrstart:=31;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itogmest:=0;sumothod:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumwoNDS.AsString;
     itogstoim:=itogstoim+qPrintSumwoNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.AsString;
    XL.Range['AE'+nrs]:=qPrintSumBegin.AsString;
     itogsumpost:=itogsumpost+qPrintSumBegin.Value;
    XL.Range['AJ'+nrs]:=qPrintAddTorg.AsString;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;
  XL.Range[nrs+':70'].Select;
  XL.Selection.RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 XL.Range['K71']:=FloatToStr(itogkolt);
 XL.Range['O71']:=FloatToStr(itogstoim);
 XL.Range['S71']:=FloatToStr(itognds);
 XL.Range['V71']:=FloatToStr(itogstoimnds);
 XL.Range['Y71']:=itogmest;
 XL.Range['AA71']:=FloatToStr(itoggruz);
 XL.Range['AD71']:=FloatToStr(itogsumpost);

 XL.Range['F74']:=UtilForm.SumNumToFull(itognds);
 XL.Range['G76']:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['G86']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['F78']:=UtilForm.SumNumToFull(tara);// отпуск разрешил
 XL.Range['F84']:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['F90']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['S90']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['H92']:=PRNZPrinPol.AsString;// груз получил
 XL.Range['F82']:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['H88']:=PRNSVodName.AsString;// принял к доставке


 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
      begin
       XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
       FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
       if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
       Data.KPRN.Close;
       Data.KPRN.Prepare;
       Data.KPRN.Open;
      end;
     end;

End;

procedure TFormPrint.Rash_PinRin20;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stovm,itogmest:Double;
  sumothod,itogsumpost,tara:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН1_СВОИМ.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itogmest:=0;sumothod:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumwoNDS.AsString;
     itogstoim:=itogstoim+qPrintSumwoNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.AsString;
    XL.Range['AD'+nrs]:=qPrintSumBegin.AsString;
     itogsumpost:=itogsumpost+qPrintSumBegin.Value;
    XL.Range['AF'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AH'+nrs]:=qPrintNormOthod.AsString;
    XL.Range['AJ'+nrs]:=qPrintSymNOthod.AsString;
    {if qPrintSymNOthod.Value<>0 then
    begin
      XL.Range['AM'+nrs]:=qPrintSymNOthod.AsString;
      sumothod:=sumothod+qPrintSymNOthod.Value;
    end;}
    TransR:=TransR+qPrintTrans.Value;
{    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
}    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;
  XL.Range[nrs+':78'].Select;
  XL.Selection.RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 XL.Range['K79']:=FloatToStr(itogkolt);
 XL.Range['O79']:=FloatToStr(itogstoim);
 XL.Range['S79']:=FloatToStr(itognds);
 XL.Range['V79']:=FloatToStr(itogstoimnds);
 XL.Range['Y79']:=itogmest;
 XL.Range['AA79']:=FloatToStr(itoggruz);
 XL.Range['AD79']:=FloatToStr(itogsumpost);
 if sumothod<>0 then XL.Range['AM79']:=FloatToStr(sumothod);

 XL.WorkBooks[1].Sheets[2].Activate;
 XL.Range['F2']:=UtilForm.SumNumToFull(itognds);
 XL.Range['H4']:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G6']:=str;
 XL.Range['H10']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA8']:=PRNSVodName.AsString;// принял водитель
 XL.Range['F8']:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y10']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE10']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z12']:=PRNZPrinPol.AsString;// груз получил

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
       XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes)
         then XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
       FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
       if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
       Data.KPRN.Close;
       Data.KPRN.Prepare;
       Data.KPRN.Open;
      end;
     end;

End;

procedure TFormPrint.Rash_PinRin21;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stovm,itogmest:Double;
  sumothod,itogsumpost,tara:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН1_СВОИМ1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.Value;// Пункт погрузки
 XL.Range['AB31']:=PRNZPunktRazgr.Value;// Пункт разгрузки
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itogmest:=0;sumothod:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumwoNDS.AsString;
     itogstoim:=itogstoim+qPrintSumwoNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.AsString;
    XL.Range['AE'+nrs]:=qPrintSumBegin.AsString;
     itogsumpost:=itogsumpost+qPrintSumBegin.Value;
    XL.Range['AJ'+nrs]:=qPrintAddTorg.AsString;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;
  nrs:=Inttostr(strtoint(nrs)+1);
  XL.Range[nrs+':78'].Select;
  XL.Selection.RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 XL.Range['K79']:=FloatToStr(itogkolt);
 XL.Range['O79']:=FloatToStr(itogstoim);
 XL.Range['S79']:=FloatToStr(itognds);
 XL.Range['V79']:=FloatToStr(itogstoimnds);
 XL.Range['Y79']:=itogmest;
 XL.Range['AA79']:=FloatToStr(itoggruz);
 XL.Range['AE79']:=FloatToStr(itogsumpost);

 XL.WorkBooks[1].Sheets[2].Activate;
 XL.Range['F2']:=UtilForm.SumNumToFull(itognds);
 XL.Range['H4']:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G6']:=str;
 XL.Range['H10']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA8']:=PRNSVodName.AsString;// принял водитель
 XL.Range['F8']:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y10']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE10']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z12']:=PRNZPrinPol.AsString;// груз получил

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes)
        then XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
    end;

End;

/// отличие этого метода от PinRin11 только в том,
/// что печать производится на приложении
/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_PinRin
/// они одинаковы и наоборот
procedure TFormPrint.Rash_PinRin11Pril;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stovm,itogmest:Double;
  sumothod,itogsumpost,stov,ndsnofs,ndsfs,tara:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;

  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
  if FormMain.VisM1.P2=1 then
  begin
    ppLabel289.Caption:=PRNSTpName.AsString;
    ppLabel288.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
    ReestrCen.DeviceType:=dtScreen;
    ReestrCen.Print;
  end;  

  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'pril_СТОРОННИМ.xls');
  XL.WorkBooks[1].Sheets[2].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
 XL.Range['B39']:='Товар согласно приложения';
 XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладгой № '+IntToStr(nn);
  nrstart:=6;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itogmest:=0;sumothod:=0;ndsnofs:=0;ndsfs:=0;
  ///XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumOpt.AsString;
     itogstoim:=itogstoim+qPrintSumOpt.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumrwNDS.AsString;
     itognds:=itognds+qPrintSumrwNDS.Value;
     if qPrintVid.Value=0 then ndsnofs:=ndsnofs+qPrintSumrwNDS.Value
     else ndsfs:=ndsfs+qPrintSumrwNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumsNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumsNDS.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.AsString;
    XL.Range['AD'+nrs]:=qPrintSumBegin.AsString;
     itogsumpost:=itogsumpost+qPrintSumBegin.Value;
    XL.Range['AF'+nrs]:=qPrintAddOpt.AsString;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);

   if nr<>kolt then
   begin
     XL.Range['B'+IntToStr(nrt-1)+':'+'AJ'+IntToStr(nrt)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(nrt+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(nrt+1)].Characters().Font.FontStyle:='';
   end
   else
   begin
     XL.Range['B'+IntToStr(nrt-1)+':'+'AJ'+IntToStr(nrt-1)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(nrt+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(nrt+1)+':'+'AJ'+IntToStr(nrt+1)].Select;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Selection.Borders[xlEdgeRight].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   end;
   XL.Range['B'+IntToStr(nrt)+':'+'AJ'+IntToStr(nrt)].Borders[xlEdgeTop].LineStyle:=1;
   qPrint.Next;
  end;

  ///ИТОГО
 inc(nrt);
 XL.Range['K'+IntToStr(nrt)]:=FloatToStr(itogkolt);
 XL.Range['O'+IntToStr(nrt)]:=FloatToStr(itogstoim);
 XL.Range['S'+IntToStr(nrt)]:=FloatToStr(itognds);
 XL.Range['V'+IntToStr(nrt)]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+IntToStr(nrt)]:=itogmest;
 XL.Range['AA'+IntToStr(nrt)]:=FloatToStr(itoggruz);
 XL.Range['AD'+IntToStr(nrt)]:=FloatToStr(itogsumpost);
 if sumothod<>0 then XL.Range['AM'+IntToStr(nrt)]:=FloatToStr(sumothod);
 XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AH$'+IntToStr(nrt);

 XL.WorkBooks[1].Sheets[2].Activate;
 nrt:=40;
 XL.Range['K'+IntToStr(nrt)]:=FloatToStr(itogkolt);
 XL.Range['O'+IntToStr(nrt)]:=FloatToStr(itogstoim);
 XL.Range['S'+IntToStr(nrt)]:=FloatToStr(itognds);
 XL.Range['V'+IntToStr(nrt)]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+IntToStr(nrt)]:=itogmest;
 XL.Range['AA'+IntToStr(nrt)]:=FloatToStr(itoggruz);
 XL.Range['AD'+IntToStr(nrt)]:=FloatToStr(itogsumpost);
 if sumothod<>0 then XL.Range['AM'+IntToStr(nrt)]:=FloatToStr(sumothod);

 if ndsfs<>0 then
 begin
   XL.Range['B45']:='Сумма НДС (по фикс. ценам)';
   XL.Range['H45']:=ndsfs;
   XL.Range['B46']:='Сумма НДС ';
   XL.Range['H46']:=ndsnofs;
 end;
 XL.Range['F52']:=UtilForm.SumNumToFull(itognds);
 itognds:=0;
 FormMain.VisM1.Execute('s P1=$G(^Nastr("DopStoim"),0)');
 itognds:=FormMain.VisM1.P1;
 itogstoimnds:=itogstoimnds+itognds;
 if itognds<>0 then XL.Range['B48']:='Оформление документов:  '+FloatToStr(itognds);
 XL.Range['H54']:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G56']:=str;
 XL.Range['H60']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AB58']:=PRNSVodName.AsString;// принял водитель
 XL.Range['F58']:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y60']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AD60']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z62']:=PRNZPrinPol.AsString;// груз получил

   //Печать проводок
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
    FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['M'+IntToStr(45+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['P'+IntToStr(45+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['T'+IntToStr(45+i)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['T'+IntToStr(45+i)]:=UtilForm.P(provka,':',6)
           else XL.Range['T'+IntToStr(45+i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      XL.Range['Y'+IntToStr(39+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AB'+IntToStr(39+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AE'+IntToStr(39+i)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AE'+IntToStr(39+i)]:=UtilForm.P(provka,':',6)
           else XL.Range['AE'+IntToStr(39+i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

{ if kolt<=2 then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A183']);
 if (2<kolt)and(kolt<11) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A165']);
 if (11<=kolt)and(kolt<16) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A157']);
 if (16<=kolt)and(kolt<22) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A143']);
 if (22<=kolt)and(kolt<26) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A135']);
}

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистые листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.Quit;
      XL:=Unassigned;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;

End;

/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_PinRin11Pril
/// они одинаковы и наоборот
procedure TFormPrint.Rash_PinRin11;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz,rr:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka,str1:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stovm,itogmest:Double;
  sumothod,itogsumpost,stov,ndsfs,ndsnofs,tara:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  if kolt>46 then
  begin
    Rash_PinRin11Pril;
    Exit;
  end;
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
  if FormMain.VisM1.P2=1 then
  begin
    ppLabel289.Caption:=PRNSTpName.AsString;
    ppLabel288.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
    ReestrCen.DeviceType:=dtScreen;
    ReestrCen.Print;
  end;

  XL.WorkBooks.Add(ProgDir+'ТТН1_СТОРОННИМ.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itogmest:=0;sumothod:=0;ndsfs:=0;ndsnofs:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    str:=IntToStr(nr)+'. '+qPrintNNT.AsString+' '+qPrintName.AsString;
    Memo1.Width:=325;
    Memo1.Text:=str;
    str1:=Memo1.Lines.Strings[0];
    str:=Copy(str,Length(str1),Length(str));
    if Length(IntToStr(nr)+'. '+qPrintNNT.AsString+' '+qPrintName.AsString)<=Length(str1) then
    begin
      str1:=IntToStr(nr)+'. '+qPrintNNT.AsString+' '+qPrintName.AsString;
      str:='';
    end;
    XL.Range['B'+nrs]:=str1; ///IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewNDS.AsString;
    XL.Range['O'+nrs]:=qPrintSumOpt.AsString;
     itogstoim:=itogstoim+qPrintSumOpt.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumrwNDS.AsString;
     itognds:=itognds+qPrintSumrwNDS.Value;
     if qPrintVid.Value=0 then ndsnofs:=ndsnofs+qPrintSumrwNDS.Value
     else ndsfs:=ndsfs+qPrintSumrwNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumsNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumsNDS.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintPrice.AsString;
    XL.Range['AD'+nrs]:=qPrintSumBegin.AsString;
     itogsumpost:=itogsumpost+qPrintSumBegin.Value;
    XL.Range['AF'+nrs]:=qPrintAddOpt.AsString;
    //XL.Range['AH'+nrs]:=qPrintAddTorg.AsString;
    {XL.Range['AJ'+nrs]:=qPrintNormOthod.AsString;
    if qPrintSymNOthod.Value<>0 then
    begin
      XL.Range['AM'+nrs]:=qPrintSymNOthod.AsString;
      sumothod:=sumothod+qPrintSymNOthod.Value;
    end;}
    TransR:=TransR+qPrintTrans.Value;
{    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
}    inc(nrt);
    nrs:=inttostr(nrt);
    if str<>'' then
    begin
     if qPrintDop.Value<>''
     then begin
           XL.Range['B'+nrs]:=str+' ДОП: '+qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
          end
    end
    else
    begin if qPrintDop.Value<>''
          then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
          end
          else XL.Rows[nrs].RowHeight:=0;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;
  nrs:=Inttostr(strtoint(nrs)+1);
  XL.Range[nrs+':130'].Select;
  XL.Selection.RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 XL.Range['K131']:=FloatToStr(itogkolt);
 XL.Range['O131']:=FloatToStr(itogstoim);
 XL.Range['S131']:=FloatToStr(itognds);
 XL.Range['V131']:=FloatToStr(itogstoimnds);
 XL.Range['Y131']:=itogmest;
 XL.Range['AA131']:=FloatToStr(itoggruz);
 XL.Range['AD131']:=FloatToStr(itogsumpost);
 if sumothod<>0 then XL.Range['AM131']:=FloatToStr(sumothod);

// XL.WorkBooks[1].Sheets[2].Activate;
 if ndsfs<>0 then
 begin
   XL.Range['B137']:='Сумма НДС (по фикс. ценам)';
   XL.Range['H137']:=ndsfs;
   XL.Range['B138']:='Сумма НДС ';
   XL.Range['H138']:=ndsnofs;
 end;
 XL.Range['F143']:=UtilForm.SumNumToFull(itognds);
 itognds:=0;
 FormMain.VisM1.Execute('s P1=$G(^Nastr("DopStoim"),0)');
 itognds:=FormMain.VisM1.P1;
 itogstoimnds:=itogstoimnds+itognds;
 if itognds<>0 then XL.Range['B141']:='Оформление документов:  '+FloatToStr(itognds);
 //XL.Range['H145']:=qPrintSumSkid;
 XL.Range['H145']:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G147']:=str;
 XL.Range['H151']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AB149']:=PRNSVodName.AsString;// принял водитель
 XL.Range['F149']:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y151']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AD151']:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['AA153']:=PRNZPrinPol.AsString;// груз получил

   //Печать проводок
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
    FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['M'+IntToStr(136+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['P'+IntToStr(136+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['T'+IntToStr(136+i)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['T'+IntToStr(136+i)]:=UtilForm.P(provka,':',6)
           else XL.Range['T'+IntToStr(136+i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      XL.Range['Y'+IntToStr(130+i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AB'+IntToStr(130+i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AE'+IntToStr(130+i)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AE'+IntToStr(130+i)]:=UtilForm.P(provka,':',6)
           else XL.Range['AE'+IntToStr(130+i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

 if kolt<=2 then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A183']);
 if (2<kolt)and(kolt<11) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A165']);
 if (11<=kolt)and(kolt<16) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A157']);
 if (16<=kolt)and(kolt<22) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A143']);
 if (22<=kolt)and(kolt<26) then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.Range['A135']);
           
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes)
        then XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
    end
  end;
  Memo1.Width:=193;
End;

procedure TFormPrint.Rash_PinRin10;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid,TransR:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itoggruz,itogmest:Double;
  tara:integer;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;

  ppLabel289.Caption:=PRNSTpName.AsString;
  ppLabel288.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
  ReestrCen.DeviceType:=dtScreen;
  ReestrCen.Print;

  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv_ch.xls');
  if kolt<=5 then begin vniz:=-44; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=26 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=52 then begin vniz:=50; XL.WorkBooks[1].Sheets[3].Activate; end;
  XL.Application.EnableEvents:=false;
  nrstart:=39;

  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itoggruz:=0;
  itogmest:=0;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
        XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDSO.AsString;
     itognds:=itognds+qPrintSumNDSO.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString;; // кол-во грузовых мест
     itogmest:=itogmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           XL.Range['B'+nrs]:=qPrintDop.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumwNDS.Value);
   qPrint.Next;
  end;

  if (kolt<>5)and(kolt<>26)and(kolt<>52) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;

 ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(93+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else
 begin
   XL.Range['V'+nrs]:=FloatToStr(tara);
   XL.Range['T'+nrs]:='Товар:';
   XL.Range['V'+nrs]:=FloatToStr(itogstoimnds-tara);
 end;
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(105+vniz)]:=str;
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=5 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end
      else if kolt<=26 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=52 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end;
      if (kolt>5) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=52 then begin XL.WorkBooks[1].Sheets[2].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
End;

procedure TFormPrint.Rash_KKP20_svoi;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo,ndstorg:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,itoggrmest,tara:Double;
Begin
   // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1, "FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      if FormMain.VisM1.P2=1 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end
      else
      if FormMain.VisM1.P2=2 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end;
    end;
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP20.xls');
  {if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;  }
  vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  XL.Range['B93']:='Цены сформированы на условии ФО';
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  begin
          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
        end;
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  if PRNSTpPr.Value=1 then
    FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
  else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
  if FormMain.VisM2.P2=1 then
  begin
    XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
    XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
    XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
  end
  else XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФО';

  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0; ndstorg:=0;itoggrmest:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintFas.AsString; // кол-во грузовых мест
    if qPrintFas.AsString<>'' then
    itoggrmest:=itoggrmest+UtilForm.Preobr(UtilForm.P(qPrintFas.AsString,'*',1));
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
    XL.Range['AC'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AE'+nrs]:=qPrintPricewNDS.AsString;
     ndstorg:=ndstorg+SimpleRoundTo(qPrintQnt.Value*qPrintPricewNDS.Value*qPrintNDS.Value/(100+qPrintNDS.Value),-2);
    XL.Range['AH'+nrs]:=qPrintSumrwNDS.AsString;
     itogrozn:=itogrozn+qPrintSumrwNDS.Value;
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           osh:=qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Range['B'+nrs]:=qPrintDop.AsString+qPrintKach.AsString+qPrintVY.AsString+qPrintGGR.AsString; //qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

  FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(95+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(95+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(95+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',8)<>'' then
     begin
       XL.Range['R'+InttoStr(95+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(95+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(95+vniz)]:='Сумма';
     end;
   end;
   i:=96;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=7 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6)
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['Z'+IntToStr(i+vniz-7)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['Z'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz-7)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;

   /// ЗЕРКАЛЬНЫЕ ПРОВОДКИ
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
   if FormMain.VisM1.P7>0 then
   begin
     FormMain.VisM1.P1:=FormMain.VisM1.P7;
     FormMain.VisM1.P2:=PRNSID.Value;
     FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
     osh:=FormMain.VisM1.P4;
     if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
     else  provki:=FormMain.VisM1.P3;
     if provki<>'' then
     begin
       XL.Range['R'+InttoStr(95+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(95+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(95+vniz)]:='Сумма';
     end;
     i:=96;
     j:=1;
     provka:=UtilForm.P(provki,'!',j);
     while provka<>'' do
     begin
      if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
      then begin
        XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['Z'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
             else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
        i:=i+1;
       end;
       j:=j+1;
       provka:=UtilForm.P(provki,'!',j);
     end;
   end;
  End;

    FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
    FormMain.VisM1.P8:=oper;
    FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
    if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
    then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoim-TransR);
    end;
    FormMain.VisM2.P1:=PRNSTpKod.Value;
    if PRNSTpPr.Value=1 then
      FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
    else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
    if FormMain.VisM2.P2=1 then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
    end;
   if ndstorg<>0 then
     XL.Range['R'+InttoStr(93+vniz)]:='НДС в торговле '+FloatToStr(ndstorg);
  ///if (kolt<>1)and(kolt<>25)and(kolt<>47) then
  ///begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
  ///end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+nrs]:=FloatToStr(itoggrmest);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 XL.Range['AH'+nrs]:=FloatToStr(itogrozn);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
 XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C165']:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
 XL.Range['H165']:=PRNZPogruzkaSpos.AsString;// погрузка, способ
 XL.Range['J165']:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
 XL.Range['M165']:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
 XL.Range['P165']:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
 XL.Range['C166']:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
 XL.Range['H166']:=PRNZRazgrSpos.AsString;// разгрузка, способ
 XL.Range['J166']:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
 XL.Range['M166']:=PRNZRazgrYbit.AsString;// разгрузка, убытие
 XL.Range['P166']:=PRNZRazgrProstoi.AsString;// разгрузка, простой
 XL.Range['H185']:=PRNZDokTov.AsString;// с товаром следуют док-ты 

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
         if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
           XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
End;

procedure TFormPrint.Rash_KKP20_FN;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka,str1,nrspl1:string;
  orgpl: boolean;
  intskid,TransR, symfo,ndstorg:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,itoggrmest,tara:Double;
Begin
   // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1, "FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      if FormMain.VisM1.P2=1 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end
      else
      if FormMain.VisM1.P2=2 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end;
    end;
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeKKPNF(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP20.xls');
  vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
//Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
 //XL.Range['B93']:='Цены сформированы на условии франко-станции назначения';

          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии франко-станции назначения';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          //XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам франко-станции назначения';
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0; ndstorg:=0;itoggrmest:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
  //--для того чтобы влазило все наименование, потом перепроверить с ККП
   str:=qPrintName.Value+' '+qPrintDop.Value+' '+qPrintKach.AsString+' '+qPrintVY.AsString+' '+qPrintGGR.AsString;
   Memo1.Width:=240;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString+' '+qPrintKach.AsString+' '+qPrintVY.AsString+' '+qPrintGGR.AsString;
   end;
   //XL.Range['B'+nrs]:=str1;
   XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
   nrspl1:=IntToStr(StrToInt(nrs)+1);
   if str<>'' then
    begin
     XL.Range['B'+nrspl1]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+nrspl1].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     XL.Rows[nrs].RowHeight:=0
    end;
    //--

    XL.Range['B'+nrs]:=qPrintNNT.AsString+'. '+str1;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString; // кол-во грузовых мест
    if qPrintGrMest.AsString<>'' then
    itoggrmest:=itoggrmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
    XL.Range['AC'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AE'+nrs]:=qPrintPricewNDS.AsString;
     ndstorg:=ndstorg+SimpleRoundTo(qPrintQnt.Value*qPrintPricewNDS.Value*qPrintNDS.Value/(100+qPrintNDS.Value),-2);
    XL.Range['AH'+nrs]:=qPrintSumrwNDS.AsString;
     itogrozn:=itogrozn+qPrintSumrwNDS.Value;
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);

    //if qPrintDop.Value<>''
    //then begin
           //osh:=qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           //XL.Range['B'+nrs]:=qPrintDop.AsString+qPrintKach.AsString+qPrintVY.AsString+qPrintGGR.AsString; //qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           //XL.Rows[nrs].Autofit;
         //end
    //else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

  FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(95+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(95+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(95+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',8)<>'' then
     begin
       XL.Range['R'+InttoStr(95+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(95+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(95+vniz)]:='Сумма';
     end;
   end;
   i:=96;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=7 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6)
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['Z'+IntToStr(i+vniz-7)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['Z'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz-7)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;

   /// ЗЕРКАЛЬНЫЕ ПРОВОДКИ
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
   if FormMain.VisM1.P7>0 then
   begin
     FormMain.VisM1.P1:=FormMain.VisM1.P7;
     FormMain.VisM1.P2:=PRNSID.Value;
     FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
     osh:=FormMain.VisM1.P4;
     if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
     else  provki:=FormMain.VisM1.P3;
     if provki<>'' then
     begin
       XL.Range['R'+InttoStr(95+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(95+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(95+vniz)]:='Сумма';
     end;
     i:=96;
     j:=1;
     provka:=UtilForm.P(provki,'!',j);
     while provka<>'' do
     begin
      if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
      then begin
        XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['Z'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
             else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
        i:=i+1;
       end;
       j:=j+1;
       provka:=UtilForm.P(provki,'!',j);
     end;
   end;
  End;

    FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
    FormMain.VisM1.P8:=oper;
    FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
    if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
    then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoim-TransR);
    end;
    FormMain.VisM2.P1:=PRNSTpKod.Value;
    if PRNSTpPr.Value=1 then
      FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
    else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
    if FormMain.VisM2.P2=1 then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
    end;
   if ndstorg<>0 then
     XL.Range['R'+InttoStr(93+vniz)]:='НДС в торговле '+FloatToStr(ndstorg);
  ///if (kolt<>1)and(kolt<>25)and(kolt<>47) then
  ///begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
  ///end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+nrs]:=FloatToStr(itoggrmest);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 XL.Range['AH'+nrs]:=FloatToStr(itogrozn);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 //str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
 //XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['G'+IntToStr(107+vniz)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(itoggruz,0))),',',1));
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['AB'+IntToStr(107+vniz)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(itoggrmest,0))),',',1));
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C165']:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
 XL.Range['H165']:=PRNZPogruzkaSpos.AsString;// погрузка, способ
 XL.Range['J165']:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
 XL.Range['M165']:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
 XL.Range['P165']:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
 XL.Range['C166']:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
 XL.Range['H166']:=PRNZRazgrSpos.AsString;// разгрузка, способ
 XL.Range['J166']:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
 XL.Range['M166']:=PRNZRazgrYbit.AsString;// разгрузка, убытие
 XL.Range['P166']:=PRNZRazgrProstoi.AsString;// разгрузка, простой
 XL.Range['H185']:=PRNZDokTov.AsString;// с товаром следуют док-ты 

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('2040478');
 XL.WorkBooks[1].Sheets[2].Protect('2040478');
 XL.WorkBooks[1].Sheets[3].Protect('2040478');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
         if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
           XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
  //end;
End;

procedure TFormPrint.Rash_KKP20_svoi_skid;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo,ndstorg:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,itoggrmest,tara:Double;
Begin
   // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1, "FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
    end;
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizvskid(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP20.xls');
  {if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;  }
  vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  XL.Range['B93']:='Цены сформированы на условии ФО';
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  begin
          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
        end;
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  if PRNSTpPr.Value=1 then
    FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
  else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
  if FormMain.VisM2.P2=1 then
  begin
    XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
    XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
    XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
  end
  else XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФО';

  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0; ndstorg:=0;itoggrmest:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintFas.AsString; // кол-во грузовых мест
    if qPrintFas.AsString<>'' then
    itoggrmest:=itoggrmest+UtilForm.Preobr(UtilForm.P(qPrintFas.AsString,'*',1));
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
    XL.Range['AC'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AE'+nrs]:=qPrintPricewNDS.AsString;
     ndstorg:=ndstorg+SimpleRoundTo(qPrintQnt.Value*qPrintPricewNDS.Value*qPrintNDS.Value/(100+qPrintNDS.Value),-2);
    XL.Range['AH'+nrs]:=qPrintSumrwNDS.AsString;
     itogrozn:=itogrozn+qPrintSumrwNDS.Value;
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           osh:=qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Range['B'+nrs]:=qPrintDop.AsString+qPrintKach.AsString+qPrintVY.AsString+qPrintGGR.AsString+qPrintDop1.AsString; //qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

  FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(95+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(95+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(95+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',8)<>'' then
     begin
       XL.Range['R'+InttoStr(95+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(95+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(95+vniz)]:='Сумма';
     end;
   end;
   i:=96;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=7 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6)
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['Z'+IntToStr(i+vniz-7)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['Z'+IntToStr(i+vniz-7)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz-7)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;

   /// ЗЕРКАЛЬНЫЕ ПРОВОДКИ
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
   if FormMain.VisM1.P7>0 then
   begin
     FormMain.VisM1.P1:=FormMain.VisM1.P7;
     FormMain.VisM1.P2:=PRNSID.Value;
     FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
     osh:=FormMain.VisM1.P4;
     if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
     else  provki:=FormMain.VisM1.P3;
     if provki<>'' then
     begin
       XL.Range['R'+InttoStr(95+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(95+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(95+vniz)]:='Сумма';
     end;
     i:=96;
     j:=1;
     provka:=UtilForm.P(provki,'!',j);
     while provka<>'' do
     begin
      if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
      then begin
        XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
        XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
        stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
        if UtilForm.P(provka,':',6)='0' then XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)
        else if UtilForm.P(provka,':',5)='0' then XL.Range['Z'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
             else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
        i:=i+1;
       end;
       j:=j+1;
       provka:=UtilForm.P(provki,'!',j);
     end;
   end;
  End;

    FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
    FormMain.VisM1.P8:=oper;
    FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
    if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
    then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoim-TransR);
    end;
    FormMain.VisM2.P1:=PRNSTpKod.Value;
    if PRNSTpPr.Value=1 then
      FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
    else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
    if FormMain.VisM2.P2=1 then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
    end;
   if ndstorg<>0 then
     XL.Range['R'+InttoStr(93+vniz)]:='НДС в торговле '+FloatToStr(ndstorg);
  ///if (kolt<>1)and(kolt<>25)and(kolt<>47) then
  ///begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
  ///end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+nrs]:=FloatToStr(itoggrmest);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 XL.Range['AH'+nrs]:=FloatToStr(itogrozn);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
 XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C165']:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
 XL.Range['H165']:=PRNZPogruzkaSpos.AsString;// погрузка, способ
 XL.Range['J165']:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
 XL.Range['M165']:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
 XL.Range['P165']:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
 XL.Range['C166']:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
 XL.Range['H166']:=PRNZRazgrSpos.AsString;// разгрузка, способ
 XL.Range['J166']:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
 XL.Range['M166']:=PRNZRazgrYbit.AsString;// разгрузка, убытие
 XL.Range['P166']:=PRNZRazgrProstoi.AsString;// разгрузка, простой
 XL.Range['H185']:=PRNZDokTov.AsString;// с товаром следуют док-ты 

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
         if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
           XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;


procedure TFormPrint.Rash_KKP10_chujie;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz,raznprint:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,itoggrmest,tara:Double;
Begin
   // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      if FormMain.VisM1.P2=1 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end
      else
      if FormMain.VisM1.P2=2 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end;
    end;
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP10.xls');
{  if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;
}
 vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
 XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  XL.Range['B93']:='Цены сформированы на условии ФО';
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  begin
          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
        end;
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  if PRNSTpPr.Value=1 then
    FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
  else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
  if FormMain.VisM2.P2=1 then
  begin
    XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
    XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
    XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
  end
  else XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФО';
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itoggrmest:=0;raznprint:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);

    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintFas.AsString; // кол-во грузовых мест
    if qPrintFas.AsString<>'' then
      itoggrmest:=itoggrmest+UtilForm.Preobr(UtilForm.P(qPrintFas.AsString,'*',1));
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    if qPrintSkid.Value<>0 then
    begin
      XL.Range['AC'+nrs]:='Цена='+qPrintPricewTax.AsString+', скидка='+qPrintSkid.AsString+'%';
    end;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           osh:=qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Range['B'+nrs]:=qPrintDop.AsString+qPrintKach.AsString+qPrintVY.AsString+qPrintGGR.AsString; //qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   raznprint:=FormMain.VisM1.P5;
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(96+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(96+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(96+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',6)<>'' then
     begin
       XL.Range['R'+InttoStr(96+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(96+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(96+vniz)]:='Сумма';
     end;
   end;
   i:=97;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=5 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
   End;
    FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
    FormMain.VisM1.P8:=oper;
    FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
    if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
    then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
    end;
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  if PRNSTpPr.Value=1 then
    FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
  else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
  if FormMain.VisM2.P2=1 then
  begin
    XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
    XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
  end;

///  if (kolt<>1)and(kolt<>25)and(kolt<>47) then
///  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
///  end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+nrs]:=FloatToStr(itoggrmest);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
 XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C165']:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
 XL.Range['H165']:=PRNZPogruzkaSpos.AsString;// погрузка, способ
 XL.Range['J165']:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
 XL.Range['M165']:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
 XL.Range['P165']:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
 XL.Range['C166']:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
 XL.Range['H166']:=PRNZRazgrSpos.AsString;// разгрузка, способ
 XL.Range['J166']:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
 XL.Range['M166']:=PRNZRazgrYbit.AsString;// разгрузка, убытие
 XL.Range['P166']:=PRNZRazgrProstoi.AsString;// разгрузка, простой
 XL.Range['H185']:=PRNZDokTov.AsString;// с товаром следуют док-ты 

 if raznprint=2 then
 begin
   XL.WorkBooks[1].Sheets[3].Copy(EmptyParam, XL.WorkBooks[1].Sheets[XL.WorkBooks[1].Sheets.Count]);
   XL.Rows['137:145'].RowHeight:=0;
   if XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0 then
   begin
     vniz:=0;
     vniz:=XL.WorkBooks[1].Sheets[4].HPageBreaks[1].Location.Row;
     if (133<=vniz)and(vniz<=146) then
       XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A135'])
     else if (146<vniz)and(vniz<=160) then
            XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
   end;
   XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 end;

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
       if raznprint<2 then
         XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false)
       else
       begin
         XL.WorkBooks[1].Sheets[4].PrintOut(1,1,1,EmptyParam,EmptyParam,EmptyParam,false);
         XL.WorkBooks[1].Sheets[3].PrintOut(1,1,1,EmptyParam,EmptyParam,EmptyParam,false);
         if (kolnakl-2)>0 then
           XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl-2,EmptyParam,EmptyParam,EmptyParam,false);
       end;
       if (raznprint<2)and(XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0)
        then
         if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
           XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false)
         else if (XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0)and(raznprint=2) then
                if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
                begin
                  XL.WorkBooks[1].Sheets[4].PrintOut(2,2,1,EmptyParam,EmptyParam,EmptyParam,false);
                  XL.WorkBooks[1].Sheets[3].PrintOut(2,2,1,EmptyParam,EmptyParam,EmptyParam,false);
                  if (kolnakl-2)>0 then
                    XL.WorkBooks[1].Sheets[4].PrintOut(2,2,kolnakl-2,EmptyParam,EmptyParam,EmptyParam,false);
                end;
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;



procedure TFormPrint.Rash_KKP10_FN;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz,raznprint:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka,str1,nrspl1:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,itoggrmest,tara:Double;
Begin
   // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      if FormMain.VisM1.P2=1 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end
      else
      if FormMain.VisM1.P2=2 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end;
    end;
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeKKPNF(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP10.xls');
 vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
 XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 if FormFTXPRNAll.CheckBox1.Checked=True then XL.Range['Z7']:='';
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 if FormFTXPRNAll.CheckBox1.Checked=True then XL.Range['I25']:='';
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
 //XL.Range['B93']:='Цены сформированы на условии франко-станции назначения';

          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии франко-станции назначения';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          //XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам франко-станции назначения';

  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itoggrmest:=0;raznprint:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);

    //--для того чтобы влазило все наименование
   str:=qPrintName.Value+' '+qPrintDop.Value+' '+qPrintKach.AsString+' '+qPrintVY.AsString+' '+qPrintGGR.AsString;
   Memo1.Width:=240;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   if Length(str1)>=Length(qPrintName.AsString) then
   begin
     str1:=qPrintName.AsString;
     str:=qPrintDop.AsString+' '+qPrintKach.AsString+' '+qPrintVY.AsString+' '+qPrintGGR.AsString;
   end;
   XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
   nrspl1:=IntToStr(StrToInt(nrs)+1);
   if str<>'' then
    begin
     XL.Range['B'+nrspl1]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+nrspl1].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     XL.Rows[nrs].RowHeight:=0
    end;
    //--

    XL.Range['B'+nrs]:=str1; //qPrintNNT.AsString+'. '+qPrintName.AsString;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintGrMest.AsString; // кол-во грузовых мест
     if qPrintGrMest.AsString<>'' then
     itoggrmest:=itoggrmest+qPrintGrMest.Value;
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    if qPrintSkid.Value<>0 then
    begin
      XL.Range['AC'+nrs]:='Цена='+qPrintPricewTax.AsString+',опт.скидка='+qPrintSkid.AsString+'%';
    end;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   raznprint:=FormMain.VisM1.P5;
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(96+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(96+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(96+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',6)<>'' then
     begin
       XL.Range['R'+InttoStr(96+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(96+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(96+vniz)]:='Сумма';
     end;
   end;
   i:=97;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=5 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
   End;
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      //XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
  FormMain.VisM2.P1:=PRNSTpKod.Value;

   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0;

   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+nrs]:=FloatToStr(itoggrmest);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 //str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
 //XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['G'+IntToStr(107+vniz)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(itoggruz,0))),',',1));
 XL.Range['AB'+IntToStr(107+vniz)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(itoggrmest,0))),',',1));
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C165']:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
 XL.Range['H165']:=PRNZPogruzkaSpos.AsString;// погрузка, способ
 XL.Range['J165']:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
 XL.Range['M165']:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
 XL.Range['P165']:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
 XL.Range['C166']:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
 XL.Range['H166']:=PRNZRazgrSpos.AsString;// разгрузка, способ
 XL.Range['J166']:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
 XL.Range['M166']:=PRNZRazgrYbit.AsString;// разгрузка, убытие
 XL.Range['P166']:=PRNZRazgrProstoi.AsString;// разгрузка, простой
 XL.Range['H185']:=PRNZDokTov.AsString;// с товаром следуют док-ты 

 if raznprint=2 then
 begin
   XL.WorkBooks[1].Sheets[3].Copy(EmptyParam, XL.WorkBooks[1].Sheets[XL.WorkBooks[1].Sheets.Count]);
   XL.Rows['137:145'].RowHeight:=0;
   if XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0 then
   begin
     vniz:=0;
     vniz:=XL.WorkBooks[1].Sheets[4].HPageBreaks[1].Location.Row;
     if (133<=vniz)and(vniz<=146) then
       XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A135'])
     else if (146<vniz)and(vniz<=160) then
            XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
   end;
   XL.WorkBooks[1].Sheets[4].Protect('2040478');
 end;

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('2040478');
 XL.WorkBooks[1].Sheets[2].Protect('2040478');
 XL.WorkBooks[1].Sheets[3].Protect('2040478');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
       if raznprint<2 then
         XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false)
       else
       begin
         XL.WorkBooks[1].Sheets[4].PrintOut(1,1,1,EmptyParam,EmptyParam,EmptyParam,false);
         XL.WorkBooks[1].Sheets[3].PrintOut(1,1,1,EmptyParam,EmptyParam,EmptyParam,false);
         if (kolnakl-2)>0 then
           XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl-2,EmptyParam,EmptyParam,EmptyParam,false);
       end;
       if (raznprint<2)and(XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0)
        then
         if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
           XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false)
         else if (XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0)and(raznprint=2) then
                if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
                begin
                  XL.WorkBooks[1].Sheets[4].PrintOut(2,2,1,EmptyParam,EmptyParam,EmptyParam,false);
                  XL.WorkBooks[1].Sheets[3].PrintOut(2,2,1,EmptyParam,EmptyParam,EmptyParam,false);
                  if (kolnakl-2)>0 then
                    XL.WorkBooks[1].Sheets[4].PrintOut(2,2,kolnakl-2,EmptyParam,EmptyParam,EmptyParam,false);
                end;
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;

procedure TFormPrint.Rash_KKP10_cena0;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz,raznprint:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv,j:integer;
  nrs,str,osh,provki,provka:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz,stov,itoggrmest,tara:Double;
Begin
   // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      if FormMain.VisM1.P2=1 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end
      else
      if FormMain.VisM1.P2=2 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end;
    end;
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeCena0(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_KKP10.xls');
{  if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;
}
 vniz:=43; XL.WorkBooks[1].Sheets[3].Activate;
 XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3+', '+FormMain.Vism2.P5;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  XL.Range['B93']:='Цены сформированы на условии ФО';
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  begin
          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
        end;
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  if PRNSTpPr.Value=1 then
    FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
  else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
  if FormMain.VisM2.P2=1 then
  begin
    XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
    XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
    XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
  end
  else XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФО';
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  tara:=0;sumdv:=0;TransR:=0;itoggrmest:=0;raznprint:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['B'+nrs].Characters.Font.FontStyle:='полужирный';
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=qPrintFas.AsString; // кол-во грузовых мест
    if qPrintFas.AsString<>'' then
      itoggrmest:=itoggrmest+UtilForm.Preobr(UtilForm.P(qPrintFas.AsString,'*',1));
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    if qPrintSkid.Value<>0 then
    begin
      XL.Range['AC'+nrs]:='Цена='+qPrintPricewTax.AsString+', скидка='+qPrintSkid.AsString+'%';
    end;
    TransR:=TransR+qPrintTrans.Value;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then begin
           osh:=qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Range['B'+nrs]:=qPrintDop.AsString+qPrintKach.AsString+qPrintVY.AsString+qPrintGGR.AsString; //qPrintDop.AsString+'   '+qPrintVY.AsString+'   '+qPrintGGR.AsString;
           XL.Rows[nrs].Autofit;
         end
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+SimpleRoundTo(qPrintSumwNDS.Value,-2);
   qPrint.Next;
  end;

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
   raznprint:=FormMain.VisM1.P5;
   FormMain.VisM1.P1:=PRNSOperac.Value;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   if provki<>'' then
   begin
     XL.Range['D'+InttoStr(96+vniz)]:='Дебет';
     XL.Range['H'+InttoStr(96+vniz)]:='Кредит';
     XL.Range['I'+InttoStr(96+vniz)]:='Сумма';
     if  UtilForm.P(provki,'!',6)<>'' then
     begin
       XL.Range['R'+InttoStr(96+vniz)]:='Дебет';
       XL.Range['V'+InttoStr(96+vniz)]:='Кредит';
       XL.Range['Z'+InttoStr(96+vniz)]:='Сумма';
     end;
   end;
   i:=97;
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
     if j<=5 then
     begin
       XL.Range['D'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['H'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end
     else
     begin
       XL.Range['R'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
       XL.Range['V'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
       stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
       if UtilForm.P(provka,':',6)='0' then XL.Range['I'+IntToStr(i+vniz)]:=FloatToStr(stov)
       else if UtilForm.P(provka,':',5)='0' then XL.Range['I'+IntToStr(i+vniz)]:=UtilForm.P(provka,':',6)
            else XL.Range['Z'+IntToStr(i+vniz)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     end;
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
   End;
    FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
    FormMain.VisM1.P8:=oper;
    FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
    if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
    then
    begin
      XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
      XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
    end;
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  if PRNSTpPr.Value=1 then
    FormMain.VisM2.Execute('if ($D(^SWTP(P1))) {s P2=+$P(^SWTP(P1),":",13)} else {s P2=0}')
  else FormMain.VisM2.Execute('if ($D(^SMOL(P1))) {s P2=+$P(^SMOL(P1),":",11)} else {s P2=0}');
  if FormMain.VisM2.P2=1 then
  begin
    XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
    XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoimnds-TransR);
  end;

///  if (kolt<>1)and(kolt<>25)and(kolt<>47) then
///  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
///  end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['Y'+nrs]:=FloatToStr(itoggrmest);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Trunc(Frac(itoggruz)*1000)))+'гр.';
 XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

 XL.Range['C165']:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
 XL.Range['H165']:=PRNZPogruzkaSpos.AsString;// погрузка, способ
 XL.Range['J165']:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
 XL.Range['M165']:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
 XL.Range['P165']:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
 XL.Range['C166']:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
 XL.Range['H166']:=PRNZRazgrSpos.AsString;// разгрузка, способ
 XL.Range['J166']:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
 XL.Range['M166']:=PRNZRazgrYbit.AsString;// разгрузка, убытие
 XL.Range['P166']:=PRNZRazgrProstoi.AsString;// разгрузка, простой
 XL.Range['H185']:=PRNZDokTov.AsString;// с товаром следуют док-ты 

 if raznprint=2 then
 begin
   XL.WorkBooks[1].Sheets[3].Copy(EmptyParam, XL.WorkBooks[1].Sheets[XL.WorkBooks[1].Sheets.Count]);
   XL.Rows['137:145'].RowHeight:=0;
   if XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0 then
   begin
     vniz:=0;
     vniz:=XL.WorkBooks[1].Sheets[4].HPageBreaks[1].Location.Row;
     if (133<=vniz)and(vniz<=146) then
       XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A135'])
     else if (146<vniz)and(vniz<=160) then
            XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[4].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
   end;
   XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 end;

 if XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0 then
 begin
 vniz:=0;
 vniz:=XL.WorkBooks[1].Sheets[3].HPageBreaks[1].Location.Row;
 if (133<=vniz)and(vniz<=139) then
   XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A135'])
 else if (139<vniz)and(vniz<=146) then
        XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A139'])
      else if (146<vniz)and(vniz<=160) then
             XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A146'])
           else if (160<vniz)and(vniz<=168) then
                  XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A160'])
                else if (168<vniz)and(vniz<=175) then
                       XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A168'])
                     else if (175<vniz)and(vniz<=186) then
                            XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A175'])
                          else if (vniz mod 2)=0 then XL.WorkBooks[1].Sheets[3].HPageBreaks.Add(XL.Range['A'+IntToStr(vniz-1)]);
 end;

 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
       if raznprint<2 then
         XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false)
       else
       begin
         XL.WorkBooks[1].Sheets[4].PrintOut(1,1,1,EmptyParam,EmptyParam,EmptyParam,false);
         XL.WorkBooks[1].Sheets[3].PrintOut(1,1,1,EmptyParam,EmptyParam,EmptyParam,false);
         if (kolnakl-2)>0 then
           XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl-2,EmptyParam,EmptyParam,EmptyParam,false);
       end;
       if (raznprint<2)and(XL.WorkBooks[1].Sheets[3].HPageBreaks.Count>0)
        then
         if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
           XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl,EmptyParam,EmptyParam,EmptyParam,false)
         else if (XL.WorkBooks[1].Sheets[4].HPageBreaks.Count>0)and(raznprint=2) then
                if (MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
                begin
                  XL.WorkBooks[1].Sheets[4].PrintOut(2,2,1,EmptyParam,EmptyParam,EmptyParam,false);
                  XL.WorkBooks[1].Sheets[3].PrintOut(2,2,1,EmptyParam,EmptyParam,EmptyParam,false);
                  if (kolnakl-2)>0 then
                    XL.WorkBooks[1].Sheets[4].PrintOut(2,2,kolnakl-2,EmptyParam,EmptyParam,EmptyParam,false);
                end;
      XL.WorkBooks[1].Close(0);
      XL.Quit;
      XL:=Unassigned;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;

procedure TFormPrint.Rash_ivac;
var
  ns,nn,oper,kolt,vniz,kodpl,i:Integer;
  start,nst,sumdv:Integer;
  osh,nstr:String;
  orgpl:Boolean;
  itogkolt,itogstoim,itognds,itogstoimnds,tara,tarands:Double;
  snds10,snds20:Double;
  s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11:String;
Begin
 if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
 if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.P2:=SK;
 FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
 osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
 if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
 ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
 qPrint.Close;
 qPrint.Prepare;
 qPrint.ParamByName('ns').Value:=ns;
 qPrint.Open;
 qPrint.First;
 kolt:=qPrint.RecordCount;
 XL.WorkBooks.Add(ProgDir+'ТН_ivac');
 if kolt<=22 then begin vniz:=-20; XL.WorkBooks[1].Sheets[2].Activate; end
 else if kolt<=32 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
      else if kolt<=69 then begin vniz:=74; XL.WorkBooks[1].Sheets[3].Activate; end;
 XL.Application.EnableEvents:=false;
 //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['Q7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['V7']:=inttostr(PRNSTpUNN.Value);
 XL.Range['B19']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F20']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
 XL.Range['G24']:=PRNZOsnOtp.AsString;
 start:=30;
 nst:=-1;
 itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;tara:=0;tarands:=0;
 for i:=1 to kolt do
 begin
  inc(nst);
  nstr:=IntToStr(start+nst);
  s1:=inttostr(i)+'. '+qPrintName.AsString;
  s2:=qPrintEI.AsString;
  s3:=FloatToStr(qPrintQnt.Value);
   itogkolt:=itogkolt+qPrintQnt.Value;
  s4:=FloatToStr(qPrintPrice.Value);
  s5:=FloatToStr(qPrintSumBegin.Value);
   itogstoim:=itogstoim+qPrintSumBegin.Value;
  s6:=FloatToStr(qPrintNDS.Value);
  s7:=FloatToStr(qPrintSumNDS.Value);
   itognds:=itognds+qPrintSumNDS.Value;
  s8:=FloatToStr(qPrintSumwNDS.Value);
   itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
  s9:=FloatToStr(qPrintAddTorg.Value);
  s10:=FloatToStr(qPrintPricewNDS.Value);
  s11:=FloatToStr(qPrintSumrwNDS.Value);
  XL.Range['B'+nstr]:=s1;
  XL.Range['L'+nstr]:=s2;
  XL.Range['N'+nstr]:=s3;
  XL.Range['P'+nstr]:=s4;
  XL.Range['S'+nstr]:=s5;
  XL.Range['V'+nstr]:=s6;
  XL.Range['X'+nstr]:=s7;
  XL.Range['AB'+nstr]:=s8;
  XL.Range['AF'+nstr]:=s9;
  XL.Range['AG'+nstr]:=s10;
  XL.Range['AI'+nstr]:=s11;
  inc(nst);
  nstr:=IntToStr(start+nst);
  if qPrintDop.Value<>'' then
   XL.Range['B'+nstr]:=qPrintDop.AsString
  else
   XL.Rows[nstr].RowHeight:=0;
  if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumwNDS.Value);
  if qPrintKodGr.Value=99 then tarands:=tarands+qPrintTarabNDS.Value;
  if qPrintNDS.Value=10 then snds10:=snds10+qPrintSumbNDS10.Value;
  if qPrintNDS.Value=20 then snds20:=snds20+qPrintSumbNDS20.Value;
  qPrint.Next;
 end;
 if (kolt<>22)and(kolt<>32)and(kolt<>69) then
 begin
  inc(nst);
  nstr:=IntToStr(start+nst);
  XL.Rows[nstr+':'+IntToStr(93+vniz)].RowHeight:=0; //Select;
  //XL.Selection.Delete;
 end;
 if tara=0
 then XL.Rows[95+vniz].RowHeight:=0
 else XL.Range['Y'+IntToStr(95+vniz)]:=FloatToStr(tara);
 //ИТОГО
 XL.Range['N'+IntToStr(94+vniz)]:=FloatToStr(itogkolt);
 XL.Range['S'+IntToStr(94+vniz)]:=FloatToStr(itogstoim);
 Xl.Range['X'+IntToStr(94+vniz)]:=FloatToStr(itognds);
 Xl.Range['AB'+IntToStr(94+vniz)]:=FloatToStr(itogstoimnds);
 XL.Range['F'+IntToStr(98+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(100+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(106+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(108+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['H'+IntToStr(110+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['H'+IntToStr(112+vniz)]:=PRNSVodName.AsString; // товар к доставке принял
 XL.Range['F'+IntToStr(114+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['R'+IntToStr(114+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['H'+IntToStr(116+vniz)]:=PRNZPrinPol.AsString;// груз получил
 FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
 FormMain.VisM1.P8:=oper;
 FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
 if FormMain.VisM1.P6=1
  then  XL.Range['B'+IntToStr(97+vniz)]:='Цены сформированы на условии ФО';
 FormMain.VisM1.P1:=idprn;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cpostdvorc(P1)');
 sumdv:=FormMain.VisM1.P2;
 if sumdv=0 then XL.Rows[121+vniz].RowHeight:=0
 else
  begin
   XL.Range['Q'+IntToStr(121+vniz)]:=InttoStr(sumdv);
   XL.Range['U'+IntToStr(121+vniz)]:=FloattoStr(sumdv*0.2);
  end;
 if snds10=0 then XL.Rows[122+vniz].RowHeight:=0
 else
  begin
   XL.Range['Q'+IntToStr(122+vniz)]:=FloattoStr(snds10);
   XL.Range['U'+IntToStr(122+vniz)]:=FloattoStr(Round(snds10*0.1));
  end;
 if (snds20-sumdv)=0 then XL.Rows[123+vniz].RowHeight:=0
 else
  begin
   XL.Range['Q'+IntToStr(123+vniz)]:=FloattoStr(snds20-sumdv);
   XL.Range['U'+IntToStr(123+vniz)]:=FloattoStr(Round((snds20-sumdv)*0.2));
  end;
 if tarands=0 then XL.Rows[124+vniz].RowHeight:=0
 else
  begin
   XL.Range['Q124']:=FloattoStr(tarands);
   XL.Range['U124']:=FloattoStr(tara-tarands);
  end;
 XL.Range['Y'+IntToStr(121+vniz)]:=FloattoStr(Round(sumdv*1.2));
 XL.Range['Y'+IntToStr(122+vniz)]:=FloattoStr(Round(snds10*1.1));
 XL.Range['Y'+IntToStr(123+vniz)]:=FloattoStr(Round(snds20*1.2));
 XL.Range['Y'+IntToStr(124+vniz)]:=FloattoStr(tara);
 XL.Range['Q'+IntToStr(125+vniz)]:=FloattoStr(sumdv+snds10+snds20+tarands);
 XL.Range['U'+IntToStr(125+vniz)]:=FloattoStr(Round((sumdv*0.2)+(snds10*0.1)+(snds20*0.2)+(tara-tarands)));
 XL.Range['Y'+IntToStr(125+vniz)]:=FloattoStr(Round((sumdv*1.2)+(snds10*1.1)+(snds20*1.2)+tara));
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=22 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end
      else if kolt<=32 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=69 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end;
      if (kolt>22) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=32 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=69 then begin XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
End;

procedure TFormPrint.Rash_proiz_sv_c;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  tara:integer;
  SumNDS10,SumbNDS10,SumNDS20,SumbNDS20,TaraNDS,TarabNDS:integer;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv_c.xls');
  if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  XL.Range['B93']:='Цены сформированы на условии ФО';
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  begin
          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
        end;
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  SumNDS10:=0;SumbNDS10:=0;SumNDS20:=0;SumbNDS20:=0;
  tara:=0;TaraNDS:=0;TarabNDS:=0;sumdv:=0;TransR:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    TaraNDS:=TaraNDS+qPrintTaraNDS.Value;
    TarabNDS:=TarabNDS+qPrintTarabNDS.Value;
    SumbNDS10:=SumbNDS10+qPrintSumbNDS10.Value;
    SumNDS10:=SumNDS10+qPrintSumNDS10.Value;
    SumbNDS20:=SumbNDS20+qPrintSumbNDS20.Value;
    SumNDS20:=SumNDS20+qPrintSumNDS20.Value;
    TransR:=TransR+qPrintTrans.Value;
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then XL.Range['B'+nrs]:=qPrintDop.AsString
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumwNDS.Value);
   qPrint.Next;
  end;
    //if nr=kolt
    //then begin
      FormMain.VisM1.P1:=idprn;
      FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cpostdvorc(P1)');
      sumdv:=FormMain.VisM1.P2;
      if sumdv=0 then XL.Rows[InttoStr(97+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(97+vniz)]:=FloatToStr(sumdv);
                 XL.Range['I'+InttoStr(97+vniz)]:=FloatToStr(sumdv*0.2);
           end;
      if SumbNDS10=0 then XL.Rows[InttoStr(98+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(98+vniz)]:=FloatToStr(SumbNDS10);
                 XL.Range['I'+InttoStr(98+vniz)]:=FloatToStr(SumNDS10);
           end;
      if (SumbNDS20-sumdv)=0 then XL.Rows[InttoStr(99+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(99+vniz)]:=FloatToStr(SumbNDS20-sumdv);
                 XL.Range['I'+InttoStr(99+vniz)]:=FloatToStr(SumNDS20-(sumdv*0.2));
           end;
      if TarabNDS=0 then XL.Rows[InttoStr(100+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(100+vniz)]:=FloatToStr(TarabNDS);
                 XL.Range['I'+InttoStr(100+vniz)]:=FloatToStr(TaraNDS);
           end;
      FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
      FormMain.VisM1.P8:=oper;
      FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
      if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
      then
      begin
        XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
        XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoim-TransR);
      end;
    //end;
 //   qPrint.Next;
 // end;
  //if tara=0 then XL.Rows[91].RowHeight:=0 else XL.Range['V91']:=tara;
  if (kolt<>1)and(kolt<>25)and(kolt<>47) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['L'+InttoStr(97+vniz)]:=FloatToStr(sumdv*1.2);
 XL.Range['L'+InttoStr(98+vniz)]:=FloatToStr(SumNDS10+SumbNDS10);
 XL.Range['L'+InttoStr(99+vniz)]:=FloatToStr(SumNDS20+SumbNDS20);
 XL.Range['L'+InttoStr(100+vniz)]:=FloatToStr(TaraNDS+TarabNDS);
 XL.Range['L'+InttoStr(101+vniz)]:=FloatToStr(TaraNDS+TarabNDS+SumNDS20+SumbNDS20+SumNDS10+SumbNDS10+sumdv*1.2);
 XL.Range['H'+InttoStr(101+vniz)]:=FloatToStr(sumdv+SumbNDS10+SumbNDS20-sumdv+TarabNDS);
 XL.Range['I'+InttoStr(101+vniz)]:=FloatToStr((sumdv*0.2)+SumNDS10+SumNDS20-(sumdv*0.2)+TaraNDS);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=1 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end
      else if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=47 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end;
      if (kolt>1) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=47 then begin XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;

procedure TFormPrint.Rash_proiz_sv_s;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS,sumdv:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid,TransR, symfo:real;
  tara:integer;
  SumNDS10,SumbNDS10,SumNDS20,SumbNDS20,TaraNDS,TarabNDS:integer;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz:Double;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv_s.xls');
  if kolt<=1 then begin vniz:=-49; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=25 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=47 then begin vniz:=43; XL.WorkBooks[1].Sheets[3].Activate; end;
  XL.Application.EnableEvents:=false;
  //XL.Visible:=true;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.AsString;
 XL.Range['AE21']:=PRNZPutList.AsString;
 XL.Range['G23']:=PRNZOwnCarName.AsString;
 XL.Range['Z23']:=PRNSVodName.AsString;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.AsString;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.AsString;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FO"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  XL.Range['B93']:='Цены сформированы на условии ФО';
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
  FormMain.VisM1.P8:=oper;
  FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
  if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
  then  begin
          XL.Range['B'+InttoStr(93+vniz)]:='Цены сформированы на условии ФН';
          XL.Range['B'+InttoStr(94+vniz)]:='Сумма транспортных расходов';
          XL.Range['R'+InttoStr(94+vniz)]:='Сумма по ценам ФО';
        end;
  nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  SumNDS10:=0;SumbNDS10:=0;SumNDS20:=0;SumbNDS20:=0;
  tara:=0;TaraNDS:=0;TarabNDS:=0;sumdv:=0;TransR:=0;
  //XL.Visible:=true;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AE'+nrs]:=qPrintPricewNDS.AsString;
    XL.Range['AH'+nrs]:=qPrintSumrwNDS.AsString;
     itogrozn:=itogrozn+qPrintSumrwNDS.Value;
    TaraNDS:=TaraNDS+qPrintTaraNDS.Value;
    TarabNDS:=TarabNDS+qPrintTarabNDS.Value;
    SumbNDS10:=SumbNDS10+qPrintSumbNDS10.Value;
    SumNDS10:=SumNDS10+qPrintSumNDS10.Value;
    SumbNDS20:=SumbNDS20+qPrintSumbNDS20.Value;
    SumNDS20:=SumNDS20+qPrintSumNDS20.Value;
    TransR:=TransR+qPrintTrans.Value;
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then XL.Range['B'+nrs]:=qPrintDop.AsString
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumwNDS.Value);
   qPrint.Next;
  end;
    //if nr=kolt
    //then begin
      FormMain.VisM1.P1:=idprn;
      FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cpostdvorc(P1)');
      sumdv:=FormMain.VisM1.P2;
      if sumdv=0 then XL.Rows[InttoStr(97+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(97+vniz)]:=FloatToStr(sumdv);
                 XL.Range['I'+InttoStr(97+vniz)]:=FloatToStr(sumdv*0.2);
           end;
      if SumbNDS10=0 then XL.Rows[InttoStr(98+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(98+vniz)]:=FloatToStr(SumbNDS10);
                 XL.Range['I'+InttoStr(98+vniz)]:=FloatToStr(SumNDS10);
           end;
      if (SumbNDS20-sumdv)=0 then XL.Rows[InttoStr(99+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(99+vniz)]:=FloatToStr(SumbNDS20-sumdv);
                 XL.Range['I'+InttoStr(99+vniz)]:=FloatToStr(SumNDS20-(sumdv*0.2));
           end;
      if TarabNDS=0 then XL.Rows[InttoStr(100+vniz)].RowHeight:=0
      else begin XL.Range['H'+InttoStr(100+vniz)]:=FloatToStr(TarabNDS);
                 XL.Range['I'+InttoStr(100+vniz)]:=FloatToStr(TaraNDS);
           end;
      FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormFTXPRN",'+inttostr(sk)+',"Print","FN"))');
      FormMain.VisM1.P8:=oper;
      FormMain.VisM1.Execute('if P7[P8 {s P6=1} else {s P6=0}');
      if FormMain.VisM1.P6=1 {(FormMain.VisM1.P7<>'') and (FormMain.VisM1.P7=oper)}
      then
      begin
        XL.Range['I'+InttoStr(94+vniz)]:=FloatToStr(TransR);
        XL.Range['W'+InttoStr(94+vniz)]:=FloatToStr(itogstoim-TransR);
      end;
    //end;
 //   qPrint.Next;
 // end;
  //if tara=0 then XL.Rows[91].RowHeight:=0 else XL.Range['V91']:=tara;
  if (kolt<>1)and(kolt<>25)and(kolt<>47) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(89+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;
   ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(90+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 XL.Range['AH'+nrs]:=FloatToStr(itogrozn);
 nrs:=IntToStr(91+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['L'+InttoStr(97+vniz)]:=FloatToStr(sumdv*1.2);
 XL.Range['L'+InttoStr(98+vniz)]:=FloatToStr(SumNDS10+SumbNDS10);
 XL.Range['L'+InttoStr(99+vniz)]:=FloatToStr(SumNDS20+SumbNDS20);
 XL.Range['L'+InttoStr(100+vniz)]:=FloatToStr(TaraNDS+TarabNDS);
 XL.Range['L'+InttoStr(101+vniz)]:=FloatToStr(TaraNDS+TarabNDS+SumNDS20+SumbNDS20+SumNDS10+SumbNDS10+sumdv*1.2);
 XL.Range['H'+InttoStr(101+vniz)]:=FloatToStr(sumdv+SumbNDS10+SumbNDS20-sumdv+TarabNDS);
 XL.Range['I'+InttoStr(101+vniz)]:=FloatToStr((sumdv*0.2)+SumNDS10+SumNDS20-(sumdv*0.2)+TaraNDS);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(105+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 //XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(107+vniz)]:=str;
 XL.Range['H'+IntToStr(111+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(109+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(109+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(111+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(111+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(113+vniz)]:=PRNZPrinPol.AsString;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=1 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end
      else if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=47 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end;
      if (kolt>1) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=47 then begin XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;

procedure TFormPrint.Rash_proiz_sv;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itogrozn,itoggruz:Double;
  tara:integer;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv.xls');
  if kolt<=5 then begin vniz:=-44; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=26 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=52 then begin vniz:=50; XL.WorkBooks[1].Sheets[3].Activate; end;
  XL.Application.EnableEvents:=false;
  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itogrozn:=0;itoggruz:=0;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    XL.Range['AC'+nrs]:=qPrintAddTorg.AsString;
    XL.Range['AE'+nrs]:=qPrintPricewNDS.AsString;
    XL.Range['AH'+nrs]:=qPrintSumrwNDS.AsString;
     itogrozn:=itogrozn+qPrintSumrwNDS.Value;
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then XL.Range['B'+nrs]:=qPrintDop.AsString
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;
  //if tara=0 then XL.Rows[93].RowHeight:=0 else XL.Range['V93']:=tara;
  if (kolt<>5)and(kolt<>26)and(kolt<>52) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;

 ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(93+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 XL.Range['AH'+nrs]:=FloatToStr(itogrozn);
 nrs:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(105+vniz)]:=str;
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=5 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end
      else if kolt<=26 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=52 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end;
      if (kolt>5) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=52 then begin XL.WorkBooks[1].Sheets[2].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;

procedure TFormPrint.Rash_proiz_ch;
var
  ns,nn,kodpl,nrt,oper,kolt,vniz:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid:real;
  itogkolt,itogstoim,itognds,itogstoimnds,itoggruz:Double;
  tara:integer;
Begin
  // новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P2:=SK;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeProizv(P1,P2)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;
  kolt:=qPrint.RecordCount;
  XL.WorkBooks.Add(ProgDir+'ТТН_proizv_ch.xls');
  if kolt<=5 then begin vniz:=-44; XL.WorkBooks[1].Sheets[2].Activate; end
  else if kolt<=26 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
       else if kolt<=52 then begin vniz:=50; XL.WorkBooks[1].Sheets[3].Activate; end;
  XL.Application.EnableEvents:=false;
  nrstart:=39;

  //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 nrstart:=39;
  nrt:=nrstart-1;
  tara:=0;
  itogkolt:=0;itogstoim:=0;itognds:=0;itogstoimnds:=0;itoggruz:=0;
  for nr:=1 to kolt do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.AsString;
    XL.Range['I'+nrs]:=qPrintEI.AsString;
    XL.Range['K'+nrs]:=qPrintQnt.AsString;
     itogkolt:=itogkolt+qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.AsString;
    XL.Range['O'+nrs]:=qPrintSumBegin.AsString;
     itogstoim:=itogstoim+qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.AsString;
    XL.Range['S'+nrs]:=qPrintSumNDS.AsString;
     itognds:=itognds+qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumwNDS.AsString;
     itogstoimnds:=itogstoimnds+qPrintSumwNDS.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:=qPrintMassaGruza.AsString;  // масса груза
     itoggruz:=itoggruz+qPrintMassaGruza.Value;
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    inc(nrt);
    nrs:=inttostr(nrt);
    if qPrintDop.Value<>''
    then XL.Range['B'+nrs]:=qPrintDop.AsString
    else XL.Rows[nrs].RowHeight:=0;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  if (kolt<>5)and(kolt<>26)and(kolt<>52) then
  begin
   inc(nrt);
   nrs:=IntToStr(nrt);
   XL.Rows[nrs+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
   //XL.Selection.Delete;
  end;

 ///ИТОГО
 inc(nrt);
 nrs:=IntToStr(93+vniz);
 XL.Range['K'+nrs]:=FloatToStr(itogkolt);
 XL.Range['O'+nrs]:=FloatToStr(itogstoim);
 XL.Range['S'+nrs]:=FloatToStr(itognds);
 XL.Range['V'+nrs]:=FloatToStr(itogstoimnds);
 XL.Range['AA'+nrs]:=FloatToStr(itoggruz);
 nrs:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nrs].RowHeight:=0
 else XL.Range['V'+nrs]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogstoimnds);
 str:=Util.UtilForm.MoneyToText(inttostr(Trunc(itoggruz)))+'кг.'+'   ';
 str:=str+Util.UtilForm.MoneyToText(floattostr(Frac(itoggruz)*1000))+'гр.';
 XL.Range['G'+IntToStr(105+vniz)]:=str;
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил

 //Печать погрузки, разгрузки

  XL.Range['C'+IntToStr(vniz+120)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
  XL.Range['H'+IntToStr(vniz+120)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
  XL.Range['K'+IntToStr(vniz+120)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
  XL.Range['M'+IntToStr(vniz+120)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
  XL.Range['O'+IntToStr(vniz+120)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
  XL.Range['C'+IntToStr(vniz+121)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
  XL.Range['H'+IntToStr(vniz+121)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
  XL.Range['K'+IntToStr(vniz+121)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
  XL.Range['M'+IntToStr(vniz+121)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
  XL.Range['O'+IntToStr(vniz+121)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  {if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);}

 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=5 then begin XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end
      else if kolt<=26 then begin XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=52 then begin XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end;
      if (kolt>5) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=25 then begin XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=52 then begin XL.WorkBooks[1].Sheets[3].PrintOut(2,2,kolnakl); end;
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;

End;

procedure TFormPrint.Rash_One;  //накладная на 1 лист, если не влазит - на 2
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
  intskid:real;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeIvatz(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_One.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintCenaOpt.Value;
    XL.Range['O'+nrs]:=qPrintSumOpt.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumOpt.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AL'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  if tara=0 then XL.Rows[93].RowHeight:=0 else XL.Range['V93']:=tara;
  for nr:=nrt+1 to 91 do XL.Rows[nr].RowHeight:=0;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['I25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AB31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S79'];
  intSumNDS:=XL.Range['V79'];

  // ----------------------------------------
// транспортные данные
//  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F96']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H98']:=str;

  XL.Range['AB104']:='';// количество мест прописью
  XL.Range['G104']:='';// груз массой брутто
  XL.Range['H108']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA106']:=PRNSVodName.Value;// принял водитель
  XL.Range['F106']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y18']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE18']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z110']:=PRNZPrinPol.Value;// груз получил
  
  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
//     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_One_2;  //накладная на 1 лист, если не влазит - на 2 с ценой округленной до рубля
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
  intskid:real;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeLunin(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_One.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);

    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.Value;
    XL.Range['O'+nrs]:=qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AL'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  if tara=0 then XL.Rows[93].RowHeight:=0 else XL.Range['V93']:=tara;
  for nr:=nrt+1 to 91 do XL.Rows[nr].RowHeight:=0;
  for nr:=100 to 103 do XL.Rows[nr].RowHeight:=0;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['I25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AB31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S92'];
  intSumNDS:=XL.Range['V92'];

  // ----------------------------------------
// транспортные данные
//  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F96']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H98']:=str;

  XL.Range['AB104']:='';// количество мест прописью
  XL.Range['G104']:='';// груз массой брутто
  XL.Range['H108']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA106']:=PRNSVodName.Value;// принял водитель
  XL.Range['F106']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y108']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE108']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z110']:=PRNZPrinPol.Value;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
//     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_One_3;  //накладная на 1 лист, если не влазит - на 2 с ценой округленной до рубля
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
  intskid:real;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;

  if (FormFTXPRN.OperationIsIncome) and (PRNSPrN.Value=0)
    then raise Exception.Create('Перед печатью приходной накладной необходимо подтвердить приход!');

  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeShv(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_One.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);

    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPrice.Value;
    XL.Range['O'+nrs]:=qPrintSumBegin.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
{    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;}
    if Length(qPrintDop.Value)>2
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AL'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;

    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  if tara=0 then XL.Rows[93].RowHeight:=0 else XL.Range['V93']:=tara;
  for nr:=nrt+1 to 91 do XL.Rows[nr].RowHeight:=0;
  for nr:=100 to 103 do XL.Rows[nr].RowHeight:=0;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['I25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AB31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S92'];
  intSumNDS:=XL.Range['V92'];

  // ----------------------------------------
// транспортные данные
//  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F96']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H98']:=str;

  XL.Range['AB104']:='';// количество мест прописью
  XL.Range['G104']:='';// груз массой брутто
  XL.Range['H108']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA106']:=PRNSVodName.Value;// принял водитель
  XL.Range['F106']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y108']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE108']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z110']:=PRNZPrinPol.Value;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
  if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,2,kolnakl);
//     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P9:=Data.TableFTXPRNTIDdoc.Value;
     if not FormFTXPRN.OperationIsIncome then FormMain.VisM1.Execute('s P8=##class(KSU.FTXPRN).Printed(P9)');
     if FormMain.VisM1.P8<>'' then ShowMessage(FormMain.VisM1.P8);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;


procedure TFormPrint.Rash_album;  //накладная на 1 лист, если не влазит - на 2 с ценой округленной до рубля
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
  intskid:real;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeLunin(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_album.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewTax.Value;
    XL.Range['O'+nrs]:=qPrintSumTotal.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AL'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  if tara=0 then XL.Rows[93].RowHeight:=0 else XL.Range['V93']:=tara;
  for nr:=nrt+1 to 91 do XL.Rows[nr].RowHeight:=0;
  for nr:=100 to 103 do XL.Rows[nr].RowHeight:=0;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AB31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S92'];
  intSumNDS:=XL.Range['V92'];

  // ----------------------------------------
// транспортные данные
  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F2']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H4']:=str;

  XL.Range['AB10']:='';// количество мест прописью
  XL.Range['G10']:='';// груз массой брутто
  XL.Range['H14']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA12']:=PRNSVodName.Value;// принял водитель
  XL.Range['F12']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y14']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE14']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z16']:=PRNZPrinPol.Value;// груз получил

  // если накладная не входит в 1 лист, то вставляем разрыв страницы после таблицы
//  if XL.WorkBooks[1].Sheets[1].HPageBreaks.Count>0
//    then XL.WorkBooks[1].Sheets[1].HPageBreaks.Add(XL.WorkBooks[1].Sheets[1].Cells[94,1]);

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;

procedure TFormPrint.Rash_album_2;  //альбомная накладная с приложением
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,osh:string;
  orgpl: boolean;
  intskid:real;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  if FormPr
  Then begin
    FormMain.Vism1.P1:=idprn;
    FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
    osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
    if osh<>''
    then begin
      MessageDlg(osh,mtError,[mbok],0);
    end
    else begin
      ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
      prov.Close;
      prov.Prepare;
      prov.ParamByName('ns').Value:=ns;
      prov.Open;
      ppLabel130.Visible:=True;
      ppLabel166.Visible:=True;
    end;
  end
  else begin
    ppLabel130.Visible:=False;
    ppLabel166.Visible:=False;
  end;

  if PRNSPrN.Value<>0
  then begin
    ppReport4.DeviceType:=dtScreen;
    ppReport4.Print;
  end
  else begin
    ppReport4.PrinterSetup.Copies:=kolnakl;
    ppReport4.DeviceType:=dtPrinter;
    ppReport4.Print;
  end;

  XL.WorkBooks.Add(ProgDir+'ТТН_album_2.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');
  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AB31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;

  XL.Range['K88']:=ppDBCalc25.Value;
  XL.Range['O88']:=ppDBCalc23.Value;
  XL.Range['S88']:=ppDBCalc22.Value;
  XL.Range['V88']:=ppDBCalc23.Value;

  //intNDS:=XL.Range['S92'];
  //intSumNDS:=XL.Range['V92'];

  // ----------------------------------------
// транспортные данные
  str:=Util.UtilForm.MoneyToText(ppDBCalc22.Text);//
  XL.Range['F91']:=str;
  str:=Util.UtilForm.MoneyToText(ppDBCalc23.Text);//
  XL.Range['H93']:=str;

//  XL.Range['AB10']:='';// количество мест прописью
//  XL.Range['G10']:='';// груз массой брутто
  XL.Range['H103']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA101']:=PRNSVodName.Value;// принял водитель
  XL.Range['F101']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y103']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE103']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z105']:=PRNZPrinPol.Value;// груз получил

  if PRNSPrN.Value<>0 then
    XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;


procedure TFormPrint.Rash_iv21;
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
  intskid:real;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeIvatz(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_ivatz_21.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintCenaOpt.Value;
    XL.Range['O'+nrs]:=qPrintSumOpt.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumOpt.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AJ'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    qPrint.Next;
  end;

  for nr:=nrt+1 to 79 do XL.Rows[nr].RowHeight:=0;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН

//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P5+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AB31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S80'];
  intSumNDS:=XL.Range['V80'];


  // ----------------------------------------
// транспортные данные
  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F2']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H4']:=str;

  XL.Range['AB10']:='';// количество мест прописью
  XL.Range['G10']:='';// груз массой брутто
  XL.Range['H14']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA12']:=PRNSVodName.Value;// принял водитель
  XL.Range['F12']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y14']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE14']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z16']:=PRNZPrinPol.Value;// груз получил


  if PRNSPrN.Value<>0 then
  XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_TTN_ruzh;
var
  ns,nn,kodpl,nrt,oper,kollist,j:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,padlist,osh,str1:string;
  orgpl: boolean;
  intskid:real;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  ///FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
  FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if FormPr Then
   begin
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    ppLabel130.Visible:=True;
    end;
   end
  else
   begin
   ppLabel130.Visible:=False;
   end;

   j:=0;
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"TTN_ruzh","NoPrilPodval"))');
   j:=FormMain.VisM1.P2;
   if j=0 then
   begin
     ppLabel91.Visible:=true;
     ppLabel113.Visible:=true;
     ppLabel114.Visible:=true;
     ppLabel124.Visible:=true;
     ppLabel125.Visible:=true;
     ppLabel126.Visible:=true;
     ppLabel127.Visible:=true;
     ppLabel128.Visible:=true;
     ppLabel129.Visible:=true;
     ppLine56.Visible:=true;
     ppLine67.Visible:=true;
     ppLine68.Visible:=true;
     ppLine73.Visible:=true;
     ppLine76.Visible:=true;
     ppLine77.Visible:=true;
     ppLine78.Visible:=true;
     ppLine79.Visible:=true;
     ppLine80.Visible:=true;
     ppLabel130.Top:=193;
     ppSubReport1.Top:=213;
     ppSummaryBand3.Height:=236;
   end
   else
   begin
     ppLabel91.Visible:=false;
     ppLabel113.Visible:=false;
     ppLabel114.Visible:=false;
     ppLabel124.Visible:=false;
     ppLabel125.Visible:=false;
     ppLabel126.Visible:=false;
     ppLabel127.Visible:=false;
     ppLabel128.Visible:=false;
     ppLabel129.Visible:=false;
     ppLine56.Visible:=false;
     ppLine67.Visible:=false;
     ppLine68.Visible:=false;
     ppLine73.Visible:=false;
     ppLine76.Visible:=false;
     ppLine77.Visible:=false;
     ppLine78.Visible:=false;
     ppLine79.Visible:=false;
     ppLine80.Visible:=false;
     ppLabel130.Top:=76;
     ppSubReport1.Top:=90;
     ppSummaryBand3.Height:=120;     
   end;

  if PRNSPrN.Value<>0 then
   begin
   ppReport2.DeviceType:=dtScreen;
   ppReport2.Print;
   end
  else
   begin
   ppReport2.PrinterSetup.Copies:=kolnakl;
   ppReport2.DeviceType:=dtScreen; ///dtPrinter;
   ppReport2.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');

// заголовок


  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:=inttostr(DayOf(PRNSDateN.AsDateTime))+' '+masmesR[MonthOfTheYear(PRNSDateN.AsDateTime)]+' '+inttostr(YearOf(PRNSDateN.AsDateTime));// Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  str1:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  if PrintMOLNakl then str1:=IntToStr(KMOLG)+' '+AnsiUpperCase(FormMain.Vism2.P5)+', '+str1;
  XL.Range['F27']:=str1;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;


//  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport2.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;


  // ----------------------------------------
// транспортные данные

  XL.Range['K41']:=ppDBCalc19.Value;
  XL.Range['O41']:=ppDBCalc6.Value;
  XL.Range['S41']:=ppDBCalc7.Value;
  XL.Range['V41']:=ppDBCalc8.Value;

  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc7.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc8.Value);

  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил


  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_Lotos;
var
  ns,nn,kodpl,nrt,oper,kollist:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,padlist,osh,str1:string;
  orgpl: boolean;
  intskid:real;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if FormPr Then
   begin
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    ppLabel130.Visible:=True;
    end;
   end
  else
   begin
   ppLabel130.Visible:=False;
   end;
  if PRNSPrN.Value<>0 then
   begin
   ppReport7.DeviceType:=dtScreen;
   ppReport7.Print;
   end
  else
   begin
   ppReport7.PrinterSetup.Copies:=kolnakl;
   ppReport7.DeviceType:=dtPrinter;
   ppReport7.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');

// заголовок


  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:=inttostr(DayOf(PRNSDateN.AsDateTime))+' '+masmesR[MonthOfTheYear(PRNSDateN.AsDateTime)]+' '+inttostr(YearOf(PRNSDateN.AsDateTime));// Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  str1:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  if PrintMOLNakl then str1:=IntToStr(KMOLG)+' '+AnsiUpperCase(FormMain.Vism2.P5)+', '+str1;
  XL.Range['F27']:=str1;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузополучатель реквизиты такие же как и грузоотправитель и заказчик
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;


//  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport7.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;


  // ----------------------------------------
// транспортные данные

  XL.Range['K41']:=ppDBCalc40.Value;
  XL.Range['O41']:=ppDBCalc38.Value;
  XL.Range['S41']:=ppDBCalc35.Value;
  XL.Range['V41']:=ppDBCalc38.Value;
  XL.Range['AA41']:=ppDBCalc41.Value;

  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc35.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc38.Value);

  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил


  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_TTN_brgzk;
var
  ns,nn,kodpl,nrt,oper,kollist:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str,padlist,osh,str1:string;
  orgpl: boolean;
  intskid:real;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeRuzh(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if FormPr Then
   begin
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    ppLabel231.Visible:=True;
    end;
   end
  else
   begin
   ppLabel231.Visible:=False;
   end;
  if PRNSPrN.Value<>0 then
   begin
   ppReport6.DeviceType:=dtScreen;
   ppReport6.Print;
   end
  else
   begin
   ppReport6.PrinterSetup.Copies:=kolnakl;
   ppReport6.DeviceType:=dtPrinter;
   ppReport6.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');

// заголовок


  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:=inttostr(DayOf(PRNSDateN.AsDateTime))+' '+masmesR[MonthOfTheYear(PRNSDateN.AsDateTime)]+' '+inttostr(YearOf(PRNSDateN.AsDateTime));// Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['P21']:=PRNSPricep.AsString;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  str1:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  if PrintMOLNakl then str1:=IntToStr(KMOLG)+' '+AnsiUpperCase(FormMain.Vism2.P5)+', '+str1;
  XL.Range['F27']:=str1;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;


//  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport6.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;


  // ----------------------------------------
// транспортные данные

  XL.Range['K41']:=ppDBCalc37.Value;
  XL.Range['O41']:=ppDBCalc32.Value;
  XL.Range['S41']:='0'; //ppDBCalc32.Value;
  XL.Range['V41']:=ppDBCalc32.Value;

  XL.Range['F44']:=Util.UtilForm.MoneyToText('0');
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc32.Value);

  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил


  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_gzk21;
var
  ns,nn,kodpl,nrt,oper,kollist,protokol:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs,osh:string;
  str,padlist:string;
  orgpl: boolean;
  intskid:real;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakePruzh1(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    raise Exception.Create(osh)
   else
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
 // ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;

  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if FormPr Then
   begin
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    ppLabel192.Visible:=True;
    ppSubReport4.Visible:=True;
    end;
   end
  else
   begin
   ppLabel192.Visible:=False;
   ppSubReport4.Visible:=False;
   end;

  if PRNSPrN.Value<>0 then
   begin
   ppReport5.DeviceType:=dtScreen;
   ppReport5.Print;
   end
  else
   begin
   ppReport5.PrinterSetup.Copies:=kolnakl;
   ppReport5.DeviceType:=dtPrinter;
   ppReport5.Print;
   end;

  protokol:=0;
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("ProtokolCen",P1,"Print"),0)');
  if FormMain.VisM1.P2='1' then protokol:=1;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');

// заголовок


  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;


  XL.Range['B20']:=PRNSDateN.Value;// Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['P21']:=PRNSPricep.AsString;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if protokol=1 then
  begin
    ppLabel264.Caption:=FormMain.Vism2.P2;
    ppLabel293.Caption:=FormMain.Vism2.P2;
    ppLabel271.Caption:=AnsiUpperCase(PRNSTpName.Value);
    ppLabel294.Caption:=AnsiUpperCase(PRNSTpName.Value);
    ppLabel297.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
    ProtocolCen.Print;
  end;
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;

//  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport5.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  // ----------------------------------------
// транспортные данные

  XL.Range['O41']:=ppDBCalc27.Value;
  XL.Range['S41']:=ppDBCalc28.Value;
  XL.Range['V41']:=ppDBCalc29.Value;

  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc28.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc29.Value);

  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил

 XL.Range['C63']:=PRNZPogruzkaIsp.AsString;
 XL.Range['H63']:=PRNZPogruzkaSpos.AsString;
 XL.Range['K63']:=PRNZPogruzkaPrib.AsString;
 XL.Range['M63']:=PRNZPogruzkaYbit.AsString;
 XL.Range['C64']:=PRNZRazgrIsp.AsString;
 XL.Range['H64']:=PRNZRazgrSpos.AsString;
 XL.Range['K64']:=PRNZRazgrPrib.AsString;
 XL.Range['M64']:=PRNZRazgrYbit.AsString;

  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_pruzh21;
var
  ns,nn,kodpl,nrt,oper,kollist:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs,osh:string;
  str,padlist:string;
  orgpl: boolean;
  intskid:real;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakePruzh1(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    raise Exception.Create(osh)
   else
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
 // ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;

  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if FormPr Then
   begin
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    ppLabel167.Visible:=True;
    ppSubReport3.Visible:=True;
    end;
   end
  else
   begin
   ppLabel167.Visible:=False;
   ppSubReport3.Visible:=False;
   end;

  if PRNSPrN.Value<>0 then
   begin
   ppReport3.DeviceType:=dtScreen;
   ppReport3.Print;
   end
  else
   begin
   ppReport3.PrinterSetup.Copies:=kolnakl;
   ppReport3.DeviceType:=dtPrinter;
   ppReport3.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');

// заголовок


  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;


  XL.Range['B20']:=PRNSDateN.Value;// Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;

//  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport3.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  // ----------------------------------------
// транспортные данные

  XL.Range['O41']:=ppDBCalc15.Value;
  XL.Range['S41']:=ppDBCalc16.Value;
  XL.Range['V41']:=ppDBCalc17.Value;

  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc16.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc17.Value);

  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил


  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;


procedure TFormPrint.Rash_TTN_olsh;
var
  ns,nn,kodpl,nrt,oper:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
  intskid,snds,sbegin:real;
  stara,stov:integer;
begin
  stov:=0;
  stara:=0;
  snds:=0;
  sbegin:=0;

// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1,P2=##Class(KSU.tNaklPrint).MakeIvatz(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=39;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_olsh.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewTax.Value;
    XL.Range['O'+nrs]:=qPrintSumTotal.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    XL.Range['AC'+nrs]:=qPrintTax.Value;
    XL.Range['AD'+nrs]:=qPrintAddTorg.Value;
    XL.Range['AF'+nrs]:=qPrintAddOpt.Value;
    XL.Range['AH'+nrs]:=qPrintPrice.Value;
    XL.Range['AJ'+nrs]:=qPrintSumBegin.Value;
    if qPrintSkid.Value>0
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs]:='Скидка - '+FloatToStr(qPrintSkid.Value);
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['V'+nrs]:=qPrintSumSkid.Value;
      intSkid:=intSkid+qPrintSumSkid.Value;
    end;

    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AH'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;

    if qPrintKodGr.Value=99
      then stara:=stara+qPrintSumTotal.AsInteger
      else stov:=stov+qPrintSumTotal.AsInteger;
    snds:=snds+qPrintSumNDS.Value;
    sbegin:=sbegin+qPrintSumBegin.Value;

    qPrint.Next;
  end;
  XL.Range['V80']:=inttostr(stov) ;
  XL.Range['V81']:=inttostr(stara);
  XL.Range['AD80']:=stov+stara-snds-sbegin;

  for nr:=nrt+1 to 78 do XL.Rows[nr].RowHeight:=0;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;

//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P5+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1
  then begin
    XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
    //Заказчик(плательщик)
    if PRNZustomer.Value then
    begin
      XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
    else begin
      if orgpl
      then begin
        FormMain.Vism2.P1:=kodpl;
        FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
        XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
      else begin
        XL.Range['I25']:='=F29';
      end;
    end
  end
  else begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
//  FormMain.VisM2.P1:=PodrG;
//  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AB31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S79'];
  intSumNDS:=XL.Range['V79'];


  // ----------------------------------------
// транспортные данные
  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F2']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H4']:=str;

  XL.Range['AB4']:='';// количество мест прописью
  XL.Range['G6']:='';// груз массой брутто
  XL.Range['H10']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA8']:=PRNSVodName.Value;// принял водитель
  XL.Range['F8']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y10']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE10']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z12']:=PRNZPrinPol.Value;// груз получил

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;


procedure TFormPrint.Rash_TN;
var
  ns,nn,nrt:Integer;
  oper:integer;
  nrstart,nr:integer;
  nrs:string;
  intNDS,intSumNDS:integer;
  str:string;
  skid:integer;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1, P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeTNKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=30;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТН.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  skid:=0;
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=qPrintName.Value;
    XL.Range['L'+nrs]:=qPrintEI.Value;
    XL.Range['N'+nrs]:=qPrintQnt.Value;
    XL.Range['P'+nrs]:=qPrintPricewNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumwNDS.Value;
    XL.Range['V'+nrs]:=qPrintNDS.Value;
    XL.Range['X'+nrs]:=qPrintSumNDS.Value;
    XL.Range['AB'+nrs]:=qPrintSumTotal.Value;
    //XL.Range['AF'+nrs]:='Цена пост.:'+FloatToStr(qPrintPrice.Value)+' ,Опт.над.: '+FloatToStr(qPrintAddTorg.Value)+'%, Сумма пост.: '+FloatToStr(qPrintSumBegin.Value)+', скидка:'+FloatToStr(qPrintSkid.Value);  // Примечания
    XL.Range['AF'+nrs]:=qPrintPrice.Value;
    XL.Range['AH'+nrs]:=qPrintAddTorg.Value;
    XL.Range['AI'+nrs]:=qPrintSumBegin.Value;
    XL.Range['AL'+nrs]:=qPrintSkid.Value;
    skid:=skid+Round((qPrintPricewNDS.Value*qPrintSkid.Value)/100);
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AH'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  for nr:=nrt+1 to 73 do
  begin
    XL.Rows[nr].RowHeight:=0
  end;
// "крышечка" - УНН
//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Q7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['V7']:=inttostr(PRNSTpUNN.Value);

  XL.Range['B19']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');

  XL.Range['F20']:=FormMain.Vism2.P5+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
  XL.Range['G24']:=PRNZOsnOtp.Value; // основание отпуска

  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  intNDS:=XL.Range['X74'];
  intSumNDS:=XL.Range['AB74'];

  // ----------------------------------------
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F76']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H78']:=str;
  if tara=0
  then begin
    XL.Rows[75].RowHeight:=0;
  end
  else begin
    XL.Range['AB75']:=tara;
  end;

  if skid=0
  then begin
    XL.Rows[82].RowHeight:=0;
    XL.Rows[83].RowHeight:=0
  end
  else begin
    str:=Util.UtilForm.MoneyToText(inttostr(skid));//
    XL.Range['F82']:=str;
  end;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS-skid));//
  XL.Range['F84']:=str;

  XL.Range['H88']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F86']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['F92']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['H90']:=PRNSVodName.Value; // товар к доставке принял
  XL.Range['R92']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['H94']:=PRNZPrinPol.Value;// груз получил

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_TN_Two;
var
  ns,nn,nrt:Integer;
  oper:integer;
  nrstart,nr:integer;
  nrs:string;
  intNDS,intSumNDS:integer;
  str:string;
  skid:integer;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1, P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeTNKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=30;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТН_two.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  skid:=0;
  
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=qPrintName.Value;
    XL.Range['L'+nrs]:=qPrintEI.Value;
    XL.Range['N'+nrs]:=qPrintQnt.Value;
    XL.Range['P'+nrs]:=qPrintPricewTax.Value;
    XL.Range['S'+nrs]:=qPrintPricewTax.Value*qPrintQnt.Value;
    XL.Range['V'+nrs]:=qPrintNDS.Value;
    XL.Range['X'+nrs]:=qPrintSumNDS.Value;
    XL.Range['AB'+nrs]:=qPrintPricewTax.Value*qPrintQnt.Value;
    //XL.Range['AF'+nrs]:='Цена пост.:'+FloatToStr(qPrintPrice.Value)+' ,Опт.над.: '+FloatToStr(qPrintAddTorg.Value)+'%, Сумма пост.: '+FloatToStr(qPrintSumBegin.Value)+', скидка:'+FloatToStr(qPrintSkid.Value);  // Примечания
    XL.Range['AF'+nrs]:=qPrintPrice.Value;
    XL.Range['AH'+nrs]:=qPrintAddTorg.Value;
    XL.Range['AI'+nrs]:=qPrintSumBegin.Value;
    XL.Range['AL'+nrs]:=qPrintSkid.Value;
    XL.Range['AM'+nrs]:=qPrintPricewNDS.Value;
    XL.Range['AN'+nrs]:=qPrintSumwNDS.Value;
    skid:=skid+Round((qPrintPricewNDS.Value*qPrintSkid.Value)/100);
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AH'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);
    qPrint.Next;
  end;

  for nr:=nrt+1 to 73 do
  begin
    XL.Rows[nr].RowHeight:=0
  end;
// "крышечка" - УНН
//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Q7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['V7']:=inttostr(PRNSTpUNN.Value);

  XL.Range['B19']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата}

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');

  XL.Range['F20']:=FormMain.Vism2.P5+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
  XL.Range['G24']:=PRNZOsnOtp.Value; // основание отпуска

  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  intNDS:=XL.Range['X74'];
  intSumNDS:=XL.Range['AB74'];

  // ----------------------------------------
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F76']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H78']:=str;
  if tara=0
  then begin
    XL.Rows[75].RowHeight:=0;
  end
  else begin
    XL.Range['AB75']:=tara;
  end;
  
  if skid=0
  then begin
    XL.Rows[82].RowHeight:=0;
    XL.Rows[83].RowHeight:=0
  end
  else begin
    str:=Util.UtilForm.MoneyToText(inttostr(skid));//
    XL.Range['F82']:=str;
  end;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS-skid));//
  XL.Range['F84']:=str;

  XL.Range['H88']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F86']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['F92']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['H90']:=PRNSVodName.Value; // товар к доставке принял
  XL.Range['R92']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['H94']:=PRNZPrinPol.Value;// груз получил
  XL.Range['J96']:=PRNZDokTov.Value;// с варом следуют документы

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_TN_toplivo;
var
  ns,nn,nrt:Integer;
  oper:integer;
  nrstart,nr:integer;
  nrs:string;
  intNDS,intSumNDS:integer;
  str:string;
  skid:integer;
  tara:integer;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
//  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1, P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeTNtoplivo(P1,P3)');
  ns:=FormMain.VisM1.P3;
  if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  nrstart:=30;
  qPrint.First;
  XL.WorkBooks.Add(ProgDir+'ТН_toplivo.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  skid:=0;

  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=qPrintName.Value;
    XL.Range['L'+nrs]:=qPrintEI.Value;
    XL.Range['N'+nrs]:=qPrintQnt.Value;
    XL.Range['P'+nrs]:=qPrintPrice.Value;
    XL.Range['S'+nrs]:=qPrintSumBegin.Value;
    XL.Range['V'+nrs]:=qPrintNDS.Value;
    XL.Range['X'+nrs]:=qPrintSumNDS.Value;
    XL.Range['AB'+nrs]:=qPrintSumTotal.Value;
    //XL.Range['AF'+nrs]:='Цена пост.:'+FloatToStr(qPrintPrice.Value)+' ,Опт.над.: '+FloatToStr(qPrintAddTorg.Value)+'%, Сумма пост.: '+FloatToStr(qPrintSumBegin.Value)+', скидка:'+FloatToStr(qPrintSkid.Value);  // Примечания
//    XL.Range['AF'+nrs]:=qPrintPrice.Value;
//    XL.Range['AH'+nrs]:=qPrintAddTorg.Value;
//    XL.Range['AI'+nrs]:=qPrintSumBegin.Value;
//    XL.Range['AL'+nrs]:=qPrintSkid.Value;
//    XL.Range['AM'+nrs]:=qPrintPricewNDS.Value;
//    XL.Range['AN'+nrs]:=qPrintSumwNDS.Value;
{    skid:=skid+Round((qPrintPricewNDS.Value*qPrintSkid.Value)/100);
    if qPrintDop.Value<>''
    then begin
      inc(nrt);
      nrs:=inttostr(nrt);
      XL.Range['B'+nrs+':AH'+nrs].Merge;
      XL.Range['B'+nrs].Font.Italic:=true;
      XL.Range['B'+nrs]:=qPrintDop.Value;
    end;
    if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumTotal.Value);}
    qPrint.Next;
  end;

  for nr:=nrt+1 to 73 do
  begin
    XL.Rows[nr].RowHeight:=0
  end;
// "крышечка" - УНН
//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Q7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['V7']:=inttostr(PRNSTpUNN.Value);

  XL.Range['B19']:='Накладная №'+inttostr(nn)+', от '+PRNSDateN.AsString;// Дата}

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');

  XL.Range['F20']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
  XL.Range['G24']:=PRNZOsnOtp.Value; // основание отпуска

  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  intNDS:=XL.Range['X74'];
  intSumNDS:=XL.Range['AB74'];
  // ----------------------------------------
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F76']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H78']:=str;
  if tara=0
  then begin
    XL.Rows[75].RowHeight:=0;
  end
  else begin
    XL.Range['AB75']:=tara;
  end;
  if skid=0
  then begin
    XL.Rows[82].RowHeight:=0;
    XL.Rows[83].RowHeight:=0
  end
  else begin
    str:=Util.UtilForm.MoneyToText(inttostr(skid));//
    XL.Range['F82']:=str;
  end;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS-skid));//
  XL.Range['F84']:=str;
  XL.Range['H88']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F86']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['F92']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['H90']:=PRNSVodName.Value; // товар к доставке принял
  XL.Range['R92']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['H94']:=PRNZPrinPol.Value;// груз получил
  XL.Range['J96']:=PRNZDokTov.Value;// с варом следуют документы

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.Rash_TN_VSr;
var
  ns,nn,nrt:Integer;
  nrstart,nr:integer;
  nrs:string;
  intNDS,intSumNDS:integer;
  str:string;
  tara:integer;
  itogkol,itogsum:Double;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeTNVSr(P1,P3)');
  ns:=FormMain.VisM1.P3;
  if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  nrstart:=30;itogkol:=0;itogsum:=0;
  qPrint.First;
  XL.WorkBooks.Add(ProgDir+'ТН_VSr.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  nrt:=nrstart-1;
  tara:=0;
  for nr:=1 to qPrint.RecordCount do
  begin
    inc(nrt);
    nrs:=inttostr(nrt);
    XL.Range['B'+nrs]:=qPrintName.AsString;
    XL.Range['L'+nrs]:=qPrintEI.AsString;
    XL.Range['N'+nrs]:=qPrintQnt.AsString;
    XL.Range['P'+nrs]:=qPrintPrice.AsString;
    XL.Range['S'+nrs]:=qPrintSumBegin.AsString;
    itogkol:=itogkol+qPrintQnt.Value;
    itogsum:=itogsum+qPrintSumBegin.Value;
    //XL.Range['V'+nrs]:=qPrintNDS.Value;
    //XL.Range['X'+nrs]:=qPrintSumNDS.Value;
    //XL.Range['AB'+nrs]:=qPrintSumTotal.Value;
    qPrint.Next;
  end;

  for nr:=nrt+1 to 64 do
  begin
    XL.Rows[nr].RowHeight:=0
  end;
//итоги
  XL.Range['N65']:=FloatToStr(itogkol);
  XL.Range['S65']:=FloatToStr(itogsum);
// "крышечка" - УНН
//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Q7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['V7']:=inttostr(PRNSTpUNN.Value);

  XL.Range['B19']:='Накладная №'+inttostr(nn)+', от '+PRNSDateN.AsString;// Дата}

  //Грузоотправитель
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F20']:=FormMain.Vism2.P5;// Грузоотправитель
  //Грузополучатель
  XL.Range['F22']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
  // основание отпуска
  XL.Range['G24']:=PRNZOsnOtp.Value;
  // ----------------------------------------
  intSumNDS:=XL.Range['S65'];
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H69']:=str;
  if tara=0
  then begin
    XL.Rows[66].RowHeight:=0;
  end
  else begin
    XL.Range['AB75']:=tara;
  end;
  XL.Range['H75']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F73']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['J83']:='   '+PRNZDokTov.AsString;// С товаром следуют документы
  //XL.Range['F79']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  //XL.Range['H77']:=PRNSVodName.Value; // товар к доставке принял
  //XL.Range['R79']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['H81']:=PRNZPrinPol.Value;// груз получил
  //XL.Range['J83']:=PRNZDokTov.Value;// с варом следуют документы

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;



procedure TFormPrint.Rash_Domach;
var osh, nstr:String;
    ns,kolt,vniz,start,i,nst:Integer;
    orgpl:Boolean; //Плательщик головная организация
    kodpl,oper:Integer;  //Её код
    s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11:String;
    itogkolt,itogstoim,itognds,itogsnds,itogbinds,tara,snds10,snds20:Double;
Begin
 if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
 if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.P2:=SK;
 FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeDomach(P1,P2)');
 osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
 if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
 ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
 qPrint.Close;
 qPrint.Prepare;
 qPrint.ParamByName('ns').Value:=ns;
 qPrint.Open;
 qPrint.First;
 kolt:=qPrint.RecordCount;
 XL.WorkBooks.Add(ProgDir+'ТТН_Domach');
 if kolt<=4 then begin vniz:=-46; XL.WorkBooks[1].Sheets[3].Activate; end
 else if kolt<=27 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
      else if kolt<=51 then begin vniz:=48; XL.WorkBooks[1].Sheets[2].Activate; end;

 //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //XL.Range['B20']:=PRNSDateN.Value;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AB31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 start:=39;
 nst:=-1;
 itogkolt:=0;itogstoim:=0;itognds:=0;itogsnds:=0;itogbinds:=0;
 tara:=0;snds10:=0;snds20:=0;
 for i:=1 to kolt do
 begin
  inc(nst);
  nstr:=IntToStr(start+nst);
  s1:=inttostr(i)+'. '+qPrintName.AsString;
  s2:=qPrintEI.AsString;
  s3:=FloatToStr(qPrintQnt.Value);
  itogkolt:=itogkolt+qPrintQnt.Value;
  s4:=FloatToStr(qPrintPricewNDS.Value);
  s5:=FloatToStr(qPrintSumwoNDS.Value);
  itogstoim:=qPrintSumwoNDS.Value+itogstoim;
  s6:=FloatToStr(qPrintNDS.Value);
  s7:=FloatToStr(qPrintSumNDS.Value);
  itognds:=qPrintSumNDS.Value+itognds;
  s8:=FloatToStr(qPrintSumwNDS.Value);
  itogsnds:=qPrintSumwNDS.Value+itogsnds;
  s9:=FloatToStr(qPrintPrice.Value);
  s10:=FloatToStr(qPrintSumBegin.Value);
  itogbinds:=qPrintSumBegin.Value+itogbinds;
  s11:=FloatToStr(qPrintAddTorg.Value);
  XL.Range['B'+nstr]:=s1;
  XL.Range['I'+nstr]:=s2;
  XL.Range['K'+nstr]:=s3;
  XL.Range['M'+nstr]:=s4;
  XL.Range['O'+nstr]:=s5;
  XL.Range['R'+nstr]:=s6;
  XL.Range['S'+nstr]:=s7;
  XL.Range['V'+nstr]:=s8;
  XL.Range['Y'+nstr]:=qPrintFas.AsString;
  XL.Range['AC'+nstr]:=s9;
  XL.Range['AF'+nstr]:=s10;
  XL.Range['AI'+nstr]:=s11;
  inc(nst);
  nstr:=IntToStr(start+nst);
  if qPrintDop.Value<>'' then
  begin
    //XL.Range['B'+nstr+':AJ'+nstr].Merge;
   //XL.Rows[]
   XL.Range['B'+nstr]:=qPrintDop.AsString;
  end
  else
  begin
   XL.Rows[nstr].RowHeight:=0;
  end;
  if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumwoNDS.Value);
  if qPrintNDS.Value=10 then snds10:=snds10+qPrintSumNDS.Value*qPrintQnt.Value;
  if qPrintNDS.Value=20 then snds20:=snds20+qPrintSumNDS.Value*qPrintQnt.Value;
  qPrint.Next;
 end;
 if (kolt<>4)and(kolt<>27)and(kolt<>52) then
 begin
  inc(nst);
  nstr:=IntToStr(start+nst);
  XL.Rows[nstr+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
  //XL.Selection.Delete;
 end;
 ///ИТОГО
 XL.Range['H'+IntToStr(96+vniz)]:=FloatToStr(snds10);
 XL.Range['M'+IntToStr(96+vniz)]:=FloatToStr(snds20);
 inc(nst);
 nstr:=IntToStr(93+vniz);
 XL.Range['K'+nstr]:=FloatToStr(itogkolt);
 XL.Range['O'+nstr]:=FloatToStr(itogstoim);
 XL.Range['S'+nstr]:=FloatToStr(itognds);
 XL.Range['V'+nstr]:=FloatToStr(itogsnds);
 XL.Range['AF'+nstr]:=FloatToStr(itogbinds);
 nstr:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nstr].RowHeight:=0
 else XL.Range['V'+nstr]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogsnds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogsnds);
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=4 then begin vniz:=-46; XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end
      else if kolt<=27 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=51 then begin vniz:=48; XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end;
      if (kolt>4) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=27 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=51 then begin vniz:=48; XL.WorkBooks[1].Sheets[2].PrintOut(2,2,kolnakl); end;
//     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
End;

procedure TFormPrint.Rash_SrNad;
var osh, nstr:String;
    ns,kolt,vniz,start,i,nst:Integer;
    orgpl:Boolean; //Плательщик головная организация
    kodpl,oper:Integer;  //Её код
    itogkolt,itogstoim,itognds,itogsnds,itogbinds,tara,snds10,snds20:Double;
Begin
 if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
 if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.Execute(' s P3=$I(^N),P2=##Class(KSU.tNaklPrint).MakeSrNad(P1,P3)');
 ns:=FormMain.VisM1.P3;
 if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
 qPrint.Close;
 qPrint.Prepare;
 qPrint.ParamByName('ns').Value:=ns;
 qPrint.Open;
 qPrint.First;
 kolt:=qPrint.RecordCount;
 XL.WorkBooks.Add(ProgDir+'ТТН_NadbDop');
 XL.WorkBooks[1].Sheets[1].Activate;
 //XL.Visible:=True;
 //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['T7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['U7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;

 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты

 //Заказчик автомобильной перевозки
   if PRNZustomer.Value then
    begin
    XL.Range['I25']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+FormMain.Vism2.P3;
    end
   else
    begin
    XL.Range['I25']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;
    end;

 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 start:=38;
 itogkolt:=0;itogstoim:=0;itognds:=0;itogsnds:=0;
 {itogbinds:=0;
 tara:=0;snds10:=0;snds20:=0;}
 for i:=1 to kolt do
 begin
  nstr:=IntToStr(start+i);
  XL.Range['B'+nstr]:=qPrintName.AsString;
  XL.Range['J'+nstr]:=qPrintEI.AsString;
  XL.Range['L'+nstr]:=qPrintQnt.AsString;
  XL.Range['N'+nstr]:=qPrintPricewoNDS.AsString;
  XL.Range['P'+nstr]:=qPrintSumBegin.AsString;
  XL.Range['S'+nstr]:=qPrintNDS.AsString;
  XL.Range['T'+nstr]:=qPrintSumNDS.AsString;
  XL.Range['W'+nstr]:=qPrintSumTotal.AsString;
  XL.Range['AE'+nstr]:=qPrintPrice.AsString;
  XL.Range['AI'+nstr]:=qPrintAddOpt.AsString;
  itogkolt:=itogkolt+qPrintQnt.Value;
  itogstoim:=itogstoim+qPrintSumBegin.Value;
  itognds:=itognds+qPrintSumNDS.Value;
  itogsnds:=itogsnds+qPrintSumTotal.Value;
  qPrint.Next;
 end;
 for i:=kolt+1 to 10 do
  begin
  nstr:=IntToStr(start+i);
  XL.Rows[nstr].RowHeight:=0
  end;
 ///ИТОГО
 XL.Range['L49']:=FloatToStr(itogkolt);
 XL.Range['P49']:=FloatToStr(itogstoim);
 XL.Range['T49']:=FloatToStr(itognds);
 XL.Range['W49']:=FloatToStr(itogsnds);
 XL.Range['F52']:=UtilForm.SumNumToFull(itognds);
 XL.Range['H54']:=UtilForm.SumNumToFull(itogsnds);
 XL.Range['H60']:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['Y58']:=PRNZPrinPol.AsString;// принял водитель
 XL.Range['F58']:=PRNZOtpRazr.AsString;// отпуск разрешил
 if PRNZDovNom.AsString<>'' then
 XL.Range['W60']:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE60']:=PRNZDovVyd.AsString;// выдана доверенность
 //XL.Range['Y62']:=PRNZPrinPol.AsString;// груз получил
 XL.Range['H91']:='   '+PRNZDokTov.AsString;// С товаром следуют документы
 if PRNSPrN.Value<>0 then
   XL.visible:=true
 else
   if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
    begin
    XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
    FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
    FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
    if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
    end;
 Data.KPRN.Close;
 Data.KPRN.Prepare;
 Data.KPRN.Open;
End;


procedure TFormPrint.Rash_gal;
 var nn,ns,koln,i,ny,vy,s1:Integer;
     rown,osh,str,sdrob:String;
     skol,swonds,snds,snds10,snds20,swnds,swnac,qnt:Double;
begin
nn:=PRNSNnak.Value;
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.P2:=SK;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeGal(P1,P2)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds10:=0;snds20:=0;swnds:=0;swnac:=0;
koln:=qPrint.RecordCount;
XL.WorkBooks.Add(ProgDir+'ТТН_gal.xls');
if koln<6 then
 begin
 vy:=48;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<20 then
  begin
  vy:=76;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<28 then
   begin
   vy:=92;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=92;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=28 then
   begin
   ny:=4;
   n:=IntToStr(ny);
   vy:=49;
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintName.Value;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPrice.AsString;
  XL.Range['O'+n]:=qPrintSumBegin.AsString;
  XL.Range['R'+n]:=qPrintNDS.AsString+'%';
  XL.Range['S'+n]:=qPrintSumNDS.AsString;
  XL.Range['V'+n]:=qPrintSumTotal.AsString;
  XL.Range['AC'+n]:=qPrintAddTorg.AsString;
  XL.Range['AE'+n]:=qPrintNac.AsString;
  XL.Range['AG'+n]:=qPrintPricewTax.AsString;
  XL.Range['AI'+n]:=qPrintSumOpt.AsString;
  if qPrintDop.Value<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=qPrintDop.Value;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumBegin.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumTotal.Value;
  swnac:=swnac+qPrintSumOpt.Value;
  if qPrintNDS.Value=10 then snds10:=snds10+qPrintSumNDS.Value;
  if qPrintNDS.Value=20 then snds20:=snds20+qPrintSumNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Запись итогов
 if (koln<20) or (koln>27) then
  begin
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=swonds;
  XL.Range['S'+IntToStr(vy+1)]:=snds;
  XL.Range['V'+IntToStr(vy+1)]:=swnds;
  XL.Range['AI'+IntToStr(vy+1)]:=swnac;
  XL.Range['F'+IntToStr(vy+4)]:=snds10;
  XL.Range['M'+IntToStr(vy+4)]:=snds20;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).nado(P1)');
  XL.Range['T'+IntToStr(vy+4)]:=FormMain.VisM1.P2;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).nac(P1)');
  XL.Range['AA'+IntToStr(vy+4)]:=FormMain.VisM1.P2;
  XL.Range['F'+IntToStr(vy+5)]:=UtilForm.SumNumToFull(snds);
  XL.Range['H'+IntToStr(vy+7)]:=UtilForm.SumNumToFull(swnds);
  XL.Range['H'+IntToStr(vy+13)]:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA'+IntToStr(vy+11)]:=PRNSVodName.Value;// принял водитель
  XL.Range['F'+IntToStr(vy+11)]:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['X'+IntToStr(vy+13)]:='№'+PRNZDovNom.Value+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+13)]:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z'+IntToStr(vy+15)]:=PRNZPrinPol.Value;// груз получил
  end
 else
  if koln<28 then
   begin
   XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
   XL.Range['O'+IntToStr(vy+1)]:=swonds;
   XL.Range['S'+IntToStr(vy+1)]:=snds;
   XL.Range['V'+IntToStr(vy+1)]:=swnds;
   XL.Range['AI'+IntToStr(vy+1)]:=swnac;
   XL.WorkBooks[1].Sheets[5].Activate;
   vy:=2;
   XL.Range['F'+IntToStr(vy+4)]:=snds10;
   XL.Range['M'+IntToStr(vy+4)]:=snds20;
   FormMain.VisM1.P1:=PRNSID.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).nado(P1)');
   XL.Range['T'+IntToStr(vy+4)]:=FormMain.VisM1.P2;
   FormMain.VisM1.P1:=PRNSID.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).nac(P1)');
   XL.Range['AA'+IntToStr(vy+4)]:=FormMain.VisM1.P2;
   XL.Range['F'+IntToStr(vy+5)]:=UtilForm.SumNumToFull(snds);
   XL.Range['H'+IntToStr(vy+7)]:=UtilForm.SumNumToFull(swnds);
   XL.Range['H'+IntToStr(vy+13)]:=PRNZCdalOtp.Value;// сдал отправитель
   XL.Range['AA'+IntToStr(vy+11)]:=PRNSVodName.Value;// принял водитель
   XL.Range['F'+IntToStr(vy+11)]:=PRNZOtpRazr.Value;// отпуск разрешил
   XL.Range['X'+IntToStr(vy+13)]:='№'+PRNZDovNom.Value+' от '+PRNZDovData.AsString;// №, дата доверенности
   XL.Range['AE'+IntToStr(vy+13)]:=PRNZDovVyd.Value;// выдана доверенность
   XL.Range['Z'+IntToStr(vy+15)]:=PRNZPrinPol.Value;// груз получил
   end;

if PRNSPrN.Value<>0 then
 XL.visible:=true
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     if koln<6 then
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl)
     else
      if koln<20 then
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl)
      else
       if koln<28 then
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl)
       else
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl);
     if koln>5 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if koln<20 then
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl)
       else
        if koln<28 then
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl)
        else
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl);
       end;
      end;
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;

/// отличие этого метода от lopo только в том,
/// что печать производится на приложении
/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_lopo
/// они одинаковы и наоборот
procedure TFormPrint.Rash_lopoPril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,snds1,swnds,swnds1,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,sumndssk,sumndsf:Double;
    provki,provka:String;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds1:=0;swnds:=0;swnds1:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;sumndssk:=0;sumndsf:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_lopo.xls');
XL.WorkBooks[1].Sheets[2].Activate;
///XL.visible:=true;
 XL.Range['B39']:='Товар согласно приложения';
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладной № '+nn;
XL.visible:=true;
ny:=5;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Rows[n].Autofit;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
  XL.Range['R'+n]:=qPrintNDS.AsString;
  XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
  XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddTorg.Value+qPrintAddOpt.Value+qPrintAddSuppl.Value;
  XL.Range['AE'+n]:=FloatToStr(nad);
  XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  XL.Range['AI'+n]:=qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=str;
   if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   end
  else
   begin
   {rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;}
   end;
  if (qPrintTrans.Value>0)or(qPrintSkid.Value>0) then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   if (qPrintSkid.Value>0) then
   begin
    XL.Range['C'+n]:='Скидка= '+qPrintSkid.AsString+'%';
   end;
   if (qPrintTrans.Value>0) then
   begin
    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
    XL.Range['O'+n]:=qPrintSumBegin.AsString;
    XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end;
   end
  else
   begin
   {rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;}
   ny:=ny+1;
   XL.Rows[IntToStr(ny)].RowHeight:=0;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  if qPrintSkid.Value=0 then snds1:=snds1+qPrintSumNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  sumndssk:=sumndssk+qPrintSumSkid.Value;
  sumndsf:=sumndsf+qPrintSumNDSO.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  if i<>koln then
   begin
     XL.Range['B'+IntToStr(ny-2)+':'+'AJ'+IntToStr(ny)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(ny+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(ny+2)].Characters().Font.FontStyle:='';
   end
   else
   begin
     XL.Range['B'+IntToStr(ny-2)+':'+'AJ'+IntToStr(ny-2)].Select;
     XL.Selection.Copy;
     XL.Range['B'+IntToStr(ny+1)].Select;
     XL.Selection.PasteSpecial(Paste:=xlPasteFormats,Operation:=xlNone,
                               SkipBlanks:=False, Transpose:=False);
     XL.CutCopyMode:=False;
     XL.Range['B'+IntToStr(ny+1)+':'+'AJ'+IntToStr(ny+1)].Select;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Selection.Borders[xlEdgeRight].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
   end;
   XL.Range['B'+IntToStr(ny+1)+':'+'AJ'+IntToStr(ny+1)].Borders[xlEdgeTop].LineStyle:=1;
  qPrint.Next;
  end;
  vy:=ny;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(vy+1);
 //Печать ТТН
 XL.WorkBooks[1].Sheets[2].Activate;
 vy:=39;
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);

 XL.Range['E'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['E'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['E'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['E'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['E'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
 sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds1;
 XL.Range['E'+IntToStr(vy+9)]:=FloatToStr(Round(sumnad));
 XL.Range['E'+IntToStr(vy+10)]:=FloatToStr(sumndssk);
 XL.Range['M'+IntToStr(vy+4)]:=FloatToStr(Round(snds));
 XL.Range['M'+IntToStr(vy+5)]:=FloatToStr(sumndsf);
 XL.Range['M'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 XL.Range['M'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 XL.Range['M'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 XL.Range['M'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['P'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['Z'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
 XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(swnds));
 XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки

 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
   XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
   XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
   XL.visible:=true;
 end
 else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистый листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
end;

procedure TFormPrint.Rash_lynrpo;
var osh,str,str1,rown,nn,m1,m2,m3:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynrpo(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_lynrpo.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AG'+n]:=qPrintAddSuppl.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then //snds:=snds+qPrintSumNDS.Value
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,-2);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa);

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;
  XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;
  XL.Range['K'+IntToStr(vy+30)]:=PRNZPogruzkaPrib.AsString;
  XL.Range['M'+IntToStr(vy+30)]:=PRNZPogruzkaYbit.AsString;
  XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;
  XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;
  XL.Range['K'+IntToStr(vy+31)]:=PRNZRazgrPrib.AsString;
  XL.Range['M'+IntToStr(vy+31)]:=PRNZRazgrYbit.AsString;

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['Y'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AB'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AF'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  if massagr>0 then
    begin
   m1:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(massagr),',',1));
   if UtilForm.P(FloatToStr(massagr),',',2)<>'' then
     massagr:=StrToFloat(UtilForm.P(FloatToStr(massagr),',',2))
   else    massagr:=0;
   m2:=UtilForm.MoneyToText(FloatToStr(massagr));
   m3:=m1+'кг. '+m2+'гр.';
   XL.Range['G'+IntToStr(vy+15)]:=m3;
    end;
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(FloatToStr(grmest));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('2040478');
    XL.WorkBooks[1].Sheets[2].Protect('2040478');
    XL.WorkBooks[1].Sheets[3].Protect('2040478');
    XL.WorkBooks[1].Sheets[4].Protect('2040478');
    XL.WorkBooks[1].Sheets[5].Protect('2040478');
    XL.WorkBooks[1].Sheets[6].Protect('2040478');
    XL.WorkBooks[1].Sheets[7].Protect('2040478');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_ivacbazaPril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs,oop:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeIvacbaza(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_ivacbaza.xls');
XL.WorkBooks[1].Sheets[2].Activate;
 XL.Range['B39']:='Товар согласно приложения';
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладной № '+nn;
ny:=5;
for i:=1  to koln do
  begin
   Memo1.Width:=193;
   ny:=ny+1;
   n:=IntToStr(ny);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     oop:=(1+Length(qPrintName.AsString)-Length(str1));
     if (Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  vy:=ny;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(vy+1);
 //Печать ТТН
 XL.WorkBooks[1].Sheets[2].Activate;
 vy:=39;
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);

  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;
 //XL.visible:=true;
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
   XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
   XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
   XL.visible:=true;
 end
 else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистые листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
end;

{procedure TFormPrint.Rash_stol2Pril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol2(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_stol2.xls');
XL.WorkBooks[1].Sheets[2].Activate;
 XL.Range['B39']:='Товар согласно приложения';
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладной № '+nn;
ny:=5;
vy:=100;
nomr:=1;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[1].Activate;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPricewoNDS.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPrice.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintTrans.AsString;
   //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewTrans.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        //XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   //if qPrintSkid.Value<=0 then
   snds:=snds+qPrintSumNDS.Value;
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
  //XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(massa);

 //Печать итогов
 XL.WorkBooks[1].Sheets[2].Activate;
    XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['I'+IntToStr(vy+4)]:='скидка';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(skida,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  //XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  XL.Range['AA'+IntToStr(vy+17)]:=PRNZPrinPol.AsString;// товар к перевозке принял
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));    ///ssssssssssssssssssssssssssssssssssssssssssss
  XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  XL.Range['AB'+IntToStr(vy+19)]:='выданной '+PRNZDovVyd.AsString;// выдана доверенность

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
   XL.WorkBooks[1].Sheets[1].Protect('2040478');
   XL.WorkBooks[1].Sheets[2].Protect('2040478');
   XL.visible:=true;
 end
 else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистые листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
     end;
  end;
end;}

procedure TFormPrint.Rash_stol2Pril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka,kstr:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol2(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_stol2.xls');
XL.WorkBooks[1].Sheets[2].Activate;
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладной № '+nn+' от '+PRNSDateN.AsString+' (операция '+PRNSOperac.AsString+')';
ny:=5;
for i:=1  to koln do
  begin
   Memo1.Width:=193;
   ny:=ny+1;
   n:=IntToStr(ny);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPricewoNDS.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPrice.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintTrans.AsString;
   //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewTrans.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        //XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   //if qPrintSkid.Value<=0 then
   //snds:=snds+qPrintSumNDS.Value;
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2);    //////fffffffffffffffffffffffff
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   //swnds:=swnds+qPrintSumrwNDS.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  vy:=ny;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(massa);
 XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(vy+1);
 //Печать ТТН
 XL.WorkBooks[1].Sheets[2].Activate;
 vy:=39;
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  kstr:=IntToStr(XL.WorkBooks[1].Sheets[1].HPageBreaks.Count-9);
 XL.Range['B39']:='Товар согласно приложения на '+kstr+' листах';
 if FormMain.VisM1.P2<>0 then
 begin
   XL.WorkBooks[1].Sheets[1].Protect('2040478');
   XL.WorkBooks[1].Sheets[2].Protect('2040478');
   XL.visible:=true;
 end
 else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистые листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
end;

procedure TFormPrint.Rash_stolbazPril;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs,oop:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka,kstr:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStolBaz(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'pril_stolbaz.xls');
XL.WorkBooks[1].Sheets[2].Activate;
ZaglN;
XL.WorkBooks[1].Sheets[1].Activate;
 XL.Range['I1']:='Приложение к товарно-транспортной накладной № '+nn+' от '+PRNSDateN.AsString+' (операция '+PRNSOperac.AsString+')';
ny:=5;
for i:=1  to koln do
  begin
   Memo1.Width:=193;
   ny:=ny+1;
   n:=IntToStr(ny);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     oop:=(1+Length(qPrintName.AsString)-Length(str1));
     if (Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'')or(qPrintCenaOpt.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintCenaOpt.Value>0 then  XL.Range['AC'+n]:='Розничная цена без скидки='+qPrintCenaOpt.AsString;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;
   swonds:=swonds+SimpleRoundTo(qPrintSumwoNDS.Value,-2);
   if qPrintSkid.Value<=0 then snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2)
   else skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2);
   sndso:=sndso+SimpleRoundTo(qPrintSumNDSO.Value,-2);
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  vy:=ny;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 XL.WorkBooks[1].Sheets[1].PageSetup.PrintArea:='$A$1:$AJ$'+IntToStr(vy+1);
 //Печать ТТН
 XL.WorkBooks[1].Sheets[2].Activate;
 vy:=39;
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  kstr:=IntToStr(XL.WorkBooks[1].Sheets[1].HPageBreaks.Count-9);
 XL.Range['B39']:='Товар согласно приложения на '+kstr+' листах';
 if FormMain.VisM1.P2<>0 then
 begin
   XL.WorkBooks[1].Sheets[1].Protect('2040478');
   XL.WorkBooks[1].Sheets[2].Protect('2040478');
   XL.visible:=true;
 end
 else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      if MessageDlg('Вставьте чистые листы для печати приложения',mtConfirmation,[mbYes,mbNo],0)=mrYes then
        XL.WorkBooks[1].Sheets[1].PrintOut(1,EmptyParam,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
end;


/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_lopoPril
/// они одинаковы и наоборот
procedure TFormPrint.Rash_lopo;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,snds1,swnds,swnds1,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,sumndssk,sumndsf,massa:Double;
    provki,provka:String;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds1:=0;swnds:=0;swnds1:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;sumndssk:=0;sumndsf:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_lopoPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=23 then
   begin
   vy:=50;
   ny:=3;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Rows[n].Autofit;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
  XL.Range['R'+n]:=qPrintNDS.AsString;
  XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
  XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddTorg.Value+qPrintAddOpt.Value+qPrintAddSuppl.Value;
  XL.Range['AE'+n]:=FloatToStr(nad);
  XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  XL.Range['AI'+n]:=qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=str;
   if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   //XL.Range['B'+n].Characters(Start:=2+Length(qPrintName.AsString)-Length(str1), Length:=1+Length(str)-Length(str1) ).Font.Size:=7;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  if (qPrintTrans.Value>0)or(qPrintSkid.Value>0) then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   if (qPrintSkid.Value>0) then
   begin
    XL.Range['C'+n]:='Скидка= '+qPrintSkid.AsString+'%';
   end;
   if (qPrintTrans.Value>0) then
   begin
    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
    XL.Range['O'+n]:=qPrintSumBegin.AsString;
    XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  if qPrintSkid.Value=0 then snds1:=snds1+qPrintSumNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  massa:=massa+qPrintMassaGruza.Value;
  sumndssk:=sumndssk+qPrintSumSkid.Value;
  sumndsf:=sumndsf+qPrintSumNDSO.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['Y'+IntToStr(vy+1)]:=grmest;
 XL.Range['AA'+IntToStr(vy+1)]:=massa;
 if nomr=3 then
  begin
  vy:=3;
  XL.WorkBooks[1].Sheets[5].Activate;
  end;
 XL.Range['E'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['E'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['E'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['E'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['E'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
 sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds1;
 XL.Range['E'+IntToStr(vy+9)]:=FloatToStr(Round(sumnad));
 XL.Range['E'+IntToStr(vy+10)]:=FloatToStr(sumndssk);
 XL.Range['M'+IntToStr(vy+4)]:=FloatToStr(Round(snds));
 XL.Range['M'+IntToStr(vy+5)]:=FloatToStr(sumndsf);
 XL.Range['M'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 XL.Range['M'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 XL.Range['M'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 XL.Range['M'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['P'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['Z'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;
 {//Печать проводок для магазинов
 XL.Range['X'+IntToStr(vy+5)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+6)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+7)]:='412/'+PRNSTpKod.AsString;
 XL.Range['AA'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
 XL.Range['AA'+IntToStr(vy+6)]:='423/11';
 XL.Range['AA'+IntToStr(vy+7)]:='428/11';
 FormMain.VisM1.P1:=PRNSID.AsString;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltov(P1),P3=##Class(KSU.Provodki).cckltara(P1),'+
 'P4=##Class(KSU.Provodki).ndsroztovs(P1),P5=##Class(KSU.Provodki).ndsroztaras(P1),P6=##Class(KSU.Provodki).crozo(P1)');
 sumtov:=FormMain.VisM1.P2;sumtara:=FormMain.VisM1.P3;sumnds:=FormMain.VisM1.P4;
 sumndst:=FormMain.VisM1.P5;sumroztov:=FormMain.VisM1.P6;
 FormMain.VisM1.Execute('s P7=##Class(KSU.Provodki).nadbasezag(P1)');
 sumnadzag:=FormMain.VisM1.P7;
 sumnad:=sumroztov-sumtov-sumtara-sumnds-sumndst;
 if sumnadzag>0 then
  begin
    XL.Range['X'+IntToStr(vy+8)]:='412/'+PRNSTpKod.AsString;
    XL.Range['AA'+IntToStr(vy+8)]:='425/11';
    XL.Range['AD'+IntToStr(vy+8)]:=sumnadzag;
  end;
 XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
 XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad-sumnadzag );
 if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
 else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
 }

 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
 XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(swnds));
 if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
 if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
 XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AA'+IntToStr(vy+17)]:=PRNSVodName.AsString; // принял водитель
 XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
 if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
 else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
 if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
 else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
 if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
 else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
 if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
 else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
  if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
 XL.visible:=true;
 end
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     if nomr=1 then
      begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      end
     else
      if nomr=2 then
       begin
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=3 then
        begin
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        begin
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end;
     if nomr>1 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if nomr=2 then
        begin
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
       end;
      end;

     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;

/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_lopoPril
/// они одинаковы и наоборот
procedure TFormPrint.Rash_lopobaz;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,snds1,swnds,swnds1,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,sumndssk,sumndsf:Double;
    provki,provka:String;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).Makelopobaz(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds1:=0;swnds:=0;swnds1:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;sumndssk:=0;sumndsf:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_lopoPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopobaz.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=23 then
   begin
   vy:=50;
   ny:=3;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;//qPrintName.AsString;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Rows[n].Autofit;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
  XL.Range['R'+n]:=qPrintNDS.AsString;
  XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
  XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddOpt.Value;
  XL.Range['AE'+n]:=FloatToStr(nad);
  XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  XL.Range['AI'+n]:=qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=str; //qPrintDop.AsString;
   if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   //XL.Range['B'+n].Characters(Start:=2+Length(qPrintName.AsString)-Length(str1), Length:=1+Length(str)-Length(str1) ).Font.Size:=7;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  if (qPrintTrans.Value>0)or(qPrintSkid.Value>0) then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   if (qPrintSkid.Value>0) then
   begin
    XL.Range['C'+n]:='Скидка= '+qPrintSkid.AsString+'%';
   end;
   if (qPrintTrans.Value>0) then
   begin
    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
    XL.Range['O'+n]:=qPrintSumBegin.AsString;
    XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  if qPrintSkid.Value=0 then snds1:=snds1+qPrintSumNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  sumndssk:=sumndssk+qPrintSumSkid.Value;
  sumndsf:=sumndsf+qPrintSumNDSO.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 if nomr=3 then
  begin
  vy:=3;
  XL.WorkBooks[1].Sheets[5].Activate;
  end;
 XL.Range['E'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['E'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['E'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['E'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['E'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
 sumnad:=sumtov*(nad/100);
 XL.Range['E'+IntToStr(vy+9)]:=FloatToStr(Round(sumnad));
 XL.Range['E'+IntToStr(vy+10)]:=FloatToStr(sumndssk);
 XL.Range['M'+IntToStr(vy+4)]:=FloatToStr(Round(snds));
 XL.Range['M'+IntToStr(vy+5)]:=FloatToStr(sumndsf);
 XL.Range['M'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 //XL.Range['M'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 //XL.Range['M'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 //XL.Range['M'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['P'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['Z'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;
 {//Печать проводок для магазинов
 XL.Range['X'+IntToStr(vy+5)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+6)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+7)]:='412/'+PRNSTpKod.AsString;
 XL.Range['AA'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
 XL.Range['AA'+IntToStr(vy+6)]:='423/11';
 XL.Range['AA'+IntToStr(vy+7)]:='428/11';
 FormMain.VisM1.P1:=PRNSID.AsString;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltov(P1),P3=##Class(KSU.Provodki).cckltara(P1),'+
 'P4=##Class(KSU.Provodki).ndsroztovs(P1),P5=##Class(KSU.Provodki).ndsroztaras(P1),P6=##Class(KSU.Provodki).crozo(P1)');
 sumtov:=FormMain.VisM1.P2;sumtara:=FormMain.VisM1.P3;sumnds:=FormMain.VisM1.P4;
 sumndst:=FormMain.VisM1.P5;sumroztov:=FormMain.VisM1.P6;
 FormMain.VisM1.Execute('s P7=##Class(KSU.Provodki).nadbasezag(P1)');
 sumnadzag:=FormMain.VisM1.P7;
 sumnad:=sumroztov-sumtov-sumtara-sumnds-sumndst;
 if sumnadzag>0 then
  begin
    XL.Range['X'+IntToStr(vy+8)]:='412/'+PRNSTpKod.AsString;
    XL.Range['AA'+IntToStr(vy+8)]:='425/11';
    XL.Range['AD'+IntToStr(vy+8)]:=sumnadzag;
  end;
 XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
 XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad-sumnadzag );
 if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
 else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
 }


 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
 //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov-swnds));
 //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov-sumnad+snds));
 XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(swnds));
 XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AA'+IntToStr(vy+17)]:=PRNSVodName.AsString; // принял водитель
 XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
 if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
 else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
 if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
 else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
 if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
 else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
 if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
 else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки

   if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;

 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
 XL.visible:=true;
 end
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     if nomr=1 then
      begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      end
     else
      if nomr=2 then
       begin
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=3 then
        begin
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        begin
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end;
     if nomr>1 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if nomr=2 then
        begin
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
       end;
      end;

     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;


/// !!!!!!!! ВНИМАНИЕ! Изменяя этот метод, надо менять и метод Rash_lopoPril
/// они одинаковы и наоборот
procedure TFormPrint.Rash_lopobaz2;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,snds1,swnds,swnds1,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,sumndssk,sumndsf:Double;
    provki,provka:String;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).Makelopobaz2(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds1:=0;swnds:=0;swnds1:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;sumndssk:=0;sumndsf:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_lopoPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopobaz2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=23 then
   begin
   vy:=50;
   ny:=3;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;//qPrintName.AsString;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Rows[n].Autofit;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
  XL.Range['R'+n]:=qPrintNDS.AsString;
  XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
  XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
  XL.Range['AE'+n]:=FloatToStr(nad);
  XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  XL.Range['AI'+n]:=qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=str; //qPrintDop.AsString;
   if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   //XL.Range['B'+n].Characters(Start:=2+Length(qPrintName.AsString)-Length(str1), Length:=1+Length(str)-Length(str1) ).Font.Size:=7;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  if (qPrintTrans.Value>0)or(qPrintSkid.Value>0) then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   if (qPrintSkid.Value>0) then
   begin
    XL.Range['C'+n]:='Скидка= '+qPrintSkid.AsString+'%';
   end;
   if (qPrintTrans.Value>0) then
   begin
    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
    XL.Range['O'+n]:=qPrintSumBegin.AsString;
    XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  if qPrintSkid.Value=0 then snds1:=snds1+qPrintSumNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  sumndssk:=sumndssk+qPrintSumSkid.Value;
  sumndsf:=sumndsf+qPrintSumNDSO.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 if nomr=3 then
  begin
  vy:=3;
  XL.WorkBooks[1].Sheets[5].Activate;
  end;
 XL.Range['E'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['E'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['E'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['E'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['E'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
 sumnad:=sumtov*(nad/100);
 XL.Range['E'+IntToStr(vy+9)]:=FloatToStr(Round(sumnad));
 XL.Range['E'+IntToStr(vy+10)]:=FloatToStr(sumndssk);
 XL.Range['M'+IntToStr(vy+4)]:=FloatToStr(Round(snds));
 XL.Range['M'+IntToStr(vy+5)]:=FloatToStr(sumndsf);
 XL.Range['M'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 //XL.Range['M'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 //XL.Range['M'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 //XL.Range['M'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['P'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['Z'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;
 {//Печать проводок для магазинов
 XL.Range['X'+IntToStr(vy+5)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+6)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+7)]:='412/'+PRNSTpKod.AsString;
 XL.Range['AA'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
 XL.Range['AA'+IntToStr(vy+6)]:='423/11';
 XL.Range['AA'+IntToStr(vy+7)]:='428/11';
 FormMain.VisM1.P1:=PRNSID.AsString;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltov(P1),P3=##Class(KSU.Provodki).cckltara(P1),'+
 'P4=##Class(KSU.Provodki).ndsroztovs(P1),P5=##Class(KSU.Provodki).ndsroztaras(P1),P6=##Class(KSU.Provodki).crozo(P1)');
 sumtov:=FormMain.VisM1.P2;sumtara:=FormMain.VisM1.P3;sumnds:=FormMain.VisM1.P4;
 sumndst:=FormMain.VisM1.P5;sumroztov:=FormMain.VisM1.P6;
 FormMain.VisM1.Execute('s P7=##Class(KSU.Provodki).nadbasezag(P1)');
 sumnadzag:=FormMain.VisM1.P7;
 sumnad:=sumroztov-sumtov-sumtara-sumnds-sumndst;
 if sumnadzag>0 then
  begin
    XL.Range['X'+IntToStr(vy+8)]:='412/'+PRNSTpKod.AsString;
    XL.Range['AA'+IntToStr(vy+8)]:='425/11';
    XL.Range['AD'+IntToStr(vy+8)]:=sumnadzag;
  end;
 XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
 XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad-sumnadzag );
 if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
 else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
 }


 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
 //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov-swnds));
 XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov-sumnad+snds));
 XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AA'+IntToStr(vy+17)]:=PRNSVodName.AsString; // принял водитель
 XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
 if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
 else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
 if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
 else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
 if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
 else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
  FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
 if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
 else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
   if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
 XL.visible:=true;
 end
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     if nomr=1 then
      begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      end
     else
      if nomr=2 then
       begin
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=3 then
        begin
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        begin
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end;
     if nomr>1 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if nomr=2 then
        begin
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
       end;
      end;

     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;


procedure TFormPrint.Rash_veg;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,snds1,swnds,swnds1,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,sumndssk,sumndsf:Double;
    sbeg,stot:Double;
    provki,provka:String;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeVeg(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds1:=0;swnds:=0;swnds1:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;sumndssk:=0;sumndsf:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_lopoPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_veg.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=23 then
   begin
   vy:=50;
   ny:=3;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;//qPrintName.AsString;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Rows[n].Autofit;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(qPrintSumwoNDS.Value);
  XL.Range['R'+n]:=qPrintNDS.AsString;
  XL.Range['S'+n]:=FloatToStr(qPrintSumNDS.Value);
  XL.Range['V'+n]:=FloatToStr(qPrintSumrwNDS.Value);
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  XL.Range['AA'+n]:=FloatToStr(qnt);
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddTorg.Value+qPrintAddOpt.Value+qPrintAddSuppl.Value;
  XL.Range['AE'+n]:=qPrintSumBegin.AsString;//FloatToStr(nad);
  //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  //XL.Range['AI'+n]:=qPrintSumTotal.AsString;//qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=str; //qPrintDop.AsString;
   if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   //XL.Range['B'+n].Characters(Start:=2+Length(qPrintName.AsString)-Length(str1), Length:=1+Length(str)-Length(str1) ).Font.Size:=7;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  if (qPrintTrans.Value>0)or(qPrintSkid.Value>0) then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   if (qPrintSkid.Value>0) then
   begin
    XL.Range['C'+n]:='Скидка= '+qPrintSkid.AsString+'%';
   end;
   if (qPrintTrans.Value>0) then
   begin
    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
    XL.Range['O'+n]:=qPrintSumBegin.AsString;
    XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  sbeg:=sbeg+qPrintSumBegin.Value;stot:=stot+qPrintSumTotal.Value;
  if qPrintSkid.Value=0 then snds1:=snds1+qPrintSumNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  sumndssk:=sumndssk+qPrintSumSkid.Value;
  sumndsf:=sumndsf+qPrintSumNDSO.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['AE'+IntToStr(vy+1)]:=FloatToStr(Round(sbeg));
 //XL.Range['AI'+IntToStr(vy+1)]:=FloatToStr(Round(stot));
 XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(skol);
 if nomr=3 then
  begin
  vy:=3;
  XL.WorkBooks[1].Sheets[5].Activate;
  end;
 {XL.Range['E'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['E'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['E'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['E'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['E'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara)); }
 sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds1;
 {XL.Range['E'+IntToStr(vy+9)]:=FloatToStr(Round(sumnad));
 XL.Range['E'+IntToStr(vy+10)]:=FloatToStr(sumndssk);
 XL.Range['M'+IntToStr(vy+4)]:=FloatToStr(Round(snds));
 XL.Range['M'+IntToStr(vy+5)]:=FloatToStr(sumndsf);
 XL.Range['M'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 XL.Range['M'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 XL.Range['M'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 XL.Range['M'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara)); }

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['P'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['Z'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;
 {//Печать проводок для магазинов
 XL.Range['X'+IntToStr(vy+5)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+6)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+7)]:='412/'+PRNSTpKod.AsString;
 XL.Range['AA'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
 XL.Range['AA'+IntToStr(vy+6)]:='423/11';
 XL.Range['AA'+IntToStr(vy+7)]:='428/11';
 FormMain.VisM1.P1:=PRNSID.AsString;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltov(P1),P3=##Class(KSU.Provodki).cckltara(P1),'+
 'P4=##Class(KSU.Provodki).ndsroztovs(P1),P5=##Class(KSU.Provodki).ndsroztaras(P1),P6=##Class(KSU.Provodki).crozo(P1)');
 sumtov:=FormMain.VisM1.P2;sumtara:=FormMain.VisM1.P3;sumnds:=FormMain.VisM1.P4;
 sumndst:=FormMain.VisM1.P5;sumroztov:=FormMain.VisM1.P6;
 FormMain.VisM1.Execute('s P7=##Class(KSU.Provodki).nadbasezag(P1)');
 sumnadzag:=FormMain.VisM1.P7;
 sumnad:=sumroztov-sumtov-sumtara-sumnds-sumndst;
 if sumnadzag>0 then
  begin
    XL.Range['X'+IntToStr(vy+8)]:='412/'+PRNSTpKod.AsString;
    XL.Range['AA'+IntToStr(vy+8)]:='425/11';
    XL.Range['AD'+IntToStr(vy+8)]:=sumnadzag;
  end;
 XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
 XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad-sumnadzag );
 if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
 else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
 }


 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
 XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(swnds));
 XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AA'+IntToStr(vy+17)]:=PRNSVodName.AsString; // принял водитель
 XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
 XL.visible:=true;
 end
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     if nomr=1 then
      begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      end
     else
      if nomr=2 then
       begin
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=3 then
        begin
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        begin
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end;
     if nomr>1 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if nomr=2 then
        begin
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
       end;
      end;

     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;

procedure TFormPrint.Rash_veg_svoi;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,snds1,swnds,swnds1,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,sumndssk,sumndsf:Double;
    sbeg,stot:Double;
    provki,provka:String;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeVeg(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;snds1:=0;swnds:=0;swnds1:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;sumndssk:=0;sumndsf:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
if koln>38 then
begin
 Rash_lopoPril;
 Exit;
end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_veg.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=23 then
   begin
   vy:=50;
   ny:=3;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;//qPrintName.AsString;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Rows[n].Autofit;
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(qPrintSumwoNDS.Value);
  XL.Range['R'+n]:=qPrintNDS.AsString;
  XL.Range['S'+n]:=FloatToStr(qPrintSumNDS.Value);
  XL.Range['V'+n]:=FloatToStr(qPrintSumrwNDS.Value);
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  XL.Range['AA'+n]:=FloatToStr(qnt);
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddTorg.Value+qPrintAddOpt.Value+qPrintAddSuppl.Value;
  XL.Range['AE'+n]:=qPrintSumBegin.AsString;//FloatToStr(nad);
  XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  XL.Range['AI'+n]:=qPrintSumTotal.AsString;//qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
   XL.Range['B'+n]:=str; //qPrintDop.AsString;
   if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   //XL.Range['B'+n].Characters(Start:=2+Length(qPrintName.AsString)-Length(str1), Length:=1+Length(str)-Length(str1) ).Font.Size:=7;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  if (qPrintTrans.Value>0)or(qPrintSkid.Value>0) then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   if (qPrintSkid.Value>0) then
   begin
    XL.Range['C'+n]:='Скидка= '+qPrintSkid.AsString+'%';
   end;
   if (qPrintTrans.Value>0) then
   begin
    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
    XL.Range['O'+n]:=qPrintSumBegin.AsString;
    XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end;
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  sbeg:=sbeg+qPrintSumBegin.Value;stot:=stot+qPrintSumTotal.Value;
  if qPrintSkid.Value=0 then snds1:=snds1+qPrintSumNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  sumndssk:=sumndssk+qPrintSumSkid.Value;
  sumndsf:=sumndsf+qPrintSumNDSO.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['AE'+IntToStr(vy+1)]:=FloatToStr(Round(sbeg));
 XL.Range['AI'+IntToStr(vy+1)]:=FloatToStr(Round(stot));
 XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
 XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(skol);
 if nomr=3 then
  begin
  vy:=3;
  XL.WorkBooks[1].Sheets[5].Activate;
  end;
 {XL.Range['E'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['E'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['E'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['E'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['E'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara)); }
 sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds1;
 {XL.Range['E'+IntToStr(vy+9)]:=FloatToStr(Round(sumnad));
 XL.Range['E'+IntToStr(vy+10)]:=FloatToStr(sumndssk);
 XL.Range['M'+IntToStr(vy+4)]:=FloatToStr(Round(snds));
 XL.Range['M'+IntToStr(vy+5)]:=FloatToStr(sumndsf);
 XL.Range['M'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 XL.Range['M'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 XL.Range['M'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 XL.Range['M'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara)); }

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['P'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['S'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['V'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['V'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['Z'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AG'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AG'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;
 {//Печать проводок для магазинов
 XL.Range['X'+IntToStr(vy+5)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+6)]:='412/'+PRNSTpKod.AsString;
 XL.Range['X'+IntToStr(vy+7)]:='412/'+PRNSTpKod.AsString;
 XL.Range['AA'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
 XL.Range['AA'+IntToStr(vy+6)]:='423/11';
 XL.Range['AA'+IntToStr(vy+7)]:='428/11';
 FormMain.VisM1.P1:=PRNSID.AsString;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltov(P1),P3=##Class(KSU.Provodki).cckltara(P1),'+
 'P4=##Class(KSU.Provodki).ndsroztovs(P1),P5=##Class(KSU.Provodki).ndsroztaras(P1),P6=##Class(KSU.Provodki).crozo(P1)');
 sumtov:=FormMain.VisM1.P2;sumtara:=FormMain.VisM1.P3;sumnds:=FormMain.VisM1.P4;
 sumndst:=FormMain.VisM1.P5;sumroztov:=FormMain.VisM1.P6;
 FormMain.VisM1.Execute('s P7=##Class(KSU.Provodki).nadbasezag(P1)');
 sumnadzag:=FormMain.VisM1.P7;
 sumnad:=sumroztov-sumtov-sumtara-sumnds-sumndst;
 if sumnadzag>0 then
  begin
    XL.Range['X'+IntToStr(vy+8)]:='412/'+PRNSTpKod.AsString;
    XL.Range['AA'+IntToStr(vy+8)]:='425/11';
    XL.Range['AD'+IntToStr(vy+8)]:=sumnadzag;
  end;
 XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
 XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad-sumnadzag );
 if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
 else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
 }


 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
 XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(swnds));
 XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AA'+IntToStr(vy+17)]:=PRNSVodName.AsString; // принял водитель
 XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
 XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
 XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
 XL.visible:=true;
 end
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     if nomr=1 then
      begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      end
     else
      if nomr=2 then
       begin
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=3 then
        begin
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        begin
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end;
     if nomr>1 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if nomr=2 then
        begin
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
       end;
      end;

     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;

// Отличается от Rash_lopo: итоги другие
procedure TFormPrint.Rash_lopo_1;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,grmest,sumtov,sumstk,sumtara,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumnadzag,stov,massa:Double;
    provki,provka:String;
    i:integer;
begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
  ny:=ny+1;
  n:=IntToStr(ny);
  if i=23 then
   begin
   vy:=50;
   ny:=3;
   n:=IntToStr(ny);
   XL.WorkBooks[1].Sheets[7].Activate;
   end;
  XL.Range['B'+n]:=qPrintNNT.AsString;
  str:=qPrintName.Value+' '+qPrintDop.Value;
  Memo1.Text:=str;
  str1:=Memo1.Lines.Strings[0];
  str:=Copy(str,Length(str1),Length(str));
  XL.Range['C'+n]:=str1;
  XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
  XL.Range['I'+n]:=qPrintEI.Value;
  qnt:=qPrintQnt.Value;
  XL.Range['K'+n]:=FloatToStr(qnt);
  XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
  XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
  XL.Range['R'+n]:=qPrintNDS.AsString;
  if qPrintSumNDS.Value<>0 then
  XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
  XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
  XL.Range['Y'+n]:=qPrintGrMest.AsString;
  XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
  cena:=qPrintPrice.Value;
  XL.Range['AC'+n]:=FloatToStr(cena);
  nad:=qPrintAddTorg.Value+qPrintAddOpt.Value+qPrintAddSuppl.Value;
  XL.Range['AE'+n]:=FloatToStr(nad);
  XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
  XL.Range['AI'+n]:=qPrintFas.AsString;
  if str<>'' then
   begin
   ny:=ny+1;
   n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  if qPrintTrans.Value>0 then
   begin
   n:=IntToStr(ny);
   XL.Range['B'+n+':'+'AJ'+n].Select;
   XL.Selection.Insert;
   XL.Selection.Delete;
   ny:=ny+1;
   n:=IntToStr(ny);
   XL.Range['M'+n]:=qPrintPricewTrans.AsString;
   XL.Range['O'+n]:=qPrintSumBegin.AsString;
   XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
   end
  else
   begin
   rown:=InttoStr(ny+1);
   XL.Rows[rown+':'+rown].Select;
   XL.Selection.Delete;
   vy:=vy-1;
   end;
  //Подсчет итогов
  skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
  snds:=snds+qPrintSumNDS.Value;swnds:=swnds+qPrintSumrwNDS.Value;
  grmest:=grmest+qPrintGrMest.Value;
  massa:=massa+qPrintMassaGruza.Value;
  if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
  else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
  if nad<>0 then  sumnad:=sumnad+(cena*qnt*nad/100);
  if qPrintTrans.Value>0 then
   sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
  if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
  else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
  qPrint.Next;
  end;
 if ny<vy then
  begin
  ny:=ny+1;
  XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
  XL.Selection.Delete;
  //Смещение вверх
  vy:=vy-(vy-ny+1);
  end;
 //Печать итогов
 XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
 XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
 XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
 XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
 XL.Range['Y'+IntToStr(vy+1)]:=grmest;
 XL.Range['AA'+IntToStr(vy+1)]:=massa;
 if nomr=3 then
  begin
  vy:=3;
  XL.WorkBooks[1].Sheets[5].Activate;
  end;
 XL.Range['G'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
 XL.Range['G'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
 XL.Range['G'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
 XL.Range['G'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
 XL.Range['G'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
 sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
 XL.Range['T'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
 XL.Range['T'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
 XL.Range['T'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
 XL.Range['T'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
 XL.Range['T'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
 XL.Range['T'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['AA'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['AD'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['AD'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AD'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;
 End;

 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).nadbasestmc(P1),P3=##Class(KSU.Provodki).ndsbasebokr(P1),P4=##Class(KSU.Provodki).nadskl(P1)');
 sumtov:=sumtov+sumstk+StrToFloat(FormMain.VisM1.P2+FormMain.VisM1.P3+FormMain.VisM1.P4);
  XL.Range['F'+IntToStr(vy+10)]:=UtilForm.SumNumToFull(Round(snds));
  XL.Range['H'+IntToStr(vy+12)]:=UtilForm.SumNumToFull(Round(sumtov));
  if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['X'+IntToStr(vy+18)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+18)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+16)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+18)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+20)]:=PRNZPrinPol.AsString;// принял грузополучатель
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
 FormMain.VisM1.P1:=Data.KPRNID.Value;
 FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
 if FormMain.VisM1.P2<>0 then
 begin
 XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
 XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
 XL.visible:=true;
 end
else
 begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     if nomr=1 then
      begin
      XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
      end
     else
      if nomr=2 then
       begin
       XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=3 then
        begin
        XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        begin
        XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end;
     if nomr>1 then
      begin
      if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
       begin
       if nomr=2 then
        begin
        XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
         XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
         XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
       end;
      end;
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;
end;

procedure TFormPrint.Rash_lopo1;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO1(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo1.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;   
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massa;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo1.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPricewoNDS.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   //XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  //XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  XL.Range['AA'+IntToStr(vy+17)]:=PRNZPrinPol.AsString;// товар к перевозке принял
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['AB'+IntToStr(vy+19)]:='выданной '+PRNZDovVyd.AsString;// выдана доверенность

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol2;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol2(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
  if koln>38 then
  begin
    Rash_stol2Pril;
    Exit;
  end;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_stol2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;

//Для Столина
XL.Range['V20']:='';
if PRNZOwnCar.Value>0 then
  begin
   FormMain.VisM2.P1:=PRNZOwnCar.Value;
   FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",6)');
   XL.Range['G23']:=PRNZOwnCarName.Value+' '+FormMain.VisM2.P2;
  end;

ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPricewoNDS.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPrice.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintTrans.AsString;
   //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewTrans.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        //XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   //if qPrintSkid.Value<=0 then
   //snds:=snds+qPrintSumNDS.Value;
   //snds:=snds+qPrintSumNDS.Value;
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2);
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   //swnds:=swnds+qPrintSumrwNDS.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(massa);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['I'+IntToStr(vy+4)]:='скидка';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(skida,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFullBel(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFullBel(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  //XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
  XL.Range['AA'+IntToStr(vy+17)]:=PRNZPrinPol.AsString;// товар к перевозке принял
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1))+' кг';
  XL.Range['AB'+IntToStr(vy+19)]:='выданной '+PRNZDovVyd.AsString;// выдана доверенность


  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('2040478');
    XL.WorkBooks[1].Sheets[2].Protect('2040478');
    XL.WorkBooks[1].Sheets[3].Protect('2040478');
    XL.WorkBooks[1].Sheets[4].Protect('2040478');
    XL.WorkBooks[1].Sheets[5].Protect('2040478');
    XL.WorkBooks[1].Sheets[6].Protect('2040478');
    XL.WorkBooks[1].Sheets[7].Protect('2040478');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol2Okr;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol2Okr(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_stol2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPricewoNDS.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPrice.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintTrans.AsString;
   //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewTrans.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        //XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   //if qPrintSkid.Value<=0 then
   //snds:=snds+qPrintSumNDS.Value;
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2);
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   //swnds:=swnds+qPrintSumrwNDS.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['I'+IntToStr(vy+4)]:='скидка';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(skida,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol4;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol4(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_stol4.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPricewoNDS.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPrice.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintTrans.AsString;
   //XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewTrans.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        //XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        //XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   //if qPrintSkid.Value<=0 then
   //snds:=snds+qPrintSumNDS.Value;
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2);
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   sndso:=sndso+qPrintSumNDSO.Value;
   //swnds:=swnds+qPrintSumrwNDS.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['I'+IntToStr(vy+4)]:='скидка';
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(skida,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
    //provka:=UtilForm.P(provki,'!',i);
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_ivacbaza2;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeIvacbaza(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_ivacbaza.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   Memo1.Width:=193;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;   
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   //XL.Range['AC'+n]:=FloatToStr(cena);
   XL.Range['AC'+n]:=qPrintPricewTrans.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
       XL.Rows[n].Autofit;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       //if qPrintTrans.Value>0 then
       //begin
        //XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        //XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       //end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать погрузки, разгрузки

  if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
    XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
    XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
    XL.Range['K'+IntToStr(12)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
    XL.Range['M'+IntToStr(12)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
    XL.Range['O'+IntToStr(12)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
    XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
    XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
    XL.Range['K'+IntToStr(13)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
    XL.Range['M'+IntToStr(13)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
    XL.Range['O'+IntToStr(13)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой
    XL.WorkBooks[1].Sheets[2].Activate;
   end;

  XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
  XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
  XL.Range['K'+IntToStr(vy+30)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
  XL.Range['M'+IntToStr(vy+30)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
  XL.Range['O'+IntToStr(vy+30)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
  XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
  XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
  XL.Range['K'+IntToStr(vy+31)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
  XL.Range['M'+IntToStr(vy+31)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
  XL.Range['O'+IntToStr(vy+31)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой

  //Печать проводок для своих филиалов
 
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massagr,0))),',',1));
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['AA'+IntToStr(vy+17)]:=PRNZPrinPol.AsString;

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');




  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('2040478');
    XL.WorkBooks[1].Sheets[2].Protect('2040478');
    XL.WorkBooks[1].Sheets[3].Protect('2040478');
    XL.WorkBooks[1].Sheets[4].Protect('2040478');
    XL.WorkBooks[1].Sheets[5].Protect('2040478');
    XL.WorkBooks[1].Sheets[6].Protect('2040478');
    XL.WorkBooks[1].Sheets[7].Protect('2040478');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;

End;

procedure TFormPrint.Rash_ivacbaza;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeIvacbaza(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_ivacbaza.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   Memo1.Width:=193;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;   
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
       XL.Rows[n].Autofit;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать погрузки, разгрузки

  if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
    XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
    XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
    XL.Range['K'+IntToStr(12)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
    XL.Range['M'+IntToStr(12)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
    XL.Range['O'+IntToStr(12)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
    XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
    XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
    XL.Range['K'+IntToStr(13)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
    XL.Range['M'+IntToStr(13)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
    XL.Range['O'+IntToStr(13)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой
    XL.WorkBooks[1].Sheets[2].Activate;
   end;

  XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
  XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
  XL.Range['K'+IntToStr(vy+30)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
  XL.Range['M'+IntToStr(vy+30)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
  XL.Range['O'+IntToStr(vy+30)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
  XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
  XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
  XL.Range['K'+IntToStr(vy+31)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
  XL.Range['M'+IntToStr(vy+31)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
  XL.Range['O'+IntToStr(vy+31)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой

  //Печать проводок для своих филиалов
 
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massagr,0))),',',1));
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['AA'+IntToStr(vy+17)]:=PRNZPrinPol.AsString;

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');




  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;

End;

procedure TFormPrint.Rash_stol_baz;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStolBaz(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>37 then
begin
 Rash_stolbazPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_stolbaz.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<22 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=22 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   Memo1.Width:=193;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
       XL.Rows[n].Autofit;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'')or(qPrintCenaOpt.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintCenaOpt.Value>0 then  XL.Range['AC'+n]:='Розничная цена без скидки='+qPrintCenaOpt.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2);
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2); //44444444
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   //swnds:=swnds+qPrintSumrwNDS.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+SimpleRoundTo((cenatr*nad/100*qnt),-2);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));
  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol_opt;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStolOpt(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_stolbazPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_stolbaz.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   Memo1.Width:=193;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   //XL.Range['AE'+n]:=qPrintAddOpt.AsString;
   XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
       XL.Rows[n].Autofit;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
      //    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
   //     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
  //      XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then //snds:=snds+qPrintSumNDS.Value
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol_baz2;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStolBaz(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_stolbazPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_stolbaz2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   Memo1.Width:=193;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintFas.AsString;
   //XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
       XL.Rows[n].Autofit;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
      //    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
   //     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
  //      XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then //snds:=snds+qPrintSumNDS.Value
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  //XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  //XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol_bazopt;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStolBazOpt(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_stolbazPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_stolbaz2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   Memo1.Width:=193;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintFas.AsString;
   //XL.Range['AE'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   //XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
       XL.Rows[n].Autofit;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
      //    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
   //     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
  //      XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         else
          XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then //snds:=snds+qPrintSumNDS.Value
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  //XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  //XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_brrpo;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeBrrpo(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_brrpo.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=qPrintSumBegin.AsString;
   //FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintAddSuppl.AsString;
   //FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
      //    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
   //     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
  //      XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       //if qPrintAddSuppl.Value>0 then
         //begin
         //if nadabs=0 then
          //XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         //else
          //XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         //end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then //snds:=snds+qPrintSumNDS.Value
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=sumbegin+qPrintSumBegin.Value;
   //swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_brrpo1;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeBrrpo1(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_brrpo.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=qPrintSumBegin.AsString;
   //FloatToStr(SimpleRoundTo(qPrintSumrwNDS.Value,-2));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintAddSuppl.AsString;
   //FloatToStr(cena);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddTorg.AsString;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   //sumroz:=sumroz+(qPrintPricewNDS.Value*qnt);
   XL.Range['AI'+n]:=qPrintSumBegin.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
      //    XL.Range['M'+n]:=qPrintPricewTrans.AsString;
   //     XL.Range['M'+n]:=qPrintPricewTrans.AsString;
  //      XL.Range['O'+n]:=qPrintSumBegin.AsString;
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        //XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       //if qPrintAddSuppl.Value>0 then
         //begin
         //if nadabs=0 then
          //XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%'
         //else
          //XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+' ';
         //end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
  //XL.visible:=true;
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then //snds:=snds+qPrintSumNDS.Value
   //else
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=sumbegin+qPrintSumBegin.Value;
   //swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cenatr*qnt);
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AI'+IntToStr(vy+1)]:=sumbegin;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtov+sumstk+sumtara,-2));

  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(sndso,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 //FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 //if FormMain.VisM1.P7>0 then
  // FormMain.VisM1.P1:=FormMain.VisM1.P7;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   //provka:=UtilForm.P(provki,'!',i);
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  ///XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(SimpleRoundTo(sumtov,-2)+SimpleRoundTo(sumtara,-2)+SimpleRoundTo(sumstk,-2)+SimpleRoundTo(sumnad,-2)+SimpleRoundTo(snds,-2)-SimpleRoundTo(skida,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_kolos;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeKolos(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_kolos.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=qPrintSumBegin.AsString;
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPricewoNDS.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddSuppl.AsString;
   XL.Range['AG'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['AI'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=sumbegin+qPrintSumBegin.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AJ'+IntToStr(vy+1)]:=swonds;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumroztov,-2));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(swnds+sumstk,-2));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumroztara,-2));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumroztov+sumroztara,-2));

  XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(snds,-2));

  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumtov+sumtara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_kolosRozn;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeKolosRozn(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_kolosRozn.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=qPrintSumBegin.AsString;
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPricewoNDS.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddSuppl.AsString;
   XL.Range['AG'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['AI'+n]:=qPrintAddTorg.AsString;
   XL.Range['AJ'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%'
         else
          XL.Range['S'+n]:='Над.Базы.='+qPrintAddOpt.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=sumbegin+qPrintSumBegin.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  //XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  //XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  //XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  //XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  //XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  //XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  //XL.Range['AJ'+IntToStr(vy+1)]:=swonds;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  //XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  //XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  //XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(swnds+sumstk,-2));
  //XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  //XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(swnds+sumstk+sumtara,-2));

  //XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(snds,-2));

  //XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  XL.Range['H'+IntToStr(vy+9)]:=qPrintNDS.Value;
  //XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumtov+sumtara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(swnds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(swnds,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_kolosOpt;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j,nadabs:Integer;
    sndso,skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena,cenatr:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,massa,massab:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,sumskid:Double;
    massagr,sumbegin:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeKolosOpt(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;sndso:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;massa:=0;massab:=0; sumskid:=0;
massagr:=0; sumbegin:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
if koln>38 then
begin
 Rash_ivacbazaPril;
 Exit;
end;
XL.WorkBooks.Add(ProgDir+'ТТН_kolosOpt.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   nadabs:=FormMain.Vism1.P2;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintFas.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['O'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(SimpleRoundTo(qPrintSumNDS.Value,-2));
   XL.Range['V'+n]:=qPrintSumBegin.AsString;
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   massa:=massa+qPrintMassaGruza.Value;
   massab:=massab+qPrintMassaGruzaB.Value;
   cena:=qPrintPrice.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['AC'+n]:=qPrintPrice.AsString;
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=qPrintAddSuppl.AsString;
   XL.Range['AG'+n]:=qPrintPrice.AsString;
   XL.Range['AH'+n]:=qPrintAddOpt.AsString;
   XL.Range['AJ'+n]:=FloatToStr(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   XL.Range['AI'+n]:=qPrintPricewNDS.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintSkid.Value>0)or(qPrintVY.Value<>'') then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintVY.Value<>'' then  XL.Range['J'+n]:='Скидка '+qPrintVY.AsString;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:='Цена с тр.='+qPrintPricewTrans.AsString;
        XL.Range['I'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddOpt.Value>0 then
         begin
         if nadabs=0 then
          XL.Range['D'+n]:='Торговая надбавка.='+qPrintAddTorg.AsString+'%'
         else
          XL.Range['D'+n]:='Торговая надбавка.='+qPrintAddTorg.AsString+' ';
         end;
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt; swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value>0 then
   skida:=skida+SimpleRoundTo(qPrintPrice.Value*qnt*qPrintSkid.Value/100,-2); ///SimpleRoundTo(qPrintSumwoNDS.Value*qPrintSkid.Value/100,0);
   snds:=snds+qPrintSumNDS.Value;
   sndso:=sndso+qPrintSumNDSO.Value;
   sumskid:=sumskid+qPrintSumSkid.Value;
   swnds:=swnds+(SimpleRoundTo(qPrintSumwNDS.Value,-2));
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   sumbegin:=sumbegin+qPrintSumBegin.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(SimpleRoundTo(qPrintSumwoNDS.Value,-2));
   if nadabs=0 then
        if nad<>0 then
          begin
          sumnad:=sumnad+(cenatr*qnt*nad/100);
          sndsb:=sndsb+(cenatr*(1+nad/100)*qPrintNDS.Value/100*qnt)
          end
        else begin end
   else if nad<>0 then
        begin
          sumnad:=sumnad+(nad*qnt);
          sndsb:=sndsb+((cenatr+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cenatr-cena));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+(qPrintPricewNDS.Value*qnt)
   else                         sumroztov:=sumroztov+(qPrintPricewNDS.Value*qnt);
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(swonds,-2));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(snds,-2));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(SimpleRoundTo(sumbegin,-2));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massagr;
  XL.Range['AJ'+IntToStr(vy+1)]:=swnds;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  //XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(swnds,-2));
  //XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(SimpleRoundTo(sumstk,-2));
  //XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(swnds+sumstk,-2));
  //XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  //XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(swnds+sumstk+sumtara,-2));

  //XL.Range['F'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumskid,-2));
  //XL.Range['B'+IntToStr(vy+10)]:='Масса нетто: '+FloatToStr(massa)+' масса брутто: '+FloatToStr(massab);
  //XL.Range['I'+IntToStr(vy+3)]:='НДС общий';
  //XL.Range['O'+IntToStr(vy+3)]:=FloatToStr(SimpleRoundTo(snds,-2));

  //XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(SimpleRoundTo(sumnad,-2));
  //XL.Range['H'+IntToStr(vy+9)]:=qPrintNDS.Value;
  //XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(SimpleRoundTo(sumtr,-2));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(SimpleRoundTo(sumtov,-2));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(SimpleRoundTo(sumtara,-2));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(SimpleRoundTo(sumtov+sumtara,-2));

  //Печать проводок для своих филиалов

 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.P2:=PRNSID.Value;
 FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
 osh:=FormMain.VisM1.P4;
 if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
 else  provki:=FormMain.VisM1.P3;
 i:=1;
 j:=1;
 provka:=UtilForm.P(provki,'!',j);
 while provka<>'' do
 begin
  if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
  then begin
   XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
   XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
   stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
   stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
   if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
   else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
   i:=i+1;
  end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
 end;

 FormMain.VisM1.P1:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
 if FormMain.VisM1.P7>0 then
  begin
  FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P3,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
   begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')   then
    begin
    XL.Range['AC'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['AF'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
        else XL.Range['AI'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
    end;
   j:=j+1;
   provka:=UtilForm.P(provki,'!',j);
   end;
  End;
  end;

  XL.Range['F'+IntToStr(vy+11)]:='/'+FloatToStr(SimpleRoundTo(snds,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(snds,-2));
  XL.Range['H'+IntToStr(vy+13)]:='/'+FloatToStr(SimpleRoundTo(sumbegin,-2))+'/'+UtilForm.SumNumToFull(SimpleRoundTo(sumbegin,-2));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_lopo2;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,massa:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO2(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPricewoNDS.Value;
   XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
   XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value;
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       if qPrintAddOpt.Value>0 then
         XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+Round(qPrintSumwoNDS.Value*qPrintSkid.Value/100);
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massa:=massa+qPrintMassaGruza.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   if FormMain.VisM1.P2=0 then
        if nad<>0 then
        begin
          sumnad:=sumnad+(cena*qnt*nad/100);
          sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        end
   else if nad<>0 then
        begin
          sumnad:=sumnad+((cena+nad)*qnt);
          sndsb:=sndsb+((cena+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massa;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 //Печать проводок на сторону
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

 XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov+sumtara+sumstk+sumnad+snds-skida));
  if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_tarabaz;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb,massagr:Double;
    sumbase,sumpost,sumnds10,sumnds20:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeTaraBazOpt(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_tarabazopt.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPricewoNDS.Value;
   XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
   XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   //XL.Range['AE'+n]:=FloatToStr(nad);
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       if qPrintAddOpt.Value>0 then
         XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+Round(qPrintSumwoNDS.Value*qPrintSkid.Value/100);
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massagr:=massagr+qPrintMassaGruza.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   if FormMain.VisM1.P2=0 then
        {if nad<>0 then
        begin
          sumnad:=sumnad+(cena*qnt*nad/100);
          sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        end
   else if nad<>0 then
        begin
          sumnad:=sumnad+((cena+nad)*qnt);
          sndsb:=sndsb+((cena+nad)*(1+qPrintNDS.Value/100)*qnt)
        end; }
        sumnad:=sumnad+(qnt*(qPrintPricewoNDS.Value-qPrintPrice.Value));
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  XL.Range['AA'+IntToStr(vy+1)]:=FloatToStr(massagr);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
  //XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
  //XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
  //XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 //Печать проводок на сторону
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFullBel(Round(snds));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFullBel(Round(sumtov+sumtara+sumstk+snds-skida));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  //XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['AB'+IntToStr(vy+19)]:='выданной '+PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['AA'+IntToStr(vy+17)]:=PRNZPrinPol.AsString;// принял грузополучатель
  //UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massagr,0))),',',1));
  XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massagr,0))),',',1))+' кг';

  if PRNZTotalPackages.Value>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(PRNZTotalPackages.Value),',',1))
  else
  XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));


  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('2040478');
    XL.WorkBooks[1].Sheets[2].Protect('2040478');
    XL.WorkBooks[1].Sheets[3].Protect('2040478');
    XL.WorkBooks[1].Sheets[4].Protect('2040478');
    XL.WorkBooks[1].Sheets[5].Protect('2040478');
    XL.WorkBooks[1].Sheets[6].Protect('2040478');
    XL.WorkBooks[1].Sheets[7].Protect('2040478');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_stol3;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeStol3(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_stol3.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPricewoNDS.Value;
   XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
   XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPricewTrans.Value);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   //XL.Range['AE'+n]:=FloatToStr(nad);
   XL.Range['AG'+n]:=qPrintPricewoNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       if qPrintAddOpt.Value>0 then
         XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   {if qPrintSkid.Value<=0 then}
   //snds:=snds+qPrintSumNDS.Value;
   snds:=snds+SimpleRoundTo(qPrintSumNDS.Value,-2);
   if qPrintSkid.Value>0 then
   skida:=skida+(qPrintPricewTrans.Value*qnt*qPrintSkid.Value/100);
   //swnds:=swnds+qPrintSumrwNDS.Value;
   swnds:=swnds+SimpleRoundTo(qPrintSumrwNDS.Value,-2);
   grmest:=grmest+qPrintGrMest.Value;
if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   //FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   //if FormMain.VisM1.P2=0 then
        //if nad<>0 then
        //begin
          sumnad:=sumnad+(qPrintPricewTrans.Value*qnt*qPrintAddOpt.Value/100);
          //sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        //end
   //else if nad<>0 then
        ///begin
          //sumnad:=sumnad+((cena+nad)*qnt);
          ///sndsb:=sndsb+((cena+nad)*(1+qPrintNDS.Value/100)*qnt)
        //end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
  XL.Range['Y'+IntToStr(vy+1)]:=FloatToStr(grmest);
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  if skida>0 then XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(skida))
  else  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 //Печать проводок на сторону
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

{
  XL.Range['R'+IntToStr(vy+5)]:='621/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+6)]:='901/88';
  XL.Range['R'+IntToStr(vy+7)]:='901/11';
  XL.Range['R'+IntToStr(vy+8)]:='901/88';
  XL.Range['R'+IntToStr(vy+9)]:='901/88';
  XL.Range['R'+IntToStr(vy+10)]:='901/88';
  XL.Range['U'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+6)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+7)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+8)]:='4211/11';
  XL.Range['U'+IntToStr(vy+9)]:='682/22';
  XL.Range['U'+IntToStr(vy+10)]:='682/11';
  if nomr<>3 then
   begin
    XL.Range['AC'+IntToStr(vy+5)]:='428/22';
    XL.Range['AC'+IntToStr(vy+6)]:='4211/11';
    XL.Range['AC'+IntToStr(vy+7)]:='424/33';
    XL.Range['AC'+IntToStr(vy+8)]:='429/11';
    XL.Range['AC'+IntToStr(vy+9)]:='901/11';
    XL.Range['AC'+IntToStr(vy+10)]:='621/'+PRNSTpKod.AsString;
   end
  else
   begin
     XL.Range['AB'+IntToStr(vy+5)]:='428/22';
     XL.Range['AB'+IntToStr(vy+6)]:='4211/11';
     XL.Range['AB'+IntToStr(vy+7)]:='424/33';
     XL.Range['AB'+IntToStr(vy+8)]:='429/11';
     XL.Range['AB'+IntToStr(vy+9)]:='901/11';
     XL.Range['AB'+IntToStr(vy+10)]:='621/'+PRNSTpKod.AsString;
   end;
  XL.Range['AF'+IntToStr(vy+5)]:='901/11';
  XL.Range['AF'+IntToStr(vy+6)]:='901/11';
  XL.Range['AF'+IntToStr(vy+7)]:='901/11';
  XL.Range['AF'+IntToStr(vy+8)]:='901/11';
  XL.Range['AF'+IntToStr(vy+9)]:='682/22';
  XL.Range['AF'+IntToStr(vy+10)]:='901/88';

  FormMain.VisM1.P1:=PRNSID.AsString;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltara(P1),P3=##Class(KSU.Provodki).ccklsteklo(P1),'+
  'P4=##Class(KSU.Provodki).cckltovfix(P1),P5=##Class(KSU.Provodki).cckltov(P1),'+
  'P6=##Class(KSU.Provodki).nadbase(P1),P7=##Class(KSU.Provodki).nadpostskl(P1),'+
  'P8=##Class(KSU.Provodki).ndscckltov10(P1),P9=##Class(KSU.Provodki).ndscckltov20(P1)');
  sumtara:=FormMain.VisM1.P2; sumsteklo:=FormMain.VisM1.P3; sumfix:=FormMain.VisM1.P4;
  sumtov:=FormMain.VisM1.P5;sumbase:=FormMain.VisM1.P6;sumpost:=FormMain.VisM1.P7;
  sumnds10:=FormMain.VisM1.P8; sumnds20:=FormMain.VisM1.P9;
  FormMain.VisM1.P2:=0;  FormMain.VisM1.P3:=0;  FormMain.VisM1.P4:=0;
  FormMain.VisM1.P5:=0;  FormMain.VisM1.P6:=0;  FormMain.VisM1.P7:=0;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).ndsccklskidtv(P1),P3=##Class(KSU.Provodki).ndsccklskids(P1),'+
  'P4=##Class(KSU.Provodki).ndsskids(P1),P5=##Class(KSU.Provodki).ndsskidtv(P1),'+
  'P6=##Class(KSU.Provodki).ndscckltara(P1),P7=##Class(KSU.Provodki).skidskl(P1)');
  skidtv:=FormMain.VisM1.P2;skids:=FormMain.VisM1.P3;
  ndsskids:=FormMain.VisM1.P4;ndsskidtv:=FormMain.VisM1.P5;
  ndstara:=FormMain.VisM1.P6; skid:=FormMain.VisM1.P7;
  tov:=sumtov+sumpost+sumbase+sumnds10+sumnds20+ndstara-skid;

  XL.RAnge['X'+IntToStr(vy+5)]:=FloatToStr(sumtara+sumsteklo);
  XL.RAnge['X'+IntToStr(vy+6)]:=FloatToStr(sumtov-sumfix-sumsteklo);
  XL.RAnge['X'+IntToStr(vy+7)]:=FloatToStr(sumfix);
  XL.RAnge['X'+IntToStr(vy+8)]:=FloatToStr(sumbase+sumpost);
  XL.RAnge['X'+IntToStr(vy+9)]:=FloatToStr(sumnds20);
  XL.RAnge['X'+IntToStr(vy+10)]:=FloatToStr(sumnds10);
  XL.RAnge['AI'+IntToStr(vy+5)]:=FloatToStr(skidtv);
  XL.RAnge['AI'+IntToStr(vy+6)]:=FloatToStr(ndsskidtv);
  XL.RAnge['AI'+IntToStr(vy+7)]:=FloatToStr(skids);
  XL.RAnge['AI'+IntToStr(vy+8)]:=FloatToStr(ndsskids);
  XL.RAnge['AI'+IntToStr(vy+9)]:=FloatToStr(ndstara);
  XL.RAnge['AI'+IntToStr(vy+10)]:=FloatToStr(tov);
}
{  XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
  XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad);
  if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
  else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
}  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumroztov+sumroztara));
  //XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov+sumtara+sumstk+sumnad+snds-skida));
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_lopo3;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb,massa:Double;
    sumbase,sumpost,sumnds10,sumnds20:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO3(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';   
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPrice.Value;
   XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
   XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   //XL.Range['AE'+n]:=FloatToStr(nad);
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'
     else
      begin
       XL.Range['M'+n]:=qPrintPricewTrans.AsString;
       XL.Range['O'+n]:=qPrintSumBegin.AsString;
       XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+Round(qPrintSumwoNDS.Value*qPrintSkid.Value/100);
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massa:=massa+qPrintMassaGruza.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   if FormMain.VisM1.P2=0 then
        if nad<>0 then
        begin
          sumnad:=sumnad+(cena*qnt*nad/100);
          sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        end
   else if nad<>0 then
        begin
          sumnad:=sumnad+((cena+nad)*qnt);
          sndsb:=sndsb+((cena+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massa;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 //Печать проводок на сторону
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;

{
  XL.Range['R'+IntToStr(vy+5)]:='6012/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+6)]:='901/88';
  XL.Range['R'+IntToStr(vy+7)]:='901/11';
  XL.Range['R'+IntToStr(vy+8)]:='901/88';
  XL.Range['R'+IntToStr(vy+9)]:='901/88';
  XL.Range['R'+IntToStr(vy+10)]:='901/88';
  XL.Range['U'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+6)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+7)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+8)]:='4211/11';
  XL.Range['U'+IntToStr(vy+9)]:='682/22';
  XL.Range['U'+IntToStr(vy+10)]:='682/11';
  if nomr<>3 then
   begin
    XL.Range['AC'+IntToStr(vy+5)]:='428/22';
    XL.Range['AC'+IntToStr(vy+6)]:='4211/11';
    XL.Range['AC'+IntToStr(vy+7)]:='424/33';
    XL.Range['AC'+IntToStr(vy+8)]:='429/11';
    XL.Range['AC'+IntToStr(vy+9)]:='901/11';
    XL.Range['AC'+IntToStr(vy+10)]:='621/'+PRNSTpKod.AsString;
   end
  else
   begin
     XL.Range['AB'+IntToStr(vy+5)]:='428/22';
     XL.Range['AB'+IntToStr(vy+6)]:='4211/11';
     XL.Range['AB'+IntToStr(vy+7)]:='424/33';
     XL.Range['AB'+IntToStr(vy+8)]:='429/11';
     XL.Range['AB'+IntToStr(vy+9)]:='901/11';
     XL.Range['AB'+IntToStr(vy+10)]:='621/'+PRNSTpKod.AsString;
   end;
  XL.Range['AF'+IntToStr(vy+5)]:='901/11';
  XL.Range['AF'+IntToStr(vy+6)]:='901/11';
  XL.Range['AF'+IntToStr(vy+7)]:='901/11';
  XL.Range['AF'+IntToStr(vy+8)]:='901/11';
  XL.Range['AF'+IntToStr(vy+9)]:='682/22';
  XL.Range['AF'+IntToStr(vy+10)]:='901/88';

  FormMain.VisM1.P1:=PRNSID.AsString;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltara(P1),P3=##Class(KSU.Provodki).ccklsteklo(P1),'+
  'P4=##Class(KSU.Provodki).cckltovfix(P1),P5=##Class(KSU.Provodki).cckltov(P1),'+
  'P6=##Class(KSU.Provodki).nadbase(P1),P7=##Class(KSU.Provodki).nadpostskl(P1),'+
  'P8=##Class(KSU.Provodki).ndscckltov10(P1),P9=##Class(KSU.Provodki).ndscckltov20(P1)');
  sumtara:=FormMain.VisM1.P2; sumsteklo:=FormMain.VisM1.P3; sumfix:=FormMain.VisM1.P4;
  sumtov:=FormMain.VisM1.P5;sumbase:=FormMain.VisM1.P6;sumpost:=FormMain.VisM1.P7;
  sumnds10:=FormMain.VisM1.P8; sumnds20:=FormMain.VisM1.P9;
  FormMain.VisM1.P2:=0;  FormMain.VisM1.P3:=0;  FormMain.VisM1.P4:=0;
  FormMain.VisM1.P5:=0;  FormMain.VisM1.P6:=0;  FormMain.VisM1.P7:=0;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).ndsccklskidtv(P1),P3=##Class(KSU.Provodki).ndsccklskids(P1),'+
  'P4=##Class(KSU.Provodki).ndsskids(P1),P5=##Class(KSU.Provodki).ndsskidtv(P1),'+
  'P6=##Class(KSU.Provodki).ndscckltara(P1),P7=##Class(KSU.Provodki).skidskl(P1)');
  skidtv:=FormMain.VisM1.P2;skids:=FormMain.VisM1.P3;
  ndsskids:=FormMain.VisM1.P4;ndsskidtv:=FormMain.VisM1.P5;
  ndstara:=FormMain.VisM1.P6; skid:=FormMain.VisM1.P7;
  tov:=sumtov+sumpost+sumbase+sumnds10+sumnds20+ndstara-skid;

  XL.RAnge['X'+IntToStr(vy+5)]:=FloatToStr(sumtara+sumsteklo);
  XL.RAnge['X'+IntToStr(vy+6)]:=FloatToStr(sumtov-sumfix-sumsteklo);
  XL.RAnge['X'+IntToStr(vy+7)]:=FloatToStr(sumfix);
  XL.RAnge['X'+IntToStr(vy+8)]:=FloatToStr(sumbase+sumpost);
  XL.RAnge['X'+IntToStr(vy+9)]:=FloatToStr(sumnds20);
  XL.RAnge['X'+IntToStr(vy+10)]:=FloatToStr(sumnds10);
  XL.RAnge['AI'+IntToStr(vy+5)]:=FloatToStr(skidtv);
  XL.RAnge['AI'+IntToStr(vy+6)]:=FloatToStr(ndsskidtv);
  XL.RAnge['AI'+IntToStr(vy+7)]:=FloatToStr(skids);
  XL.RAnge['AI'+IntToStr(vy+8)]:=FloatToStr(ndsskids);
  XL.RAnge['AI'+IntToStr(vy+9)]:=FloatToStr(ndstara);
  XL.RAnge['AI'+IntToStr(vy+10)]:=FloatToStr(tov);
 }
{  XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
  XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad);
  if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
  else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
}  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov+sumtara+sumstk+sumnad+snds-skida));
  if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_lopo4;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,trans:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,stov,cenatr,massa:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO4(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';   
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPricewoNDS.Value;
   cenatr:=qPrintPricewTrans.Value;
   XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
   XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   nad:=qPrintAddSuppl.Value; //qPrintAddOpt.Value+qPrintAddTorg.Value;
   XL.Range['AE'+n]:=FloatToStr(nad);
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       if qPrintAddOpt.Value>0 then
         XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+Round(qPrintSumwoNDS.Value*qPrintSkid.Value/100);
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massa:=massa+qPrintMassaGruza.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cenatr*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cenatr*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   if FormMain.VisM1.P2=0 then
        if nad<>0 then
        begin
          sumnad:=sumnad+(cena*qnt*nad/100);
          sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        end
   else if nad<>0 then
        begin
          sumnad:=sumnad+((cena+nad)*qnt);
          sndsb:=sndsb+((cena+nad)*qPrintNDS.Value/100*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massa;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));
  XL.Range['R'+IntToStr(vy+4)]:='';
  XL.Range['U'+IntToStr(vy+4)]:='';
  XL.Range['X'+IntToStr(vy+4)]:='';
  XL.Range['AC'+IntToStr(vy+4)]:='';
  XL.Range['AF'+IntToStr(vy+4)]:='';
  XL.Range['AI'+IntToStr(vy+4)]:='';

  //Печать погрузки, разгрузки
  if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
    if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
    else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
    //XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
    XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
    XL.Range['K'+IntToStr(12)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
    XL.Range['M'+IntToStr(12)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
    XL.Range['O'+IntToStr(12)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
    XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
    XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
    XL.Range['K'+IntToStr(13)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
    XL.Range['M'+IntToStr(13)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
    XL.Range['O'+IntToStr(13)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
  //XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// погрузка, исполнитель
  //XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// погрузка, способ
  XL.Range['K'+IntToStr(vy+30)]:=PRNZPogruzkaPrib.AsString;// погрузка, прибытие
  XL.Range['M'+IntToStr(vy+30)]:=PRNZPogruzkaYbit.AsString;// погрузка, убытие
  XL.Range['O'+IntToStr(vy+30)]:=PRNZPogruzkaProstoi.AsString;// погрузка, простой
  //XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// разгрузка, исполнитель
  //XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// разгрузка, способ
  XL.Range['K'+IntToStr(vy+31)]:=PRNZRazgrPrib.AsString;// разгрузка, прибытие
  XL.Range['M'+IntToStr(vy+31)]:=PRNZRazgrYbit.AsString;// разгрузка, убытие
  XL.Range['O'+IntToStr(vy+31)]:=PRNZRazgrProstoi.AsString;// разгрузка, простой
    if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
 //Печать для возврата
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;    
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;
{
  XL.Range['R'+IntToStr(vy+5)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+6)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+7)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+8)]:='427/11';
  XL.Range['R'+IntToStr(vy+9)]:='601/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+10)]:='441/11';
  XL.Range['U'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+6)]:='183/33';
  XL.Range['U'+IntToStr(vy+7)]:='183/11';
  XL.Range['U'+IntToStr(vy+8)]:='601/'+PRNSTpKod.AsString;
  XL.Range['U'+IntToStr(vy+9)]:='423/11';
  XL.Range['U'+IntToStr(vy+10)]:='411/'+IntToStr(SK);

  FormMain.VisM1.P1:=PRNSID.AsString;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltara(P1),P3=##Class(KSU.Provodki).ccklsteklo(P1),'+
  'P4=##Class(KSU.Provodki).cckltovfix(P1),P5=##Class(KSU.Provodki).cckltov(P1),'+
  'P6=##Class(KSU.Provodki).nadbase(P1),P7=##Class(KSU.Provodki).nadpostskl(P1),'+
  'P8=##Class(KSU.Provodki).ndscckltov10(P1),P9=##Class(KSU.Provodki).ndscckltov20(P1)');
  sumtara:=FormMain.VisM1.P2; sumsteklo:=FormMain.VisM1.P3; sumfix:=FormMain.VisM1.P4;
  sumtov:=FormMain.VisM1.P5;sumbase:=FormMain.VisM1.P6;sumpost:=FormMain.VisM1.P7;
  sumnds10:=FormMain.VisM1.P8; sumnds20:=FormMain.VisM1.P9;
  FormMain.VisM1.P2:=0;  FormMain.VisM1.P3:=0;  FormMain.VisM1.P4:=0;
  FormMain.VisM1.P5:=0;  FormMain.VisM1.P6:=0;  FormMain.VisM1.P7:=0;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).skidskl(P1),P3=##Class(KSU.Provodki).ndsccklskids(P1),'+
  'P4=##Class(KSU.Provodki).ndsskids(P1),P5=##Class(KSU.Provodki).ndsskidtv(P1),'+
  'P6=##Class(KSU.Provodki).ndscckltara(P1),P7=##Class(KSU.Provodki).trans(P1)');
  skidtv:=FormMain.VisM1.P2;skids:=FormMain.VisM1.P3;
  ndsskids:=FormMain.VisM1.P4;ndsskidtv:=FormMain.VisM1.P5;
  ndstara:=FormMain.VisM1.P6; trans:=FormMain.VisM1.P7;
  tov:=sumtov+sumpost+sumbase+sumnds10+sumnds20+ndstara-skid;

  XL.RAnge['X'+IntToStr(vy+5)]:=FloatToStr(tov+sumtara);
  XL.RAnge['X'+IntToStr(vy+6)]:=FloatToStr(sumnds10);
  XL.RAnge['X'+IntToStr(vy+7)]:=FloatToStr(sumnds20);
  XL.RAnge['X'+IntToStr(vy+8)]:=FloatToStr(skidtv);
  XL.RAnge['X'+IntToStr(vy+9)]:=FloatToStr(sumpost);
  XL.RAnge['X'+IntToStr(vy+10)]:=FloatToStr(trans);
}
  {  XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
  XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad);
  if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
  else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
}  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov+sumtara+sumstk+snds-skida)); //+sumnad
  if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель

  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_lopo5;
var osh,str,str1,rown,nn:String;
    ns,koln,vy,ny,nomr,j:Integer;
    skol,swonds,snds,swnds,nad,qnt,qnt1,grmest,sumtov,sumstk,sumtara,sumsteklo,cena:Double;
    sumnds,sumnad,sumtr,sumroztov,sumroztara,sumndst,sumfix,skida,sndsb:Double;
    sumbase,sumpost,sumnds10,sumnds20,trans:Double;
    skidtv,skids,ndsskids,ndsskidtv,ndstara,tov,skid,sumroz,bonus,bonushran,stov,massa:Double;
    provki,provka:String;
Begin
FormMain.VisM1.P1:=PRNSID.Value;
FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakeLynORO5(P1)');
osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
if osh<>'' then
     raise Exception.Create(osh)
else
ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
qPrint.Close;
qPrint.Prepare;
qPrint.SQL.Strings[2]:='order by KodGr';
qPrint.ParamByName('ns').Value:=ns;
qPrint.Open;
qPrint.First;
skol:=0;swonds:=0;snds:=0;swnds:=0;grmest:=0;
sumtov:=0;sumstk:=0;sumtara:=0;
sumnds:=0;sumnad:=0;sumtr:=0;sumroztov:=0;sumroztara:=0;
sumroz:=0; skida:=0; sndsb:=0;
koln:=qPrint.RecordCount;
nn:=PRNSNnak.AsString;
XL.WorkBooks.Add(ProgDir+'ТТН_lopo2.xls');
if koln<6 then
 begin
 vy:=53;
 nomr:=1;
 XL.WorkBooks[1].Sheets[1].Activate;
 end
else
 if koln<16 then
  begin
  vy:=83;
  nomr:=2;
  XL.WorkBooks[1].Sheets[2].Activate;
  end
 else
  if koln<23 then
   begin
   vy:=104;
   nomr:=3;
   XL.WorkBooks[1].Sheets[4].Activate;
   end
  else
   begin
   vy:=50;
   nomr:=4;
   XL.WorkBooks[1].Sheets[6].Activate;
   end;
//XL.visible:=true;
ZaglN;
ny:=38;
 for i:=1  to koln do
  begin
   ny:=ny+1;
   n:=IntToStr(ny);
   if i=23 then
    begin
     vy:=50;
     ny:=3;
     n:=IntToStr(ny);
     XL.WorkBooks[1].Sheets[7].Activate;
    end;
   XL.Range['B'+n]:=qPrintNNT.AsString;
   str:=qPrintName.Value+' '+qPrintDop.Value;
   Memo1.Text:=str;
   str1:=Memo1.Lines.Strings[0];
   str:=Copy(str,Length(str1),Length(str));
   XL.Range['C'+n]:=str1; //qPrintName.AsString;
   XL.Range['C'+n].Characters.Font.FontStyle:='полужирный';   
   XL.Range['I'+n]:=qPrintEI.Value;
   qnt:=qPrintQnt.Value;
   XL.Range['K'+n]:=FloatToStr(qnt);
   XL.Range['M'+n]:=qPrintPricewoNDS.AsString;
   cena:=qPrintPricewoNDS.Value;
   XL.Range['O'+n]:=FloatToStr(Round(qPrintSumwoNDS.Value));
   XL.Range['R'+n]:=qPrintNDS.AsString;
   if qPrintSumNDS.Value<>0 then
   XL.Range['S'+n]:=FloatToStr(Round(qPrintSumNDS.Value));
   XL.Range['V'+n]:=FloatToStr(Round(qPrintSumrwNDS.Value));
   XL.Range['Y'+n]:=qPrintGrMest.AsString;
   XL.Range['AA'+n]:=qPrintMassaGruza.AsString;
   XL.Range['AC'+n]:=FloatToStr(qPrintPrice.Value);
   nad:=qPrintAddOpt.Value+qPrintAddSuppl.Value; //+qPrintAddTorg.Value;
   //XL.Range['AE'+n]:=FloatToStr(nad);
   XL.Range['AG'+n]:=qPrintPricewNDS.AsString;
   XL.Range['AI'+n]:=qPrintFas.AsString;
   if str<>'' then
    begin
     ny:=ny+1;
     n:=InttoStr(ny);
     XL.Range['B'+n]:=str; //qPrintDop.AsString;
     if (1+Length(qPrintName.AsString)-Length(str1))>0 then
       XL.Range['B'+n].Characters(Start:=1, Length:=1+Length(qPrintName.AsString)-Length(str1) ).Font.FontStyle:='полужирный';
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
   if (qPrintTrans.Value>0)or(qPrintAddOpt.Value>0)or(qPrintAddSuppl.Value>0)or(qPrintSkid.Value>0) then
    begin
     n:=IntToStr(ny);
     XL.Range['B'+n+':'+'AJ'+n].Select;
     XL.Selection.Insert;
     XL.Selection.Delete;
     ny:=ny+1;
     n:=IntToStr(ny);
     qnt1:=qnt*qPrintPricewoNDS.Value*qPrintSkid.Value/100;
     if qPrintSkid.Value>0 then  XL.Range['D'+n]:='Скидка='+qPrintSkid.AsString+'%'+'     '+FloatToStr(qnt1)
     else
      begin
       if qPrintTrans.Value>0 then
       begin
        XL.Range['M'+n]:=qPrintPricewTrans.AsString;
        XL.Range['O'+n]:=qPrintSumBegin.AsString;
        XL.Range['S'+n]:='Транс.='+qPrintTrans.AsString+'%';
       end;
       if qPrintAddSuppl.Value>0 then
         XL.Range['D'+n]:='Над.Пост.='+qPrintAddSuppl.AsString+'%';
       if qPrintAddOpt.Value>0 then
         XL.Range['AA'+n]:='Над.Базы.='+qPrintAddOpt.AsString+'%';
      end;
    end
   else
    begin
     rown:=InttoStr(ny+1);
     XL.Rows[rown+':'+rown].Select;
     XL.Selection.Delete;
     vy:=vy-1;
    end;
  //Подсчет итогов
   skol:=skol+qnt;swonds:=swonds+qPrintSumwoNDS.Value;
   if qPrintSkid.Value<=0 then snds:=snds+qPrintSumNDS.Value
   else skida:=skida+Round(qPrintSumwoNDS.Value*qPrintSkid.Value/100);
   swnds:=swnds+qPrintSumrwNDS.Value;
   grmest:=grmest+qPrintGrMest.Value;
   massa:=massa+qPrintMassaGruza.Value;
   if qPrintKodGr.Value=99 then sumtara:=sumtara+(cena*qnt)
   else
   if qPrintKodGr.Value=93 then sumstk:=sumstk+(cena*qnt)
   else  sumtov:=sumtov+(cena*qnt);
   FormMain.Vism1.P1:=qPrintNNT.Value;
   FormMain.Vism1.Execute('s P2=+$LG(^KSU.STMCD(P1),46)');
   if FormMain.VisM1.P2=0 then
        if nad<>0 then
        begin
          sumnad:=sumnad+(cena*qnt*nad/100);
          sndsb:=sndsb+(cena*(1+nad/100)*qPrintNDS.Value/100*qnt)
        end
   else if nad<>0 then
        begin
          sumnad:=sumnad+((cena+nad)*qnt);
          sndsb:=sndsb+((cena+nad)*(1+qPrintNDS.Value/100)*qnt)
        end;
   if qPrintTrans.Value>0 then
    sumtr:=sumtr+(qnt*(cena-qPrintPricewTrans.Value));
   if qPrintKodGr.Value=99 then sumroztara:=sumroztara+qPrintSumrwNDS.Value
   else                         sumroztov:=sumroztov+qPrintSumrwNDS.Value;
   qPrint.Next;
  end;
  if ny<vy then
   begin
    ny:=ny+1;
    XL.Rows[IntToStr(ny)+':'+IntToStr(vy)].Select;
    XL.Selection.Delete;
    //Смещение вверх
    vy:=vy-(vy-ny+1);
   end;
 //Печать итогов
  XL.Range['K'+IntToStr(vy+1)]:=FloatToStr(skol);
  XL.Range['O'+IntToStr(vy+1)]:=FloatToStr(Round(swonds));
  XL.Range['S'+IntToStr(vy+1)]:=FloatToStr(Round(snds));
  XL.Range['V'+IntToStr(vy+1)]:=FloatToStr(Round(swnds));
  XL.Range['Y'+IntToStr(vy+1)]:=grmest;
  XL.Range['AA'+IntToStr(vy+1)]:=massa;
  if nomr=3 then
   begin
    vy:=3;
    XL.WorkBooks[1].Sheets[5].Activate;
   end;
  XL.Range['F'+IntToStr(vy+4)]:=FloatToStr(Round(sumtov));
  XL.Range['F'+IntToStr(vy+5)]:=FloatToStr(Round(sumstk));
  XL.Range['F'+IntToStr(vy+6)]:=FloatToStr(Round(sumtov+sumstk));
  XL.Range['F'+IntToStr(vy+7)]:=FloatToStr(Round(sumtara));
  XL.Range['F'+IntToStr(vy+8)]:=FloatToStr(Round(sumtov+sumstk+sumtara));
  //sumnad:=sumroztov+sumroztara-sumtov-sumstk-sumtara-snds ;
  XL.Range['O'+IntToStr(vy+4)]:=FloatToStr(Round(sumnad));
  XL.Range['O'+IntToStr(vy+5)]:=FloatToStr(Round(snds));
  XL.Range['O'+IntToStr(vy+6)]:=FloatToStr(Round(sumtr));
  XL.Range['O'+IntToStr(vy+7)]:=FloatToStr(Round(sumroztov));
  XL.Range['O'+IntToStr(vy+8)]:=FloatToStr(Round(sumroztara));
  XL.Range['O'+IntToStr(vy+9)]:=FloatToStr(Round(sumroztov+sumroztara));

 //Печать для возврата
 FormMain.VisM1.P1:=SK; //PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",3)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",3)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=1;
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
    if i<=6 then
    begin
      XL.Range['R'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['U'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
      if UtilForm.P(provka,':',6)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['X'+IntToStr(vy+i+4)]:=UtilForm.P(provka,':',6)
           else XL.Range['X'+IntToStr(vy+i+4)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    if i>6 then
    begin
      if nomr<>3 then
        XL.Range['AC'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2)
      else  XL.Range['AB'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
      XL.Range['AF'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
      stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
      stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     if UtilForm.P(provka,':',6)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)
      else if UtilForm.P(provka,':',5)='0' then XL.Range['AI'+IntToStr(vy+i-2)]:=UtilForm.P(provka,':',6)
           else XL.Range['AI'+IntToStr(vy+i-2)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    end;
    i:=i+1;      
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  End;
{
  XL.Range['R'+IntToStr(vy+5)]:='621/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+6)]:='621/'+PRNSTpKod.AsString;
  XL.Range['R'+IntToStr(vy+7)]:='911/77';
  XL.Range['U'+IntToStr(vy+5)]:='411/'+IntToStr(SK);
  XL.Range['U'+IntToStr(vy+6)]:='911/77';
  XL.Range['U'+IntToStr(vy+7)]:='622/22';

  FormMain.VisM1.P1:=PRNSID.AsString;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cckltara(P1),P3=##Class(KSU.Provodki).ccklsteklo(P1),'+
  'P4=##Class(KSU.Provodki).cckltovfix(P1),P5=##Class(KSU.Provodki).cckltov(P1),'+
  'P6=##Class(KSU.Provodki).nadbase(P1),P7=##Class(KSU.Provodki).nadpostskl(P1),'+
  'P8=##Class(KSU.Provodki).ndscckltov10(P1),P9=##Class(KSU.Provodki).ndscckltov20(P1)');
  sumtara:=FormMain.VisM1.P2; sumsteklo:=FormMain.VisM1.P3; sumfix:=FormMain.VisM1.P4;
  sumtov:=FormMain.VisM1.P5;sumbase:=FormMain.VisM1.P6;sumpost:=FormMain.VisM1.P7;
  sumnds10:=FormMain.VisM1.P8; sumnds20:=FormMain.VisM1.P9;
  FormMain.VisM1.P2:=0;  FormMain.VisM1.P3:=0;  FormMain.VisM1.P4:=0;
  FormMain.VisM1.P5:=0;  FormMain.VisM1.P6:=0;  FormMain.VisM1.P7:=0;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).skidskl(P1),P3=##Class(KSU.Provodki).ndsccklskids(P1),'+
  'P4=##Class(KSU.Provodki).ndsskids(P1),P5=##Class(KSU.Provodki).ndsskidtv(P1),'+
  'P6=##Class(KSU.Provodki).ndscckltara(P1),P7=##Class(KSU.Provodki).trans(P1)');
  skidtv:=FormMain.VisM1.P2;skids:=FormMain.VisM1.P3;
  ndsskids:=FormMain.VisM1.P4;ndsskidtv:=FormMain.VisM1.P5;
  ndstara:=FormMain.VisM1.P6; trans:=FormMain.VisM1.P7;
  tov:=sumtov+sumpost+sumbase+sumnds10+sumnds20+ndstara-skid;
 }
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P3:=PRNSTpKod.Value;
  FormMain.VisM1.Execute('s P2=$LG(^KSU.FTXPRND(P1),2), P4=##Class(KSU.SprBonus).ViborBonus(P3,P2)');
  bonus:=StrtoFloat(FormMain.VisM1.P4);
  if bonus=0 then
  begin
    bonushran:=0;
    FormMain.VisM1.P1:=SK;
    FormMain.VisM1.Execute('s P2=##Class(KSU.SprBonus).ViborBonus1(P1)');
    if FormMain.VisM1.P2<>'' then
    begin
      bonus:=StrToFloat(UtilForm.P(FormMain.VisM1.P2,':',1));
      bonushran:=StrToFloat(UtilForm.P(FormMain.VisM1.P2,':',2));
    end;
  end;
{
  XL.RAnge['X'+IntToStr(vy+5)]:=FloatToStr(tov+sumtara)+'/'+FloatToStr(sumtara);
  XL.RAnge['X'+IntToStr(vy+6)]:=FloatToStr(sumtov*bonus);
  XL.RAnge['X'+IntToStr(vy+7)]:=FloatToStr(Round(sumtov*bonus*(0.1667)));

    XL.Range['AD'+IntToStr(vy+5)]:=FLoatToStr(sumtov+sumtara)+'/'+FloatToStr(sumtara);
  XL.Range['AD'+IntToStr(vy+6)]:=FLoatToStr(sumnad);
  if sumndst<>0 then  XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds+sumndst)+'/'+FloatToStr(sumndst)
  else                XL.Range['AD'+IntToStr(vy+7)]:=FLoatToStr(sumnds);
  }
  XL.Range['F'+IntToStr(vy+11)]:=UtilForm.SumNumToFull(Round(snds));
  XL.Range['H'+IntToStr(vy+13)]:=UtilForm.SumNumToFull(Round(sumtov+sumtara+sumnad+sumstk+snds-skida+(sumstk*bonus)+(sumstk*bonushran)));
  if massa>0 then XL.Range['G'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(massa,0))),',',1));
  if grmest>0 then XL.Range['AB'+IntToStr(vy+15)]:=UtilForm.MoneyToText(UtilForm.P(FloatToStr((SimpleRoundTo(grmest,0))),',',1));
  XL.Range['X'+IntToStr(vy+19)]:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE'+IntToStr(vy+19)]:=PRNZDovVyd.AsString;// выдана доверенность
  XL.Range['F'+IntToStr(vy+17)]:=PRNZOtpRazr.AsString; // отпуск разрешил
  XL.Range['H'+IntToStr(vy+19)]:=PRNZCdalOtp.AsString;// сдал грузоотправитель
  XL.Range['Z'+IntToStr(vy+21)]:=PRNZPrinPol.AsString;// принял грузополучатель
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+30)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
  if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['C'+IntToStr(vy+31)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+30)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+30)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
   FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
  if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(vy+31)]:=FormMain.VisM1.P2
  else XL.Range['F'+IntToStr(vy+31)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    if nomr=2 then
   begin
    XL.WorkBooks[1].Sheets[3].Activate;
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(12)]:=PRNZPogruzkaIsp.AsString;// исполнитель погрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrIsp"))');
   if FormMain.VisM1.P2<>'' then XL.Range['C'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['C'+IntToStr(13)]:=PRNZRazgrIsp.AsString;// исполнитель разгрузки
     FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","PogruzkaSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(12)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(12)]:=PRNZPogruzkaSpos.AsString;// способ погрузки
    FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormMain","RazgrSpos"))');
   if FormMain.VisM1.P2<>'' then XL.Range['F'+IntToStr(13)]:=FormMain.VisM1.P2
   else XL.Range['F'+IntToStr(13)]:=PRNZRazgrSpos.AsString;// способ разгрузки
    XL.WorkBooks[1].Sheets[2].Activate;
   end;
  FormMain.VisM1.P1:=Data.KPRNID.Value;
  FormMain.VisM1.Execute('s P2=+$LG(^KSU.FTXPRND(P1),25)');
  if FormMain.VisM1.P2<>0 then
   begin
    XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[2].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[3].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[4].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[5].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[6].Protect('AOM49fN');
    XL.WorkBooks[1].Sheets[7].Protect('AOM49fN');
    XL.visible:=true;
   end
  else
   begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      if nomr=1 then
       begin
        XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
       end
      else
       if nomr=2 then
        begin
         XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
        end
       else
        if nomr=3 then
         begin
          XL.WorkBooks[1].Sheets[4].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end
        else
         begin
          XL.WorkBooks[1].Sheets[6].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
         end;
      if nomr>1 then
       begin
        if MessageDlg('Вставьте обратную сторону бланка ТТН-1 с №'+nn,mtConfirmation,[mbYes,mbNo],0)=mrYes then
         begin
          if nomr=2 then
            begin
             XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
          else
           if nomr=3 then
            begin
             XL.WorkBooks[1].Sheets[5].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
            end
           else
            begin
             XL.WorkBooks[1].Sheets[7].PrintOut(1,1,kolnakl,EmptyParam,EmptyParam,EmptyParam,false);
           end;
         end;
       end;
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
   end;
End;

procedure TFormPrint.Rash_new;
var ns,kollist,nn,kodpl:Integer;
    padlist:String;
    orgpl: boolean;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, s P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if PRNSPrN.Value<>0 then
   begin
   ppReport1.DeviceType:=dtScreen;
   ppReport1.Print;
   end
  else
   begin
   ppReport1.PrinterSetup.Copies:=kolnakl;
   ppReport1.DeviceType:=dtPrinter;
   ppReport1.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');

// заголовок


  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;


  XL.Range['B20']:=PRNSDateN.Value;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;


//  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport1.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;


  // ----------------------------------------
// транспортные данные

  XL.Range['Q41']:=ppDBCalc13.Value-ppDBCalc12.Value;
  XL.Range['S41']:=ppDBCalc12.Value;
  XL.Range['V41']:=ppDBCalc13.Value;

  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc12.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc13.Value);

  // ------------------------ подвал
//  XL.Range['O39']:='';// оттиск
  XL.Range['AB48']:='';// количество мест прописью
  XL.Range['C48']:='';// груз массой брутто
  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
//  XL.Range['P52']:='';// оттиск
//  XL.Range['Z52']:='';// количество мест прописью
//  XL.Range['E54']:='';// груз массой брутто
//  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['Y52']:='№'+PRNZDovNom.Value+', от '+PRNZDovData.AsString;// №, дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z54']:=PRNZPrinPol.Value;// груз получил


  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');

  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;


end;

procedure TFormPrint.Prich7;
var copt,crozn,cskl,snds,sotpnds,nds,sroznnds,sskl,kol:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    ItogtorgTov,ItogtorgTara,ItogbothTov,ItogbothTara:Double;
    i, fixcena:Integer;
    SumBegin,SumNDS,nad,ItogsumbndsTov,ItogsumbndsTara:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,s1,s2:String;
begin
  nn:=PRNSNnak.Value;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;ItogsumbndsTov:=0;ItogsumbndsTara:=0;
  ItogtorgTov:=0;ItogtorgTara:=0;ItogbothTov:=0;ItogbothTara:=0;
  // 
  XL.WorkBooks.Add(ProgDir+'ПК-1_вторсырье.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;
  XL.Range['C16']:=PRNSDateN.AsString;
  XL.Range['C17']:=PRNSNnak.AsString;
  XL.Range['E17']:=PRNSDateN.AsString;

  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  FormMain.VisM2.Execute('s P7=$P($G(^SPD(P1)),":",6),P8=$P($G(^SPD(P1)),":",5)');
  XL.Range['A4']:=FormMain.VisM2.P4+', '+FormMain.VisM2.P7+', '+FormMain.VisM2.P8;
  //XL.Range['A5']:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  //XL.Range['A7']:='Мат.отв.лицо_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['E4']:=PRNSTpName.AsString+', '+PRNSTpAdres.AsString+', '+PRNSTpUNN.AsString; //FormMain.VisM2.P8;
  QPr.First;
  n:='21';
  for i:=1 to QPr.RecordCount do
   begin
     XL.Range['A'+n]:=QPrName.AsString;
     XL.Range['C'+n]:=QPrKol.AsString;
     ItKolTov:=ItKolTov+QPrKol.Value;
     XL.Range['D'+n]:=QPrPrice.AsString;
     XL.Range['E'+n]:=SimpleRoundTo(QPrKol.Value*QPrPrice.Value,-2);
     SumBegin:=SumBegin+SimpleRoundTo(QPrKol.Value*QPrPrice.Value,-2);
     XL.Range['F'+n]:=QPrNDS.AsString;
     XL.Range['G'+n]:=SimpleRoundTo(QPrKol.Value*QPrPrice.Value*QPrNDS.Value/100,-2);
     SumNDS:=SumNDS+SimpleRoundTo(QPrKol.Value*QPrPrice.Value*QPrNDS.Value/100,-2);
     XL.Range['H'+n]:=SimpleRoundTo(QPrKol.Value*QPrPrice.Value,-2)+SimpleRoundTo(QPrKol.Value*QPrPrice.Value*QPrNDS.Value/100,-2);
     ItsndsTov:=ItsndsTov+SimpleRoundTo(QPrKol.Value*QPrPrice.Value,-2)+SimpleRoundTo(QPrKol.Value*QPrPrice.Value*QPrNDS.Value/100,-2);
     n:=Incn(n);
     if n='38' then
     begin
       n:='3';
       XL.WorkBooks[1].Sheets[2].Activate;
     end;
     QPr.Next;
   end;
  QPr.Close;
  XL.WorkBooks[1].Sheets[2].Activate;
  XL.Range['C29']:=ItkolTov;
  XL.Range['E29']:=SimpleRoundTo(SumBegin,-2);
  XL.Range['G29']:=SimpleRoundTo(SumNDS,-2);
  XL.Range['H29']:=SimpleRoundTo(ItsndsTov,-2);

  XL.Range['H30']:=UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)));
  s1:='';
  s2:='';
  s1:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(ItKolTov),',',1))+' кг.';
  s2:=UtilForm.MoneyToText(UtilForm.P(FloatToStr(ItKolTov),',',2))+' гр.';
  XL.Range['C31']:=s1+s2; //UtilForm.MoneyToText(FloatToStr(ItKolTov));
  XL.visible:=true;
  //Защищаем листы накладной
  //XL.WorkBooks[1].Sheets[1].Protect(4654654);
  //XL.WorkBooks[1].Sheets[2].Protect(4654654);

end;

// На основе Prich1, добавлены поля: Норма отходов и сумма без отходов,
// сумма торговой надб.; использует ПН-6
procedure TFormPrint.Prich6;
var copt,crozn,cskl,snds,sotpnds,nds,sroznnds,sskl,kol:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    ItogtorgTov,ItogtorgTara,ItogbothTov,ItogbothTara:Double;
    i, fixcena:Integer;
    SumBegin,SumNDS,nad,ItogsumbndsTov,ItogsumbndsTara:Double;
    Tovar:Boolean;
    ns:Integer;
    osh:String;
begin
  nn:=PRNSNnak.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.tNaklPrint).MakePinRin(P1)');
  osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
  if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
  ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  qPrint.First;

  ppLabel289.Caption:=PRNSTpName.AsString;
  ppLabel288.Caption:=IntToStr(nn)+', от '+PRNSDateN.AsString;
  ReestrCen.DeviceType:=dtScreen;
  ReestrCen.Print;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;ItogsumbndsTov:=0;ItogsumbndsTara:=0;
  ItogtorgTov:=0;ItogtorgTara:=0;ItogbothTov:=0;ItogbothTara:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-6.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация_'+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель_'+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   XL.Range['A'+n]:=QPrNnt.Value;
   XL.Range['B'+n]:=QPrName.Value;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=QPrKol.Value;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*QPrKol.Value,-2);
   if fixcena>0 then
    XL.Range['F'+n]:=QPrSkid_1.Value
   else
    XL.Range['F'+n]:=QPrAddSuppl.Value;
   kol:=QPrKol.Value;
   case fixcena of
    0:begin
      copt:=QPrPrice.Value*(1+QprTrans.Value/100)*(1+QPrAddSuppl.Value/100);
      nds:=QPrNDS.Value;
      snds:=SimpleRoundTo(kol*copt*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*copt*(1+nds/100),-2);
      if QPrAddBuyer.Value<=100 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      {if QPrKodGr.Value=99 then
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),-2)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),-2)
      else
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),-2)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),-2);}
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=QPrKol.Value*cskl;
      end;
    1:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=QPrKol.Value*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/124,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=QPrKol.Value*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   XL.Range['G'+n]:=copt;
   XL.Range['H'+n]:=SimpleRoundTo(copt*kol,-2);
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end
   else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['M'+n]:=SimpleRoundTo(copt*QPrAddBuyer.Value/100*kol,-2);
   XL.Range['N'+n]:=sroznnds;
   XL.Range['O'+n]:=QPrNal.Value;
   XL.Range['P'+n]:=cskl;
   XL.Range['Q'+n]:=sskl;
   XL.Range['R'+n]:=QPrSkidV.Value;
   XL.Range['S'+n]:=SimpleRoundTo(sskl-(sskl*QPrSkidV.Value/100),-2);
   if Tovar then
    begin
    ItogbothTov:=ItogbothTov+SimpleRoundTo(sskl-(sskl*QPrSkidV.Value/100),-2);
    ItogtorgTov:=ItogtorgTov+SimpleRoundTo(copt*QPrAddBuyer.Value/100*kol,-2);
    ItogsumbndsTov:=ItogsumbndsTov+SimpleRoundTo(copt*kol,-2);
    ItKolTov:=ItKolTov+QPrKol.Value;
    ItsndsTov:=ItsndsTov+snds;
    ItsotpndsTov:=ItsotpndsTov+sotpnds;
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItogbothTara:=ItogbothTara+SimpleRoundTo(sskl-(sskl*QPrSkidV.Value/100),-2);
    ItogtorgTara:=ItogtorgTara+SimpleRoundTo(copt*QPrAddBuyer.Value/100*kol,-2);
    ItogsumbndsTara:=ItogsumbndsTara+SimpleRoundTo(copt*kol,-2);
    ItKolTara:=ItKolTara+QPrKol.Value;
    ItsndsTara:=ItsndsTara+snds;
    ItsotpndsTara:=ItsotpndsTara+sotpnds;
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы'+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    end;
   if Length(QPrDop.Value)>0 then
    begin
    n:=Incn(n);
    if Length(QPrDop.Value)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':P'+n].Merge;
    XL.Range['A'+n+':P'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTov,-2);
    XL.Range['E'+n]:=SimpleRoundTo(SumBegin,-2);
    XL.Range['H'+n]:=SimpleRoundTo(ItogsumbndsTov,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    XL.Range['M'+n]:=SimpleRoundTo(ItogtorgTov,-2);
    XL.Range['N'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;
    XL.Range['Q'+n]:=SimpleRoundTo(ItssklTov,-2);
    XL.Range['S'+n]:=SimpleRoundTo(ItogbothTov,-2);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTara,-2);
    XL.Range['H'+n]:=SimpleRoundTo(ItogsumbndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:=SimpleRoundTo(ItogtorgTara,-2);
    XL.Range['N'+n]:= SimpleRoundTo(ItsroznndsTara,0) ;
    XL.Range['Q'+n]:=SimpleRoundTo(ItssklTara,-2);
    XL.Range['S'+n]:=SimpleRoundTo(ItogbothTara,-2);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=SimpleRoundTo(ItKolTov,-2)+SimpleRoundTo(ItkolTara,-2);
    XL.Range['H'+n]:=SimpleRoundTo(ItogsumbndsTov,-2)+SimpleRoundTo(ItogsumbndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:=SimpleRoundTo(ItogtorgTov,-2)+SimpleRoundTo(ItogtorgTara,-2);
    XL.Range['N'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,0) ;
    XL.Range['Q'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    XL.Range['S'+n]:=SimpleRoundTo(ItogbothTov,-2)+SimpleRoundTo(ItogbothTara,-2);
    n:=Incn(n);
    end;
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2)))+'/';

  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['I'+n]:=ProvBSD.Value;
     XL.Range['J'+n]:=ProvBSDA.Value;
     XL.Range['L'+n]:=ProvBSK.Value;
     XL.Range['M'+n]:=ProvBSKA.Value;
     XL.Range['O'+n]:=ProvS.Value;
     n:=Incn(n);
     Prov.Next;
     end;
    end;
   end;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(4654654);

end;

procedure TFormPrint.Prich1;
var copt,crozn,cskl,snds,sotpnds, nds,sroznnds,sskl,kol,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,sumstr:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    VesGr,VesSk,SumSk:Double;
    i, fixcena:Integer;
    SumBegin,SumNDS,nad,ItTrans,prices,ost,sopt,itogsopttov,itogsopttara,itoggruz:Double;
    Tovar:Boolean;
    ns:Integer;
    osh:String;
begin
 // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;
 
  // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1, "FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      if FormMain.VisM1.P2=1 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end
      else
      if FormMain.VisM1.P2=3 then
      begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
      end;
    end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;ItTrans:=0;prices:=0;ost:=0;sopt:=0;itogsopttov:=0;itogsopttara:=0;itoggruz:=0;
  sumstr:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация_'+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель_'+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;
   kol:=QPrKol.Value;
   if QPrYbil.Value<>0 then
     kol:=QPrYbil.Value;
   kolopr:=kolopr+QPrKol.Value;

   XL.Range['A'+n]:=QPrNnt.Value;
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kol; ///QPrKol.Value;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kol,-2);
   if fixcena>0 then
    XL.Range['F'+n]:=QPrSkid_1.Value
   else
   begin
    if (QPrAddSuppl.Value>0)or((QPrKodGr.Value=93)or(QPrKodGr.Value=99)) then
      XL.Range['F'+n]:=QPrAddSuppl.Value
    else if PRNSSkidNakl.Value>0 then XL.Range['F'+n]:='-'+PRNSSkidNakl.AsString;
   end;

   case fixcena of
    0:begin
      if (PRNSSkidNakl.Value=0)or((QPrKodGr.Value=93)or(QPrKodGr.Value=99)) then
        prices:=QPrPrice.Value
      else prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*PRNSSkidNakl.Value/100),-2);
      copt:=prices*(1+QPrAddSuppl.Value/100); //*(1+QprTrans.Value/100)
      nds:=QPrNDS.Value;
      snds:=SimpleRoundTo(kol*copt*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*copt*(1+nds/100),-2);
      if QPrAddBuyer.Value<=100 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      if QPrKodGr.Value=99 then
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),0)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),0)
      else
      begin
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),1)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),1);
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       {if QPrSocialnost.Value=0 then
       begin
         ost:=frac(cskl/100)*100;
         if ost<25 then cskl:=trunc(cskl/100)*100
         else if (ost>=25)and(ost<75) then cskl:=(trunc(cskl/100)*100)+50
              else cskl:=(trunc(cskl/100)*100)+100;
       end
       else
       begin
         cskl:=trunc(cskl/10)*10;
       end;}
      end;
      sskl:=kol*cskl;
      end;
    1:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=kol*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/124,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=kol*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   XL.Range['G'+n]:=copt;
   XL.Range['H'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   XL.Range['I'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['J'+n]:=sotpnds;
   itoggruz:=itoggruz+QPrVes.Value;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['K'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['K'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['L'+n]:=crozn;
   XL.Range['M'+n]:=sroznnds;
   XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['O'+n]:=cskl;
   XL.Range['P'+n]:=sskl;
   n:=Incn(n);
   sopt:=SimpleRoundTo(copt*kol,-2);
   XL.Range['G'+n]:=sopt;

   if Tovar then
    begin
    ItKolTov:=ItKolTov+kol;
    ItsndsTov:=ItsndsTov+snds;
    ItsotpndsTov:=ItsotpndsTov+sotpnds;
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    itogsopttov:=itogsopttov+sopt;
    end
   else
    begin
    ItKolTara:=ItKolTara+kol;
    ItsndsTara:=ItsndsTara+snds;
    ItsotpndsTara:=ItsotpndsTara+sotpnds;
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    itogsopttara:=itogsopttara+sopt;
    end;

   if QprTrans.Value>0 then
    begin
///    n:=Incn(n);
    XL.Range['A'+n]:='Транс. расходы'+FloatToStr(QprTrans.Value)+'%'+
      '   '+FloatToStr(QPrPrice.Value*QprTrans.Value/100)+
      '   '+FloatToStr(QPrPrice.Value*(1+QprTrans.Value/100))+
      '   '+FloatToStr(SimpleRoundTo(QPrPrice.Value*(1+QprTrans.Value/100)*kol,-2));
    //XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    ItTrans:=ItTrans+(QPrPrice.Value*QprTrans.Value/100*kol);
    //XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    sumstr:=sumstr+SimpleRoundTo(QPrPrice.Value*(1+QprTrans.Value/100)*kol,-2);
    ///XL.Range['E'+n]:=SimpleRoundTo(QPrPrice.Value*(1+QprTrans.Value/100)*kol,-2);
    XL.Range['J'+n]:='Надбавка базы= '+FloatToStr(QPrAddBase.Value)+'%';
    end
    else sumstr:=sumstr+sopt;
    if (QPrAddBase.Value>0)and(QprTrans.Value=0) then
    begin
///     n:=Incn(n);
     XL.Range['J'+n]:='Надбавка базы= '+FloatToStr(QPrAddBase.Value)+'%';
    end;
    FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(QPrDop.Value)>0 then
    begin
    n:=Incn(n);
    if Length(QPrDop.Value)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':P'+n].Merge;
    XL.Range['A'+n+':P'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    VesSk:=RoundTo((kol*(QPrSkidV.AsFloat/100)),-2);
    VesGr:=kol+VesSk;
    FormMain.VisM1.P7:=SK;
    SumSk:=QPrPrice.Value*VesSk;
    FormMain.VisM1.Execute('s P8=+$G(^KSU.Option("FormFTXPRN",P7,"PrintDopVes"))');
    if (FormMain.VisM1.P8=1) and (QPrSkidV.Value>0)  then
    XL.Range['A'+n]:='/Общий вес='+FloatToStr(VesGr)+' '+'Скидка='+FloatToStr(VesSk)+'/ '+FormMain.VisM1.P2
    else
    XL.Range['A'+n]:=FormMain.VisM1.P2; ///QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTov,-2);
    XL.Range['E'+n]:=SimpleRoundTo(SumBegin,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2);
    XL.Range['G'+n]:=SimpleRoundTo(itogsopttov,-2);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTara,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTara,-2);
    XL.Range['G'+n]:=SimpleRoundTo(itogsopttara,-2);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=SimpleRoundTo(ItKolTov,-2)+SimpleRoundTo(ItkolTara,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    XL.Range['G'+n]:=SimpleRoundTo(itogsopttov,-2)+SimpleRoundTo(itogsopttara,-2);    
    n:=Incn(n);
    end;
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма с транспортными расходами:'+FloatToStr(SimpleRoundTo(sumstr,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(sumstr,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(UtilForm.P(FloatToStr(kolopr),',',1))+' и '+UtilForm.MoneyToText(UtilForm.P(FloatToStr(kolopr),',',2))+'/';
  end;
  if ItTrans>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма транспортных расходов: '+FloatToStr(SimpleRoundTo(ItTrans,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItTrans,-2)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2)))+'/';
  XL.Range['A'+FloatToStr(StrToFloat(n)+2)]:='Экономист по ценам';
  XL.Range['A'+FloatToStr(StrToFloat(n)+4)]:='Заведующий складом';
  XL.Range['A'+FloatToStr(StrToFloat(n)+6)]:='Товаровед';
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P2:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"PrintDop",P2))');
  if FormMain.VisM1.P3>0 then
  begin
   XL.Range['A'+FloatToStr(StrToFloat(n)+8)]:='Принял оператор ЭВМ';
   XL.Range['A'+FloatToStr(StrToFloat(n)+10)]:='Сдал бригадир';
   XL.Range['A'+FloatToStr(StrToFloat(n)+12)]:='Всего масса груза '+FloatToStr(itoggruz)+' кг';
  end;


  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    XL.Range['I'+FloatToStr(StrToFloat(n)-1)]:='Дебет';
    XL.Range['L'+FloatToStr(StrToFloat(n)-1)]:='Кредит';
    XL.Range['O'+FloatToStr(StrToFloat(n)-1)]:='Сумма';
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['I'+n]:=ProvBSD.Value;
     XL.Range['J'+n]:=ProvBSDA.Value;
     XL.Range['L'+n]:=ProvBSK.Value;
     XL.Range['M'+n]:=ProvBSKA.Value;
     XL.Range['O'+n]:=ProvS.Value;
     n:=Incn(n);
     Prov.Next;
     end;
    end;
   end;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(4654654);

end;

procedure TFormPrint.PrichProiz;
var copt,crozn,cskl,snds,sotpnds,nds,sroznnds,sskl,kol,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,sumstr:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i, fixcena:Integer;
    SumBegin,SumNDS,nad,ItTrans,prices,ost,sopt,itogsopttov,itogsopttara,itoggruz:Double;
    Tovar:Boolean;
    ns:Integer;
    osh:String;
begin
 // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;
 
  // Печать качественного удостоверения
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1, "FormKachYdo"))');
   if FormMain.VisM1.P2>0 then
    begin
      tky.Enter();
      FormKachYdo.PrintKY(Data.KPRNID.Value);
    end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;ItTrans:=0;prices:=0;ost:=0;sopt:=0;itogsopttov:=0;itogsopttara:=0;itoggruz:=0;
  sumstr:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  //XL.Range['A3']:='Организация_'+FormMain.VisM2.P4;
  //XL.Range['A5']:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  //XL.Range['A7']:='Мат.отв.лицо_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  //XL.Range['A9']:='Грузоотправитель_'+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;
   kol:=QPrKol.Value;
   if QPrYbil.Value<>0 then
     kol:=QPrYbil.Value;
   kolopr:=kolopr+QPrKol.Value;

   XL.Range['A'+n]:=QPrNnt.Value;
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kol; ///QPrKol.Value;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kol,-2);
   if fixcena>0 then
    XL.Range['F'+n]:=QPrSkid_1.Value
   else
   begin
    if (QPrAddSuppl.Value>0)or((QPrKodGr.Value=93)or(QPrKodGr.Value=99)) then
      XL.Range['F'+n]:=QPrAddSuppl.Value
    else if PRNSSkidNakl.Value>0 then XL.Range['F'+n]:='-'+PRNSSkidNakl.AsString;
   end;

   case fixcena of
    0:begin
      if (PRNSSkidNakl.Value=0)or((QPrKodGr.Value=93)or(QPrKodGr.Value=99)) then
        prices:=QPrPrice.Value
      else prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*PRNSSkidNakl.Value/100),-2);
      copt:=prices*(1+QPrAddSuppl.Value/100); //*(1+QprTrans.Value/100)
      nds:=QPrNDS.Value;
      snds:=SimpleRoundTo(kol*copt*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*copt*(1+nds/100),-2);
      if QPrAddBuyer.Value<=100 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      if QPrKodGr.Value=99 then
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),0)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),0)
      else
      begin
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),1)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),1);
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       {if QPrSocialnost.Value=0 then
       begin
         ost:=frac(cskl/100)*100;
         if ost<25 then cskl:=trunc(cskl/100)*100
         else if (ost>=25)and(ost<75) then cskl:=(trunc(cskl/100)*100)+50
              else cskl:=(trunc(cskl/100)*100)+100;
       end
       else
       begin
         cskl:=trunc(cskl/10)*10;
       end;}
      end;
      sskl:=kol*cskl;
      end;
    1:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=kol*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/124,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      //cskl:=FormMain.VisM1.P2;
      sskl:=kol*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   XL.Range['G'+n]:=copt;
   XL.Range['H'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   XL.Range['I'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['J'+n]:=sotpnds;
   itoggruz:=itoggruz+(QPrVes.Value*kol);
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['K'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['K'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['L'+n]:=crozn;
   XL.Range['M'+n]:=sroznnds;
   XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['O'+n]:=cskl;
   XL.Range['P'+n]:=sskl;
   n:=Incn(n);
   sopt:=SimpleRoundTo(copt*kol,-2);
   XL.Range['G'+n]:=sopt;

   if Tovar then
    begin
    ItKolTov:=ItKolTov+kol;
    ItsndsTov:=ItsndsTov+snds;
    ItsotpndsTov:=ItsotpndsTov+sotpnds;
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    itogsopttov:=itogsopttov+sopt;
    end
   else
    begin
    ItKolTara:=ItKolTara+kol;
    ItsndsTara:=ItsndsTara+snds;
    ItsotpndsTara:=ItsotpndsTara+sotpnds;
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    itogsopttara:=itogsopttara+sopt;
    end;

   if QprTrans.Value>0 then
    begin
///    n:=Incn(n);
    XL.Range['A'+n]:='Транс. расходы'+FloatToStr(QprTrans.Value)+'%'+
      '   '+FloatToStr(QPrPrice.Value*QprTrans.Value/100)+
      '   '+FloatToStr(QPrPrice.Value*(1+QprTrans.Value/100))+
      '   '+FloatToStr(SimpleRoundTo(QPrPrice.Value*(1+QprTrans.Value/100)*kol,-2));
    //XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    ItTrans:=ItTrans+(QPrPrice.Value*QprTrans.Value/100*kol);
    //XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    sumstr:=sumstr+SimpleRoundTo(QPrPrice.Value*(1+QprTrans.Value/100)*kol,-2);
    ///XL.Range['E'+n]:=SimpleRoundTo(QPrPrice.Value*(1+QprTrans.Value/100)*kol,-2);
    XL.Range['J'+n]:='Надбавка базы= '+FloatToStr(QPrAddBase.Value)+'%';
    end
    else sumstr:=sumstr+sopt;
    if (QPrAddBase.Value>0)and(QprTrans.Value=0) then
    begin
///     n:=Incn(n);
     XL.Range['J'+n]:='Надбавка базы= '+FloatToStr(QPrAddBase.Value)+'%';
    end;
    FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(QPrDop.Value)>0 then
    begin
    n:=Incn(n);
    if Length(QPrDop.Value)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':P'+n].Merge;
    XL.Range['A'+n+':P'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=FormMain.VisM1.P2; ///QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTov,-2);
    XL.Range['E'+n]:=SimpleRoundTo(SumBegin,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2);
    XL.Range['G'+n]:=SimpleRoundTo(itogsopttov,-2);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTara,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTara,-2);
    XL.Range['G'+n]:=SimpleRoundTo(itogsopttara,-2);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=SimpleRoundTo(ItKolTov,-2)+SimpleRoundTo(ItkolTara,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    XL.Range['G'+n]:=SimpleRoundTo(itogsopttov,-2)+SimpleRoundTo(itogsopttara,-2);    
    n:=Incn(n);
    end;
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма с транспортными расходами:'+FloatToStr(SimpleRoundTo(sumstr,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(sumstr,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(UtilForm.P(FloatToStr(kolopr),',',1))+' и '+UtilForm.MoneyToText(UtilForm.P(FloatToStr(kolopr),',',2))+'/';
  end;
  if ItTrans>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма транспортных расходов: '+FloatToStr(SimpleRoundTo(ItTrans,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItTrans,-2)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2)))+'/';
  XL.Range['A'+FloatToStr(StrToFloat(n)+3)]:='Экономист по ценам';
  XL.Range['A'+FloatToStr(StrToFloat(n)+4)]:='Заведующий складом';
  XL.Range['A'+FloatToStr(StrToFloat(n)+5)]:='Товаровед';


  XL.Range['A'+FloatToStr(StrToFloat(n)+7)]:='Организация_'+FormMain.VisM2.P4;
  XL.Range['A'+FloatToStr(StrToFloat(n)+8)]:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A'+FloatToStr(StrToFloat(n)+9)]:='Оператор ЭВМ_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A'+FloatToStr(StrToFloat(n)+10)]:='Бригадир_'+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;

  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.Execute('s P2="" if $D(^KSU.Option("FormFTXPRN",P1,"Print","DebetDop1")) {s P2=^KSU.Option("FormFTXPRN",P1,"Print","DebetDop1")}');
  FormMain.VisM1.Execute('s P3="" if $D(^KSU.Option("FormFTXPRN",P1,"Print","DebetDop2")) {s P3=^KSU.Option("FormFTXPRN",P1,"Print","DebetDop2")}');
  XL.Range['A'+FloatToStr(StrToFloat(n)+12)]:=FormMain.VisM1.P2;
  XL.Range['A'+FloatToStr(StrToFloat(n)+13)]:=FormMain.VisM1.P3;
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P2:=PRNSOperac.Value;
   XL.Range['A'+FloatToStr(StrToFloat(n)+1)]:='Всего масса груза: '+FloatToStr(itoggruz)+' кг';


  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['I'+n]:=ProvBSD.Value;
     XL.Range['J'+n]:=ProvBSDA.Value;
     XL.Range['L'+n]:=ProvBSK.Value;
     XL.Range['M'+n]:=ProvBSKA.Value;
     XL.Range['O'+n]:=ProvS.Value;
     n:=Incn(n);
     Prov.Next;
     end;
    end;
   end;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(4654654);

end;

procedure TFormPrint.PrichStol1;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i,j,vj, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin
  // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-Stol1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   XL.Range['F'+n]:=kolv*QPrPrice.Value;
   prices:=0;
   if fixcena=1 then
   begin
     prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     XL.Range['E'+n]:=prices;
     XL.Range['F'+n]:=kolv*prices;
   end;
   if fixcena>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value; //QPrAddBase.Value;
   kol:=kolv;
   case fixcena of
    0:begin
      if QPrVidnad.Value=1 then
       begin
       cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value;//+QPrAddBase.Value;
       end
      else
       begin
       cpost:=QPrPrice.Value*(1+QPrAddSuppl.Value/100);
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value{+QPrAddBase.Value})/100);
       //copt:=QPrPrice.Value*(1+(QPrAddSuppl.Value)/100);
       end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      snds:=SimpleRoundTo(kol*(copt-(QPrPrice.Value*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((copt-(QPrPrice.Value*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*QPrPrice.Value*QPrAddSuppl.Value/100,-2);
      if QPrVidnad.Value=1 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    1:begin
      ///copt:=QPrPrice.Value*(1+QPrTrans.Value);
      copt:=prices*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      ///sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      sotpnds:=SimpleRoundTo(kol*prices,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/100,-2);
      ///snds:=0;
      snds:=SimpleRoundTo(prices*kolv*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      //cskl:=FormMain.VisM1.P2;
      if not QPrBottle.IsNull then
      begin
        FormMain.VisM1.P1:=QPrBottle.Value;
        FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
        cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      copt:=QPrPrice.Value*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/124,-2);
      snds:=0;
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=copt;
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   //-if QPrAddBuyer.Value<=100 then
      //-begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    //XL.Range['L'+n]:=FloatToStr(nad)+'%';
    //-end

   //-else
    //XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   //XL.Range['M'+n]:=crozn;
   //XL.Range['M'+n]:=sroznnds;
   //XL.Range['N'+n]:=QPrNal.Value;
   //XL.Range['N'+n]:=cskl;
   //XL.Range['O'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if copt>0 then
    begin
    n:=Incn(n);
    //XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    //XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['H'+n]:=copt*kolv  ;
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':N'+n].Merge;
    XL.Range['A'+n+':K'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    //XL.Range['E'+n]:=FloatToStr(SimpleRoundTo(SumBegin,-2));
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    //XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;
    //if ItssklTov<>0 then
      //XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,-2) ;
    //if ItssklTara<>0 then
      //XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,0) ;
    //if (ItssklTov+ItssklTara)<>0 then
      //XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    //XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  //XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  //XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    //XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+IntToStr(StrToInt(n)-2)]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n))]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+1)]:='Заведующий складом';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Начальник производства';
  XL.Range['A'+IntToStr(StrToInt(n)+3)]:='Оператор';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['G'+n+':L'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['G'+n+':H'+n].Merge;
  XL.Range['G'+n].HorizontalAlignment:=xlCenter;
  XL.Range['G'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['G'+n]:='Дебет';
  XL.Range['I'+n+':J'+n].Merge;
  XL.Range['I'+n].HorizontalAlignment:=xlCenter;
  XL.Range['I'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['I'+n]:='Кредит';
  XL.Range['K'+n+':L'+n].Merge;
  XL.Range['K'+n].HorizontalAlignment:=xlCenter;
  XL.Range['K'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['L'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['K'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
 { FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
   FormMain.VisM1.P1:=FormMain.VisM1.P7;}
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['G'+n+':L'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['H'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['J'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['L'+n].Borders[xlEdgeRight].LineStyle:=1;
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['G'+IntToStr(i)].NumberFormat:='@';
    XL.Range['G'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['I'+IntToStr(i)].NumberFormat:='@';
    XL.Range['I'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['K'+n+':L'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['K'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['K'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['K'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;

 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;

procedure TFormPrint.PrichStol2;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsotpndsStekl,ItsroznndsTara,ItssklTara:Double;
    i,j,vj:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices,pervcena:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItsotpndsStekl:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-Stol2.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
   if QPrPriceOpt.Value>0 then pervcena:=QPrPriceOpt.Value
   else pervcena:=QPrPrice.Value;
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   XL.Rows[n].Rowheight:=15;
   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   //if QPrPriceOpt.Value>0 then XL.Range['E'+n]:=QPrPriceOpt.Value
   //else
   XL.Range['E'+n]:=pervcena;
   SumBegin:=SumBegin+SimpleRoundTo(pervcena*kolv,-2);
   //if QPrPriceOpt.Value>0 then
   //begin
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(pervcena*kolv,-2);
   //end
   //else
   //begin
   //if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   //end;
   //if QPrPriceOpt.Value>0 then
   //begin
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(pervcena*kolv,-2);
   //end
   //else
   //begin
   //if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   //end;
   //if QPrPriceOpt.Value>0 then
   //begin
   if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SimpleRoundTo(pervcena*kolv,-2);
   //end
   //else
   //begin
   //if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   //end;
   //if QPrPriceOpt.Value>0 then XL.Range['F'+n]:=kolv*QPrPriceOpt.Value
   //else
   XL.Range['F'+n]:=kolv*pervcena;
   prices:=0;
   //if fixcena=1 then
   //begin
     //prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     //XL.Range['E'+n]:=prices;
     //XL.Range['F'+n]:=kolv*prices;
   //end;
   if QPrSkid.Value>0 then
    XL.Range['G'+n]:=QPrSkid.Value
   else
   if QPrSkid_1.Value>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value;
   kol:=kolv;
   //case fixcena of
    //0:begin
      //if QPrVidnad.Value=1 then
       //begin
       //cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       //copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value*(1-QPrSkid_1.Value/100);//+QPrAddBase.Value;
       //end
      //else
       //begin
       cpost:=pervcena*(1+QPrAddSuppl.Value/100);
       if QPrSkid.Value>0 then
       copt:=SimpleRoundTo(pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100)*(1-QPrSkid.Value/100),-2)
       else
       if QPrSkid_1.Value>0 then
       copt:=SimpleRoundTo(pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100)*(1-QPrSkid_1.Value/100),-2)
       else
       copt:=SimpleRoundTo(pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100),-2);
       //end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      if QPrSkid.Value>0 then SumSkid:=SumSkid+SimpleRoundTo(kol*pervcena*QPrSkid.Value/100,-2)
       else SumSkid:=SumSkid+SimpleRoundTo(kol*pervcena*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo(kol*(copt-(pervcena*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((copt-(pervcena*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*pervcena*QPrAddSuppl.Value/100,-2);
      //if QPrVidnad.Value=1 then
       //crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      //else
       crozn:=pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
       FormMain.VisM1.P1:=QPrNnt.Value;
       if (QPrNadT.Value>0) then
        begin
         FormMain.VisM1.P4:=QPrNad.Value;
         FormMain.VisM1.P5:=QPrNadT.Value;
         FormMain.VisM1.P6:=QPrAddSuppl.Value;
         FormMain.VisM1.P7:=QPrTrans.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaZmod($TR(P4,",","."),$TR(P5,",","."),$TR(P6,",","."),$TR(P7,",","."),P1)');
         cskl:=FormMain.VisM1.P2;
        end
       else
        begin
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=StrToFloat(PointToComa(FormMain.VisM1.P2));
        end;
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      sskl:=kolv*cskl;
      //end;
    //1:begin

      //end;
    //2:begin

      //end;
   //end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   //if QPrPriceOpt.Value>0 then XL.Range['H'+n]:=QPrPriceOpt.Value
   //else
   XL.Range['H'+n]:=copt;
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   //if QPrPriceOpt.Value>0 then XL.Range['J'+n]:=SimpleRoundTo(QPrPriceOpt.Value*kolv*nds/100,0)
   //else
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   //if QPrPriceOpt.Value>0 then XL.Range['K'+n]:=(QPrPriceOpt.Value*kolv)+(SimpleRoundTo(QPrPriceOpt.Value*kolv*nds/100,-2))
   //else
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    if (QPrNadT.Value>0) then nad:=QPrNadT.Value+QPrNad.Value
    else nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end

   else
    if QPrNadT.Value>0 then XL.Range['L'+n]:=QPrNadT.Value else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   if ((QPrNadT.Value>0) and (QPrNad.Value>0)) then XL.Range['M'+n]:=QPrNad.Value else
   XL.Range['M'+n]:=QPrAddBase.Value;
   //if QPrPriceOpt.Value>0 then XL.Range['N'+n]:=QPrPriceOpt.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)
   //else
   if QPrPriceOpt.Value>0 then
   begin
   XL.Range['O15']:='';
   XL.Range['N15']:='';
   end
   else
   begin
   XL.Range['N'+n]:=cskl;
   //if QPrPriceOpt.Value>0 then XL.Range['N'+n]:=0;
   //if QPrPriceOpt.Value>0 then XL.Columns('N:N').ColumnWidth:=0;
   //if QPrPriceOpt.Value>0 then XL.Range['O'+n]:=(QPrPriceOpt.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100))*kolv
   //else
   XL.Range['O'+n]:=sskl;
   //if QPrPriceOpt.Value>0 then XL.Range['O'+n]:=0;
   //if QPrPriceOpt.Value>0 then XL.Columns('O:O').ColumnWidth:=0;
   end;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=pervcena*QprTrans.Value/100;
    XL.Range['E'+n]:=pervcena*(1+QprTrans.Value/100)  ;
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    if ItssklTov<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Стеклопосуда: '+FloatToStr(SimpleRoundTo(ItsotpndsStekl,-2));
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad,-2)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2)))+'/'; //'Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;

procedure TFormPrint.PrichStol2cena;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsotpndsStekl,ItsroznndsTara,ItssklTara:Double;
    i,j,vj:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices,pervcena:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItsotpndsStekl:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-Stol2cena.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
   if QPrPriceOpt.Value>0 then pervcena:=QPrPriceOpt.Value
   else pervcena:=QPrPrice.Value;
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   XL.Rows[n].Rowheight:=15;
   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   XL.Range['E'+n]:=pervcena;
   SumBegin:=SumBegin+SimpleRoundTo(pervcena*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(pervcena*kolv,-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(pervcena*kolv,-2);
   if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SimpleRoundTo(pervcena*kolv,-2);
   XL.Range['F'+n]:=kolv*pervcena;
   prices:=0;
   if QPrSkid_1.Value>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value;
   kol:=kolv;
       cpost:=pervcena*(1+QPrAddSuppl.Value/100);
       if QPrSkid_1.Value>0 then
       {copt:=pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100)*(1-QPrSkid_1.Value/100)
       else
       copt:=pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100);}

      copt:=SimpleRoundTo(pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100)*(1-QPrSkid_1.Value/100),-2)
      else
      copt:=SimpleRoundTo(pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100),-2);

      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*pervcena*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo(kol*(copt-(pervcena*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((copt-(pervcena*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*pervcena*QPrAddSuppl.Value/100,-2);
       crozn:=pervcena*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
       FormMain.VisM1.P1:=QPrNnt.Value;
       if (QPrNadT.Value>0) then
        begin
         FormMain.VisM1.P4:=QPrNad.Value;
         FormMain.VisM1.P5:=QPrNadT.Value;
         FormMain.VisM1.P6:=QPrAddSuppl.Value;
         FormMain.VisM1.P7:=QPrTrans.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaZmod(P4,P5,P6,P7,P1)');
         cskl:=FormMain.VisM1.P2;
        end
       else
        begin
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         //cskl:=FormMain.VisM1.P2;
         cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end;
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         //cskl:=cskl+FormMain.VisM1.P2;
         cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      sskl:=kolv*cskl;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=copt;
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    if (QPrNadT.Value>0) then nad:=QPrNadT.Value+QPrNad.Value
    else nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end

   else
    if QPrNadT.Value>0 then XL.Range['L'+n]:=QPrNadT.Value else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   if ((QPrNadT.Value>0) and (QPrNad.Value>0)) then XL.Range['M'+n]:=QPrNad.Value else
   XL.Range['M'+n]:=QPrAddBase.Value;
   if QPrPriceOpt.Value>0 then
   begin
   XL.Range['O15']:='';
   XL.Range['N15']:='';
   end
   else
   begin
   XL.Range['N'+n]:=cskl;
   XL.Range['O'+n]:=sskl;
   end;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=pervcena*QprTrans.Value/100;
    XL.Range['E'+n]:=pervcena*(1+QprTrans.Value/100)  ;
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Стеклопосуда: '+FloatToStr(SimpleRoundTo(ItsotpndsStekl,-2));
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2)))+'/'; //'Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;


procedure TFormPrint.PrichStol4;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsotpndsStekl,ItsroznndsTara,ItssklTara:Double;
    i,j,vj, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin
  // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItsotpndsStekl:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-Stol4.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   XL.Range['E'+n]:=QPrPrice.Value;//*(100+(QPrSkid_1.Value/100));
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   XL.Range['F'+n]:=kolv*QPrPrice.Value;
   prices:=0;
   if fixcena=1 then
   begin
     prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     XL.Range['E'+n]:=prices;
     XL.Range['F'+n]:=kolv*prices;
   end;
   if QPrSkid_1.Value>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value; //QPrAddBase.Value;
   kol:=kolv;
   case fixcena of
    0:begin
      if QPrVidnad.Value=1 then
       begin
       cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value*(1-QPrSkid_1.Value/100);//+QPrAddBase.Value;
       end
      else
       begin
       cpost:=QPrPrice.Value*(1+QPrAddSuppl.Value/100);
       if QPrSkid_1.Value>0 then
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value{+QPrAddBase.Value})/100)*(1-QPrSkid_1.Value/100)
       else
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100);
       end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo(kol*(SimpleRoundTo(copt*(1+(QPrAddBase.Value/100)),-2)-(QPrPrice.Value*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((SimpleRoundTo(copt*(1+(QPrAddBase.Value/100)),-2)-(QPrPrice.Value*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*QPrPrice.Value*QPrAddSuppl.Value/100,-2);
      if QPrVidnad.Value=1 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);

      {if QPrKodGr.Value=99 then
       if QPrVidnad.Value=1 then
        cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+(nds/100))
       else
        cskl:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+(nds/100))
      else
       if QPrVidnad.Value=1 then
        cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+(nds/100))
       else
        cskl:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+(nds/100));
 }
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
         {FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
         if FormMain.Vism1.P2<>'0' then
         begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
         end}
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        //ItsotpndsStekl:=ItsotpndsStekl+ItsotpndsTov;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    1:begin
      ///copt:=QPrPrice.Value*(1+QPrTrans.Value);
      copt:=prices*(1+QPrTrans.Value)*(1-QPrSkid_1.Value/100);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      ///sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      sotpnds:=SimpleRoundTo(kol*prices,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/100,-2);
      ///snds:=0;
      snds:=SimpleRoundTo(prices*kolv*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
      begin
        FormMain.VisM1.P1:=QPrBottle.Value;
        FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
        cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      copt:=QPrPrice.Value*(1+QPrTrans.Value)*(1-QPrSkid_1.Value/100);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/124,-2);
      snds:=0;
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
       end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=SimpleRoundTo(copt*(1+(QPrAddBase.Value/100)),-2);
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['M'+n]:=QPrAddBase.Value;
   //XL.Range['M'+n]:=sroznnds;
   //XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['N'+n]:=cskl;
   XL.Range['O'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    //if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SumBeginTov;
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':N'+n].Merge;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    //XL.Range['E'+n]:=FloatToStr(SimpleRoundTo(SumBegin,-2));
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    //XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;
    if ItssklTov<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,0) ;
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,-2) ;
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Стеклопосуда: '+FloatToStr(SimpleRoundTo(ItsotpndsStekl,-2));
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2)))+'/'; //'Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
 { FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
   FormMain.VisM1.P1:=FormMain.VisM1.P7;}
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;

{
  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    XL.Range['H'+n+':N'+n].Select;
    XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
    XL.Range['H'+n+':I'+n].Merge;
    XL.Range['H'+n].HorizontalAlignment:=xlCenter;
    XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
    XL.Range['H'+n]:='Дебет';
    XL.Range['J'+n+':L'+n].Merge;
    XL.Range['J'+n].HorizontalAlignment:=xlCenter;
    XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
    XL.Range['J'+n]:='Кредит';
    XL.Range['M'+n+':N'+n].Merge;
    XL.Range['M'+n].HorizontalAlignment:=xlCenter;
    XL.Range['M'+n].Borders[xlEdgeLeft].LineStyle:=1;
    XL.Range['N'+n].Borders[xlEdgeRight].LineStyle:=1;
    XL.Range['M'+n]:='Сумма';
    n:=Incn(n);
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['H'+n+':N'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['H'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+n]:=ProvBSD.Value;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['I'+n]:=ProvBSDA.Value;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n]:=ProvBSK.Value;
     XL.Range['L'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['L'+n]:=ProvBSKA.Value;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n]:=ProvS.Value;
     XL.Range['N'+n].Borders[xlEdgeRight].LineStyle:=1;
     if provST.Value<>0 then  XL.Range['N'+n]:=provST.Value;
     n:=Incn(n);
     Prov.Next;
     end;

    end;
   end;}
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;





procedure TFormPrint.PrichStol3;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsotpndsStekl,ItsroznndsTara,ItssklTara:Double;
    i,j,vj, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin
  // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItsotpndsStekl:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-Stol2.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   XL.Range['E'+n]:=QPrPrice.Value*(1+(QPrAddBase.Value/100));
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*(1+(QPrAddBase.Value/100)),-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   XL.Range['F'+n]:=SimpleRoundTo(kolv*(QPrPrice.Value*(1+(QPrAddBase.Value/100))),-2);
   prices:=0;
   if fixcena=1 then
   begin
     prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     XL.Range['E'+n]:=prices;
     XL.Range['F'+n]:=kolv*prices;
   end;
   if QPrSkid_1.Value>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value; //QPrAddBase.Value;
   kol:=kolv;
   case fixcena of
    0:begin
      if QPrVidnad.Value=1 then
       begin
       cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value*(1-QPrSkid_1.Value/100);//+QPrAddBase.Value;
       end
      else
       begin
       cpost:=QPrPrice.Value*(1+QPrAddSuppl.Value/100);
       if QPrSkid_1.Value>0 then
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value{+QPrAddBase.Value})/100)*(1-QPrSkid_1.Value/100)
       else
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100);
       end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo((QPrPrice.Value*(1+(QPrAddBase.Value/100))*nds/100),-2);
      sotpnds:=SimpleRoundTo((kol*(QPrPrice.Value*(1+(QPrAddBase.Value/100)))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*QPrPrice.Value*QPrAddSuppl.Value/100,-2);
      if QPrVidnad.Value=1 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);

      {if QPrKodGr.Value=99 then
       if QPrVidnad.Value=1 then
        cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+(nds/100))
       else
        cskl:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+(nds/100))
      else
       if QPrVidnad.Value=1 then
        cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+(nds/100))
       else
        cskl:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+(nds/100));
 }
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
         {FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
         if FormMain.Vism1.P2<>'0' then
         begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
         end}
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        //ItsotpndsStekl:=ItsotpndsStekl+ItsotpndsTov;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    1:begin
      ///copt:=QPrPrice.Value*(1+QPrTrans.Value);
      copt:=prices*(1+QPrTrans.Value)*(1-QPrSkid_1.Value/100);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      ///sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      sotpnds:=SimpleRoundTo(kol*prices,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/100,-2);
      ///snds:=0;
      snds:=SimpleRoundTo(prices*kolv*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
      begin
        FormMain.VisM1.P1:=QPrBottle.Value;
        FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
        cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      copt:=QPrPrice.Value*(1+QPrTrans.Value)*(1-QPrSkid_1.Value/100);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/124,-2);
      snds:=0;
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
       end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=copt;
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['M'+n]:=QPrAddBase.Value;
   //XL.Range['M'+n]:=sroznnds;
   //XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['N'+n]:=cskl;
   XL.Range['O'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    //if QPrKodGr.Value=93 then ItsotpndsStekl:=ItsotpndsStekl+SumBeginTov;
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':N'+n].Merge;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    //XL.Range['E'+n]:=FloatToStr(SimpleRoundTo(SumBegin,-2));
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    //XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,0) ;
    if ItssklTov<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,0) ;
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,0) ;
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Стеклопосуда: '+FloatToStr(SimpleRoundTo(ItsotpndsStekl,-2));
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo((ItsotpndsTov+ItsotpndsTara),-2)))+'/'; //'Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
 { FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
   FormMain.VisM1.P1:=FormMain.VisM1.P7;}
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;
  XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;

procedure TFormPrint.Prich4Ivac;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i,j,vj, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin
  // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-4.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   //XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   //XL.Range['F'+n]:=kolv*QPrPrice.Value;
   prices:=0;
   if fixcena=1 then
   begin
     prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     XL.Range['E'+n]:=prices;
     XL.Range['F'+n]:=kolv*prices;
   end;
   if fixcena>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value; //QPrAddBase.Value;
   kol:=kolv;
   case fixcena of
    0:begin
      if QPrVidnad.Value=1 then
       begin
       cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value;//+QPrAddBase.Value;
       end
      else
       begin
       cpost:=QPrPrice.Value*(1+QPrAddSuppl.Value/100);
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value{+QPrAddBase.Value})/100);
       end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      snds:=SimpleRoundTo(kol*(copt-(QPrPrice.Value*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((copt-(QPrPrice.Value*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*QPrPrice.Value*QPrAddSuppl.Value/100,-2);
      if QPrVidnad.Value=1 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);

      {if QPrKodGr.Value=99 then
       if QPrVidnad.Value=1 then
        cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+(nds/100))
       else
        cskl:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+(nds/100))
      else
       if QPrVidnad.Value=1 then
        cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+(nds/100))
       else
        cskl:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+(nds/100));
 }
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
         {FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
         if FormMain.Vism1.P2<>'0' then
         begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
         end}
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    1:begin
      ///copt:=QPrPrice.Value*(1+QPrTrans.Value);
      copt:=prices*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      ///sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      sotpnds:=SimpleRoundTo(kol*prices,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/100,-2);
      ///snds:=0;
      snds:=SimpleRoundTo(prices*kolv*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
      begin
        FormMain.VisM1.P1:=QPrBottle.Value;
        FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
        cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      copt:=QPrPrice.Value*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/124,-2);
      snds:=0;
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       {FormMain.VisM1.P1:=QPrBottle.Value;
       FormMain.VisM1.Execute('s P2=+$LG(^KSU.STMCD(+P1),11), P3=+$LG(^KSU.STMCD(+P1),15)');
       if FormMain.Vism1.P2<>'0' then
       begin
           if FormMain.Vism1.P3<>'0' then
                cskl:=cskl+SimpleRoundTo(FormMain.Vism1.P2*(1+(FormMain.Vism1.P3/100)),1)
           else cskl:=cskl+FormMain.Vism1.P2;
       end}
       end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=copt;
   XL.Range['E'+n]:=copt;
   XL.Range['F'+n]:=kolv*copt;



   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['M'+n]:=crozn;
   //XL.Range['M'+n]:=sroznnds;
   //XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['N'+n]:=cskl;
   XL.Range['O'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   {if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    end;}
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':N'+n].Merge;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    //XL.Range['E'+n]:=FloatToStr(SimpleRoundTo(SumBegin,-2));
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    //XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;     ////// qqqqqqqqqqqqqq
    if ItssklTov<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,0) ;
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,0) ;
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
 { FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
   FormMain.VisM1.P1:=FormMain.VisM1.P7;}
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;

procedure TFormPrint.Prich4;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i,j,vj, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin
  // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-4.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   XL.Range['F'+n]:=kolv*QPrPrice.Value;
   prices:=0;
   if fixcena=1 then
   begin
     prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     XL.Range['E'+n]:=prices;
     XL.Range['F'+n]:=kolv*prices;
   end;
   if fixcena>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value; //QPrAddBase.Value;
   kol:=kolv;
   case fixcena of
    0:begin
      if QPrVidnad.Value=1 then
       begin
       cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value;//+QPrAddBase.Value;
       end
      else
       begin
       cpost:=QPrPrice.Value*(1+QPrAddSuppl.Value/100);
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value{+QPrAddBase.Value})/100);
       end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      snds:=SimpleRoundTo(kol*(copt-(QPrPrice.Value*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((copt-(QPrPrice.Value*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*QPrPrice.Value*QPrAddSuppl.Value/100,-2);
      if QPrVidnad.Value=1 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       cskl:=StrToFloat(PointtoComa(FormMain.VisM1.P2));
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    1:begin
      ///copt:=QPrPrice.Value*(1+QPrTrans.Value);
      copt:=prices*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      ///sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      sotpnds:=SimpleRoundTo(kol*prices,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/100,-2);
      ///snds:=0;
      snds:=SimpleRoundTo(prices*kolv*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
      begin
        FormMain.VisM1.P1:=QPrBottle.Value;
        FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
        cskl:=cskl+FormMain.VisM1.P2;
      end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      copt:=QPrPrice.Value*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      //snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/124,-2);
      snds:=0;
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=crozn*(1+QPrNal.Value/100);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       end;
      //cskl:=SimpleRoundTo(cskl,1);
      sskl:=kolv*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=copt;
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['M'+n]:=crozn;
   //XL.Range['M'+n]:=sroznnds;
   //XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['N'+n]:=SimpleRoundTo(cskl,-2);
   XL.Range['O'+n]:=SimpleRoundTo(sskl,-2);
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100);
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':N'+n].Merge;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    //XL.Range['E'+n]:=FloatToStr(SimpleRoundTo(SumBegin,-2));
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    //XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,0) ;
    if ItssklTov<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,0) ;
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    //XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,0) ;
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
 { FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
   FormMain.VisM1.P1:=FormMain.VisM1.P7;}
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;

{
  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    XL.Range['H'+n+':N'+n].Select;
    XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
    XL.Range['H'+n+':I'+n].Merge;
    XL.Range['H'+n].HorizontalAlignment:=xlCenter;
    XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
    XL.Range['H'+n]:='Дебет';
    XL.Range['J'+n+':L'+n].Merge;
    XL.Range['J'+n].HorizontalAlignment:=xlCenter;
    XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
    XL.Range['J'+n]:='Кредит';
    XL.Range['M'+n+':N'+n].Merge;
    XL.Range['M'+n].HorizontalAlignment:=xlCenter;
    XL.Range['M'+n].Borders[xlEdgeLeft].LineStyle:=1;
    XL.Range['N'+n].Borders[xlEdgeRight].LineStyle:=1;
    XL.Range['M'+n]:='Сумма';
    n:=Incn(n);
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['H'+n+':N'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['H'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+n]:=ProvBSD.Value;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['I'+n]:=ProvBSDA.Value;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n]:=ProvBSK.Value;
     XL.Range['L'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['L'+n]:=ProvBSKA.Value;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n]:=ProvS.Value;
     XL.Range['N'+n].Borders[xlEdgeRight].LineStyle:=1;
     if provST.Value<>0 then  XL.Range['N'+n]:=provST.Value;
     n:=Incn(n);
     Prov.Next;
     end;

    end;
   end;}
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;

procedure TFormPrint.Prich8;
var copt,cpost,crozn,cskl,snds,sotpnds,spost,nds,sroznnds,sskl,kol,kolv,kolopr:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov,itspost:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i,j,vj, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,SumNad,stov,SumBeginTov,SumBeginTara,prices:Double;
    Tovar:Boolean;
    ns:Integer;
    osh,provka,provki:String;
begin
  // Печать реестра цен
 FormMain.VisM1.P1:=SK;
 FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"ReestrPrint"))');
 if FormMain.VisM1.P2=1 then
 begin
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).PrePrint(P1), P3=$P(P2,":",1)');
  ns:=StrToInt(FormMain.VisM1.P3);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  ppReestrCen.DeviceType:=dtScreen;
  ppReestrCen.Print;
 end;

  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;itspost:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumBeginTov:=0;SumBeginTara:=0;SumNad:=0;kolv:=0;kolopr:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-4БШ.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  if PRNSTpPr.Value=1 then
  begin
   FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
   XL.Range['A10']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  end;
  QPr.First;
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;
   XL.Rows[n].Rowheight:=15;
   if QPrYbil.Value<>0 then
   begin
     kolv:=QPrYbil.Value;
     kolopr:=kolopr+QPrKol.Value;
   end
   else kolv:=QPrKol.Value;
   if QPrSocialnost.Value=0 then XL.Range['A'+n]:=QPrNnt.Value
   else XL.Range['A'+n]:=QPrNnt.AsString+'*';
   XL.Range['B'+n]:=QPrName.Value;
   //XL.Rows[n].Autofit;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=kolv;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value<>99 then SumBeginTov:=SumBeginTov+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   if QPrKodGr.Value=99 then SumBeginTara:=SumBeginTara+SimpleRoundTo(QPrPrice.Value*kolv,-2);
   XL.Range['F'+n]:=kolv*QPrPrice.Value;
   prices:=0;
   if fixcena=1 then
   begin
     prices:=SimpleRoundTo(QPrPrice.Value-(QPrPrice.Value*QPrSkid_1.Value/100),-2);
     XL.Range['E'+n]:=prices;
     XL.Range['F'+n]:=kolv*prices;
   end;
   if fixcena>0 then
    XL.Range['G'+n]:=QPrSkid_1.Value
   else
    XL.Range['G'+n]:=QPrAddSuppl.Value;
   kol:=kolv;
   case fixcena of
    0:begin
      if QPrVidnad.Value=1 then
       begin
       cpost:=QPrPrice.Value+QPrAddSuppl.Value;
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value;
       end
      else
       begin
       cpost:=QPrPrice.Value*(1+QPrAddSuppl.Value/100);
       copt:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100);
       end;
      nds:=QPrNDS.Value;
      spost:=SimpleRoundTo(cpost*kol*(1+nds/100),-2);
      snds:=SimpleRoundTo(kol*(copt-(QPrPrice.Value*QPrTrans.Value/100))*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*((copt-(QPrPrice.Value*QPrTrans.Value/100))*(1+nds/100)),-2);
      SumNad:=SumNad+SimpleRoundTo(kol*QPrPrice.Value*QPrAddSuppl.Value/100,-2);
      if QPrVidnad.Value=1 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100);
       sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       end;
      if QPrKodGr.Value=93 then
      begin
        FormMain.VisM1.P1:=QPrIDdoc.Value;
        FormMain.VisM1.P2:=QPrNnt.Value;
        FormMain.VisM1.Execute('s P3=##Class(KSU.FTXPRNT).ProvNntByt(P1,P2)');
        if FormMain.VisM1.P3='' then
        begin
          FormMain.VisM1.P1:=QPrNnt.Value;
          FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
          //cskl:=FormMain.VisM1.P2;
          cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
        end
        else cskl:=0;
      end;
      sskl:=kolv*cskl;
      end;
    1:begin
      copt:=prices*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*prices,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo(prices*kolv*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
      begin
        FormMain.VisM1.P1:=QPrBottle.Value;
        FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
        cskl:=cskl+FormMain.VisM1.P2;
      end;
      sskl:=kolv*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      copt:=QPrPrice.Value*(1+QPrTrans.Value);
      cpost:=QPrPrice.Value*(1-QPrSkid_1.Value/100);
      spost:=SimpleRoundTo(cpost*kol,-2);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      snds:=0;
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      if not QPrBottle.IsNull then
       begin
         FormMain.VisM1.P1:=QPrBottle.Value;
         FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
         cskl:=cskl+FormMain.VisM1.P2;
       end;
      sskl:=kolv*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   itspost:=itspost+spost;
   XL.Range['H'+n]:=copt;
   XL.Range['I'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   if snds<>0 then
   XL.Range['J'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['K'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value+QPrAddBase.Value;
    XL.Range['L'+n]:=FloatToStr(nad)+'%';
    end
   else
    XL.Range['L'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['M'+n]:=crozn;
   XL.Range['N'+n]:=cskl;
   XL.Range['O'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+kolv;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+kolv;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
    XL.Rows[n].Rowheight:=15;
    XL.Range['A'+n+':O'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=QPrDop.Value;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    if ItsndsTov<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2);
    if ItsotpndsTov<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    if ItssklTov<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2);
    if SumBeginTov<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTov);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    if ItsndsTara<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTara,-2);
    if ItsotpndsTara<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    if ItssklTara<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTara,-2);
    if SumBeginTara<>0 then
      XL.Range['F'+n]:=FloatToStr(SumBeginTara);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    if (ItsndsTov+ItsndsTara)<>0 then
      XL.Range['J'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    if (ItsotpndsTov+ItsotpndsTara)<>0 then
      XL.Range['K'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    if (ItssklTov+ItssklTara)<>0 then
      XL.Range['O'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    if (SumBeginTov+SumBeginTara)<>0 then
      XL.Range['F'+n]:=FloatToStr(SimpleRoundTo(SumBeginTov,-2)+SimpleRoundTo(SumBeginTara,-2));
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='* - социальнозначимый товар';
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  if kolopr<>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Количество оприходованное на склад: '+FloatToStr(kolopr)+' / '+UtilForm.MoneyToText(FloatToStr(kolopr))+'/';
  end;
  if SumNad>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Сумма надбавки поставщика: '+FloatToStr(SimpleRoundTo(SumNad))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumNad)))+'/';
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  if  PRNSTransp.Value>0 then
  begin
    n:=Incn(n);
    XL.Range['A'+n]:='Транспортные расходы: '+PRNSTransp.AsString;
    itspost:=itspost+SimpleRoundTo(PRNSTransp.Value*1.2,-2);
  end;
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(itspost,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(itspost,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['G'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['G'+n+':I'+n].Merge;
  XL.Range['G'+n].HorizontalAlignment:=xlCenter;
  XL.Range['G'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['G'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';

  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['G'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    XL.Range['L'+n+':M'+n].Merge;
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
  // Печать зеркальных проводок
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
  begin
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
   FormMain.VisM1.P2:=PRNSID.Value;
   FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
   osh:=FormMain.VisM1.P4;
   if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
   else  provki:=FormMain.VisM1.P3;
   n:=Incn(n);
   i:=StrToInt(Incn(n));
   j:=1;
   provka:=UtilForm.P(provki,'!',j);
   while provka<>'' do
   begin
    if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
    then begin
      n:=Incn(n);
      XL.Range['H'+n+':M'+n].Select;
      XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
      XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
      XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
      XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
      XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['H'+IntToStr(i)].NumberFormat:='@';
     XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
     XL.Range['J'+IntToStr(i)].NumberFormat:='@';
     XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
     stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
     stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
     XL.Range['L'+n+':M'+n].Merge;
     if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
     else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
          else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
     i:=i+1;
    end;
     j:=j+1;
     provka:=UtilForm.P(provki,'!',j);
   end;
  end;
 End;

 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(2040478);

end;

procedure TFormPrint.Prich5;
var copt,crozn,cskl,snds,sotpnds,nds,sroznnds,sskl,kol:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i, fixcena:Integer;
    SumBegin,SumNDS,nad,SumSkid,stov:Double;
    Tovar:Boolean;
    ns,j:Integer;
    osh,provka,provki:String;
begin
  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;
  SumBegin:=0;SumNDS:=0;SumSkid:=0;
  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация '+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт '+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо '+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель '+PRNSTpKod.AsString+' '+PRNSTpName.Value; //FormMain.VisM2.P8;
  FormMain.VisM2.Execute('s P8=$P(##Class(SU.SWTP).AdrBank(P7),":",1), P9=$P(##Class(SU.SWTP).AdrBank(P7),":",2)');
  XL.Range['A4']:=FormMain.VisM2.P8+'   '+FormMain.VisM2.P9;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  n2:='17';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;

   XL.Rows[n].Rowheight:=15;

   XL.Range['A'+n]:=QPrNnt.Value;
   XL.Range['B'+n]:=QPrName.Value;
   XL.Rows[n].Autofit;   
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=QPrKol.Value;
   XL.Range['E'+n]:=QPrPrice.Value;
   SumBegin:=SumBegin+SimpleRoundTo(QPrPrice.Value*QPrKol.Value,-2);
   if fixcena>0 then
    XL.Range['F'+n]:=QPrSkid_1.Value
   else
    XL.Range['F'+n]:=QPrAddBase.Value;
   kol:=QPrKol.Value;
   case fixcena of
    0:begin
      copt:=QPrPrice.Value*(1+QPrTrans.Value/100);
      nds:=QPrNDS.Value;
     if QPrVidNad.value=0 then
     begin
      snds:=SimpleRoundTo(kol*(QPrPrice.Value*(1+QPrAddSuppl.Value/100))*nds/100,-2);
//      sotpnds:=SimpleRoundTo(kol*((copt-(QPrPrice.Value*QPrTrans.Value/100))*(1+nds/100)),-2);
      sotpnds:=SimpleRoundTo(kol*copt*(1+QPrAddSuppl.Value/100)*(1+nds/100),-2);
      if QPrAddBuyer.Value<=100 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      {if QPrKodGr.Value=99 then
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),0)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),0)
      else
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),1)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBase.Value)/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),1);
    }
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=QPrKol.Value*cskl;
     end
     else
     begin
       snds:=SimpleRoundTo(kol*(QPrPrice.Value+QPrAddSuppl.Value)*nds/100,-2);
       sotpnds:=SimpleRoundTo(kol*(copt+QPrAddSuppl.Value)*(1+nds/100),-2);
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBuyer.Value+QPrAddBase.Value);
       sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
       //cskl:=(QPrPrice.Value*(1+QPrTrans.Value/100)+(QPrAddSuppl.Value+QPrAddBase.Value+QPrAddBuyer.Value))*(1+nds/100);
       FormMain.VisM1.P1:=QPrNnt.Value;
       FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
       //cskl:=FormMain.VisM1.P2;
       cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
       sskl:=QPrKol.Value*cskl;
     end;
      end;
    1:begin
      copt:=QPrPrice.Value*(1+QPrTrans.Value);
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      //cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=QPrKol.Value*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value,-2);
      SumSkid:=SumSkid+SimpleRoundTo(kol*QPrPrice.Value*QPrSkid_1.Value/100,-2);
      snds:=SimpleRoundTo((kol*QPrPrice.Value*QPrSkid_1.Value/100)*nds/124,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      //cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      FormMain.VisM1.P1:=QPrNnt.Value;
      FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).CenaRoz(P1)');
      //cskl:=FormMain.VisM1.P2;
      cskl:=cskl+StrToFloat(PointtoComa(FormMain.VisM1.P2));
      sskl:=QPrKol.Value*cskl;
      end;
   end;
   SumNDS:=SumNDS+snds;
   XL.Range['G'+n]:=copt;
   XL.Range['H'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   XL.Range['I'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['J'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
      begin
    nad:=QPrAddBuyer.Value;
    XL.Range['K'+n]:=FloatToStr(nad)+'%';
    end

   else
    XL.Range['K'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['L'+n]:=crozn;
   XL.Range['M'+n]:=sroznnds;
   XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['O'+n]:=cskl;
   XL.Range['P'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+QPrKol.Value;
    ItsndsTov:=ItsndsTov+SimpleRoundTo(snds,-2);
    ItsotpndsTov:=ItsotpndsTov+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+QPrKol.Value;
    ItsndsTara:=ItsndsTara+SimpleRoundTo(snds,-2);
    ItsotpndsTara:=ItsotpndsTara+SimpleRoundTo(sotpnds,-2);
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
     n:=Incn(n);
     XL.Range['B'+n]:='Транспортные расходы  '+FloatToStr(QprTrans.Value)+'%';
     XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
     XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100);
     if QprAddSuppl.Value>0 then
      begin
       XL.Range['G'+n]:='Надбавка поставщика  '+FloatToStr(QprAddSuppl.Value)+'%';
       XL.Range['J'+n]:=QPrPrice.Value*QprAddSuppl.Value/100;
       XL.Range['K'+n]:=QPrPrice.Value*(1+QprAddSuppl.Value/100);
      end;
    end
   else if QprAddSuppl.Value>0 then
         begin
           n:=Incn(n);
           XL.Range['B'+n]:='Надбавка поставщика  '+FloatToStr(QprAddSuppl.Value)+'%';
           XL.Range['D'+n]:=QPrPrice.Value*QprAddSuppl.Value/100;
           XL.Range['E'+n]:=QPrPrice.Value*(1+QprAddSuppl.Value/100);
         end;
   FormMain.VisM1.P1:=QPrDop.Value;
   FormMain.VisM1.Execute('s P2=$TR(P1,$C(13,10)," ")');
   if Length(FormMain.VisM1.P2)>0 then
    begin
    n:=Incn(n);
    if Length(FormMain.VisM1.P2)>150 then
     XL.Rows[n].Rowheight:=30
    else
     XL.Rows[n].Rowheight:=15;
    //XL.Range['A'+n+':P'+n].Merge;
    XL.Range['A'+n+':P'+n].Select;
    XL.Selection.WrapText := True;
    XL.Selection.MergeCells := True;
    XL.Range['A'+n]:=FormMain.VisM1.P2;
    end;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n
   n:=Incn(n);
  // n:=Incn(n);
  // n2:=Incn(n2);
  // n2:=Incn(n2);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    //XL.Range['E'+n]:=SimpleRoundTo(SumBegin,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    XL.Range['M'+n]:=SimpleRoundTo(ItsroznndsTov,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=ItkolTara;
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTara,-2);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=ItKolTov+ItkolTara;
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    n:=Incn(n);
    end;
  n:=Incn(n);
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Итого по цене поставщика: '+FloatToStr(SimpleRoundTo(SumBegin,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumBegin,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма скидки: '+FloatToStr(SimpleRoundTo(SumSkid))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(SumSkid)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Всего по розничным ценам: '+FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2))+' / '+UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2)))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(ItsotpndsTov-SumSkid-ItsndsTov,-2)+SimpleRoundTo(ItsotpndsTara-ItsndsTara,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2)))+'/';
  XL.Range['A'+IntToStr(StrToInt(n)+2)]:='Экономист по ценам';
  XL.Range['A'+IntToStr(StrToInt(n)+4)]:='Заведующий складом';
  
 FormMain.VisM1.P1:=PRNSSK.Value;
 FormMain.VisM1.P2:=PRNSOperac.Value;
 FormMain.VisM1.Execute('s P3=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2))');
 FormMain.VisM1.Execute('s P4=$D(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"))');
 if FormMain.VisM1.P3>0 then
    FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit",P2),":",2)')
 else if FormMain.VisM1.P4>0 then
         FormMain.VisM1.Execute('s P5=+$P(^KSU.Option("FormFTXPRN",P1,"Print","Kredit"),":",2)')
      else FormMain.VisM1.P5:=0;
 if (FormMain.VisM1.P5>0) then
 Begin
  n:=Incn(n);
  XL.Range['H'+n+':M'+n].Select;
  XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
  XL.Range['H'+n+':I'+n].Merge;
  XL.Range['H'+n].HorizontalAlignment:=xlCenter;
  XL.Range['H'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['H'+n]:='Дебет';
  XL.Range['J'+n+':K'+n].Merge;
  XL.Range['J'+n].HorizontalAlignment:=xlCenter;
  XL.Range['J'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['J'+n]:='Кредит';
  XL.Range['L'+n+':M'+n].Merge;
  XL.Range['L'+n].HorizontalAlignment:=xlCenter;
  XL.Range['L'+n].Borders[xlEdgeLeft].LineStyle:=1;
  XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
  XL.Range['L'+n]:='Сумма';
  FormMain.VisM1.P1:=PRNSOperac.Value;
  FormMain.VisM1.Execute('s P7=+$LG(^KSU.SOD(P1),7)');
  if FormMain.VisM1.P7>0 then
   FormMain.VisM1.P1:=FormMain.VisM1.P7;
  FormMain.VisM1.P2:=PRNSID.Value;
  FormMain.VisM1.Execute('s P3=##Class(KSU.SOP).Provodka(P1,P2), P4=$P(P3,";",1)');
  osh:=FormMain.VisM1.P4;
  if osh='' then raise Exception.Create(UtilForm.P(FormMain.VisM1.P4,';',2))
  else  provki:=FormMain.VisM1.P3;
  i:=StrToInt(Incn(n));
  j:=1;
  provka:=UtilForm.P(provki,'!',j);
  while provka<>'' do
  begin
   if (UtilForm.P(provka,':',5)<>'0')or(UtilForm.P(provka,':',6)<>'0')
   then begin
     n:=Incn(n);
     XL.Range['H'+n+':M'+n].Select;
     XL.Selection.Borders[xlEdgeBottom].LineStyle:=1;
     XL.Selection.Borders[xlEdgeTop].LineStyle:=1;
     XL.Selection.Borders[xlEdgeLeft].LineStyle:=1;
     XL.Range['I'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['K'+n].Borders[xlEdgeRight].LineStyle:=1;
     XL.Range['M'+n].Borders[xlEdgeRight].LineStyle:=1;
    //provka:=UtilForm.P(provki,'!',i);
    XL.Range['H'+IntToStr(i)].NumberFormat:='@';
    XL.Range['H'+IntToStr(i)]:=UtilForm.P(provka,':',1)+'/'+UtilForm.P(provka,':',2);
    XL.Range['J'+IntToStr(i)].NumberFormat:='@';    
    XL.Range['J'+IntToStr(i)]:=UtilForm.P(provka,':',3)+'/'+UtilForm.P(provka,':',4);
    stov:=StrToFloat(UtilForm.P(UtilForm.P(provka,':',5),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',5),'.',2));
    stov:=stov+StrToFloat(UtilForm.P(UtilForm.P(provka,':',6),'.',1)+','+UtilForm.P(UtilForm.P(provka,':',6),'.',2));
    if UtilForm.P(provka,':',6)='0' then XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)
    else if UtilForm.P(provka,':',5)='0' then XL.Range['L'+IntToStr(i)]:=UtilForm.P(provka,':',6)
         else XL.Range['L'+IntToStr(i)]:=FloatToStr(stov)+'/'+UtilForm.P(provka,':',6);
    i:=i+1;
   end;
    j:=j+1;
    provka:=UtilForm.P(provki,'!',j);
  end;
 End;

{  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['I'+n]:=ProvBSD.Value;
     XL.Range['J'+n]:=ProvBSDA.Value;
     XL.Range['L'+n]:=ProvBSK.Value;
     XL.Range['M'+n]:=ProvBSKA.Value;
     XL.Range['O'+n]:=ProvS.Value;
     if provST.Value<>0 then  XL.Range['P'+n]:=provST.Value;
     n:=Incn(n);
     Prov.Next;
     end;
    end;
   end; }

 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(4654654);

end;

procedure TFormPrint.Prih_KSS;
var copt,crozn,cskl,snds,sotpnds,nds,sroznnds,sskl,kol:Double ;
    ItKolTov,ItsndsTov,ItsotpndsTov,ItsroznndsTov,ItssklTov:Double;
    ItKolTara,ItsndsTara,ItsotpndsTara,ItsroznndsTara,ItssklTara:Double;
    i, fixcena:Integer;
    Tovar:Boolean;
    ns:Integer;
    osh:String;
begin
  ItKolTov:=0;ItsndsTov:=0;ItsotpndsTov:=0;ItsroznndsTov:=0;ItssklTov:=0;
  ItKolTara:=0;ItsndsTara:=0;ItsotpndsTara:=0;ItsroznndsTara:=0;ItssklTara:=0;

  // загружаем его
  XL.WorkBooks.Add(ProgDir+'ПН-1.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  XL.visible:=true;

  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация_'+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель_'+PRNSTpKod.AsString+' '+FormMain.VisM2.P8;
  QPr.First;
  {if QPrKodGr.Value<>99 then Tovar:=True
  else Tovar:=False;}
  n:='16';
  for i:=1 to QPr.RecordCount do
   begin
  { if Tovar and (QPrKodGr.Value=99) then
    begin
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=ItkolTov;
    XL.Range['I'+n]:=ItsndsTov;
    XL.Range['J'+n]:=ItsotpndsTov;
    XL.Range['M'+n]:= ItsroznndsTov ;
    XL.Range['P'+n]:=ItssklTov;
    n:=Incn(n);
    end; }
   if QPrKodGr.Value<>99 then Tovar:=True
   else Tovar:=False;
   FormMain.VisM1.P1:=QPrNnt.Value;
   FormMain.VisM1.Execute('s P2=##Class(KSU.STMC).FixCena(P1)');
   fixcena:=FormMain.VisM1.P2;
   
   XL.Rows[n].Rowheight:=20;
   XL.Rows[n].Borders[xlEdgeBottom].LineStyle:=1; // рисуем нижнюю границу на ряду n

   XL.Range['A'+n]:=QPrNnt.Value;
   XL.Range['B'+n]:=QPrName.Value;
   XL.Range['C'+n]:=QPrKodEiName.Value;
   XL.Range['D'+n]:=QPrKol.Value;
   XL.Range['E'+n]:=QPrPrice.Value;
   if fixcena>0 then
    XL.Range['F'+n]:=QPrSkid_1.Value
   else
    XL.Range['F'+n]:=QPrAddSuppl.Value;
   kol:=QPrKol.Value;
   case fixcena of
    0:begin
      copt:=QPrPrice.Value*(1+QprTrans.Value/100)*(1+QPrAddSuppl.Value/100);
      nds:=QPrNDS.Value;
      snds:=SimpleRoundTo(kol*copt*nds/100,-2);
      sotpnds:=SimpleRoundTo(kol*copt*(1+nds/100),-2);
      if QPrAddBuyer.Value<=100 then
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value)/100)
      else
       crozn:=QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value)/100)+QPrAddBuyer.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      if QPrKodGr.Value=99 then
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),-2)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+QPrAddSuppl.Value/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),-2)
      else
       if QPrAddBuyer.Value<=100 then
        cskl:=SimpleRoundTo(QPrPrice.Value*(1+QPrTrans.Value/100)*(1+(QPrAddSuppl.Value+QPrAddBuyer.Value)/100)*(1+nds/100)*(1+QPrNal.Value/100),-2)
       else
        cskl:=SimpleRoundTo((QPrPrice.Value*(1+QPrTrans.Value/100)*(1+QPrAddSuppl.Value/100)+QPrAddBuyer.Value)*(1+nds/100)*(1+QPrNal.Value/100),-2);
      sskl:=QPrKol.Value*cskl;
      end;
    1:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/100,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/100,-2);
      cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      sskl:=QPrKol.Value*cskl;
      end;
    2:begin
      copt:=QPrPrice.Value;
      nds:=QPrNDS.Value;
      sotpnds:=SimpleRoundTo(kol*QPrPrice.Value-(kol*QPrPrice.Value*QPrSkid_1.Value/100),-2);
      snds:=SimpleRoundTo(sotpnds*nds/124,-2);
      crozn:=QPrPrice.Value;
      sroznnds:=SimpleRoundTo(crozn*kol*nds/124,-2);
      cskl:=SimpleRoundTo(crozn*(1+QPrNal.Value/100),1);
      sskl:=QPrKol.Value*cskl;
      end;
   end;
   XL.Range['G'+n]:=copt;
   XL.Range['H'+n]:=FloatToStr(nds);
   //Сумма НДС оптовая
   XL.Range['I'+n]:=snds;
   //Сумма отпускная с НДС
   XL.Range['J'+n]:=sotpnds;
   if QPrAddBuyer.Value<=100 then
    XL.Range['K'+n]:=QPrAddBuyer.AsString+'%'
   else
    XL.Range['K'+n]:=QPrAddBuyer.Value;
   //Розничная цена без НДС
   XL.Range['L'+n]:=crozn;
   XL.Range['M'+n]:=sroznnds;
   XL.Range['N'+n]:=QPrNal.Value;
   XL.Range['O'+n]:=cskl;
   XL.Range['P'+n]:=sskl;
   if Tovar then
    begin
    ItKolTov:=ItKolTov+QPrKol.Value;
    ItsndsTov:=ItsndsTov+snds;
    ItsotpndsTov:=ItsotpndsTov+sotpnds;
    ItsroznndsTov:=ItsroznndsTov+sroznnds;
    ItssklTov:=ItssklTov+sskl;
    end
   else
    begin
    ItKolTara:=ItKolTara+QPrKol.Value;
    ItsndsTara:=ItsndsTara+snds;
    ItsotpndsTara:=ItsotpndsTara+sotpnds;
    ItsroznndsTara:=ItsroznndsTara+sroznnds;
    ItssklTara:=ItssklTara+sskl;
    end;
   if QprTrans.Value>0 then
    begin
    n:=Incn(n);
    XL.Range['B'+n]:='Транспортные расходы'+FloatToStr(QprTrans.Value)+'%';
    XL.Range['D'+n]:=QPrPrice.Value*QprTrans.Value/100;
    XL.Range['E'+n]:=QPrPrice.Value*(1+QprTrans.Value/100)  ;
    end;
   n:=Incn(n);
   //Выводим дополнительные сведения Пока закоментарим .Надо
   //разобраться как программно объеденить ячейки
   {if Length(QPrDop.Value)>1 then
    begin
    //ShowMessage(IntToStr(Length(QPrDop.Value)));
    //ShowMessage(QPrDop.Value);
    XL.Range['A'+n]:=QPrDop.Value;
    n:=Incn(n);
    end; }
   QPr.Next;
   end;
  QPr.Close;
    XL.Range['B'+n]:='Всего товар:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTov,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2);
    n:=Incn(n);
  if ItkolTara<>0 then
    begin
    XL.Range['B'+n]:='Всего тара:';
    XL.Range['D'+n]:=SimpleRoundTo(ItkolTara,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTara,-2);
    n:=Incn(n);
    XL.Range['B'+n]:='Всего по накладной:';
    XL.Range['D'+n]:=SimpleRoundTo(ItKolTov,-2)+SimpleRoundTo(ItkolTara,-2);
    XL.Range['I'+n]:=SimpleRoundTo(ItsndsTov,-2)+SimpleRoundTo(ItsndsTara,-2);
    XL.Range['J'+n]:=SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2);
    XL.Range['M'+n]:= SimpleRoundTo(ItsroznndsTov,-2)+SimpleRoundTo(ItsroznndsTara,-2) ;
    XL.Range['P'+n]:=SimpleRoundTo(ItssklTov,-2)+SimpleRoundTo(ItssklTara,-2);
    n:=Incn(n);
    end;
  XL.Range['A'+n]:='Оприходовано по накладной: '+FloatToStr(ItKolTov+ItKolTara)+' / '+UtilForm.MoneyToText(FloatToStr(ItKolTov+ItKolTara))+'/';
  n:=Incn(n);
  XL.Range['A'+n]:='Сумма к оплате: '+FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2))+' / '+ UtilForm.MoneyToText(FloatToStr(SimpleRoundTo(ItsotpndsTov,-2)+SimpleRoundTo(ItsotpndsTara,-2)))+'/';
  if FormPr Then
   begin
   n:=Incn(n);
   //Формируем проводки в классе TmpProv
   FormMain.Vism1.P1:=idprn;
   FormMain.Vism1.Execute('s P2=$$prn^Prov(P1)');
   //Если при формировании ошибки ,то выводим ошибку
   //если нет то выводим проводки
   osh:=UtilForm.P(FormMain.VisM1.P2,':',1);
   if osh<>'' then
    begin
    MessageDlg(osh,mtError,[mbok],0);
    end
   else
    begin
    ns:=StrToInt(UtilForm.P(FormMain.VisM1.P2,':',2));
    prov.Close;
    prov.Prepare;
    prov.ParamByName('ns').Value:=ns;
    prov.Open;
    Prov.First;
    for i:=1 to Prov.RecordCount do
     begin
     XL.Range['I'+n]:=ProvBSD.Value;
     XL.Range['J'+n]:=ProvBSDA.Value;
     XL.Range['L'+n]:=ProvBSK.Value;
     XL.Range['M'+n]:=ProvBSKA.Value;
     XL.Range['O'+n]:=ProvS.Value;
     n:=Incn(n);
     Prov.Next;
     end;
    end;
   end;
 //Защищаем листы накладной
 XL.WorkBooks[1].Sheets[1].Protect(4654654);

end;






procedure TFormPrint.Rash_new_2;
var
  ns,nn,kodpl:Integer;
  nr,nrstart,intNDS,intSumNDS:integer;
  nrs:string;
  str:string;
  orgpl: boolean;
begin
// новая накладная
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeVC(P1,P3)');
  ns:=FormMain.VisM1.P3;
//  FormMain.VisM1.P4:=SK;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;

  nrstart:=38;
  qPrint.First;

  XL.WorkBooks.Add(ProgDir+'ТТН_new_2.xls');
  XL.WorkBooks[1].Sheets[1].Activate;
  //XL.visible:=true;

  for nr:=1 to qPrint.RecordCount do
  begin
    nrs:=inttostr(nr+nrstart-1);
    XL.Range['B'+nrs]:=IntToStr(nr)+'. '+qPrintName.Value;
    XL.Range['I'+nrs]:=qPrintEI.Value;
    XL.Range['K'+nrs]:=qPrintQnt.Value;
    XL.Range['M'+nrs]:=qPrintPricewoNDS.Value;
    XL.Range['O'+nrs]:=qPrintSumwNDS.Value;
    XL.Range['R'+nrs]:=qPrintNDS.Value;
    XL.Range['S'+nrs]:=qPrintSumNDS.Value;
    XL.Range['V'+nrs]:=qPrintSumTotal.Value;
    XL.Range['Y'+nrs]:=''; // кол-во грузовых мест
    XL.Range['AA'+nrs]:='';  // масса груза
    XL.Range['AC'+nrs]:='Надбавка: '+FloatToStr(qPrintAddTorg.Value)+'%, отпусткная цена: '+FloatToStr(qPrintPrice.Value);  // Примечания
    qPrint.Next;
  end;

  for nr:=nr+nrstart-1 to 56 do XL.Rows[nr].RowHeight:=0;

  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |


//Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U7']:=inttostr(PRNSTpUNN.Value);

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
   end;

  XL.Range['B20']:=PRNSDateN.Value;// Дата}

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;


  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.Execute('s P3=$P($G(^SPD(P1)),":",6)');

  XL.Range['Q31']:=FormMain.VisM2.P3;
  XL.Range['AC31']:=PRNSTpAdres.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
  intNDS:=XL.Range['S57'];
  intSumNDS:=XL.Range['V57'];


  // ----------------------------------------
// транспортные данные
  XL.WorkBooks[1].Sheets[2].Activate;
  str:=Util.UtilForm.MoneyToText(inttostr(intNDS));//
  XL.Range['F2']:=str;
  str:=Util.UtilForm.MoneyToText(inttostr(intSumNDS));//
  XL.Range['H4']:=str;

  XL.Range['AB4']:='';// количество мест прописью
  XL.Range['G6']:='';// груз массой брутто
  XL.Range['H10']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA8']:=PRNSVodName.Value;// принял водитель
  XL.Range['F8']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y10']:='№'+PRNZDovNom.AsString+', от '+PRNZDovData.AsString;// № дата доверенности
  XL.Range['AE10']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['Z12']:='';// груз получил


  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;

procedure TFormPrint.ppDetailBand1BeforeGenerate(Sender: TObject);
var kfas:Double;
    Text,Axct:String;
begin
{ if qPrintKodGr.Value=99 then
  begin
  tSumQnt:=tSumQnt+qPrintQnt.Value;
  tSumnds:=tSumnds+qPrintSumNDS.Value;
  tSumVnds:=tSumVnds+qPrintSumwNDS.Value;
  tSumtotal:=tSumtotal+qPrintSumTotal.Value;

  end;}
 { if qPrintTrans.Value=0
  then begin
    ppDetailBand1.Height:=8.2;
    ppLabel1.Visible:=false;
    ppdbtext20.Visible:=false;
    ppdbtext18.Visible:=false;
    ppdbtext19.Visible:=false;
  end
  else begin
    ppDetailBand1.Height:=12.17;
    ppLabel1.Visible:=true;
    ppLabel1.Top:=8.5;
    ppdbtext20.Visible:=true;
    ppdbtext20.Top:=8.5;
    ppdbtext18.Visible:=true;
    ppdbtext18.Top:=8.5;
    ppdbtext19.Visible:=true;
    ppdbtext19.Top:=8.5;
  end; }

if Length(ppDBText2.Text)>37 then
 begin
 ppDBText2.Height:=7.558;
 ppLabel19.Top:=7.030;
 end
else
 begin
 ppDBText2.Height:=3.979;
 ppLabel19.Top:=3.015;
 end;
Text:=UtilForm.DelSim(qPrintDop.Value);
Axct:=UtilForm.DelSim(qPrintAxc.Value);
//ShowMessage(Text+'='+IntToStr(Length(Text)));
if Length(Text)=0 then
 begin
 ppLabel19.Height:=0.01;
 ppLabel20.Top:=ppLabel19.Top;
 end
else  if Length(Text)>134 then
       begin
       ppLabel19.Height:=5.7;
       ppLabel20.Top:=ppLabel19.Top+ppLabel19.Height;
       end
      else
       begin
       ppLabel19.Height:=3.21;
       ppLabel20.Top:=ppLabel19.Top+ppLabel19.Height;
       end;
if Length(Axct)=0 then ppLabel20.Height:=0.01
else
    if Length(Axct)>134 then ppLabel20.Height:=5.8
    else                     ppLabel20.Height:=3.91;
ppLine35.Top:=ppLabel20.Top+ppLabel20.Height;
ppLabel19.Caption:=Text;
ppLabel20.Caption:=Axct;
//ShowMessage(ppDBText2.Text+'h='+FloatToStr(ppDBText2.Height)+'t='+FloatToStr(ppLabel19.Height));
if (qPrintFas.Value='0') or (qPrintFas.Value='') then ppLabel18.Caption:=FloatToStr(qPrintQnt.Value)
else
  begin
  //kfas:=qPrintQnt.Value/qPrintFas.Value;
  ppLabel18.Caption:=qPrintFas.Value+'='+FloatToStr(qPrintQnt.Value);
  end;
end;

procedure TFormPrint.ppTitleBand1BeforeGenerate(Sender: TObject);
begin
 ppLabel4.Caption:='Приложение к товарно-транспортной накладной №'+PRNSNnak.AsString;
end;

procedure TFormPrint.RashKyl;
var ns,kollist,nn:Integer;
    padlist:String;
begin
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  if PRNSPrN.Value<>0 then
   begin
   ppReport1.DeviceType:=dtScreen;
   ppReport1.Print;
   end
  else
   begin
   ppReport1.PrinterSetup.Copies:=kolnakl;
   ppReport1.DeviceType:=dtPrinter;
   ppReport1.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_1.xls');
  Zagl;
  XL.Range['D32:AG32'].Merge;
  kollist:=ppReport1.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['D31']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  XL.Range['Q33']:=ppDBCalc13.Value-ppDBCalc12.Value;
  XL.Range['Y33']:=ppDBCalc12.Value;
  XL.Range['Z33']:=ppDBCalc13.Value;
  XL.Range['E35']:=Util.UtilForm.MoneyToText(ppDBCalc12.Value);
  XL.Range['G37']:=Util.UtilForm.MoneyToText(ppDBCalc13.Value);
  Podv;
  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;



  //FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3)');

end;

procedure TFormPrint.RashNewKyl;
var ns,kollist,nn,kodpl,pprep:Integer;
    padlist:String;
    orgpl:boolean;
begin
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  FormMain.VisM1.P1:=PRNSID.Value;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3,P4)');
  ns:=FormMain.VisM1.P3;
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  FormMain.VisM1.P4:=SK;
  FormMain.VisM1.Execute('s P7=$G(^KSU.Option("FormSTMC",P4,"Ypakovka"))');
  if FormMain.VisM1.P7='' then
  begin
    pprep:=1;
    if PRNSPrN.Value<>0 then
    begin
      ppReport1.DeviceType:=dtScreen;
      ppReport1.Print;
    end
    else
    begin
      ppReport1.PrinterSetup.Copies:=kolnakl;
      ppReport1.DeviceType:=dtPrinter;
      ppReport1.Print;
    end;
  end
  else
  begin
    pprep:=2;
    if PRNSPrN.Value<>0 then
    begin
      ppReport9.DeviceType:=dtScreen;
      ppReport9.Print;
    end
    else
    begin
      ppReport9.PrinterSetup.Copies:=kolnakl;
      ppReport9.DeviceType:=dtPrinter;
      ppReport9.Print;
    end;
  end;

  XL.WorkBooks.Add(ProgDir+'ТТН_new.xls');
  //Zagl;

  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;
  //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  //Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);

   //Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;
  XL.Range['B20']:='операция '+PRNSOperac.AsString+' от'+PRNSDateN.AsString; // Дата

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  if PRNSTpPr.Value=1 then
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;

  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AC31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
//  XL.Range['AC25']:='';// № маршрута
//  XL.Range['Z27']:='';// прицеп
//  XL.Range['AC27']:='';// Гараж

  //XL.Range['D32:AG32'].Merge;
 if pprep=1 then
 begin
  kollist:=ppReport1.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  XL.Range['O41']:=ppDBCalc13.Value-ppDBCalc12.Value;
  XL.Range['S41']:=ppDBCalc12.Value;
  XL.Range['V41']:=ppDBCalc13.Value;
  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc12.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc13.Value);
 end
 else
 begin
  kollist:=ppReport9.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['B39']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  XL.Range['O41']:=ppDBCalc77.Value-ppDBCalc76.Value;
  XL.Range['S41']:=ppDBCalc76.Value;
  XL.Range['V41']:=ppDBCalc77.Value;
  XL.Range['F44']:=Util.UtilForm.MoneyToText(ppDBCalc76.Value);
  XL.Range['H46']:=Util.UtilForm.MoneyToText(ppDBCalc77.Value);
 end;

  XL.Range['H52']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['AA50']:=PRNSVodName.Value;// принял водитель
  XL.Range['F50']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['Y52']:=PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// № и дата доверенности
  XL.Range['AE52']:=PRNZDovVyd.Value;// выдана доверенность

  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;

end;




procedure TFormPrint.RashNewKyl1;
var ns,kollist,nn,kodpl,oper,kolt,vniz,start,nst:Integer;
    padlist,osh,nstr:String;
    orgpl:boolean;
    s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11:String;
    itogkolt,itogstoim,itognds,itogsnds,itogbinds,tara,snds10,snds20:Double;
begin
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
 if UnitFTXPRN.Table then oper:=Data.TableFTXPRNOperac.Value else oper:=PRNSOperac.Value;
 FormMain.VisM1.P1:=PRNSID.Value;
 FormMain.VisM1.P4:=SK;
 FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3,P4)');
 ns:=FormMain.VisM1.P3;
 osh:=UtilForm.P(FormMain.VisM1.P3,':',2);
 if osh<>'' then MessageDlg(osh,mtError,[mbok],0);
 ns:=StrToInt(UtilForm.P(FormMain.VisM1.P3,':',1));
 qPrint.Close;
 qPrint.Prepare;
 qPrint.ParamByName('ns').Value:=ns;
 qPrint.Open;
 qPrint.First;
 kolt:=qPrint.RecordCount;
 XL.WorkBooks.Add(ProgDir+'ТТН_kond');
 if kolt<=4 then begin vniz:=-46; XL.WorkBooks[1].Sheets[3].Activate; end
 else if kolt<=27 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].Activate; end
      else if kolt<=51 then begin vniz:=48; XL.WorkBooks[1].Sheets[2].Activate; end;

 //Определим кто плательщик
 FormMain.VisM2.P1:=PRNSTpKod.Value;
 FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
 if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
  begin
   orgpl:=True;
   kodpl:=FormMain.VisM2.P2;
  end
 else
  begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
  end;
 //Грузоотправитель
 if not DataSpr.QuerySPDUNN.IsNull then
  XL.Range['P7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
 //Грузополучатель
 if not PRNSTpUNN.IsNull then
  XL.Range['U7']:=inttostr(PRNSTpUNN.Value);
 //Заказчик(плательщик)
 if PRNZustomer.Value  then
  begin // если заказчик=грузоотправитель
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['Z7']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end
 else
  begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Z7']:=inttostr(PRNSTpUNN.Value);
  end;
 XL.Range['B20']:='Накладная №'+inttostr(nn)+', операция '+inttostr(oper)+', от '+PRNSDateN.AsString;// Дата
 //XL.Range['B20']:=PRNSDateN.Value;// Дата
 //Транспорт
 XL.Range['E21']:=PRNSCar.Value;
 XL.Range['AE21']:=PRNZPutList.Value;
 XL.Range['G23']:=PRNZOwnCarName.Value;
 XL.Range['Z23']:=PRNSVodName.Value;
 //Грузоотправитель
 FormMain.VisM2.P1:=PodrG;
 FormMain.VisM2.P4:=KMOLG;
 FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
 XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
 if PRNSTpPr.Value=1 then
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
     XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
    end
   else
    begin
     if orgpl then
      begin
       FormMain.Vism2.P1:=kodpl;
       FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
       XL.Range['I25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
      end
     else
      begin
       XL.Range['I25']:='=F29';
      end;
    end
  end
 else
  begin
   XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['I25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
  end;
 XL.Range['G31']:=PRNZOsnOtp.AsString;
 XL.Range['Q31']:=PRNZPunktPogr.AsString;
 XL.Range['AC31']:=PRNZPunktRazgr.AsString;
   // переадресовка
 XL.Range['F33']:=PRNZPereadr.Value;
 start:=39;
 nst:=-1;
 itogkolt:=0;itogstoim:=0;itognds:=0;itogsnds:=0;itogbinds:=0;
 tara:=0;snds10:=0;snds20:=0;
 for i:=1 to kolt do
 begin
  inc(nst);
  nstr:=IntToStr(start+nst);
  s1:=inttostr(i)+'. '+qPrintName.AsString;
  s2:=qPrintEI.AsString;
  s3:=FloatToStr(qPrintQnt.Value);
  itogkolt:=itogkolt+qPrintQnt.Value;
  s4:=FloatToStr(qPrintPrice.Value);
  s5:=FloatToStr(qPrintSumBegin.Value);
  itogstoim:=qPrintSumBegin.Value+itogstoim;
  s6:=FloatToStr(qPrintNDS.Value);
  s7:=FloatToStr(qPrintSumNDS.Value);
  itognds:=qPrintSumNDS.Value+itognds;
  s8:=FloatToStr(qPrintSumTotal.Value);
  itogsnds:=qPrintSumTotal.Value+itogsnds;

  s9:=FloatToStr(qPrintSkid.Value);
  s10:=FloatToStr(qPrintSumSkid.Value);
  itogbinds:=qPrintSumSkid.Value+itogbinds;
  s11:=FloatToStr(qPrintAddTorg.Value);
  XL.Range['B'+nstr]:=s1;
  XL.Range['I'+nstr]:=s2;
  XL.Range['K'+nstr]:=s3;
  XL.Range['M'+nstr]:=s4;
  XL.Range['O'+nstr]:=s5;
  XL.Range['R'+nstr]:=s6;
  XL.Range['S'+nstr]:=s7;
  XL.Range['V'+nstr]:=s8;
  XL.Range['Y'+nstr]:=qPrintFas.AsString;
  XL.Range['AC'+nstr]:=s9;
  XL.Range['AG'+nstr]:=s10;
  inc(nst);
  nstr:=IntToStr(start+nst);
  if qPrintDop.Value<>'' then
  begin
    //XL.Range['B'+nstr+':AJ'+nstr].Merge;
   //XL.Rows[]
   XL.Range['B'+nstr]:=qPrintDop.AsString;
  end
  else
  begin
   XL.Rows[nstr].RowHeight:=0;
  end;
  if qPrintKodGr.Value=99 then tara:=tara+Round(qPrintSumBegin.Value);
  if qPrintNDS.Value=10 then snds10:=snds10+qPrintSumNDS.Value*qPrintQnt.Value;
  if qPrintNDS.Value=20 then snds20:=snds20+qPrintSumNDS.Value*qPrintQnt.Value;
  qPrint.Next;
 end;
 if (kolt<>4)and(kolt<>27)and(kolt<>52) then
 begin
  inc(nst);
  nstr:=IntToStr(start+nst);
  XL.Rows[nstr+':'+IntToStr(92+vniz)].RowHeight:=0; //Select;
  //XL.Selection.Delete;
 end;
 ///ИТОГО
 //XL.Range['H'+IntToStr(96+vniz)]:=FloatToStr(snds10);
 //XL.Range['M'+IntToStr(96+vniz)]:=FloatToStr(snds20);
 inc(nst);
 nstr:=IntToStr(93+vniz);
 XL.Range['K'+nstr]:=FloatToStr(itogkolt);
 XL.Range['O'+nstr]:=FloatToStr(itogstoim);
 XL.Range['S'+nstr]:=FloatToStr(itognds);
 XL.Range['V'+nstr]:=FloatToStr(itogsnds);
 XL.Range['AG'+nstr]:=FloatToStr(itogbinds);
 nstr:=IntToStr(94+vniz);
 if tara=0 then XL.Rows[nstr].RowHeight:=0
 else XL.Range['V'+nstr]:=FloatToStr(tara);
 XL.Range['F'+IntToStr(97+vniz)]:=UtilForm.SumNumToFull(itognds);
 XL.Range['H'+IntToStr(99+vniz)]:=UtilForm.SumNumToFull(itogsnds);
 XL.Range['F'+IntToStr(101+vniz)]:=UtilForm.SumNumToFull(itogbinds);
 XL.Range['F'+IntToStr(103+vniz)]:=UtilForm.SumNumToFull(itogsnds);
 XL.Range['H'+IntToStr(109+vniz)]:=PRNZCdalOtp.AsString;// сдал отправитель
 XL.Range['AA'+IntToStr(107+vniz)]:=PRNSVodName.AsString;// принял водитель
 XL.Range['F'+IntToStr(107+vniz)]:=PRNZOtpRazr.AsString;// отпуск разрешил
 XL.Range['Y'+IntToStr(109+vniz)]:='№'+PRNZDovNom.AsString+' от '+PRNZDovData.AsString;// №, дата доверенности
 XL.Range['AE'+IntToStr(109+vniz)]:=PRNZDovVyd.AsString;// выдана доверенность
 XL.Range['Z'+IntToStr(111+vniz)]:=PRNZPrinPol.AsString;// груз получил
 if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставьте чистый бланк ТТН-1 с №'+IntToStr(nn),mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
      if kolt<=4 then begin vniz:=-46; XL.WorkBooks[1].Sheets[3].PrintOut(1,1,kolnakl); end
      else if kolt<=27 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl); end
           else if kolt<=51 then begin vniz:=48; XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl); end;
      if (kolt>4) and(MessageDlg('Переверните листы' ,mtConfirmation,[mbYes,mbNo],0)=mrYes) then
       if kolt<=27 then begin vniz:=0; XL.WorkBooks[1].Sheets[1].PrintOut(2,2,kolnakl); end
       else if kolt<=51 then begin vniz:=48; XL.WorkBooks[1].Sheets[2].PrintOut(2,2,kolnakl); end;
//     XL.WorkBooks[1].Sheets[2].PrintOut(1,1,kolnakl);
      FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
      FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
      if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
      Data.KPRN.Close;
      Data.KPRN.Prepare;
      Data.KPRN.Open;
     end;
  end;
end;


procedure TFormPrint.Rash11;
var ns,kollist:Integer;
    padlist:String;
begin
  FormMain.VisM1.P1:=PRNSID.Value;

  FormMain.VisM1.Execute(' i ''$D(^N) {s ^N=1}  s ^N=^N+1  s P3=^N-1, P2=##Class(KSU.tNaklPrint).MakeIvatz(P1,P3)');
  ns:=FormMain.VisM1.P3;
  if FormMain.VisM1.P2<>'' then raise Exception.Create(FormMain.VisM1.P2);
  qPrint.Close;
  qPrint.Prepare;
  qPrint.ParamByName('ns').Value:=ns;
  qPrint.Open;
  SumTara.Close;
  SumTara.Prepare;
  SumTara.ParamByName('ns').Value:=ns;
  SumTara.Open;
  FormMain.Vism1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).cposttov(P1),P3=##Class(KSU.Provodki).cposttara(P1)');
  ppLabel60.Caption:=FormMain.VisM1.P2;
  ppLabel62.Caption:=FormMain.VisM1.P3;
  ppLabel64.Caption:=FloatToStr(StrToFloat(ppLabel60.Caption)+StrToFloat(ppLabel62.Caption));
  FormMain.Vism1.P1:=PRNSID.Value;
  FormMain.VisM1.Execute('s P2=##Class(KSU.Provodki).sumcnadtov(P1),P3=##Class(KSU.Provodki).sumcnadtara(P1)');
  ppLabel67.Caption:=FormMain.VisM1.P2;
  ppLabel69.Caption:=FormMain.VisM1.P3;
  ppLabel71.Caption:=FloatToStr(StrToFloat(ppLabel67.Caption)+StrToFloat(ppLabel69.Caption));
  if PRNSPrN.Value<>0 then
   begin
   Addition.DeviceType:=dtScreen;
   Addition.Print;
   end
  else
   begin
   Addition.PrinterSetup.Copies:=kolnakl;
   Addition.DeviceType:=dtPrinter;
   Addition.Print;
   end;

  XL.WorkBooks.Add(ProgDir+'ТТН_1.xls');
  Zagl;
  XL.Range['D32:AG32'].Merge;
  kollist:=Addition.AbsolutePageCount;
  if kollist=1 then padlist:='лист'
  else
   if kollist<5 then padlist:='листа'
   else padlist:='листов';
  XL.Range['D31']:='Товар согласно приложения '+IntToStr(kollist)+' '+padlist;

  XL.Range['Q33']:=ppDBCalc4.Value-ppDBCalc2.Value;
  XL.Range['Y33']:=ppDBCalc2.Value;
  XL.Range['Z33']:=ppDBCalc4.Value;
  XL.Range['E35']:=Util.UtilForm.MoneyToText(ppDBCalc2.Value);
  XL.Range['G37']:=Util.UtilForm.MoneyToText(ppDBCalc4.Value);
  Podv;
  XL.WorkBooks[1].Sheets[1].Protect('AOM49fN');
  if PRNSPrN.Value<>0 then
   XL.visible:=true
  else begin
    if MessageDlg('Вставте ТТН',mtConfirmation,[mbYes,mbNo],0)=mrYes then
     begin
    // XL.visible:=true;
     XL.WorkBooks[1].Sheets[1].PrintOut(1,1,kolnakl);
     FormMain.VisM1.P1:=Data.TableFTXPRNTIDdoc.Value;
     FormMain.VisM1.Execute('s P2=##class(KSU.FTXPRN).Printed(P1)');
     if FormMain.VisM1.P2<>'' then ShowMessage(FormMain.VisM1.P2);
     Data.KPRN.Close;
     Data.KPRN.Prepare;
     Data.KPRN.Open;
     end;
  end;



  //FormMain.VisM1.Execute('s P2=##Class(KSU.tNaklPrint).MakeKobrin(P1,P3)');

end;


procedure TFormPrint.ZaglN;
var orgpl:Boolean; //Плательщик головная организация
    kodpl:Integer;  //Её код
    rashizprih:boolean; //Расходная накладная из приходной
begin
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;


//Грузоотправитель
  FormMain.VisM1.P1:=SK;
  FormMain.VisM1.P3:=Data.KPRNOperac.Value;
  FormMain.VisM1.Execute('s P2=":"_$G(^KSU.Option("FormFTXPRN",P1,"Print","RashIzPrih"))_":" s P4=$L(P2,":"_P3_":")');
  if FormMain.VisM1.P4>1 then rashizprih:=True;
  if rashizprih then
  begin
   if not PRNSTpUNN.IsNull then
    XL.Range['K4']:=inttostr(PRNSTpUNN.Value);// УНН
  end
  else
  begin
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['K4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  end;

//Грузополучатель
   if rashizprih then
  begin
   if not DataSpr.QuerySPDUNN.IsNull then
    XL.Range['P4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН
  end
  else
  begin
   if not PRNSTpUNN.IsNull then
    XL.Range['P4']:=inttostr(PRNSTpUNN.Value);// УНН
  end;

//Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['U4']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['U4']:=inttostr(PRNSTpUNN.Value);
   end;
  if UnitFTXPRN.Table then nn:=Data.TableFTXPRNNnak.Value else nn:=PRNSNnak.Value;
  XL.Range['K20']:='Накладная № '+inttostr(nn)+' от '+PRNSDateN.AsString;// Дата
  XL.Range['V20']:='Отпущено со склада '+IntToStr(KMOLG);

  FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=0  if $D(^KSU.Option("FormFTXPRN",P1,"PrintIsp")) { s P2=$G(^KSU.Option("FormFTXPRN",P1,"Min")) }');
   if FormMain.VisM1.P2<>0 then
     XL.Range['V20']:='Отпущено со склада '+IntToStr(KMOLG)+' ('+FormMain.UserName+')'
     else XL.Range['V20']:='Отпущено со склада '+IntToStr(KMOLG);

  //Транспорт
  XL.Range['E21']:=PRNSCar.Value;
  XL.Range['P21']:=PRNSPricep.AsString;
  XL.Range['AE21']:=PRNZPutList.Value;
  XL.Range['G23']:=PRNZOwnCarName.Value;
  XL.Range['Z23']:=PRNSVodName.Value;

  if rashizprih then
  begin
    //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;

  FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"PrintGruzotpr"))');
  if FormMain.VisM1.P2=1 then
  begin
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F29']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3+', '+AnsiUpperCase(FormMain.Vism2.P5);// Грузоотправитель
  end
  else
  begin
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F29']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  end;
  if PRNSTpPr.Value=1 then
   begin
   FormMain.Vism2.P1:=kodpl;
   if orgpl=True
   then
   begin
   FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1)');
   //XL.Range['F27']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['F27']:=FormMain.Vism2.P2+', '+PRNSTpName.Value+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   end
   else
   //XL.Range['F27']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['F27']:=PRNSTpName.Value+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:='=F29';
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F27';
     end;
    end
   end
  else
   begin
   FormMain.VisM2.P8:=PRNSTpKod.Value;
   FormMain.VisM2.Execute('s P6=$P($G(^SMOL(P8)),":",10)');
   FormMain.VisM2.P7:='';
   if FormMain.VisM2.P6<>'' then
     FormMain.VisM2.Execute('if $D(^SU.STPD(P6)) {s P7=$LG(^SU.STPD(P6),4),P9=$LG(^SU.STPD(P6),6)}');
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"NoPrintGruzop"))');
   if FormMain.VisM2.P7='' then
     //XL.Range['F27']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value // Грузополучатель реквизиты
     XL.Range['F27']:=PRNSTpName.Value+', '+PRNSTpAdres.Value
   else if FormMain.VisM1.P2='1' then XL.Range['F27']:=AnsiUpperCase(PRNSTpName.Value)
   else if FormMain.VisM1.P2='2' then XL.Range['F27']:=AnsiUpperCase(PRNSTpName.Value)+', '+FormMain.VisM2.P9
   else XL.Range['F27']:=FormMain.VisM2.P7+', '+FormMain.VisM2.P9+', '+AnsiUpperCase(PRNSTpName.Value);
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;
  end



  else



  begin
    //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;

  FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"PrintGruzotpr"))');
  if FormMain.VisM1.P2=1 then
  begin
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3+', '+AnsiUpperCase(FormMain.Vism2.P5);// Грузоотправитель
  end
  else
  begin
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['F27']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;// Грузоотправитель
  end;
  if PRNSTpPr.Value=1 then
   begin
   FormMain.Vism2.P1:=kodpl;
   if orgpl=True
   then
   begin
   FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1)');
   //XL.Range['F29']:=AnsiUpperCase(FormMain.Vism2.P2)+', '+AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['F29']:=FormMain.Vism2.P2+', '+PRNSTpName.Value+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   end
   else
   //XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   XL.Range['F29']:=PRNSTpName.Value+', '+PRNSTpAdres.Value;// Грузополучатель реквизиты
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['M25']:='=F27';
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['M25']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3;
     end
    else
     begin
     XL.Range['M25']:='=F29';
     end;
    end
   end
  else
   begin
   FormMain.VisM2.P8:=PRNSTpKod.Value;
   FormMain.VisM2.Execute('s P6=$P($G(^SMOL(P8)),":",10)');
   FormMain.VisM2.P7:='';
   if FormMain.VisM2.P6<>'' then
     FormMain.VisM2.Execute('if $D(^SU.STPD(P6)) {s P7=$LG(^SU.STPD(P6),4),P9=$LG(^SU.STPD(P6),6)}');
   FormMain.VisM1.P1:=SK;
   FormMain.VisM1.Execute('s P2=+$G(^KSU.Option("FormFTXPRN",P1,"NoPrintGruzop"))');
   if FormMain.VisM2.P7='' then
     //XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value // Грузополучатель реквизиты
     XL.Range['F29']:=PRNSTpName.Value+', '+PRNSTpAdres.Value
   else if FormMain.VisM1.P2='1' then XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)
   else if FormMain.VisM1.P2='2' then XL.Range['F29']:=AnsiUpperCase(PRNSTpName.Value)+', '+FormMain.VisM2.P9
   else XL.Range['F29']:=FormMain.VisM2.P7+', '+FormMain.VisM2.P9+', '+AnsiUpperCase(PRNSTpName.Value);
   XL.Range['M25']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3;
   end;
  end;
  if FormFTXPRNAll.CheckBox1.Checked=True then XL.Range['M25']:='';
  XL.Range['G31']:=PRNZOsnOtp.Value;
//  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['Q31']:=PRNZPunktPogr.Value;
  XL.Range['AD31']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['F33']:=PRNZPereadr.Value;
end;

procedure TFormPrint.Zagl;
var orgpl:Boolean; //Плательщик головная организация
    kodpl:Integer;  //Её код
begin
  XL.WorkBooks[1].Sheets[1].Activate;
  //Определим кто плательщик
  FormMain.VisM2.P1:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P2=+$P($G(^SWTP(P1)),":",11),P3=$D(^SWTP(P2))');
  if (FormMain.VisM2.P2<>'0') and (FormMain.VisM2.P3<>'0') then
    begin
    orgpl:=True;
    kodpl:=FormMain.VisM2.P2;
    end
  else
   begin
   orgpl:=False;
   kodpl:=PRNSTpKod.Value;
   end;
  //Грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['P5']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
  XL.Range['P6']:=DataSpr.QuerySPDOklp.Value;// ОКЮЛП            | Грузоотправителя
  XL.Range['P7']:=DataSpr.QuerySPDLicens.Value;// лицензия         |

  //Грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['Y5']:=inttostr(PRNSTpUNN.Value);
   XL.Range['Y6']:=PRNSTpOklp.Value;
   XL.Range['Y7']:=PRNSTpLicens.Value;

   //Заказчик(плательщик)
  if PRNZustomer.Value  then
   begin // если заказчик=грузоотправитель
  if not DataSpr.QuerySPDUNN.IsNull then
   XL.Range['AA5']:=inttostr(DataSpr.QuerySPDUNN.Value);// УНН               |
   XL.Range['AA6']:=DataSpr.QuerySPDOklp.Value;// ОКЮЛП            | Грузоотправителя
   XL.Range['AA7']:=DataSpr.QuerySPDLicens.Value;// лицензия         |
   end
  else
   begin  // заказчик=грузополучатель
   if not PRNSTpUNN.IsNull then
    XL.Range['AA5']:=inttostr(PRNSTpUNN.Value);
   XL.Range['AA6']:=PRNSTpOklp.Value;
   XL.Range['AA7']:=PRNSTpLicens.Value;
   end;
  XL.Range['P12']:=PRNSDateN.Value;// Дата}

  //Транспорт
  XL.Range['E13']:=PRNSCar.Value;
  XL.Range['Z13']:=PRNZPutList.Value;
  XL.Range['F15']:=PRNZOwnCarName.Value;
  XL.Range['V15']:=PRNSVodName.Value;
  XL.Range['AA15']:='Авто';// вид перевозки

  qrBankAccount.Close;
  qrBankAccount.SQL.Text:=SQLStringPodr;
  qrBankAccount.Prepare;
  qrBankAccount.ParamByName('c').Value:=PodrG;
  qrBankAccount.Open;
  //Грузоотправитель
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P4:=KMOLG;
  FormMain.VisM2.Execute('s P2=$P($G(^SPD(P1)),":",1),P3=$P($G(^SPD(P1)),":",6),P5=$P($G(^SMOL(P4)),":",1)');
  XL.Range['E19']:=AnsiUpperCase(FormMain.Vism2.P5)+', '+FormMain.Vism2.P2+', '+FormMain.Vism2.P3+'; '+ qrBankAccountRS.Value+', '+qrBankAccountAdressB.Value+', '+qrBankAccountNameB.Value;// Грузоотправитель
  XL.Range['AE18']:=qrBankAccountMFOB.Value;// код банка грузоотправителя
  if PRNSTpPr.Value=1 then
   begin
   qrBankAccount.Close;
   qrBankAccount.SQL.Text:=SQLStringTp;
   qrBankAccount.Prepare;
   qrBankAccount.ParamByName('c').Value:=kodpl;
   qrBankAccount.Open;
   XL.Range['E21']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value+'; '+qrBankAccountRS.Value+', '+qrBankAccountAdressB.Value+', '+qrBankAccountNameB.Value;// Грузополучатель реквизиты
   XL.Range['AE20']:=qrBankAccountMFOB.Value;// Код банка грузополучателя
   //Заказчик(плательщик)
   if PRNZustomer.Value then
    begin
    XL.Range['F17']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3+'; '+ qrBankAccountRS.Value+', '+qrBankAccountAdressB.Value+', '+qrBankAccountNameB.Value;
    XL.Range['AE16']:='=AE18';
    end
   else
    begin
    if orgpl then
     begin
     FormMain.Vism2.P1:=kodpl;
     FormMain.VisM2.Execute('s P2=$P($G(^SWTP(P1)),":",1),P3=$P($G(^SWTP(P1)),":",6)');
     XL.Range['F17']:=FormMain.VisM2.P2+','+FormMain.VisM2.P3+'; '+qrBankAccountRS.Value+', '+qrBankAccountAdressB.Value+', '+qrBankAccountNameB.Value;
     XL.Range['AE16']:='=AE20';
     end
    else
     begin
     XL.Range['F17']:='=E21';
     XL.Range['AE16']:='=AE20';
     end;
    end
   end
  else
   begin
   XL.Range['E21']:=AnsiUpperCase(PRNSTpName.Value)+', '+PRNSTpAdres.Value+'; '+qrBankAccountRS.Value+', '+qrBankAccountAdressB.Value+', '+qrBankAccountNameB.Value;// Грузополучатель реквизиты
   XL.Range['AE20']:='=AE18';// Код банка грузополучателя
   XL.Range['F17']:=FormMain.Vism2.P2+', '+FormMain.Vism2.P3+'; '+ qrBankAccountRS.Value+', '+qrBankAccountAdressB.Value+', '+qrBankAccountNameB.Value;
   XL.Range['AE16']:='=AE18';
   end;
  XL.Range['E23']:=PRNZOsnOtp.Value;
  XL.Range['Z23']:=PRNZCelPriobr.Value;
  XL.Range['E25']:=PRNZPunktPogr.Value;
  XL.Range['U25']:=PRNZPunktRazgr.Value;
   // переадресовка
  XL.Range['E27']:=PRNZPereadr.Value;
  XL.Range['AC25']:='';// № маршрута
  XL.Range['Z27']:='';// прицеп
  XL.Range['AC27']:='';// Гараж

end;

procedure TFormPrint.Podv;
begin
  XL.Range['O39']:='';// оттиск
  XL.Range['Z39']:='';// количество мест прописью
  XL.Range['E41']:='';// груз массой брутто
  XL.Range['E43']:=PRNZCdalOtp.Value;// сдал отправитель
  XL.Range['F45']:=PRNSVodName.Value;// принял водитель
  XL.Range['E50']:=PRNZOtpRazr.Value;// отпуск разрешил
  XL.Range['P52']:='';// оттиск
  XL.Range['Z52']:='';// количество мест прописью
  XL.Range['E54']:='';// груз массой брутто
  XL.Range['F56']:=PRNSVodName.Value;// сдал водитель
  XL.Range['E64']:=PRNZDovNom.Value;// № доверенности
  XL.Range['M64']:=PRNZDovData.AsString;// дата доверенности
  XL.Range['Z64']:=PRNZDovVyd.Value;// выдана доверенность
  XL.Range['E66']:='';// груз получил

end;

procedure TFormPrint.ppDetailBand2BeforePrint(Sender: TObject);
var Text:String;
begin
if Length(ppDBText22.Text)>37 then
 begin
 ppDBText22.Height:=0.3437;
 ppLabel28.Top:=0.3042;
 end
else
 begin
 ppDBText22.Height:=0.1563;
 ppLabel28.Top:=0.15;
 end;
Text:=UtilForm.DelSim(qPrintDop.Value);
//ShowMessage(Text+'='+IntToStr(Length(Text)));
if Length(Text)=0 then   ppLabel28.Height:=0.01
else  if Length(Text)>113 then ppLabel28.Height:=0.3437
else                     ppLabel28.Height:=0.1583;
ppLabel28.Caption:=Text;
ppLine34.Top:=ppLabel28.Top+ppLabel28.Height;
end;

procedure TFormPrint.ppDBCalc12Print(Sender: TObject);
begin
ppDBCalc12.Value:=Round(ppDBCalc12.Value);
end;

procedure TFormPrint.ppDBCalc11Print(Sender: TObject);
begin
ppDBCalc11.Value:=Round(ppDBCalc11.Value);

end;

procedure TFormPrint.ppDBCalc9Print(Sender: TObject);
begin
ppDBCalc9.Value:=Round(ppDBCalc9.Value);

end;

procedure TFormPrint.ppDBCalc13Print(Sender: TObject);
begin
ppDBCalc13.Value:=Round(ppDBCalc13.Value);

end;

procedure TFormPrint.ppLabel49GetText(Sender: TObject; var Text: String);
begin
Text:='Приложение к товаро-транспортной накладной № '+PRNSNnak.AsString;
end;

procedure TFormPrint.ZaglPr;
begin
  XL.Range['A1']:='Накладная по приходу № '+PRNSNnak.AsString+'от '+ PRNSDateN.AsString;
  FormMain.VisM2.P1:=PodrG;
  FormMain.VisM2.P2:=KBSG;
  FormMain.VisM2.P3:=KMOLG;
  FormMain.VisM2.P7:=PRNSTpKod.Value;
  FormMain.VisM2.Execute('s P4=$P($G(^SPD(P1)),":",1),P5=$$NameBS^AA(P2),P6=$$NameA^AA(P2,P3),P8=$P($G(^SWTP(P7)),":",1)');
  XL.Range['A3']:='Организация_'+FormMain.VisM2.P4;
  XL.Range['A5']:='Счёт_'+KBSG+' '+FormMain.VisM2.P5;
  XL.Range['A7']:='Мат.отв.лицо_'+IntToStr(KMOLG)+' '+FormMain.VisM2.P6;
  XL.Range['A9']:='Грузоотправитель_'+PRNSTpKod.AsString+' '+PRNSTpName.Value;
end;

procedure TFormPrint.Prich2;
var ndsrs,isum,isumnds,sum,sumnds:Real;

begin
isum:=0;isumnds:=0;sum:=0;sumnds:=0;
FormMain.VisM1.P1:=KMOLG;
FormMain.VisM1.P2:=Date;
FormMain.VisM1.Execute('s P3=$ZDH($TR(P2,".","/"),4),P4=##class(KSU.NDS).NDSfromDate(P1,P3),P4=$TR(P4,".",",")');
ndsrs:=FormMain.VisM1.P4;
XL.WorkBooks.Add(ProgDir+'ПН-2.xls');
XL.WorkBooks[1].Sheets[1].Activate;
XL.visible:=true;
ZaglPr;
QPr.First;
n:='16';
for i:=1 to QPr.RecordCount do
  begin
  XL.Range['A'+n]:=QPrNnt.Value;
  XL.Range['B'+n]:=QPrName.Value;
  XL.Range['C'+n]:=QPrKodEiName.Value;
  XL.Range['D'+n]:=QPrKol.Value;
  XL.Range['E'+n]:=QPrPrice.Value;
  XL.Range['F'+n]:=FloatToStr(ndsrs);
  sum:=QPrKol.Value*QPrPrice.Value;
  sum:=SimpleRoundTo(sum, -2) ;
  sumnds:=sum*ndsrs/100;
  sumnds:=SimpleRoundTo(sumnds, -2);
  XL.Range['G'+n]:=sumnds; //FloatToStr(sumnds);
  XL.Range['H'+n]:=sum; //FloatToStr(sum);
  isum:=isum+sum;isumnds:=isumnds+sumnds;
  n:=Incn(n);
  QPr.Next;
  end;
  XL.Range['B'+n]:='Итого:';
  XL.Range['G'+n]:=isumnds; //FloatToStr(isumnds);
  XL.Range['H'+n]:=isum; //FloatToStr(isum);

end;

procedure TFormPrint.Prich3;
var isum,isumnds,isumo,sum,sumnds,sumo:Real;

begin
isum:=0;isumnds:=0;sum:=0;sumnds:=0;
isumo:=0;sumo:=0 ;
XL.WorkBooks.Add(ProgDir+'ПН-3.xls');
XL.WorkBooks[1].Sheets[1].Activate;
XL.visible:=true;
ZaglPr;
QPr.First;
n:='16';
for i:=1 to QPr.RecordCount do
  begin
  XL.Range['A'+n]:=QPrNnt.Value;
  XL.Range['B'+n]:=QPrName.Value;
  XL.Range['C'+n]:=QPrKodEiName.Value;
  XL.Range['D'+n]:=QPrKol.Value;
  XL.Range['E'+n]:=QPrPrice.Value;
  sum:=QPrKol.Value*QPrPrice.Value;
  sum:=SimpleRoundTo(sum, -2) ;
  XL.Range['F'+n]:=sum;
  XL.Range['G'+n]:=QPrNDS.Value;
  sumnds:=sum*QPrNDS.Value/100;
  sumnds:=SimpleRoundTo(sumnds, -2);
  XL.Range['H'+n]:=sumnds;
  sumo:=sum+sumnds;
  XL.Range['I'+n]:=sumo;
  isum:=isum+sum;isumnds:=isumnds+sumnds;
  isumo:=isumo+sumo ;
  n:=Incn(n);
  QPr.Next;
  end;
  XL.Range['B'+n]:='Итого:';
  XL.Range['F'+n]:=isum;
  XL.Range['H'+n]:=isumnds;
  XL.Range['I'+n]:=isumo;

end;
procedure TFormPrint.Prich3cr;
var nds,isum,isumnds,isumo,sum,sumnds,sumo:Double;

begin
isum:=0;isumnds:=0;sum:=0;sumnds:=0;
FormMain.VisM1.P1:=KMOLG;
FormMain.VisM1.P2:=Date;
//FormMain.VisM1.Execute('s P3=$ZDH($TR(P2,".","/"),4),P4=##class(KSU.NDS).NDSfromDate(P1,P3),P4=$TR(P4,".",",")');
//ndsrs:=FormMain.VisM1.P4;
XL.WorkBooks.Add(ProgDir+'ПН-3.xls');
XL.WorkBooks[1].Sheets[1].Activate;
XL.visible:=true;
ZaglPr;
XL.Rows[10].RowHeight:=0;
XL.Rows[11].RowHeight:=0;
XL.Rows[12].RowHeight:=0;
XL.Rows[13].RowHeight:=0;
XL.Rows[14].RowHeight:=0;
QPr.First;
n:='16';
for i:=1 to QPr.RecordCount do
  begin
  XL.Range['A'+n]:=QPrNnt.Value;
  XL.Range['B'+n]:=QPrName.Value;
  XL.Range['C'+n]:=QPrKodEiName.Value;
  XL.Range['D'+n+':'+'I'+n].Select;
  Xl.Selection.NumberFormat:='@';
  Xl.Selection.HorizontalAlignment:=xlRight;
  XL.Range['D'+n]:=QPrKol.AsString;
  XL.Range['E'+n]:=QPrPriceSr.AsString;
  sum:=QPrKol.Value*QPrPriceSr.Value;
  sum:=SimpleRoundTo(sum,-2);
  XL.Range['F'+n]:=FloatToStr(sum);
  nds:=QPrNDS.Value;
  XL.Range['G'+n]:=FloatToStr(nds);
  sumnds:=QPrKol.Value*QPrPriceSr.Value*nds/100;
  sumnds:=SimpleRoundTo(sumnds,-2);
  sumo:=sum+sumnds;
  XL.Range['H'+n]:=FloatToStr(sumnds);
  XL.Range['I'+n]:=FloatToStr(sumo);
  isum:=isum+sum;isumnds:=isumnds+sumnds;isumo:=isumo+sumo;
  n:=Incn(n);
  QPr.Next;
  end;
  XL.Range['A'+n+':'+'I'+n].Select;
  Xl.Selection.Borders[xledgeTop].LineStyle:=1;
  XL.Range['B'+n]:='Итого:';
  XL.Range['F'+n]:=FloatToStr(isum);
  XL.Range['H'+n]:=FloatToStr(isumnds);
  XL.Range['I'+n]:=FloatToStr(isumo);
  XL.Columns['D'].Autofit;
  XL.Columns['E'].Autofit;
  XL.Columns['F'].Autofit;
  XL.Columns['H'].Autofit;
  XL.Columns['I'].Autofit;
  n:=Incn(n);
  n:=Incn(n);
  XL.Range['B'+n]:='Сдал грузоотправитель____________________________________';
  n:=Incn(n);
  n:=Incn(n);
  XL.Range['B'+n]:='Принял грузополучатель___________________________________';
end;


procedure TFormPrint.ppSummaryBand1BeforeGenerate(Sender: TObject);
begin
if SumTaraTotal.IsNull then
 begin
 ppLabel21.Visible:=False;ppLabel22.Visible:=False;ppLabel23.Visible:=False;
 ppLabel24.Visible:=False;ppLabel25.Visible:=False;
 ppLabel52.Visible:=False;ppLabel53.Visible:=False;ppLabel54.Visible:=False;
 ppLabel55.Visible:=False;ppLabel56.Visible:=False;
 ppLabel1.Top:=0.5;ppDBCalc1.Top:=0.5;ppDBCalc2.Top:=0.5;
 ppDBCalc3.Top:=0.5;ppDBCalc4.Top:=0.5;
 ppLabel58.Top:=5.292;ppLabel59.Top:=5.292;ppLabel60.Top:=5.292;
 ppLabel61.Visible:=False;ppLabel62.Visible:=False;ppLabel63.Visible:=False;ppLabel64.Visible:=False;
 ppLabel65.Top:=9.525;ppLabel66.Top:=9.525;ppLabel67.Top:=9.525;
 ppLabel68.Visible:=False;ppLabel69.Visible:=False;ppLabel70.Visible:=False;ppLabel71.Visible:=False;
 end
else
 begin
 ppLabel21.Visible:=True;ppLabel22.Visible:=True;ppLabel23.Visible:=True;
 ppLabel24.Visible:=True;ppLabel25.Visible:=True;
 ppLabel52.Visible:=True;ppLabel53.Visible:=True;ppLabel54.Visible:=True;
 ppLabel55.Visible:=True;ppLabel56.Visible:=True;
 ppLabel1.Top:=9.525;ppDBCalc1.Top:=9.525;ppDBCalc2.Top:=9.525;
 ppDBCalc3.Top:=9.525;ppDBCalc4.Top:=9.525;
 ppLabel22.Caption:=FloatToStr(ppDBCalc1.Value-SumTaraQnt.Value);
 ppLabel53.Caption:=SumTaraQnt.AsString;
 ppLabel23.Caption:=FloatToStr(ppDBCalc2.Value-SumTaraNDS.Value);
 ppLabel54.Caption:=SumTaraNDS.AsString;
 ppLabel24.Caption:=FloatToStr(ppDBCalc3.Value-SumTarawNDS.Value);
 ppLabel55.Caption:=SumTarawNDS.AsString;
 ppLabel25.Caption:=FloatToStr(ppDBCalc4.Value-SumTaraTotal.Value);
 ppLabel56.Caption:=SumTaraTotal.AsString;
 ppLabel61.Visible:=True;ppLabel62.Visible:=True;ppLabel63.Visible:=True;ppLabel64.Visible:=True;
 ppLabel68.Visible:=True;ppLabel69.Visible:=True;ppLabel70.Visible:=True;ppLabel71.Visible:=True;
 ppLabel58.Top:=13.758;ppLabel59.Top:=13.758;ppLabel60.Top:=13.758;
 ppLabel65.Top:=17.992;ppLabel66.Top:=17.992;ppLabel67.Top:=17.992;

 end;
end;

procedure TFormPrint.ppHeaderBand2BeforeGenerate(Sender: TObject);
begin
if VidSK then FormMain.VisM1.P1:=KMOLG
else          FormMain.VisM1.P1:=KBSG;
FormMain.VisM1.Execute('s P2=$G(^KSU.Option("FormSTMC",P1,"AvtD"),0),P3=$G(^KSU.Option("FormSTMC",P1,"AvtD","Gr")),P4=$G(^KSU.Option("FormSTMC",P1,"AvtD","Text")),P5=$G(^KSU.Option("FormSTMC",P1,"AvtD","Zap"))');
if (FormMain.VisM1.P2='1') and (FormMain.VisM1.P5='3') then
 begin
 ppLabel57.Text:=FormMain.VisM1.P4;
 end
else
 begin
 ppLabel57.Text:='';
 end;
end;

procedure TFormPrint.ppHeaderBand3BeforeGenerate(Sender: TObject);
begin
  ppLabel72.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel73.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppHeaderBand300BeforeGenerate(Sender: TObject);
begin
  ppLabel203.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel204.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppHeaderBand9BeforeGenerate(Sender: TObject);
begin
  ppLabel195.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel196.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppDetailBand3BeforeGenerate(Sender: TObject);
var
  height:integer;
  fDop,fDop2,fAxc,fTrans:boolean;
  dop:string;
begin
  dop:='';
  if PrintTPNakl then dop:=qPrintTPNakl.Value;
  height:=18;fDop:=false;fDop2:=false;fAxc:=false;fTrans:=false;
  dop:=dop+qPrintDop.Value;
  ppLabel112.Text:=dop;
  if dop<>''
  then begin
    height:=height+14;
    fDop:=true;
    ppLabel112.Height:=14;
    ppLabel112.Visible:=true;
  end
  else begin
    ppLabel112.Visible:=false;
  end;

  if Length(dop)>110
  then begin
    height:=height+14;
    fDop2:=true;
    ppLabel112.Height:=26;
  end
  else begin

  end;

  if qPrintAxc.Value<>''
  then begin
    height:=height+14;
    fAxc:=true;
    ppDBText60.Visible:=true;
  end
  else begin
    ppDBText60.Visible:=false;
  end;

  if qPrintTrans.Value<>0
  then begin
    height:=height+14;
    fTrans:=true;
    ppLabel97.Visible:=true;
    ppDBText42.Visible:=true;
    ppDBText43.Visible:=true;
    ppDBText52.Visible:=true;
  end
  else begin
    ppLabel97.Visible:=false;
    ppDBText42.Visible:=false;
    ppDBText43.Visible:=false;
    ppDBText52.Visible:=false;
  end;

  ppDetailBand3.Height:=height;

  if fTrans
  then begin
    if fDop
    then begin
      if fDop2
      then begin
        ppLabel112.Top:=28;
        if fAxc
        then begin
          ppDBText60.Top:=56;
          ppLine36.Top:=70;
        end
        else ppLine36.Top:=56;
      end
      else begin
        ppLabel112.Top:=28;
        if fAxc
        then begin
          ppDBText60.Top:=42;
          ppLine36.Top:=56;
        end
        else ppLine36.Top:=42;
      end;
    end
    else begin
      if fAxc
      then begin
        ppDBText60.Top:=28;
        ppLine36.Top:=42;
      end
      else ppLine36.Top:=28;
    end;
  end
  else begin
    if fDop
    then begin
      if fDop2
      then begin
        ppLabel112.Top:=16;
        if fAxc
        then begin
          ppDBText60.Top:=42;
          ppLine36.Top:=56;
        end
        else ppLine36.Top:=42;
      end
      else begin
        ppLabel112.Top:=16;
        if fAxc
        then begin
          ppDBText60.Top:=28;
          ppLine36.Top:=42;
        end
        else ppLine36.Top:=28;
      end;
    end
    else begin
      if fAxc
      then begin
        ppDBText60.Top:=16;
        ppLine36.Top:=28;
      end
      else ppLine36.Top:=16;
    end;
  end;


end;

procedure TFormPrint.ppDetailBand300BeforeGenerate(Sender: TObject);
var
  height:integer;
  fDop,fDop2,fAxc,fTrans:boolean;
  dop:string;
begin
  dop:='';
  if PrintTPNakl then dop:=qPrintTPNakl.Value;
  height:=18;fDop:=false;fDop2:=false;fAxc:=false;fTrans:=false;
  dop:=dop+qPrintDop.Value;
  ppLabel239.Text:=dop;
  if dop<>''
  then begin
    height:=height+14;
    fDop:=true;
    ppLabel239.Height:=14;
    ppLabel239.Visible:=true;
  end
  else begin
    ppLabel239.Visible:=false;
  end;

  if Length(dop)>110
  then begin
    height:=height+14;
    fDop2:=true;
    ppLabel112.Height:=26;
  end
  else begin

  end;

  if qPrintAxc.Value<>''
  then begin
    height:=height+14;
    fAxc:=true;
    ppDBText146.Visible:=true;
  end
  else begin
    ppDBText146.Visible:=false;
  end;

  if qPrintTrans.Value<>0
  then begin
    height:=height+14;
    fTrans:=true;
    ppLabel97.Visible:=true;
    ppDBText42.Visible:=true;
    ppDBText43.Visible:=true;
    ppDBText52.Visible:=true;
  end
  else begin
    ppLabel97.Visible:=false;
    ppDBText42.Visible:=false;
    ppDBText43.Visible:=false;
    ppDBText52.Visible:=false;
  end;

  ppDetailBand3.Height:=height;

  if fTrans
  then begin
    if fDop
    then begin
      if fDop2
      then begin
        ppLabel239.Top:=28;
        if fAxc
        then begin
          ppDBText146.Top:=56;
          ppLine146.Top:=70;
        end
        else ppLine36.Top:=56;
      end
      else begin
        ppLabel239.Top:=28;
        if fAxc
        then begin
          ppDBText146.Top:=42;
          ppLine36.Top:=56;
        end
        else ppLine36.Top:=42;
      end;
    end
    else begin
      if fAxc
      then begin
        ppDBText146.Top:=28;
        ppLine36.Top:=42;
      end
      else ppLine36.Top:=28;
    end;
  end
  else begin
    if fDop
    then begin
      if fDop2
      then begin
        ppLabel239.Top:=16;
        if fAxc
        then begin
          ppDBText146.Top:=42;
          ppLine36.Top:=56;
        end
        else ppLine36.Top:=42;
      end
      else begin
        ppLabel239.Top:=16;
        if fAxc
        then begin
          ppDBText146.Top:=28;
          ppLine36.Top:=42;
        end
        else ppLine36.Top:=28;
      end;
    end
    else begin
      if fAxc
      then begin
        ppDBText146.Top:=16;
        ppLine36.Top:=28;
      end
      else ppLine36.Top:=16;
    end;
  end;


end;

procedure TFormPrint.ppDetailBand13BeforeGenerate(Sender: TObject);
var
  height:integer;
  fDop,fDop2,fAxc,fTrans:boolean;
  dop:string;
begin
  dop:='';
  if PrintTPNakl then dop:=qPrintTPNakl.Value;
  height:=18;fDop:=false;fDop2:=false;fAxc:=false;fTrans:=false;
  dop:=dop+qPrintDop.Value;
  ppLabel214.Text:=dop;
  if dop<>''
  then begin
    height:=height+14;
    fDop:=true;
    ppLabel214.Height:=14;
    ppLabel214.Visible:=true;
  end
  else begin
    ppLabel214.Visible:=false;
  end;

  if Length(dop)>110
  then begin
    height:=height+14;
    fDop2:=true;
    ppLabel214.Height:=26;
  end
  else begin

  end;

  if qPrintAxc.Value<>''
  then begin
    height:=height+14;
    fAxc:=true;
    ppDBText134.Visible:=true;
  end
  else begin
    ppDBText134.Visible:=false;
  end;

  if qPrintTrans.Value<>0
  then begin
    height:=height+14;
    fTrans:=true;
    ppLabel213.Visible:=true;
    ppDBText131.Visible:=true;
    ppDBText132.Visible:=true;
    ppDBText120.Visible:=true;
  end
  else begin
    ppLabel213.Visible:=false;
    ppDBText131.Visible:=false;
    ppDBText132.Visible:=false;
    ppDBText120.Visible:=false;
  end;

  ppDetailBand11.Height:=height;

  if fTrans
  then begin
    if fDop
    then begin
      if fDop2
      then begin
        ppLabel214.Top:=28;
        if fAxc
        then begin
          ppDBText134.Top:=56;
          ppLine148.Top:=70;
        end
        else ppLine148.Top:=56;
      end
      else begin
        ppLabel214.Top:=28;
        if fAxc
        then begin
          ppDBText134.Top:=42;
          ppLine148.Top:=56;
        end
        else ppLine148.Top:=42;
      end;
    end
    else begin
      if fAxc
      then begin
        ppDBText134.Top:=28;
        ppLine148.Top:=42;
      end
      else ppLine148.Top:=28;
    end;
  end
  else begin
    if fDop
    then begin
      if fDop2
      then begin
        ppLabel214.Top:=16;
        if fAxc
        then begin
          ppDBText134.Top:=42;
          ppLine148.Top:=56;
        end
        else ppLine148.Top:=42;
      end
      else begin
        ppLabel214.Top:=16;
        if fAxc
        then begin
          ppDBText134.Top:=28;
          ppLine148.Top:=42;
        end
        else ppLine148.Top:=28;
      end;
    end
    else begin
      if fAxc
      then begin
        ppDBText134.Top:=16;
        ppLine148.Top:=28;
      end
      else ppLine148.Top:=16;
    end;
  end;


end;

procedure TFormPrint.ppSummaryBand3BeforeGenerate(Sender: TObject);
begin
  ppLabel92.Caption:=FormFTXPRN.wwQuery2STov.AsString;
  ppLabel93.Caption:=FormFTXPRN.wwQuery2STara.AsString;
end;

procedure TFormPrint.ppSummaryBand300BeforeGenerate(Sender: TObject);
begin
  ppLabel242.Caption:=FormFTXPRN.wwQuery2STov.AsString;
  ppLabel243.Caption:=FormFTXPRN.wwQuery2STara.AsString;
end;

procedure TFormPrint.ppDetailBand4BeforeGenerate(Sender: TObject);
begin
  if qPrintDop.Value=''
    then begin
      if (qPrintTrans.Value=0)
      then begin
        ppDetailBand4.Height:=18;
        ppLine74.Top:=13;
        ppLabel115.Visible:=false;
        ppDBText58.Visible:=false;
        ppDBText59.Visible:=false;
        ppDBText47.Visible:=false;
      end
      else begin
        ppDetailBand4.Height:=34;
        ppLine74.Top:=24;
        ppLabel115.Visible:=true;
        ppDBText58.Visible:=true;
        ppDBText59.Visible:=true;
        ppDBText47.Visible:=true;
        ppLabel115.Top:=12;
        ppDBText59.Top:=12;
        ppDBText58.Top:=12;
        ppDBText47.Top:=12;
      end
    end
    else begin
      if (qPrintTrans.Value=0)
      then begin
        ppDetailBand4.Height:=34;
        ppLine74.Top:=24;
        ppDBtext57.Top:=12;
        ppLabel115.Visible:=false;
        ppDBText58.Visible:=false;
        ppDBText59.Visible:=false;
        ppDBText47.Visible:=false;
      end
      else begin
        ppDetailBand4.Height:=45;
        ppLine74.Top:=36;
        ppDBtext57.Top:=24;
        ppLabel115.Visible:=true;
        ppDBText58.Visible:=true;
        ppDBText59.Visible:=true;
        ppDBText47.Visible:=true;
        ppLabel115.Top:=12;
        ppDBText58.Top:=12;
        ppDBText59.Top:=12;
        ppDBText47.Top:=12;
      end;
    end
end;

procedure TFormPrint.ppSummaryBand4BeforeGenerate(Sender: TObject);
begin
  FormMain.VisM1.P8:=NomK;
  FormMain.VisM1.Execute('s ^TEMP("TMO",P8,"OkrNo")=1');
  wwQuery2.Close;
  wwQuery2.Prepare;
  wwQuery2.ParamByName('id').Value:=Data.KPRNID.Value;
  wwQuery2.Open;
  ppLabel118.Caption:=wwQuery2STov2.AsString;
  ppLabel119.Caption:=wwQuery2STara2.AsString;
end;

procedure TFormPrint.ppDetailBand6BeforeGenerate(Sender: TObject);
var
  height:integer;
  fDop,fDop2,fAxc,fTrans:boolean;
  dop:string;
begin
  dop:='';
  if PrintTPNakl then dop:=qPrintTPNakl.Value;
  height:=18;fDop:=false;fDop2:=false;fAxc:=false;fTrans:=false;
  dop:=dop+qPrintDop.Value;
  ppLabel149.Text:=dop;
  if dop<>''
  then begin
    height:=height+14;
    fDop:=true;
    ppLabel149.Height:=14;
    ppLabel149.Visible:=true;
  end
  else begin
    ppLabel149.Visible:=false;
  end;
 
  if qPrintAxc.Value<>''
  then begin
    height:=height+14;
    fAxc:=true;
    ppDBText82.Visible:=true;
  end
  else begin
    ppDBText82.Visible:=false;
  end;

  if qPrintTrans.Value<>0
  then begin
    height:=height+14;
    fTrans:=true;
    ppLabel148.Visible:=true;
    ppDBText79.Visible:=true;
    ppDBText80.Visible:=true;
    ppDBText81.Visible:=true;
  end
  else begin
    ppLabel148.Visible:=false;
    ppDBText79.Visible:=false;
    ppDBText80.Visible:=false;
    ppDBText81.Visible:=false;
  end;

  ppDetailBand6.Height:=height;

  if fTrans
  then begin
    if fDop
    then begin
        ppLabel149.Top:=28;
        if fAxc
        then begin
          ppDBText82.Top:=42;
          ppLine99.Top:=56;
        end
        else ppLine99.Top:=42;
	  end
	  else begin
      if fAxc
      then begin
        ppDBText82.Top:=28;
        ppLine99.Top:=42;
      end
      else ppLine99.Top:=28;
    end;
  end
  else begin
    if fDop
    then begin
        ppLabel149.Top:=16;
        if fAxc
        then begin
          ppDBText82.Top:=28;
          ppLine99.Top:=42;
        end
        else ppLine99.Top:=28;
    end
    else begin
      if fAxc
      then begin
        ppDBText82.Top:=16;
        ppLine99.Top:=28;
      end
      else ppLine99.Top:=16;
    end;
  end;
end;

procedure TFormPrint.ppSummaryBand5BeforeGenerate(Sender: TObject);
begin
  ppLabel152.Caption:=FormFTXPRN.wwQuery2STov.AsString;
  ppLabel153.Caption:=FormFTXPRN.wwQuery2STara.AsString;
end;

procedure TFormPrint.ppHeaderBand5BeforeGenerate(Sender: TObject);
begin
  ppLabel131.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel132.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppSummaryBand7BeforeGenerate(Sender: TObject);
begin
  FormMain.VisM1.P8:=NomK;
  FormMain.VisM1.Execute('s ^TEMP("TMO",P8,"OkrNo")=1');
  wwQuery2.Close;
  wwQuery2.Prepare;
  wwQuery2.ParamByName('id').Value:=Data.KPRNID.Value;
  wwQuery2.Open;
  ppLabel186.Caption:=wwQuery2STov2.AsString;
  ppLabel187.Caption:=wwQuery2STara2.AsString;
  ppLabel217.Caption:=wwQuery2STov2.AsString;
  ppLabel218.Caption:=wwQuery2STara2.AsString;
end;

procedure TFormPrint.ppDetailBand9BeforeGenerate(Sender: TObject);
begin
  if qPrintDop.Value=''
    then begin
      if (qPrintTrans.Value=0)
      then begin
        ppDetailBand9.Height:=18;
        ppLine125.Top:=13;
        ppLabel183.Visible:=false;
        ppDBText105.Visible:=false;
        ppDBText106.Visible:=false;
        ppDBText107.Visible:=false;
      end
      else begin
        ppDetailBand9.Height:=34;
        ppLine125.Top:=24;
        ppLabel183.Visible:=true;
        ppDBText105.Visible:=true;
        ppDBText106.Visible:=true;
        ppDBText107.Visible:=true;
        ppLabel183.Top:=12;
        ppDBText105.Top:=12;
        ppDBText106.Top:=12;
        ppDBText107.Top:=12;
      end
    end
    else begin
      if (qPrintTrans.Value=0)
      then begin
        ppDetailBand9.Height:=34;
        ppLine125.Top:=24;
        ppDBtext104.Top:=12;
        ppLabel183.Visible:=false;
        ppDBText105.Visible:=false;
        ppDBText106.Visible:=false;
        ppDBText107.Visible:=false;
      end
      else begin
        ppDetailBand9.Height:=45;
        ppLine125.Top:=36;
        ppDBtext104.Top:=24;
        ppLabel183.Visible:=true;
        ppDBText105.Visible:=true;
        ppDBText106.Visible:=true;
        ppDBText107.Visible:=true;
        ppLabel183.Top:=12;
        ppDBText105.Top:=12;
        ppDBText106.Top:=12;
        ppDBText107.Top:=12;
      end;
    end
end;

procedure TFormPrint.ppHeaderBand8BeforeGenerate(Sender: TObject);
begin
  ppLabel169.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel170.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppHeaderBand4BeforeGenerate(Sender: TObject);
begin
  ppLabel86.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel98.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppGroupHeaderBand1AfterGenerate(Sender: TObject);
begin
  if qPrintEd.Value=1 then ppLabel311.Caption:='Завтрак'
  else if qPrintEd.Value=2 then ppLabel311.Caption:='Обед'
       else if qPrintEd.Value=3 then ppLabel311.Caption:='Ужин'
            else if qPrintEd.Value=4 then ppLabel311.Caption:=''
                 else if qPrintEd.Value=5 then ppLabel311.Caption:='Упаковка';
end;

procedure TFormPrint.ppHeaderBand11BeforeGenerate(Sender: TObject);
begin
  ppLabel300.Caption:='Приложение к товарно-транспортной накладной';
  ppLabel301.Caption:='№'+Data.KPRNNnak.AsString+' от '+Data.KPRNDateN.AsString;
end;

procedure TFormPrint.ppSummaryBand11BeforeGenerate(Sender: TObject);
begin
  {FormMain.VisM1.P8:=NomK;
  FormMain.VisM1.Execute('s ^TEMP("TMO",P8,"OkrNo")=1');
  wwQuery2.Close;
  wwQuery2.Prepare;
  wwQuery2.ParamByName('id').Value:=Data.KPRNID.Value;
  wwQuery2.Open;
  ppLabel319.Caption:=wwQuery2STov2.AsString;
  ppLabel320.Caption:=wwQuery2STara2.AsString;}
end;

procedure TFormPrint.ppGroupHeaderBand3BeforeGenerate(Sender: TObject);
begin
  FormMain.VisM1.P1:=qPrintKodGr.Value;
  FormMain.VisM1.Execute('s P2=$LG($G(^KSU.SprGrupD(P1)),2)');
  ppLabel346.Caption:=FormMain.VisM1.P2;

end;

procedure TFormPrint.ppDetailBand20BeforePrint(Sender: TObject);
var Text:String;
begin
if Length(ppDBText211.Text)>37 then
 begin
 ppDBText211.Height:=0.3437;
 ppLabel368.Top:=0.3042;
 end
else
 begin
 ppDBText211.Height:=0.1563;
 ppLabel368.Top:=0.15;
 end;
Text:=UtilForm.DelSim(qPrintDop.Value);
//ShowMessage(Text+'='+IntToStr(Length(Text)));
if Length(Text)=0 then   ppLabel368.Height:=0.01
else  if Length(Text)>113 then ppLabel368.Height:=0.3437
else                     ppLabel368.Height:=0.1583;
ppLabel368.Caption:=Text;
ppLine267.Top:=ppLabel368.Top+ppLabel368.Height;
end;

procedure TFormPrint.ppDBCalc71Print(Sender: TObject);
begin
ppDBCalc71.Value:=Round(ppDBCalc71.Value);
end;

procedure TFormPrint.ppDBCalc74Print(Sender: TObject);
begin
ppDBCalc74.Value:=Round(ppDBCalc74.Value);
end;

procedure TFormPrint.ppDBCalc76Print(Sender: TObject);
begin
ppDBCalc76.Value:=Round(ppDBCalc76.Value);
end;

procedure TFormPrint.ppDBCalc77Print(Sender: TObject);
begin
ppDBCalc77.Value:=Round(ppDBCalc77.Value);
end;

procedure TFormPrint.ppDBCalc78Print(Sender: TObject);
begin
ppDBCalc78.Value:=Round(ppDBCalc78.Value);
end;

procedure TFormPrint.ppDBCalc79Print(Sender: TObject);
begin
ppDBCalc79.Value:=Round(ppDBCalc79.Value);
end;

procedure TFormPrint.ppDBCalc80Print(Sender: TObject);
begin
ppDBCalc80.Value:=Round(ppDBCalc80.Value);
end;

procedure TFormPrint.ppDBCalc81Print(Sender: TObject);
begin
ppDBCalc81.Value:=Round(ppDBCalc81.Value);
end;

procedure TFormPrint.ppGroupHeaderBand2BeforeGenerate(Sender: TObject);
begin
  FormMain.VisM1.P1:=qPrintKodGr.Value;
  FormMain.VisM1.Execute('s P2=$LG(^KSU.SprGrupD(P1),2)');
  ppLabel319.Caption:=FormMain.VisM1.P2;
end;

procedure TFormPrint.ppDetailBand22BeforeGenerate(Sender: TObject);
var i:Integer;
begin
  i:=ppDBMemo1.Lines.Count;
  ppLine297.Top:=0.125*(i+1);
  ppDBMemo1.Height:=0.1667*(i+1);
  ppDetailBand22.Height:=0.1771*(i+1);
end;

end.
